<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SignalWire C2C Widget</title>
  </head>
  <body>
    <button id="callButton1">Call Sigmond (chat only)</button>

    <call-widget
      button-id="callButton1"
      token="token"
      support-video="true"
      support-audio="true"
      destination="/private/demo-1"
      log-level="info"
      window-mode="video+transcript"
    ></call-widget>

    <script type="module" src="/src/index.ts"></script>

    <script type="module">
      import { showContactForm } from "/src/lib/contactForm.js";

      document.addEventListener("DOMContentLoaded", function () {
        const widget = document.querySelector("call-widget");

        widget.addEventListener("beforeDial", function (event) {
          const approve = event.detail.approve;
          const reject = event.detail.reject;

          // Indicate that we're listening and will handle this event
          event.detail.hasListeners = true;

          showContactForm(
            {
              onSubmit: (data) => {
                console.log("Form submitted:", data);

                const payload = {
                  email: data.email,
                  name: data.name,
                  phone: data.number,
                };

                try {
                  fetch("http://localhost:3000/submit", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(payload),
                  }).catch((error) => {
                    console.error("Form submission error:", error);
                  });
                } catch (error) {
                  console.error("Form submission error:", error);
                  // we don't want this fetch error to block the call
                }

                approve();
              },
              onCancel: () => {
                console.log("Form cancelled");
                reject();
              },
            },
            widget
          );
        });
      });
    </script>
  </body>
</html>
