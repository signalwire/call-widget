(self.webpackChunkdoc_for_c_2_c_widget=self.webpackChunkdoc_for_c_2_c_widget||[]).push([[219],{3065:function(e,t,i){var r,o;!function(){"use strict";r=function(){var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],o={},n=null;function s(e,t){var i=e[t];if("function"==typeof i.bind)return i.bind(e);try{return Function.prototype.bind.call(i,e)}catch(r){return function(){return Function.prototype.apply.apply(i,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(r){return"debug"===r&&(r="log"),typeof console!==t&&("trace"===r&&i?a:void 0!==console[r]?s(console,r):void 0!==console.log?s(console,"log"):e)}function d(){for(var i=this.getLevel(),o=0;o<r.length;o++){var n=r[o];this[n]=o<i?e:this.methodFactory(n,i,this.name)}if(this.log=this.debug,typeof console===t&&i<this.levels.SILENT)return"No console available for logging"}function l(e){return function(){typeof console!==t&&(d.call(this),this[e].apply(this,arguments))}}function u(e,t,i){return c(e)||l.apply(this,arguments)}function h(e,i){var s,a,c,l=this,h="loglevel";function m(e){var i=(r[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=i)}catch(o){}try{window.document.cookie=encodeURIComponent(h)+"="+i+";"}catch(o){}}}function p(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(n){}if(typeof e===t)try{var i=window.document.cookie,r=encodeURIComponent(h),o=i.indexOf(r+"=");-1!==o&&(e=/^([^;]+)/.exec(i.slice(o+r.length+1))[1])}catch(n){}return void 0===l.levels[e]&&(e=void 0),e}}function g(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function v(e){var t=e;if("string"==typeof t&&void 0!==l.levels[t.toUpperCase()]&&(t=l.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=l.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),l.name=e,l.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},l.methodFactory=i||u,l.getLevel=function(){return null!=c?c:null!=a?a:s},l.setLevel=function(e,t){return c=v(e),!1!==t&&m(c),d.call(l)},l.setDefaultLevel=function(e){a=v(e),p()||l.setLevel(e,!1)},l.resetLevel=function(){c=null,g(),d.call(l)},l.enableAll=function(e){l.setLevel(l.levels.TRACE,e)},l.disableAll=function(e){l.setLevel(l.levels.SILENT,e)},l.rebuild=function(){if(n!==l&&(s=v(n.getLevel())),d.call(l),n===l)for(var e in o)o[e].rebuild()},s=v(n?n.getLevel():"WARN");var f=p();null!=f&&(c=v(f)),d.call(l)}(n=new h).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=o[e];return t||(t=o[e]=new h(e,n.methodFactory)),t};var m=typeof window!==t?window.log:void 0;return n.noConflict=function(){return typeof window!==t&&window.log===n&&(window.log=m),n},n.getLoggers=function(){return o},n.default=n,n},void 0===(o="function"==typeof r?r.call(t,i,t,e):r)||(e.exports=o)}()},4219:(e,t,i)=>{"use strict";i.r(t),i.d(t,{C2CWidget:()=>tl});var r={};i.r(r),i.d(r,{__DO_NOT_USE__ActionTypes:()=>w,applyMiddleware:()=>P,bindActionCreators:()=>M,combineReducers:()=>E,compose:()=>x,createStore:()=>S,legacy_createStore:()=>C});var o=i(3065),n=i.n(o);const s={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};let a;const c=new Uint8Array(16);function d(){if(!a&&(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!a))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(c)}const l=[];for(let il=0;il<256;++il)l.push((il+256).toString(16).slice(1));function u(e,t=0){return l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]}const h=function(e,t,i){if(s.randomUUID&&!t&&!e)return s.randomUUID();const r=(e=e||{}).random||(e.rng||d)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){i=i||0;for(let e=0;e<16;++e)t[i+e]=r[e];return t}return u(r)};function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function p(e){var t=function(e,t){if("object"!=m(e)||!e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=m(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==m(t)?t:t+""}function g(e,t,i){return(t=p(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function v(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function f(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?v(Object(i),!0).forEach((function(t){g(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):v(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function y(e){return"Minified Redux error #"+e+"; visit https://redux.js.org/Errors?code="+e+" for the full message or use the non-minified dev environment for full errors. "}var b="function"==typeof Symbol&&Symbol.observable||"@@observable",_=function(){return Math.random().toString(36).substring(7).split("").join(".")},w={INIT:"@@redux/INIT"+_(),REPLACE:"@@redux/REPLACE"+_(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+_()}};function k(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}function S(e,t,i){var r;if("function"==typeof t&&"function"==typeof i||"function"==typeof i&&"function"==typeof arguments[3])throw new Error(y(0));if("function"==typeof t&&void 0===i&&(i=t,t=void 0),void 0!==i){if("function"!=typeof i)throw new Error(y(1));return i(S)(e,t)}if("function"!=typeof e)throw new Error(y(2));var o=e,n=t,s=[],a=s,c=!1;function d(){a===s&&(a=s.slice())}function l(){if(c)throw new Error(y(3));return n}function u(e){if("function"!=typeof e)throw new Error(y(4));if(c)throw new Error(y(5));var t=!0;return d(),a.push(e),function(){if(t){if(c)throw new Error(y(6));t=!1,d();var i=a.indexOf(e);a.splice(i,1),s=null}}}function h(e){if(!k(e))throw new Error(y(7));if(void 0===e.type)throw new Error(y(8));if(c)throw new Error(y(9));try{c=!0,n=o(n,e)}finally{c=!1}for(var t=s=a,i=0;i<t.length;i++){(0,t[i])()}return e}return h({type:w.INIT}),(r={dispatch:h,subscribe:u,getState:l,replaceReducer:function(e){if("function"!=typeof e)throw new Error(y(10));o=e,h({type:w.REPLACE})}})[b]=function(){var e,t=u;return(e={subscribe:function(e){if("object"!=typeof e||null===e)throw new Error(y(11));function i(){e.next&&e.next(l())}return i(),{unsubscribe:t(i)}}})[b]=function(){return this},e},r}var C=S;function E(e){for(var t=Object.keys(e),i={},r=0;r<t.length;r++){var o=t[r];0,"function"==typeof e[o]&&(i[o]=e[o])}var n,s=Object.keys(i);try{!function(e){Object.keys(e).forEach((function(t){var i=e[t];if(void 0===i(void 0,{type:w.INIT}))throw new Error(y(12));if(void 0===i(void 0,{type:w.PROBE_UNKNOWN_ACTION()}))throw new Error(y(13))}))}(i)}catch(Pa){n=Pa}return function(e,t){if(void 0===e&&(e={}),n)throw n;for(var r=!1,o={},a=0;a<s.length;a++){var c=s[a],d=i[c],l=e[c],u=d(l,t);if(void 0===u){t&&t.type;throw new Error(y(14))}o[c]=u,r=r||u!==l}return(r=r||s.length!==Object.keys(e).length)?o:e}}function I(e,t){return function(){return t(e.apply(this,arguments))}}function M(e,t){if("function"==typeof e)return I(e,t);if("object"!=typeof e||null===e)throw new Error(y(16));var i={};for(var r in e){var o=e[r];"function"==typeof o&&(i[r]=I(o,t))}return i}function x(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce((function(e,t){return function(){return e(t.apply(void 0,arguments))}}))}function P(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return function(e){return function(){var i=e.apply(void 0,arguments),r=function(){throw new Error(y(15))},o={getState:i.getState,dispatch:function(){return r.apply(void 0,arguments)}},n=t.map((function(e){return e(o)}));return r=x.apply(void 0,n)(i.dispatch),f(f({},i),{},{dispatch:r})}}}var T=function(e){return"@@redux-saga/"+e},R=T("CANCEL_PROMISE"),A=T("CHANNEL_END"),O=T("IO"),L=T("MATCH"),j=T("MULTICAST"),V=T("SAGA_ACTION"),D=T("SELF_CANCELLATION"),W=T("TASK"),N=T("TASK_CANCEL"),$=T("TERMINATE"),U=T("LOCATION"),z=i(8168),B=i(8587),H=function(e){return null==e},F=function(e){return null!=e},q=function(e){return"function"==typeof e},J=function(e){return"string"==typeof e},K=Array.isArray,G=function(e){return e&&q(e.then)},Z=function(e){return e&&q(e.next)&&q(e.throw)},X=function e(t){return t&&(J(t)||ee(t)||q(t)||K(t)&&t.every(e))},Q=function(e){return e&&q(e.take)&&q(e.close)},Y=function(e){return q(e)&&e.hasOwnProperty("toString")},ee=function(e){return Boolean(e)&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype},te=function(e){return Q(e)&&e[j]};var ie=function(e){return function(){return e}},re=ie(!0),oe=function(){};var ne=function(e){return e};"function"==typeof Symbol&&Symbol.asyncIterator&&Symbol.asyncIterator;var se=function(e,t){(0,z.A)(e,t),Object.getOwnPropertySymbols&&Object.getOwnPropertySymbols(t).forEach((function(i){e[i]=t[i]}))};function ae(e,t){var i=e.indexOf(t);i>=0&&e.splice(i,1)}function ce(e){var t=!1;return function(){t||(t=!0,e())}}var de=function(e){throw e},le=function(e){return{value:e,done:!0}};function ue(e,t,i){void 0===t&&(t=de),void 0===i&&(i="iterator");var r={meta:{name:i},next:e,throw:t,return:le,isSagaIterator:!0};return"undefined"!=typeof Symbol&&(r[Symbol.iterator]=function(){return r}),r}function he(e,t){var i=t.sagaStack;console.error(e),console.error(i)}var me=function(e){return Array.apply(null,new Array(e))},pe=function(e){return function(t){return e(Object.defineProperty(t,V,{value:!0}))}},ge=function(e){return e===$},ve=function(e){return e===N},fe=function(e){return ge(e)||ve(e)};function ye(e,t){var i=Object.keys(e),r=i.length;var o,n=0,s=K(e)?me(r):{},a={};return i.forEach((function(e){var i=function(i,a){o||(a||fe(i)?(t.cancel(),t(i,a)):(s[e]=i,++n===r&&(o=!0,t(s))))};i.cancel=oe,a[e]=i})),t.cancel=function(){o||(o=!0,i.forEach((function(e){return a[e].cancel()})))},a}function be(e){return{name:e.name||"anonymous",location:_e(e)}}function _e(e){return e[U]}function we(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce((function(e,t){return function(){return e(t.apply(void 0,arguments))}}))}var ke={isEmpty:re,put:oe,take:oe};function Se(e,t){void 0===e&&(e=10);var i=new Array(e),r=0,o=0,n=0,s=function(t){i[o]=t,o=(o+1)%e,r++},a=function(){if(0!=r){var t=i[n];return i[n]=null,r--,n=(n+1)%e,t}},c=function(){for(var e=[];r;)e.push(a());return e};return{isEmpty:function(){return 0==r},put:function(a){var d;if(r<e)s(a);else switch(t){case 1:throw new Error("Channel's Buffer overflow!");case 3:i[o]=a,n=o=(o+1)%e;break;case 4:d=2*e,i=c(),r=i.length,o=i.length,n=0,i.length=d,e=d,s(a)}},take:a,flush:c}}var Ce=function(){return ke},Ee=function(e){return Se(e,4)},Ie="TAKE",Me="PUT",xe="ALL",Pe="RACE",Te="CALL",Re="CPS",Ae="FORK",Oe="JOIN",Le="CANCEL",je="SELECT",Ve="ACTION_CHANNEL",De="CANCELLED",We="FLUSH",Ne="GET_CONTEXT",$e="SET_CONTEXT",Ue=function(e,t){var i;return(i={})[O]=!0,i.combinator=!1,i.type=e,i.payload=t,i};function ze(e,t){return void 0===e&&(e="*"),X(e)?(F(t)&&console.warn("take(pattern) takes one argument but two were provided. Consider passing an array for listening to several action types"),Ue(Ie,{pattern:e})):te(e)&&F(t)&&X(t)?Ue(Ie,{channel:e,pattern:t}):Q(e)?(F(t)&&console.warn("take(channel) takes one argument but two were provided. Second argument is ignored."),Ue(Ie,{channel:e})):void 0}function Be(e,t){return H(t)&&(t=e,e=void 0),Ue(Me,{channel:e,action:t})}function He(e,t){var i,r=null;return q(e)?i=e:(K(e)?(r=e[0],i=e[1]):(r=e.context,i=e.fn),r&&J(i)&&q(r[i])&&(i=r[i])),{context:r,fn:i,args:t}}function Fe(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return Ue(Te,He(e,i))}function qe(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return Ue(Ae,He(e,i))}function Je(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return o=qe.apply(void 0,[e].concat(i)),Ue(Ae,(0,z.A)({},o.payload,{detached:!0}));var o}function Ke(e){void 0===e&&(e=ne);for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return Ue(je,{selector:e,args:i})}function Ge(){return Ue(De,{})}function Ze(){var e={};return e.promise=new Promise((function(t,i){e.resolve=t,e.reject=i})),e}const Xe=Ze;var Qe=[],Ye=0;function et(e){try{rt(),e()}finally{ot()}}function tt(e){Qe.push(e),Ye||(rt(),nt())}function it(e){try{return rt(),e()}finally{nt()}}function rt(){Ye++}function ot(){Ye--}function nt(){var e;for(ot();!Ye&&void 0!==(e=Qe.shift());)et(e)}var st=function(e){return function(t){return e.some((function(e){return ut(e)(t)}))}},at=function(e){return function(t){return e(t)}},ct=function(e){return function(t){return t.type===String(e)}},dt=function(e){return function(t){return t.type===e}},lt=function(){return re};function ut(e){var t="*"===e?lt:J(e)?ct:K(e)?st:Y(e)?ct:q(e)?at:ee(e)?dt:null;if(null===t)throw new Error("invalid pattern: "+e);return t(e)}var ht={type:A},mt=function(e){return e&&e.type===A};function pt(e){void 0===e&&(e=Ee());var t=!1,i=[];return{take:function(r){t&&e.isEmpty()?r(ht):e.isEmpty()?(i.push(r),r.cancel=function(){ae(i,r)}):r(e.take())},put:function(r){if(!t){if(0===i.length)return e.put(r);i.shift()(r)}},flush:function(i){t&&e.isEmpty()?i(ht):i(e.flush())},close:function(){if(!t){t=!0;var e=i;i=[];for(var r=0,o=e.length;r<o;r++){(0,e[r])(ht)}}}}}function gt(e,t){void 0===t&&(t=Ce());var i,r=!1,o=pt(t),n=function(){r||(r=!0,q(i)&&i(),o.close())};return i=ce(i=e((function(e){mt(e)?n():o.put(e)}))),r&&i(),{take:o.take,flush:o.flush,close:n}}function vt(){var e,t=!1,i=[],r=i;var o=function(){r===i&&(r=i.slice())},n=function(){t=!0;var e=i=r;r=[],e.forEach((function(e){e(ht)}))};return(e={})[j]=!0,e.put=function(e){if(!t)if(mt(e))n();else for(var o=i=r,s=0,a=o.length;s<a;s++){var c=o[s];c[L](e)&&(c.cancel(),c(e))}},e.take=function(e,i){void 0===i&&(i=lt),t?e(ht):(e[L]=i,o(),r.push(e),e.cancel=ce((function(){o(),ae(r,e)})))},e.close=n,e}function ft(){var e=vt(),t=e.put;return e.put=function(e){e[V]?t(e):tt((function(){t(e)}))},e}var yt=0,bt=1,_t=2,wt=3;function kt(e,t){var i=e[R];q(i)&&(t.cancel=i),e.then(t,(function(e){t(e,!0)}))}var St,Ct=0,Et=function(){return++Ct};function It(e){e.isRunning()&&e.cancel()}var Mt=((St={})[Ie]=function(e,t,i){var r=t.channel,o=void 0===r?e.channel:r,n=t.pattern,s=t.maybe,a=function(e){e instanceof Error?i(e,!0):!mt(e)||s?i(e):i($)};try{o.take(a,F(n)?ut(n):null)}catch(c){return void i(c,!0)}i.cancel=a.cancel},St[Me]=function(e,t,i){var r=t.channel,o=t.action,n=t.resolve;tt((function(){var t;try{t=(r?r.put:e.dispatch)(o)}catch(s){return void i(s,!0)}n&&G(t)?kt(t,i):i(t)}))},St[xe]=function(e,t,i,r){var o=r.digestEffect,n=Ct,s=Object.keys(t);if(0!==s.length){var a=ye(t,i);s.forEach((function(e){o(t[e],n,a[e],e)}))}else i(K(t)?[]:{})},St[Pe]=function(e,t,i,r){var o=r.digestEffect,n=Ct,s=Object.keys(t),a=K(t)?me(s.length):{},c={},d=!1;s.forEach((function(e){var t=function(t,r){d||(r||fe(t)?(i.cancel(),i(t,r)):(i.cancel(),d=!0,a[e]=t,i(a)))};t.cancel=oe,c[e]=t})),i.cancel=function(){d||(d=!0,s.forEach((function(e){return c[e].cancel()})))},s.forEach((function(e){d||o(t[e],n,c[e],e)}))},St[Te]=function(e,t,i,r){var o=t.context,n=t.fn,s=t.args,a=r.task;try{var c=n.apply(o,s);if(G(c))return void kt(c,i);if(Z(c))return void Wt(e,c,a.context,Ct,be(n),!1,i);i(c)}catch(d){i(d,!0)}},St[Re]=function(e,t,i){var r=t.context,o=t.fn,n=t.args;try{var s=function(e,t){H(e)?i(t):i(e,!0)};o.apply(r,n.concat(s)),s.cancel&&(i.cancel=s.cancel)}catch(a){i(a,!0)}},St[Ae]=function(e,t,i,r){var o=t.context,n=t.fn,s=t.args,a=t.detached,c=r.task,d=function(e){var t=e.context,i=e.fn,r=e.args;try{var o=i.apply(t,r);if(Z(o))return o;var n=!1;return ue((function(e){return n?{value:e,done:!0}:(n=!0,{value:o,done:!G(o)})}))}catch(s){return ue((function(){throw s}))}}({context:o,fn:n,args:s}),l=function(e,t){return e.isSagaIterator?{name:e.meta.name}:be(t)}(d,n);it((function(){var t=Wt(e,d,c.context,Ct,l,a,void 0);a?i(t):t.isRunning()?(c.queue.addTask(t),i(t)):t.isAborted()?c.queue.abort(t.error()):i(t)}))},St[Oe]=function(e,t,i,r){var o=r.task,n=function(e,t){if(e.isRunning()){var i={task:o,cb:t};t.cancel=function(){e.isRunning()&&ae(e.joiners,i)},e.joiners.push(i)}else e.isAborted()?t(e.error(),!0):t(e.result())};if(K(t)){if(0===t.length)return void i([]);var s=ye(t,i);t.forEach((function(e,t){n(e,s[t])}))}else n(t,i)},St[Le]=function(e,t,i,r){var o=r.task;t===D?It(o):K(t)?t.forEach(It):It(t),i()},St[je]=function(e,t,i){var r=t.selector,o=t.args;try{i(r.apply(void 0,[e.getState()].concat(o)))}catch(n){i(n,!0)}},St[Ve]=function(e,t,i){var r=t.pattern,o=pt(t.buffer),n=ut(r),s=function t(i){mt(i)||e.channel.take(t,n),o.put(i)},a=o.close;o.close=function(){s.cancel(),a()},e.channel.take(s,n),i(o)},St[De]=function(e,t,i,r){i(r.task.isCancelled())},St[We]=function(e,t,i){t.flush(i)},St[Ne]=function(e,t,i,r){i(r.task.context[t])},St[$e]=function(e,t,i,r){var o=r.task;se(o.context,t),i()},St);function xt(e,t){return e+"?"+t}function Pt(e){var t=e.name,i=e.location;return i?t+"  "+xt(i.fileName,i.lineNumber):t}function Tt(e){var t,i,r,o=(t=function(e){return e.cancelledTasks},i=e,(r=[]).concat.apply(r,i.map(t)));return o.length?["Tasks cancelled due to error:"].concat(o).join("\n"):""}var Rt=null,At=[],Ot=function(e){e.crashedEffect=Rt,At.push(e)},Lt=function(){Rt=null,At.length=0},jt=function(e){Rt=e},Vt=function(){var e=At[0],t=At.slice(1),i=e.crashedEffect?function(e){var t=_e(e);return t?t.code+"  "+xt(t.fileName,t.lineNumber):""}(e.crashedEffect):null;return["The above error occurred in task "+Pt(e.meta)+(i?" \n when executing effect "+i:"")].concat(t.map((function(e){return"    created by "+Pt(e.meta)})),[Tt(At)]).join("\n")};function Dt(e,t,i,r,o,n,s){var a;void 0===s&&(s=oe);var c,d,l=yt,u=null,h=[],m=Object.create(i),p=function(e,t,i){var r,o=[],n=!1;function s(e){t(),c(),i(e,!0)}function a(t){o.push(t),t.cont=function(a,c){n||(ae(o,t),t.cont=oe,c?s(a):(t===e&&(r=a),o.length||(n=!0,i(r))))}}function c(){n||(n=!0,o.forEach((function(e){e.cont=oe,e.cancel()})),o=[])}return a(e),{addTask:a,cancelAll:c,abort:s,getTasks:function(){return o}}}(t,(function(){h.push.apply(h,p.getTasks().map((function(e){return e.meta.name})))}),g);function g(t,i){if(i){if(l=_t,Ot({meta:o,cancelledTasks:h}),v.isRoot){var r=Vt();Lt(),e.onError(t,{sagaStack:r})}d=t,u&&u.reject(t)}else t===N?l=bt:l!==bt&&(l=wt),c=t,u&&u.resolve(t);v.cont(t,i),v.joiners.forEach((function(e){e.cb(t,i)})),v.joiners=null}var v=((a={})[W]=!0,a.id=r,a.meta=o,a.isRoot=n,a.context=m,a.joiners=[],a.queue=p,a.cancel=function(){l===yt&&(l=bt,p.cancelAll(),g(N,!1))},a.cont=s,a.end=g,a.setContext=function(e){se(m,e)},a.toPromise=function(){return u||(u=Xe(),l===_t?u.reject(d):l!==yt&&u.resolve(c)),u.promise},a.isRunning=function(){return l===yt},a.isCancelled=function(){return l===bt||l===yt&&t.status===bt},a.isAborted=function(){return l===_t},a.result=function(){return c},a.error=function(){return d},a);return v}function Wt(e,t,i,r,o,n,s){var a=e.finalizeRunEffect((function(t,i,r){if(G(t))kt(t,r);else if(Z(t))Wt(e,t,d.context,i,o,!1,r);else if(t&&t[O]){(0,Mt[t.type])(e,t.payload,r,l)}else r(t)}));u.cancel=oe;var c={meta:o,cancel:function(){c.status===yt&&(c.status=bt,u(N))},status:yt},d=Dt(e,c,i,r,o,n,s),l={task:d,digestEffect:h};return s&&(s.cancel=d.cancel),u(),d;function u(e,i){try{var o;i?(o=t.throw(e),Lt()):ve(e)?(c.status=bt,u.cancel(),o=q(t.return)?t.return(N):{done:!0,value:N}):o=ge(e)?q(t.return)?t.return():{done:!0}:t.next(e),o.done?(c.status!==bt&&(c.status=wt),c.cont(o.value)):h(o.value,r,u)}catch(n){if(c.status===bt)throw n;c.status=_t,c.cont(n,!0)}}function h(t,i,r,o){void 0===o&&(o="");var n,s=Et();function c(i,o){n||(n=!0,r.cancel=oe,e.sagaMonitor&&(o?e.sagaMonitor.effectRejected(s,i):e.sagaMonitor.effectResolved(s,i)),o&&jt(t),r(i,o))}e.sagaMonitor&&e.sagaMonitor.effectTriggered({effectId:s,parentEffectId:i,label:o,effect:t}),c.cancel=oe,r.cancel=function(){n||(n=!0,c.cancel(),c.cancel=oe,e.sagaMonitor&&e.sagaMonitor.effectCancelled(s))},a(t,s,c)}}function Nt(e,t){var i=e.channel,r=void 0===i?ft():i,o=e.dispatch,n=e.getState,s=e.context,a=void 0===s?{}:s,c=e.sagaMonitor,d=e.effectMiddlewares,l=e.onError,u=void 0===l?he:l;for(var h=arguments.length,m=new Array(h>2?h-2:0),p=2;p<h;p++)m[p-2]=arguments[p];var g=t.apply(void 0,m);var v,f=Et();if(c&&(c.rootSagaStarted=c.rootSagaStarted||oe,c.effectTriggered=c.effectTriggered||oe,c.effectResolved=c.effectResolved||oe,c.effectRejected=c.effectRejected||oe,c.effectCancelled=c.effectCancelled||oe,c.actionDispatched=c.actionDispatched||oe,c.rootSagaStarted({effectId:f,saga:t,args:m})),d){var y=we.apply(void 0,d);v=function(e){return function(t,i,r){return y((function(t){return e(t,i,r)}))(t)}}}else v=ne;var b={channel:r,dispatch:pe(o),getState:n,sagaMonitor:c,onError:u,finalizeRunEffect:v};return it((function(){var e=Wt(b,g,a,f,be(t),!0,void 0);return c&&c.effectResolved(f,e),e}))}const $t=function(e){var t,i=void 0===e?{}:e,r=i.context,o=void 0===r?{}:r,n=i.channel,s=void 0===n?ft():n,a=i.sagaMonitor,c=(0,B.A)(i,["context","channel","sagaMonitor"]);function d(e){var i=e.getState,r=e.dispatch;return t=Nt.bind(null,(0,z.A)({},c,{context:o,channel:s,dispatch:r,getState:i,sagaMonitor:a})),function(e){return function(t){a&&a.actionDispatched&&a.actionDispatched(t);var i=e(t);return s.put(t),i}}}return d.run=function(){return t.apply(void 0,arguments)},d.setContext=function(e){se(o,e)},d};const Ut=i(9443);var zt=Object.defineProperty,Bt=Object.defineProperties,Ht=Object.getOwnPropertyDescriptor,Ft=Object.getOwnPropertyDescriptors,qt=Object.getOwnPropertyNames,Jt=Object.getOwnPropertySymbols,Kt=Object.prototype.hasOwnProperty,Gt=Object.prototype.propertyIsEnumerable,Zt=(e,t,i)=>t in e?zt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Xt=(e,t)=>{for(var i in t||(t={}))Kt.call(t,i)&&Zt(e,i,t[i]);if(Jt)for(var i of Jt(t))Gt.call(t,i)&&Zt(e,i,t[i]);return e},Qt=(e,t)=>Bt(e,Ft(t)),Yt=(e,t)=>{var i={};for(var r in e)Kt.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&Jt)for(var r of Jt(e))t.indexOf(r)<0&&Gt.call(e,r)&&(i[r]=e[r]);return i},ei=(e,t)=>{for(var i in t)zt(e,i,{get:t[i],enumerable:!0})},ti=(e,t,i,r)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let o of qt(t))Kt.call(e,o)||o===i||zt(e,o,{get:()=>t[o],enumerable:!(r=Ht(t,o))||r.enumerable});return e},ii=(e,t,i)=>(ti(e,t,"default"),i&&ti(i,t,"default")),ri=(e,t,i)=>Zt(e,"symbol"!=typeof t?t+"":t,i),oi="__local__",ni="__synthetic__",si="video",ai="chat",ci=["room.started","room.ended"],di=(ci.map((e=>`${si}.${e}`)),n().getLogger("signalwire")),li=di.methodFactory;di.methodFactory=(e,t,i)=>{const r=li(e,t,i);return function(...e){e.unshift((new Date).toISOString(),"-"),r.apply(void 0,e)}};var ui,hi=di.getLevel();di.setLevel(hi);var mi={},pi=()=>null!=ui?ui:di,gi=({type:e,payload:t})=>{const i=pi(),{logWsTraffic:r}=mi||{};if(!r)return;const o=(e=>!("method"in e)||"signalwire.ping"!==e.method)(t)?JSON.stringify(t,null,2):t;return i.info(`${e.toUpperCase()}: \n`,o,"\n")},vi=()=>{const e=pi();return new Proxy(e,{get:(e,t,i)=>"wsTraffic"===t?gi:Reflect.get(e,t,i)})},fi=/[A-Z]/g,yi=e=>e.replace(fi,(e=>`_${e.toLowerCase()}`)),bi=["webrtc.message"],_i=e=>bi.includes(e),wi=/^2[0-9][0-9]$/,ki=(e,t)=>{const{result:i={},error:r}=e;if(r)return{error:r};const{code:o,node_id:n,result:s=null}=i;return o&&!wi.test(o)?{error:i}:null===s?(t&&(i.node_id=t),{result:i}):s?s.jsonrpc?ki(s,n):{result:s}:{result:i}},Si={propsToUpdateValue:["updated","layers","members","recordings","playbacks"]},Ci=(e,t=Si)=>(null==e?void 0:e.__sw_symbol)||(null==e?void 0:e.__sw_proxy)?e:Object.entries(e).reduce(((e,[i,r])=>{const o=Ei(i);return"object"===typeof r&&r?Array.isArray(r)?t.propsToUpdateValue.includes(i)?e[o]=r.map((e=>"string"==typeof e?Ei(e):Ci(e))):e[o]=r:e[o]=Ci(r):(e=>e.endsWith("At"))(o)?e[o]=(e=>{if(void 0===e)return e;const t=new Date(1e3*e);return isNaN(t.getTime())?e:t})(r):e[o]=r,e}),{}),Ei=e=>e.includes("_")?e.split("_").reduce(((e,t,i)=>{const r=t.trim().charAt(0),o=t.substr(1).toLowerCase();return`${e}${0===i?r.toLowerCase():r.toUpperCase()}${o}`}),""):e,Ii=({namespace:e,event:t})=>!e||t.startsWith(e)?t:`${e}:${t}`,Mi=e=>{const{event_type:t,params:i,node_id:r}=e;if("queuing.relay.tasks"===t)return{type:t,payload:e};if(_i(t)&&(null==i?void 0:i.jsonrpc)){const e=i;return e.params&&(e.params.nodeId=r),{type:t,payload:e}}return{type:t,payload:i}},xi=(e,t)=>(Object.keys(t).forEach((t=>{if(e.prototype.hasOwnProperty(t))throw new Error(`[extendComponent] Duplicated method name: ${t}`)})),Object.defineProperties(e.prototype,t),e);var Pi=(e,t)=>{if(t&&"string"==typeof t){const i=new RegExp(`^${t}.`);return e.replace(i,"")}const i=e.split(".");return i.length>1?(i.shift(),i.join(".")):e},Ti=({delayLimit:e=Number.MAX_SAFE_INTEGER,initialDelay:t=100,variation:i=1})=>{if(t<0||e<0||i<0)throw new Error("No Negative Numbers");if(t>e)throw new Error("initialDelay must be lte delayLimit");let r=Math.min(t,e);return()=>{if(r===e)return e;const t=r;return r=Math.min(r+i,e),t}},Ri=async({asyncCallable:e,maxRetries:t=10,delayFn:i,validator:r,expectedErrorHandler:o})=>{let n=t-1,s=0;const a=async()=>{var c;try{let t;return t=s<=0?await e():await new Promise(((t,i)=>setTimeout((()=>{e().then(t).catch(i)}),s))),n&&(null==r||r(t)),t}catch(d){if(n-- >0&&!(null==o?void 0:o(d)))return s=null!=(c=null==i?void 0:i())?c:0,vi().debug(`Retrying request: ${t-n} of ${t}`),a();throw d}};return a()},Ai=/^(ws|wss):\/\//,Oi=(e,t,i)=>{let r=null;return Promise.race([e,new Promise(((e,o)=>r=setTimeout(o,t,i)))]).finally((()=>clearTimeout(r)))},Li=["video.member.updated","video.member.talking"],ji=["video.room.joined","video.track","video.active","video.answering","video.destroy","video.early","video.hangup","video.held","video.new","video.purge","video.recovering","video.requesting","video.ringing","video.trying","video.media.connected","video.media.reconnecting","video.media.disconnected","video.microphone.updated","video.camera.updated","video.speaker.updated","video.microphone.disconnected","video.camera.disconnected","video.speaker.disconnected"],Vi=e=>{const t=e.map((e=>{if("string"==typeof e){const t=(e=>{const t=e.split(":");return t[t.length-1]})(e);if(ji.includes(t)||(e=>e.includes(ni))(t)||Di(t)||(e=>e.includes("session."))(t))return null;return Li.find((e=>t.startsWith(e)))||t}return e}));return Array.from(new Set(t)).filter(Boolean)},Di=e=>e.includes(oi),Wi=e=>!(e=>Boolean(e.method))(e),Ni=e=>void 0!==e&&"jti"in e,$i=e=>{var t;return Xt({jsonrpc:"2.0",id:null!=(t=e.id)?t:h()},e)},Ui=e=>Xt({jsonrpc:"2.0"},e),zi={major:3,minor:0,revision:0},Bi={major:4,minor:0,revision:0},Hi=e=>$i({method:"signalwire.connect",params:Xt({version:zi,event_acks:!0},e)}),Fi=e=>$i({method:"signalwire.reauthenticate",params:{authentication:e}}),qi={id:"callID",destinationNumber:"destination_number",remoteCallerName:"remote_caller_id_name",remoteCallerNumber:"remote_caller_id_number",callerName:"caller_id_name",callerNumber:"caller_id_number"},Ji=e=>{if(e.hasOwnProperty("dialogParams")){const t=e.dialogParams,{remoteSdp:i,localStream:r,remoteStream:o}=t,n=Yt(t,["remoteSdp","localStream","remoteStream"]);for(const e in qi)e&&n.hasOwnProperty(e)&&(n[qi[e]]=n[e],delete n[e]);e.dialogParams=n}return e},Ki=e=>(t={})=>$i({method:e,params:Ji(t)}),Gi=Ki("verto.invite"),Zi=Ki("verto.bye"),Xi=(Ki("verto.attach"),Ki("verto.modify")),Qi=Ki("verto.info"),Yi=Ki("verto.answer"),er=Ki("verto.subscribe"),tr=Ki("verto.pong"),ir=(e,t)=>Ui({id:e,result:{method:t}}),rr={};ei(rr,{authErrorAction:()=>hr,authExpiringAction:()=>pr,authSuccessAction:()=>mr,createAction:()=>nr,destroyAction:()=>lr,getCustomSagaActionType:()=>wr,initAction:()=>dr,makeCustomSagaAction:()=>_r,reauthAction:()=>ur,sessionDisconnectedAction:()=>vr,sessionForceCloseAction:()=>yr,sessionReconnectingAction:()=>fr,socketMessageAction:()=>gr});var or={};function nr(e,t){function i(...i){if(t){let r=t(...i);if(!r)throw new Error("prepareAction did not return an object");return Xt(Xt({type:e,payload:r.payload},"meta"in r&&{meta:r.meta}),"error"in r&&{error:r.error})}return{type:e,payload:i[0]}}return i.toString=()=>`${e}`,i.type=e,i.match=t=>t.type===e,i}ei(or,{configureStore:()=>cr,createAction:()=>nr}),ii(or,r);var sr="undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__?window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__:function(){if(0!==arguments.length)return"object"==typeof arguments[0]?x:x.apply(null,arguments)};"undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__&&window.__REDUX_DEVTOOLS_EXTENSION__;var ar=!0;function cr(e){const t=function(){return[]},{reducer:i,middleware:r=t(),devTools:o=!0,preloadedState:n,enhancers:s}=e||{};let a;if("function"==typeof i)a=i;else{if(!function(e){if("object"!=typeof e||null===e)return!1;let t=Object.getPrototypeOf(e);if(null===t)return!0;let i=t;for(;null!==Object.getPrototypeOf(i);)i=Object.getPrototypeOf(i);return t===i}(i))throw new Error('"reducer" is a required argument, and must be a function or an object of functions that can be passed to combineReducers');a=E(i)}let c=r;if("function"==typeof c&&(c=c(t),!ar&&!Array.isArray(c)))throw new Error("when using a middleware builder function, an array of middleware must be returned");if(!ar&&c.some((e=>"function"!=typeof e)))throw new Error("each middleware provided to configureStore must be a function");const d=P(...c);let l=x;o&&(l=sr(Xt({trace:!ar},"object"==typeof o&&o)));let u=[d];Array.isArray(s)?u=[d,...s]:"function"==typeof s&&(u=s(u));return S(a,n,l(...u))}var dr=nr("swSdk/init"),lr=nr("swSdk/destroy"),ur=nr("swSdk/reauth"),hr=nr("auth/error"),mr=nr("auth/success"),pr=nr("auth/expiring"),gr=nr("socket/message"),vr=nr("session.disconnected"),fr=nr("session.reconnecting"),yr=nr("session.forceClose"),br=(e,t)=>`${t.type}/${e}`,_r=(e,t)=>Qt(Xt({},t),{type:br(e,t)}),wr=(e,t)=>br(e,t);function kr(e){const t={},i=[];let r;const o={addCase(e,i){const r="string"==typeof e?e:e.type;if(r in t)throw new Error("addCase cannot be called with two reducers for the same action type");return t[r]=i,o},addMatcher:(e,t)=>(i.push({matcher:e,reducer:t}),o),addDefaultCase:e=>(r=e,o)};return e(o),[t,i,r]}function Sr(e){const{name:t}=e;if(!t)throw new Error("`name` is a required option for createSlice");const i=e.initialState,r=e.reducers||{},o=Object.keys(r),n={},s={},a={};function c(){const[t={},r=[],o]="function"==typeof e.extraReducers?kr(e.extraReducers):[e.extraReducers],n=Xt(Xt({},t),s);return function(e,t,i=[],r){let o,[n,s,a]="function"==typeof t?kr(t):[t,i,r];function c(e=o(),t){let i=[n[t.type],...s.filter((({matcher:e})=>e(t))).map((({reducer:e})=>e))];return 0===i.filter((e=>!!e)).length&&(i=[a]),i.reduce(((e,i)=>i?i(e,t):e),e)}return o="function"==typeof e?()=>e():()=>e,c.getInitialState=o,c}(i,n,r,o)}let d;return o.forEach((e=>{const i=r[e],o=`${t}/${e}`;let c,d;"reducer"in i?(c=i.reducer,d=i.prepare):c=i,n[e]=c,s[o]=c,a[e]=d?nr(o,d):nr(o)})),{name:t,reducer:(e,t)=>(d||(d=c()),d(e,t)),actions:a,caseReducers:n,getInitialState:()=>(d||(d=c()),d.getInitialState())}}var Cr=({name:e="",initialState:t,reducers:i,extraReducers:r})=>Sr({name:e,initialState:t,reducers:i,extraReducers:e=>{e.addCase(lr.type,(()=>t)),"function"==typeof r&&r(e)}});function Er(e){return[dr.type,ur.type].includes(e.type)}var Ir=Cr({name:"session",initialState:{protocol:"",iceServers:[],authStatus:"unknown",authorization:void 0,authorizationState:void 0,authError:void 0,authCount:0},reducers:{connected:(e,{payload:t})=>{var i,r;return Qt(Xt({},e),{authStatus:"authorized",authorization:null==t?void 0:t.authorization,authCount:e.authCount+1,protocol:null!=(i=null==t?void 0:t.protocol)?i:"",iceServers:null!=(r=null==t?void 0:t.ice_servers)?r:[]})},authStatus:(e,{payload:t})=>Qt(Xt({},e),{authStatus:t}),updateAuthorization:(e,{payload:t})=>Qt(Xt({},e),{authorization:t}),updateAuthorizationState:(e,{payload:t})=>Qt(Xt({},e),{authorizationState:t})},extraReducers:e=>{e.addCase(hr.type,((e,{payload:t})=>Qt(Xt({},e),{authStatus:"unauthorized",authError:t.error}))),e.addMatcher(Er,(e=>Qt(Xt({},e),{authStatus:"authorizing"})))}}),{actions:Mr,reducer:xr}=Ir,Pr=Symbol("BaseSession"),Tr=()=>{return 1e3*(e=1,t=4,Math.floor(Math.random()*(t-e+1)+e));var e,t},Rr=class{constructor(e){var t,i;this.options=e,ri(this,"__sw_symbol",Pr),ri(this,"uuid",h()),ri(this,"WebSocketConstructor"),ri(this,"CloseEventConstructor"),ri(this,"agent"),ri(this,"connectVersion",zi),ri(this,"_rpcConnectResult"),ri(this,"_requests",new Map),ri(this,"_socket",null),ri(this,"_host","wss://relay.signalwire.com"),ri(this,"_executeTimeoutMs",1e4),ri(this,"_executeTimeoutError",Symbol.for("sw-execute-timeout")),ri(this,"_executeQueue",new Set),ri(this,"_swConnectError",Symbol.for("sw-connect-error")),ri(this,"_executeConnectionClosed",Symbol.for("sw-execute-connection-closed")),ri(this,"_checkPingDelay",15e3),ri(this,"_checkPingTimer",null),ri(this,"_reconnectTimer"),ri(this,"_status","unknown"),ri(this,"_sessionChannel"),ri(this,"wsOpenHandler"),ri(this,"wsCloseHandler"),ri(this,"wsErrorHandler");const{host:r,logLevel:o="info",sessionChannel:n}=e;r&&(this._host=(e=>`${Ai.test(e)?"":"wss://"}${e}`)(r)),n&&(this._sessionChannel=n),o&&(null==(i=(t=this.logger).setLevel)||i.call(t,o)),this._onSocketOpen=this._onSocketOpen.bind(this),this._onSocketError=this._onSocketError.bind(this),this._onSocketClose=this._onSocketClose.bind(this),this._onSocketMessage=this._onSocketMessage.bind(this),this.execute=this.execute.bind(this),this.connect=this.connect.bind(this),this.wsOpenHandler=e=>{var t;null==(t=this._socket)||t.removeEventListener("open",this.wsOpenHandler),this._onSocketOpen(e)},this.wsCloseHandler=e=>{var t;null==(t=this._socket)||t.removeEventListener("close",this.wsCloseHandler),this._onSocketClose(e)},this.wsErrorHandler=e=>{var t;null==(t=this._socket)||t.removeEventListener("error",this.wsErrorHandler),this._onSocketError(e)}}get host(){return this._host}get rpcConnectResult(){return this._rpcConnectResult}get relayProtocol(){var e,t;return null!=(t=null==(e=this._rpcConnectResult)?void 0:e.protocol)?t:""}get signature(){if(this._rpcConnectResult){const{authorization:e}=this._rpcConnectResult;return e.signature}}get logger(){return vi()}get connecting(){var e;return 0===(null==(e=this._socket)?void 0:e.readyState)}get connected(){var e;return 1===(null==(e=this._socket)?void 0:e.readyState)}get closing(){var e;return 2===(null==(e=this._socket)?void 0:e.readyState)}get closed(){return!this._socket||3===this._socket.readyState}get status(){return this._status}get idle(){return"idle"===this._status}get ready(){return!Boolean(this.idle||!this.connected)}set token(e){this.options.token=e}connect(){if(!(null==this?void 0:this.WebSocketConstructor))throw new Error("Missing WebSocketConstructor");if(!(null==this?void 0:this.CloseEventConstructor))throw new Error("Missing CloseEventConstructor");this._clearTimers(),this.connecting||this.connected?this.logger.warn("Session already connected."):(this._removeSocketListeners(),this.destroySocket(),this._clearCheckPingTimer(),this._socket=this._createSocket(),this._addSocketListeners())}_createSocket(){return new this.WebSocketConstructor(this._host)}destroySocket(){this._socket&&(this._socket.close(),this.wsCloseHandler(new this.CloseEventConstructor("close",{reason:"Client-side closed"})),this._socket=null)}_addSocketListeners(){if(!this._socket)return this.logger.debug("Invalid socket instance to add listeners");this._removeSocketListeners(),this._socket.addEventListener("open",this.wsOpenHandler),this._socket.addEventListener("close",this.wsCloseHandler),this._socket.addEventListener("error",this.wsErrorHandler),this._socket.addEventListener("message",this._onSocketMessage)}_removeSocketListeners(){if(!this._socket)return this.logger.debug("Invalid socket instance to remove listeners");this._socket.removeEventListener("open",this.wsOpenHandler),this._socket.removeEventListener("close",this.wsCloseHandler),this._socket.removeEventListener("error",this.wsErrorHandler),this._socket.removeEventListener("message",this._onSocketMessage)}disconnect(){this._socket&&!this.closing?(this._status="disconnecting",this._checkCurrentStatus()):this.logger.debug("Session not connected or already in closing state.")}execute(e){if("disconnecting"===this._status)return this.logger.warn("Reject request because the session is disconnecting",e),Promise.reject({code:"400",message:"The SDK session is disconnecting"});if("disconnected"===this._status)return Promise.reject({code:"400",message:"The SDK is disconnected"});let t=Promise.resolve();return"params"in e&&(t=new Promise(((t,i)=>{this._requests.set(e.id,{rpcRequest:e,resolve:t,reject:i})}))),this.ready?(this._send(e),Oi(t,this._executeTimeoutMs,this._executeTimeoutError).catch((t=>{if(t===this._executeConnectionClosed)throw this._executeConnectionClosed;if(t!==this._executeTimeoutError)throw t;if("method"in e&&"signalwire.connect"===e.method)throw this._swConnectError;if(this._checkCurrentStatus(),this.logger.error("Request Timeout",e),"disconnected"===this.status)return this.logger.debug("Request failed because the session is disconnected",this.status,this._socket);this._closeConnection("reconnecting")}))):(this._addToExecuteQueue(e),this.connect(),t)}get _connectParams(){return{agent:this.agent,version:this.connectVersion,authentication:{project:this.options.project,token:this.options.token}}}async authenticate(){var e,t;const i=this._connectParams;this._relayProtocolIsValid()&&(i.protocol=this.relayProtocol),(null==(e=this.options.topics)?void 0:e.length)?i.contexts=this.options.topics:(null==(t=this.options.contexts)?void 0:t.length)&&(i.contexts=this.options.contexts),this._rpcConnectResult=await this.execute(Hi(i))}authError(e){this._removeSocketListeners(),this.dispatch(hr({error:e}))}forceClose(){return this._removeSocketListeners(),this._closeConnection("reconnecting")}async _onSocketOpen(e){this.logger.debug("_onSocketOpen",e.type);try{this._status="unknown",this._clearTimers(),await this.authenticate(),this._status="connected",this._flushExecuteQueue(),this.dispatch(mr())}catch(t){if(t===this._swConnectError||t===this._executeConnectionClosed)return void this.logger.debug("Invalid connect or connection closed. Waiting for retry.");this.logger.error("Auth Error",t),this.authError(t)}}_onSocketError(e){this.logger.debug("_onSocketError",e)}_onSocketClose(e){this.logger.debug("_onSocketClose",e.type,e.code,e.reason),"disconnected"!==this._status&&(this._status="reconnecting",this.dispatch(fr()),this._clearTimers(),this._clearPendingRequests(),this._reconnectTimer=setTimeout((()=>{this.connect()}),Tr())),this._socket=null}_clearTimers(){clearTimeout(this._reconnectTimer)}_clearPendingRequests(){this.logger.debug("_clearPendingRequests",this._requests.size),this._requests.forEach((({reject:e})=>{e(this._executeConnectionClosed)}))}_onSocketMessage(e){const t=this.decode(e.data);if(this.logger.wsTraffic({type:"recv",payload:t}),Wi(t)){const e=this._requests.get(t.id);if(e){const{rpcRequest:i,resolve:r,reject:o}=e;this._requests.delete(t.id);const{result:n,error:s}=(({response:e,request:t})=>{const{result:i={},error:r}=e;return r?{error:r}:"signalwire.connect"===t.method?{result:i}:ki(e)})({response:t,request:i});return this._checkCurrentStatus(),s?o(s):r(n)}return this.logger.warn("Unknown request for",t)}switch(t.method){case"signalwire.ping":return this._pingHandler(t);case"signalwire.disconnect":this.execute((i=t.id,Ui({id:i,result:{}}))).catch((e=>{this.logger.error("SwDisconnect Error",e)})).finally((()=>{this._status="idle"}));break;default:this._eventAcknowledgingHandler(t).catch((e=>this.logger.error("Event Acknowledging Error",e))),this.dispatch(gr(t))}var i}dispatch(e){if(!this._sessionChannel)throw new Error("Session channel does not exist");this._sessionChannel.put(e)}_relayProtocolIsValid(){var e;return this.signature&&(null==(e=null==this?void 0:this.relayProtocol)?void 0:e.split("_")[1])===this.signature}encode(e){return JSON.stringify(e)}decode(e){return(e=>{if("string"!=typeof e)return e;try{return JSON.parse(e)}catch(t){return e}})(e)}async onSwAuthorizationState(e){this.persistSwAuthorizationState(e)}async retrieveSwAuthorizationState(){return""}async persistSwAuthorizationState(e){}_send(e){this.logger.wsTraffic({type:"send",payload:e}),this._socket.send(this.encode(e))}_addToExecuteQueue(e){this.logger.warn("Request queued waiting for session to reconnect",e),this._executeQueue.add(e)}_flushExecuteQueue(){if(this._executeQueue.size){if(!this.ready)return this.logger.warn("Session not ready to flush the queue."),void this._closeConnection("reconnecting");this.logger.debug(`${this._executeQueue.size} messages to flush`),this._executeQueue.forEach((e=>{this._send(e),this._executeQueue.delete(e)})),this._executeQueue.clear()}}_clearCheckPingTimer(){clearTimeout(this._checkPingTimer)}async _pingHandler(e){var t,i,r;this._clearCheckPingTimer(),this._checkPingTimer=setTimeout((()=>{this.logger.debug("Timeout waiting for ping"),this._closeConnection("reconnecting")}),this._checkPingDelay),await this.execute((i=e.id,r=null==(t=null==e?void 0:e.params)?void 0:t.timestamp,Ui({id:i,result:{timestamp:r||Date.now()/1e3}})))}async _eventAcknowledgingHandler(e){const{method:t,id:i}=e;return"signalwire.event"===t?this.execute((e=>Ui({id:e,result:{}}))(i)):Promise.resolve()}_checkCurrentStatus(){switch(this._status){case"disconnecting":if(this._requests.size>0)return;this._requests.clear(),this._closeConnection("disconnected");break;case"disconnected":this.dispatch(vr());break;case"reconnecting":this.wsCloseHandler(new this.CloseEventConstructor("close",{reason:"Client-side closed"}))}}_closeConnection(e){this._clearCheckPingTimer(),this.logger.debug("Close Connection:",e),this._status=e,this.dispatch(Mr.authStatus("disconnected"===e?"unauthorized":"unknown")),this._removeSocketListeners(),this.destroySocket(),this._checkCurrentStatus()}},Ar=class extends Rr{constructor(e){super(e),this.options=e,ri(this,"_expiredDiffSeconds",0),ri(this,"_refreshTokenNotificationDiff",120),ri(this,"_checkTokenExpirationDelay",2e4),ri(this,"_checkTokenExpirationTimer",null),this._checkTokenExpiration=this._checkTokenExpiration.bind(this),this.reauthenticate=this.reauthenticate.bind(this)}get expiresAt(){var e;if(!(null==this?void 0:this._rpcConnectResult))return 0;const{authorization:t}=this._rpcConnectResult,i=null!=(e=Ni(t)?t.fabric_subscriber.expires_at:null==t?void 0:t.expires_at)?e:0;if("string"==typeof i){const e=Date.parse(i);if(!isNaN(e))return Math.floor(e/1e3)}return i}get expiresIn(){const e=Math.floor(Date.now()/1e3);return this.expiresAt-e}get expired(){return this.expiresAt>0&&this.expiresIn<=this._expiredDiffSeconds}async authenticate(){const e=Qt(Xt({},this._connectParams),{authentication:{jwt_token:this.options.token}});if(this._relayProtocolIsValid())e.protocol=this.relayProtocol;else{const t=await this.retrieveRelayProtocol();t&&(e.protocol=t)}if(e.protocol){const t=await this.retrieveSwAuthorizationState();t&&(e.authorization_state=t)}try{this._rpcConnectResult=await this.execute(Hi(e)),await this.persistRelayProtocol(),await this._checkTokenExpiration()}catch(t){throw this.logger.debug("BaseJWTSession authenticate error",t),t}}async retrieveRelayProtocol(){return""}async persistRelayProtocol(){}async reauthenticate(){if(this.logger.debug("Session Reauthenticate",{ready:this.ready,expired:this.expired}),!this.ready||this.expired)return this.connect();const e={project:this._rpcConnectResult.authorization.project_id,jwt_token:this.options.token};try{this._rpcConnectResult=await this.execute(Fi(e))}catch(t){throw clearTimeout(this._checkTokenExpirationTimer),t}}_onSocketClose(e){clearTimeout(this._checkTokenExpirationTimer),super._onSocketClose(e)}async _checkTokenExpiration(){if(!this.expiresAt)return;const e=this.options.onRefreshToken;if(this.expiresIn<=this._refreshTokenNotificationDiff)if(this.dispatch(pr()),"function"==typeof e)try{const t=await e();this.dispatch(ur({token:t}))}catch(t){this.logger.error(t)}else this.logger.warn("The token is going to expire!");clearTimeout(this._checkTokenExpirationTimer),this.expired||(this._checkTokenExpirationTimer=setTimeout(this._checkTokenExpiration,this._checkTokenExpirationDelay))}},Or={};ei(Or,{authErrorAction:()=>hr,authExpiringAction:()=>pr,authSuccessAction:()=>mr,configureStore:()=>uo,connect:()=>co,createAction:()=>nr,createCatchableSaga:()=>Ur,createRestartableSaga:()=>Nr,destroyAction:()=>lr,eventChannel:()=>gt,getCustomSagaActionType:()=>wr,initAction:()=>dr,makeCustomSagaAction:()=>_r,reauthAction:()=>ur,sessionDisconnectedAction:()=>vr,sessionForceCloseAction:()=>yr,sessionReconnectingAction:()=>fr,socketMessageAction:()=>gr});var Lr=Cr({name:"components",initialState:{byId:{}},reducers:{upsert:(e,{payload:t})=>t.id in e.byId?Qt(Xt({},e),{byId:Qt(Xt({},e.byId),{[t.id]:Xt(Xt({},e.byId[t.id]),t)})}):Qt(Xt({},e),{byId:Qt(Xt({},e.byId),{[t.id]:t})}),cleanup:(e,{payload:t})=>Qt(Xt({},e),{byId:Object.entries(e.byId).reduce(((e,[i,r])=>(t.ids.includes(i)||(e[i]=r),e)),{})})}}),{actions:jr,reducer:Vr}=Lr,Dr=(0,or.combineReducers)({components:Vr,session:xr}),Wr={};ei(Wr,{createCatchableSaga:()=>Ur,createRestartableSaga:()=>Nr,eventChannel:()=>gt});var Nr=e=>function*(){Je((function*(){for(;;)try{vi().debug("Run a restartable saga"),yield Fe(e),vi().debug("One of the restartable saga has ended. Restarting..")}catch(t){vi().error("Restartable Saga Error",t)}}))},$r=e=>vi().error("Catchable Saga Error",e),Ur=(e,t=$r)=>function*(...i){try{yield Fe(e,...i)}catch(r){t(r)}},zr=e=>_i(null==e?void 0:e.event_type),Br=e=>{var t;return!!(null==(t=null==e?void 0:e.event_type)?void 0:t.startsWith("video."))},Hr=e=>"signalwire.authorization.state"===(null==e?void 0:e.event_type);function*Fr({sessionChannel:e,swEventChannel:t,session:i}){function*r(e){if(yield Be(t,Mi(e)),!zr(e)&&!Br(e))return Hr(e)?(i.onSwAuthorizationState(e.params.authorization_state),void(yield Be(Mr.updateAuthorizationState(e.params.authorization_state)))):void(yield Be({type:e.event_type,payload:e}))}vi().debug("sessionChannelWatcher [started]");const o=Ur((function*(e){if(e.type!==gr.type)return void(yield Be(e));const{method:t,params:i}=e.payload;if("signalwire.event"!==t)return vi().debug(`Unknown message: ${t}`,e);yield qe(r,i)}),(e=>{vi().error("Channel Error",e)}));for(;;)try{for(;;){const t=yield ze(e);yield qe(o,t)}}catch(n){vi().error("sessionChannelWorker error:",n)}finally{vi().debug("sessionChannelWorker [finally]")}}var qr=class e extends Error{constructor(t,i){super(i),this.code=t,this.message=i,ri(this,"name","AuthError"),Object.setPrototypeOf(this,e.prototype)}},Jr=class e extends Error{constructor(t,i,r){super(i),this.code=t,this.message=i,this.response=r,ri(this,"name","HttpError"),Object.setPrototypeOf(this,e.prototype)}},Kr=class extends Error{constructor(e){super(e),this.name="CapabilityError"}};function*Gr({initSession:e,sessionEmitter:t,userOptions:i,channels:r}){var o;vi().debug("sessionSaga [started]");const n=e(),s=r.swEventChannel,a=r.sessionChannel;let c=[];if(null==(o=i.workers)?void 0:o.length)try{const e=i.workers.map((e=>Fe(Nr(e))));c=yield function(e){var t=Ue(xe,e);return t.combinator=!0,t}(e)}catch(u){vi().error("Error running custom workers",u)}const d=yield qe(Fr,{session:n,sessionChannel:a,swEventChannel:s}),l=yield qe(Xr,{session:n,sessionEmitter:t,sessionChannel:a,userOptions:i});n.connect(),yield ze(lr.type),n.disconnect(),yield ze(vr.type),t.emit("session.disconnected"),l.cancel(),d.cancel(),c.forEach((e=>e.cancel())),s.close(),a.close(),vi().debug("sessionSaga [ended]")}function*Zr({session:e,token:t,sessionEmitter:i}){try{e.reauthenticate&&(e.token=t,yield Fe(e.reauthenticate),yield Be(Mr.connected(e.rpcConnectResult)),i.emit("session.connected"))}catch(r){vi().error("Reauthenticate Error",r),e.authError(r)}}function*Xr(e){vi().debug("sessionStatusWatcher [started]");const{session:t,sessionEmitter:i}=e;try{for(;;){const r=yield ze([mr.type,hr.type,pr.type,ur.type,fr.type,yr.type]);switch(vi().debug("sessionStatusWatcher",r.type,r.payload),r.type){case mr.type:yield Be(Mr.connected(t.rpcConnectResult)),i.emit("session.connected");break;case hr.type:yield qe(Qr,Qt(Xt({},e),{action:r}));break;case pr.type:i.emit("session.expiring");break;case ur.type:yield qe(Zr,{session:t,token:r.payload.token,sessionEmitter:i});break;case fr.type:i.emit("session.reconnecting");break;case yr.type:t.forceClose()}}}finally{(yield Ge())&&vi().debug("sessionStatusWatcher [cancelled]")}}function*Qr(e){vi().debug("sessionAuthErrorSaga [started]");try{const{action:t,sessionEmitter:i}=e,{error:r}=t.payload,o=r?new qr(r.code,r.message):new Error("Unauthorized");i.emit("session.auth_error",o)}finally{(yield Ge())&&vi().debug("sessionAuthErrorSaga [cancelled]")}}var Yr=e=>function*({userOptions:t,channels:i}){var r;for(vi().debug("rootSaga [started]"),t.logger&&(r=t.logger,ui=r),t.debug&&(e=>{null!=e?Object.assign(mi,e):mi={}})(t.debug);;){yield ze(dr.type);try{yield Fe(Gr,Qt(Xt({},e),{userOptions:t,channels:i}));break}catch(o){vi().error("RootSaga Error:",o)}finally{(yield Ge())&&vi().debug("rootSaga [cancelled]"),vi().debug("Reboot rootSaga")}}vi().debug("rootSaga [finished]")},eo={};ei(eo,{getAuthError:()=>oo,getAuthStatus:()=>ro,getAuthorization:()=>no,getAuthorizationState:()=>so,getIceServers:()=>to,getProtocol:()=>ao,getSession:()=>io});var to=({session:e})=>{var t;return null!=(t=null==e?void 0:e.iceServers)?t:[]},io=e=>e.session,ro=({session:e})=>e.authStatus,oo=({session:e})=>e.authError,no=({session:e})=>e.authorization,so=({session:e})=>e.authorizationState,ao=({session:e})=>e.protocol,co=e=>{const{sessionListeners:t={},store:i,Component:r,customSagas:o=[]}=e,n=Object.keys(t);return e=>{const s=new r(Qt(Xt({},e),{store:i})),a=new Map;let c=!0;const d=i.subscribe((()=>{const e=i.getState(),r=io(e);for(const i of n){if(!1===c)return;const e=`session.${i}`,o=a.get(e),n=r[i];if(void 0!==n&&o!==n){a.set(e,n);const o=t[i];"string"==typeof o?s[o](r):"function"==typeof o&&o(r)}}})),l=null==o?void 0:o.map((e=>i.runSaga(e,{instance:s,runSaga:i.runSaga})));return s.destroyer=()=>{c=!1,d(),a.clear(),(null==l?void 0:l.length)&&l.forEach((e=>e.cancel()))},s}},lo=()=>new Ut;ii(Or,or);var uo=e=>{var t;const{userOptions:i,SessionConstructor:r,preloadedState:o={},runRootSaga:n=!0}=e,s=$t({sagaMonitor:i.sagaMonitor}),a=vt(),c=pt(),d={swEventChannel:a,sessionChannel:c},l=cr({devTools:null==(t=null==i?void 0:i.devTools)||t,reducer:Dr,preloadedState:o,middleware:e=>e().concat(s)}),u=(()=>{const e=new Map;return{get:t=>e.get(t),set:(t,i)=>(e.set(t,i),e),remove:t=>(e.delete(t),e),getAll:()=>Array.from(e.entries()),deleteAll:()=>(e.clear(),e)}})(),{initSession:h,getSession:m,sessionEmitter:p}=(e=>{const{SessionConstructor:t,userOptions:i,sessionChannel:r}=e,o=lo();let n=null;return{session:n,initSession:()=>(n=new t(Qt(Xt({},i),{sessionChannel:r})),n),getSession:()=>(n||vi().warn("Session does not exist!"),n),sessionEmitter:o}})({userOptions:i,sessionChannel:c,SessionConstructor:r});if(n){const e=Yr({initSession:h,sessionEmitter:p});s.run(e,{userOptions:i,channels:d})}return Qt(Xt({},l),{runSaga:(e,t)=>s.run(e,Qt(Xt({},t),{channels:d,getSession:m,instanceMap:u})),channels:d,instanceMap:u,sessionEmitter:p})},ho=function*(e){const{initialState:t,onDone:i,onFail:r,getSession:o}=e,{requestId:n,method:s,params:a}=t,c=o();if(!c){const e=new Error("Session does not exist!");return vi().error(e),void(null==r||r(e))}try{let e=(({method:e,params:t})=>$i({method:e,params:t}))({id:n,method:s,params:a});const t=yield Fe(c.execute,e);null==i||i(t)}catch(d){vi().warn("Execute error: ",d),null==r||r(d)}},mo=e=>e,po=Symbol("BaseComponent"),go=class{constructor(e){this.options=e,ri(this,"__sw_symbol",po),ri(this,"uuid",h()),ri(this,"_customSagaTriggers",new Map),ri(this,"_destroyer"),ri(this,"eventEmitter"),ri(this,"_runningWorkers",[]),ri(this,"_workers",new Map),this.eventEmitter=new Ut}get __uuid(){return this.uuid}get logger(){return vi()}set destroyer(e){this._destroyer=e}get store(){return this.options.store}get instanceMap(){return this.store.instanceMap}get emitter(){return this.eventEmitter}get sessionEmitter(){return this.store.sessionEmitter}get session(){return this.sessionEmitter}on(e,t){return this.emitter.on(e,t)}once(e,t){return this.emitter.once(e,t)}off(e,t){return this.emitter.off(e,t)}removeAllListeners(e){return e?this.off(e):(this.eventNames().forEach((e=>{this.off(e)})),this.emitter)}eventNames(){return this.emitter.eventNames()}sessionEventNames(){return this.sessionEmitter.eventNames()}getSubscriptions(){return Vi(this.eventNames())}emit(e,...t){return this.emitter.emit(e,...t)}listenerCount(e){return this.emitter.listenerCount(e)}destroy(){var e;null==(e=this._destroyer)||e.call(this),this.removeAllListeners(),this.detachWorkers()}execute({method:e,params:t},{transformParams:i=mo,transformResolve:r=mo,transformReject:o=mo}={transformParams:mo,transformResolve:mo,transformReject:mo}){return new Promise(((n,s)=>{const a=h();this.runWorker("executeActionWorker",{worker:ho,onDone:e=>n(r(e)),onFail:e=>s(o(e)),initialState:{requestId:a,componentId:this.__uuid,method:e,params:i(t)}})}))}triggerCustomSaga(e){return new Promise(((t,i)=>{const r=h();this._customSagaTriggers.set(r,{resolve:t,reject:i}),this.store.dispatch(Xt({dispatchId:r},_r(this.__uuid,e)))}))}settleCustomSagaTrigger({dispatchId:e,payload:t,kind:i}){const r=this._customSagaTriggers.get(e);r&&(r[i](t),this._customSagaTriggers.delete(e))}select(e){return e(this.store.getState())}getStateProperty(e){return this[e]}get _sessionAuthStatus(){return this.select(ro)}get _sessionAuthorization(){return this.select(no)}_waitUntilSessionAuthorized(){switch(this._sessionAuthStatus){case"authorized":return Promise.resolve(this);case"unknown":case"authorizing":return new Promise(((e,t)=>{const i=this.store.subscribe((()=>{const r=this.select(ro),o=this.select(oo);if("authorized"===r)e(this),i();else if("unauthorized"===r){const e=o?new qr(o.code,o.message):new Error("Unauthorized");t(e),i()}}))}));case"unauthorized":return Promise.reject(new Error("Unauthorized"))}}runWorker(e,t){return this._workers.has(e)?vi().warn(`[runWorker] Worker with name ${e} has already been registerd.`):this._setWorker(e,t),this._attachWorker(e,t)}_setWorker(e,t){this._workers.set(e,t)}_attachWorker(e,t){var i=t,{worker:r}=i,o=Yt(i,["worker"]);const n=this.store.runSaga(r,Xt({instance:this,runSaga:this.store.runSaga},o));return this._runningWorkers.push(n),this._workers.delete(e),n}detachWorkers(){this._runningWorkers.forEach((e=>{e.cancel()})),this._runningWorkers=[]}},vo=class extends go{constructor(e){super(e),this.options=e}connect(){const e=ro(this.store.getState());return"unknown"!==e&&"unauthorized"!==e||this.store.dispatch(dr()),this._waitUntilSessionAuthorized()}disconnect(){this.store.dispatch(lr())}removeAllListeners(e){return this.sessionEventNames().forEach((e=>{this.sessionEmitter.off(e)})),super.removeAllListeners(e)}},fo=class extends go{constructor(e){super(e),this.options=e,ri(this,"subscribeMethod","signalwire.subscribe"),ri(this,"subscribeParams",{}),ri(this,"_latestExecuteParams");const t=()=>{this._latestExecuteParams=void 0};super.session.on("session.connected",t),super.session.on("session.disconnected",t),super.session.on("session.reconnecting",t)}shouldExecuteSubscribe(e){return!this._latestExecuteParams||JSON.stringify(e)!==JSON.stringify(this._latestExecuteParams)}async subscribe(){await this._waitUntilSessionAuthorized();const e=this.getSubscriptions();if(0===e.length)return void this.logger.debug("`subscribe()` was called without any listeners attached.");const t={method:this.subscribeMethod,params:Qt(Xt({},this.subscribeParams),{event_channel:this.getStateProperty("eventChannel"),events:e})};if(this.shouldExecuteSubscribe(t))return this._latestExecuteParams=t,new Promise((async(e,i)=>{try{return await this.execute(t),e(void 0)}catch(r){return i(r)}}));this.logger.debug("BaseConsumer.subscribe() - Skipped .execute() since the execParams are exactly the same as last time")}},yo={audio_muted:!0,video_muted:!0,deaf:!0,visible:!0,input_volume:1,output_volume:1,input_sensitivity:1},bo=(Object.keys(yo).map((e=>`${si}.member.updated.${e}`)),Ci(yo)),_o=(Object.keys(bo).map((e=>`member.updated.${e}`)),{});ei(_o,{getComponent:()=>wo,getComponentsById:()=>ko,getComponentsToCleanup:()=>So});var wo=({components:e},t)=>{var i;return null==(i=e.byId)?void 0:i[t]},ko=({components:e})=>e.byId,So=e=>{const t=ko(e);let i=[];return Object.keys(t).forEach((e=>{(t[e].responses||t[e].errors)&&i.push(e)})),i},Co=(Object.keys({audioMuted:!0,videoMuted:!0,deaf:!0,visible:!0,inputVolume:1,outputVolume:1,inputSensitivity:1}).map((e=>`member.updated.${e}`)),{});ei(Co,{RoomSessionPlaybackAPI:()=>yn,RoomSessionRecordingAPI:()=>vn,RoomSessionStreamAPI:()=>_n,audioMuteMember:()=>Go,audioUnmuteMember:()=>Zo,createRoomSessionPlaybackObject:()=>bn,createRoomSessionRecordingObject:()=>fn,createRoomSessionStreamObject:()=>wn,deafMember:()=>Yo,deleteMemberMeta:()=>pn,deleteMeta:()=>Fo,demote:()=>an,getLayouts:()=>xo,getMemberMeta:()=>un,getMembers:()=>Po,getMeta:()=>zo,getPlaybacks:()=>No,getRecordings:()=>Do,getStreams:()=>qo,hideVideoMuted:()=>Ao,lock:()=>Lo,play:()=>$o,promote:()=>sn,removeAllMembers:()=>ln,removeMember:()=>dn,setDeaf:()=>tn,setHideVideoMuted:()=>Vo,setInputSensitivityMember:()=>nn,setInputVolumeMember:()=>rn,setLayout:()=>To,setMemberMeta:()=>hn,setMemberPosition:()=>cn,setMeta:()=>Bo,setOutputVolumeMember:()=>on,setPositions:()=>Ro,setPrioritizeHandraise:()=>Ko,setRaisedHand:()=>gn,showVideoMuted:()=>Oo,startRecording:()=>Wo,startStream:()=>Jo,undeafMember:()=>en,unlock:()=>jo,updateMemberMeta:()=>mn,updateMeta:()=>Ho,videoMuteMember:()=>Xo,videoUnmuteMember:()=>Qo});var Eo=()=>{},Io=(e,t={})=>({value:function(i={}){return this.execute({method:e,params:Xt({room_session_id:this.roomSessionId},i)},t)}}),Mo=(e,t={})=>({value:function(i={}){var r=i,{memberId:o}=r,n=Yt(r,["memberId"]);return this.execute({method:e,params:Xt({room_session_id:this.roomSessionId,member_id:o||this.memberId},n)},t)}}),xo=Io("video.list_available_layouts",{transformResolve:e=>({layouts:e.layouts})}),Po=Io("video.members.get",{transformResolve:e=>({members:e.members})}),To=Io("video.set_layout",{transformResolve:Eo}),Ro=Io("video.set_position",{transformResolve:Eo}),Ao=Io("video.hide_video_muted",{transformResolve:Eo}),Oo=Io("video.show_video_muted",{transformResolve:Eo}),Lo=Io("video.lock",{transformResolve:Eo}),jo=Io("video.unlock",{transformResolve:Eo}),Vo={value:function(e){return this.execute({method:e?"video.hide_video_muted":"video.show_video_muted",params:{room_session_id:this.roomSessionId}},{transformResolve:Eo})}},Do={value:function(){return new Promise((async(e,t)=>{try{const{recordings:t}=await this.execute({method:"video.recording.list",params:{room_session_id:this.roomSessionId}}),i=[];t.forEach((e=>{let t=this.instanceMap.get(e.id);t?t.setPayload({room_id:this.roomId,room_session_id:this.roomSessionId,recording:e}):t=fn({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,recording:e}}),i.push(t),this.instanceMap.set(t.id,t)})),e({recordings:i})}catch(i){t(i)}}))}},Wo={value:function(){return new Promise((async(e,t)=>{try{const{recording:t}=await this.execute({method:"video.recording.start",params:{room_session_id:this.roomSessionId}}),i=fn({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,recording:t}});this.instanceMap.set(i.id,i),e(i)}catch(i){t(i)}}))}},No={value:function(){return new Promise((async(e,t)=>{try{const{playbacks:t}=await this.execute({method:"video.playback.list",params:{room_session_id:this.roomSessionId}}),i=[];t.forEach((e=>{let t=this.instanceMap.get(e.id);t?t.setPayload({room_id:this.roomId,room_session_id:this.roomSessionId,playback:e}):t=bn({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,playback:e}}),i.push(t),this.instanceMap.set(t.id,t)})),e({playbacks:i})}catch(i){t(i)}}))}},$o={value:function(e){var t=e,{seekPosition:i,currentTimecode:r}=t,o=Yt(t,["seekPosition","currentTimecode"]);return new Promise((async(e,t)=>{try{const t=i||r,{playback:n}=await this.execute({method:"video.playback.start",params:Xt({room_session_id:this.roomSessionId,seek_position:t},o)}),s=bn({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,playback:n}});this.instanceMap.set(s.id,s),e(s)}catch(n){t(n)}}))}},Uo=e=>Io(e,{transformResolve:Eo,transformParams:e=>{const t=e,{room_session_id:i}=t;return{room_session_id:i,meta:Yt(t,["room_session_id"])}}}),zo=Io("video.get_meta",{transformResolve:({meta:e})=>({meta:e})}),Bo=Uo("video.set_meta"),Ho=Uo("video.update_meta"),Fo={value:function(e){return this.execute({method:"video.delete_meta",params:{room_session_id:this.roomSessionId,keys:e}})}},qo={value:function(){return new Promise((async(e,t)=>{try{const{streams:t}=await this.execute({method:"video.stream.list",params:{room_session_id:this.roomSessionId}}),i=[];t.forEach((e=>{let t=this.instanceMap.get(e.id);t?t.setPayload({room_id:this.roomId,room_session_id:this.roomSessionId,stream:e}):t=wn({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,stream:e}}),i.push(t),this.instanceMap.set(t.id,t)})),e({streams:i})}catch(i){t(i)}}))}},Jo={value:function(e){return new Promise((async(t,i)=>{try{const{stream:i}=await this.execute({method:"video.stream.start",params:Xt({room_session_id:this.roomSessionId},e)}),r=wn({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,stream:i}});this.instanceMap.set(r.id,r),t({stream:r})}catch(r){i(r)}}))}},Ko={value:function(e){return this.execute({method:"video.prioritize_handraise",params:{room_session_id:this.roomSessionId,enable:e}})}},Go=Mo("video.member.audio_mute",{transformResolve:Eo}),Zo=Mo("video.member.audio_unmute",{transformResolve:Eo}),Xo=Mo("video.member.video_mute",{transformResolve:Eo}),Qo=Mo("video.member.video_unmute",{transformResolve:Eo}),Yo=Mo("video.member.deaf",{transformResolve:Eo}),en=Mo("video.member.undeaf",{transformResolve:Eo}),tn={value:function(e){return this.execute({method:e?"video.member.deaf":"video.member.undeaf",params:{room_session_id:this.roomSessionId,member_id:this.memberId}},{transformResolve:Eo})}},rn=Mo("video.member.set_input_volume",{transformResolve:Eo}),on=Mo("video.member.set_output_volume",{transformResolve:Eo}),nn=Mo("video.member.set_input_sensitivity",{transformResolve:Eo}),sn={value:function(e){var t=e,{memberId:i,mediaAllowed:r,joinAudioMuted:o,joinVideoMuted:n}=t,s=Yt(t,["memberId","mediaAllowed","joinAudioMuted","joinVideoMuted"]);return this.execute({method:"video.member.promote",params:Xt({room_session_id:this.roomSessionId,member_id:i,media_allowed:r,join_audio_muted:o,join_video_muted:n},s)},{transformResolve:Eo})}},an={value:function({memberId:e,mediaAllowed:t}){return this.execute({method:"video.member.demote",params:{room_session_id:this.roomSessionId,member_id:e,media_allowed:t}},{transformResolve:Eo})}},cn=Mo("video.member.set_position",{transformResolve:Eo}),dn={value:function(e){var t=e,{memberId:i}=t,r=Yt(t,["memberId"]);if(!i)throw new TypeError('Invalid or missing "memberId" argument');return this.execute({method:"video.member.remove",params:Xt({room_session_id:this.roomSessionId,member_id:i},r)},{transformResolve:Eo})}},ln={value:function(){return this.execute({method:"video.member.remove",params:{room_session_id:this.roomSessionId,member_id:"all"}},{transformResolve:Eo})}},un=Mo("video.member.get_meta",{transformResolve:({meta:e})=>({meta:e})}),hn=Mo("video.member.set_meta",{transformResolve:Eo}),mn=Mo("video.member.update_meta",{transformResolve:Eo}),pn=Mo("video.member.delete_meta",{transformResolve:Eo}),gn={value:function(e){const{raised:t=!0,memberId:i=this.memberId}=e||{};if(!i)throw new TypeError('Invalid or missing "memberId" argument');return this.execute({method:t?"video.member.raisehand":"video.member.lowerhand",params:{room_session_id:this.roomSessionId,member_id:i}},{transformResolve:Eo})}},vn=class extends go{constructor(e){super(e),ri(this,"_payload"),this._payload=e.payload}get id(){return this._payload.recording.id}get roomId(){return this._payload.room_id}get roomSessionId(){return this._payload.room_session_id}get state(){return this._payload.recording.state}get duration(){return this._payload.recording.duration}get startedAt(){if(this._payload.recording.started_at)return new Date(1e3*this._payload.recording.started_at)}get endedAt(){if(this._payload.recording.ended_at)return new Date(1e3*this._payload.recording.ended_at)}setPayload(e){this._payload=e}async pause(){await this.execute({method:"video.recording.pause",params:{room_session_id:this.getStateProperty("roomSessionId"),recording_id:this.getStateProperty("id")}})}async resume(){await this.execute({method:"video.recording.resume",params:{room_session_id:this.getStateProperty("roomSessionId"),recording_id:this.getStateProperty("id")}})}async stop(){await this.execute({method:"video.recording.stop",params:{room_session_id:this.getStateProperty("roomSessionId"),recording_id:this.getStateProperty("id")}})}},fn=e=>co({store:e.store,Component:vn})(e),yn=class extends go{constructor(e){super(e),ri(this,"_payload"),this._payload=e.payload}get id(){return this._payload.playback.id}get roomId(){return this._payload.room_id}get roomSessionId(){return this._payload.room_session_id}get url(){return this._payload.playback.url}get state(){return this._payload.playback.state}get volume(){return this._payload.playback.volume}get startedAt(){if(this._payload.playback.started_at)return new Date(1e3*this._payload.playback.started_at)}get endedAt(){if(this._payload.playback.ended_at)return new Date(1e3*this._payload.playback.ended_at)}get position(){return this._payload.playback.position}get seekable(){return this._payload.playback.seekable}setPayload(e){this._payload=e}async pause(){await this.execute({method:"video.playback.pause",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id")}})}async resume(){await this.execute({method:"video.playback.resume",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id")}})}async stop(){await this.execute({method:"video.playback.stop",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id")}})}async setVolume(e){await this.execute({method:"video.playback.set_volume",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),volume:e}})}async seek(e){await this.execute({method:"video.playback.seek_absolute",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),position:Math.abs(e)}})}async forward(e=5e3){await this.execute({method:"video.playback.seek_relative",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),position:Math.abs(e)}})}async rewind(e=5e3){await this.execute({method:"video.playback.seek_relative",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),position:-Math.abs(e)}})}},bn=e=>co({store:e.store,Component:yn})(e),_n=class extends go{constructor(e){super(e),ri(this,"_payload"),this._payload=e.payload}get id(){return this._payload.stream.id}get roomId(){return this._payload.room_id}get roomSessionId(){return this._payload.room_session_id}get state(){return this._payload.stream.state}get duration(){return this._payload.stream.duration}get url(){return this._payload.stream.url}get startedAt(){if(this._payload.stream.started_at)return new Date(1e3*this._payload.stream.started_at)}get endedAt(){if(this._payload.stream.ended_at)return new Date(1e3*this._payload.stream.ended_at)}setPayload(e){this._payload=e}async stop(){await this.execute({method:"video.stream.stop",params:{room_session_id:this.getStateProperty("roomSessionId"),stream_id:this.getStateProperty("id")}})}},wn=e=>co({store:e.store,Component:_n})(e),kn={};ei(kn,{BaseChatAPI:()=>zn,BaseChatConsumer:()=>Un,ChatMember:()=>Fn,ChatMessage:()=>Hn,applyCommonMethods:()=>Kn,createBaseChatObject:()=>Bn,getMemberState:()=>On,getMembers:()=>Tn,getMessages:()=>Pn,publish:()=>xn,setMemberState:()=>An});var Sn=e=>{const t=!e||Array.isArray(e)?e:[e];return Array.isArray(t)?t.map((e=>({name:e}))):[]},Cn=e=>Array.isArray(e)||"string"==typeof e,En=()=>{},In=(e,t={})=>({value:function(i={}){return this.execute({method:e,params:i},t)}}),Mn=(e,t={})=>({value:function(i={}){var r=i,{memberId:o}=r,n=Yt(r,["memberId"]);return this.execute({method:e,params:Xt({member_id:o},n)},t)}}),xn=In("chat.publish",{transformResolve:En}),Pn=In("chat.messages.get",{transformResolve:e=>({messages:e.messages.map((e=>Ci(e))),cursor:e.cursor})}),Tn=In("chat.members.get",{transformResolve:e=>({members:e.members.map((e=>Ci(e)))})}),Rn=e=>{const t=Cn(null==e?void 0:e.channels)?Sn(e.channels):void 0;return Qt(Xt({},e),{channels:t})},An=Mn("chat.member.set_state",{transformResolve:En,transformParams:Rn}),On=Mn("chat.member.get_state",{transformResolve:e=>({channels:e.channels}),transformParams:Rn}),Ln={};ei(Ln,{BasePubSubConsumer:()=>Dn,PubSubMessage:()=>Nn,createBasePubSubObject:()=>Wn});var jn=function*(e){vi().trace("pubSubWorker started");const{instance:t,channels:{swEventChannel:i}}=e;function*r(e){const{type:i,payload:r}=e;switch(i){case`${ai}.channel.message`:{const{channel:e,message:i}=r,o=i,{member:n}=o,s=Yt(o,["member"]),a=Ci(Qt(Xt({},s),{channel:e})),c=new Nn(a);t.emit("message",c);break}default:vi().warn(`Unknown pubsub event: "${i}"`)}}const o=e=>e.type.startsWith(`${ai}.`);for(;;){const e=yield ze(i,o);yield qe(r,e)}vi().trace("pubSubWorker ended")},Vn=e=>e.map((e=>({name:e}))),Dn=class extends fo{constructor(e){super(e),ri(this,"subscribeMethod",`${ai}.subscribe`),this.initWorker()}initWorker(){this.runWorker("pubSub",{worker:jn})}_getChannelsParam(e,t){const i=!e||Array.isArray(e)?e:[e];if(!Array.isArray(i)||0===i.length)throw new Error(`Please specify one or more channels when calling .${t}()`);return{channels:Vn(i)}}_setSubscribeParams(e){this.subscribeParams=Xt(Xt({},this.subscribeParams),e)}_getSubscribeParams({channels:e}){return Xt({},this._getChannelsParam(e,"subscribe"))}_getUnsubscribeParams({channels:e}){const t=this._getChannelsParam(e,"unsubscribe");return Xt({},t)}_checkMissingSubscriptions(){0===this.getSubscriptions().length&&(this.logger.info("Subscribe was called before any listeners were attached. Move `.subscribe()` right after your event listeners to suppress this message."),this.once("message",(()=>{})))}getSubscriptions(){const e=this.eventNames().map((e=>`${ai}.${String(e)}`));return Vi(e)}async subscribe(e){this._checkMissingSubscriptions();const t=this._getSubscribeParams({channels:e});return this._setSubscribeParams(t),super.subscribe()}async unsubscribe(e){if("unknown"===this._sessionAuthStatus||"unauthorized"===this._sessionAuthStatus)throw new Error("You must be authenticated to unsubscribe from a channel");const t=this._getUnsubscribeParams({channels:e});return new Promise((async(e,i)=>{const r=this.getSubscriptions();if(r.length>0){const e={method:`${ai}.unsubscribe`,params:Qt(Xt({},t),{events:r})};try{await this.execute(e)}catch(o){return i(o)}}else this.logger.warn("`unsubscribe()` was called without any listeners attached.");return e()}))}updateToken(e){return new Promise(((t,i)=>{this.session.once("session.auth_error",(e=>{i(e)})),this.session.once("session.connected",(()=>{t()})),this.store.dispatch(rr.reauthAction({token:e}))}))}publish(e){return this.execute({method:`${ai}.publish`,params:e})}async getAllowedChannels(){await this._waitUntilSessionAuthorized();const e=this.select(no);return e&&"channels"in e&&e.channels?e.channels:{}}},Wn=e=>co({store:e.store,Component:Dn})(e),Nn=class{constructor(e){this.payload=e}get id(){return this.payload.id}get channel(){return this.payload.channel}get content(){return this.payload.content}get meta(){return this.payload.meta}get publishedAt(){return this.payload.publishedAt}},$n=function*(e){vi().trace("chatWorker started");const{instance:t,channels:{swEventChannel:i}}=e;function*r(e){const{type:i,payload:r}=e;switch(i){case"chat.channel.message":{const{channel:e,message:i}=r,o=Ci(Qt(Xt({},i),{channel:e})),n=new Hn(o);t.emit("message",n);break}case"chat.member.joined":case"chat.member.updated":case"chat.member.left":{const{member:e}=r,o=Ci(e),n=new Fn(o),s=Pi(i);t.emit(s,n);break}default:vi().warn(`Unknown chat event: "${i}"`)}}const o=e=>e.type.startsWith("chat.");for(;;){const e=yield ze(i,o);yield qe(r,e)}vi().trace("chatWorker ended")},Un=class extends Dn{constructor(e){super(e),ri(this,"subscribeMethod","chat.subscribe")}initWorker(){this.runWorker("chat",{worker:$n})}},zn=xi(Un,{publish:xn,getMembers:Tn,getMessages:Pn,setMemberState:An,getMemberState:On}),Bn=e=>co({store:e.store,Component:zn})(e),Hn=class extends Nn{get member(){return this.payload.member}},Fn=class{constructor(e){this.payload=e}get id(){return this.payload.id}get channel(){return this.payload.channel}get state(){var e;return null!=(e=this.payload.state)?e:{}}},qn=e=>{const t=Cn(null==e?void 0:e.channels)?Sn(e.channels):void 0;return Qt(Xt({},e),{channels:t})},Jn=()=>{};function Kn(e){return class extends e{getMembers(e){return this._client.execute({method:"chat.members.get",params:e},{transformResolve:e=>({members:e.members.map((e=>Ci(e)))})})}getMessages(e){return this._client.execute({method:"chat.messages.get",params:e},{transformResolve:e=>({messages:e.messages.map((e=>Ci(e))),cursor:e.cursor})})}setMemberState(e={}){var t=e,{memberId:i}=t,r=Yt(t,["memberId"]);return this._client.execute({method:"chat.member.set_state",params:Xt({member_id:i},r)},{transformResolve:Jn,transformParams:qn})}getMemberState(e={}){var t=e,{memberId:i}=t,r=Yt(t,["memberId"]);return this._client.execute({method:"chat.member.get_state",params:Xt({member_id:i},r)},{transformResolve:e=>({channels:e.channels}),transformParams:qn})}}}var Gn={};ei(Gn,{memberPositionWorker:()=>Yn,memberUpdatedWorker:()=>Qn});var Zn=function*(e,t,i){const r=Pi(e);i.emit(r,t)};function*Xn(e){const{action:t,memberList:i,instance:r,dispatcher:o=Zn}=e,n=t.payload.layout.layers,s={};n.forEach((e=>{var t;const r=e.member_id;if(!r)return;const o=i.get(r);o&&e.position!==(null==(t=o.member)?void 0:t.current_position)?(es({memberList:i,memberId:r,currentPosition:e.position}),s[r]=!0):s[r]=!1}));for(const[a,c]of i)if(s[a])yield null==o?void 0:o("video.member.updated",c,r);else if(void 0===s[a]){const e=es({memberList:i,memberId:a,currentPosition:"off-canvas"});if(!e)return;yield null==o?void 0:o("video.member.updated",e,r)}}function*Qn({action:e,memberList:t,instance:i,dispatcher:r=Zn}){var o,n;const s=e.payload.member.id,a=es({memberList:t,memberId:s,currentPosition:null==(n=null==(o=t.get(s))?void 0:o.member)?void 0:n.current_position});if(!a)return;const{member:{updated:c=[]}}=e.payload,d=Qt(Xt({},a),{member:Xt(Xt({},a.member),e.payload.member)});t.set(s,d);for(const l of c){const t=`${e.type}.${l}`;yield null==r?void 0:r(t,d,i)}yield null==r?void 0:r(e.type,d,i)}var Yn=function*({instance:e,channels:t,initialState:i,getSession:r,instanceMap:o,dispatcher:n=Zn}){if(!i)return;const{swEventChannel:s}=t;let a=ts(i);const c=e=>{a.has(e.member.id)||a.set(e.member.id,e)};for(;;){const i=yield ze(s,(e=>"video.member.joined"===e.type||"video.member.updated"===e.type||"video.member.left"===e.type||"video.layout.changed"===e.type));switch(i.type){case"video.member.joined":c(i.payload);break;case"video.member.updated":c(i.payload),yield qe(Qn,{action:i,channels:t,memberList:a,instance:e,getSession:r,instanceMap:o,dispatcher:n});break;case"video.member.left":{const e=i.payload.member;a.delete(e.id);break}case"video.layout.changed":yield qe(Xn,{action:i,channels:t,memberList:a,instance:e,dispatcher:n})}}},es=({memberList:e,memberId:t,currentPosition:i})=>{const r=e.get(t);if(!r)return;if(!i)return r;const o=Qt(Xt({},r),{member:Qt(Xt({},null==r?void 0:r.member),{current_position:i})});return e.set(t,o),o},ts=e=>{const t=e.room_session.members,i=new Map;return t.forEach((t=>{const r=t.id,o=e.room_session.id||e.room_session.room_session_id;i.set(r,{room_id:e.room_session.room_id,room_session_id:o,member:t})})),i};ei({},{configureFullStack:()=>ss,configureJestStore:()=>ns,createMockedLogger:()=>os,createSessionChannel:()=>ls,createSwEventChannel:()=>ds,rpcConnectResultVRT:()=>cs,wait:()=>as});var is="8f0a119a-cda7-4497-a47d-c81493b824d4",rs="<VRT>",os=()=>({fatal:jest.fn(),error:jest.fn(),warn:jest.fn(),info:jest.fn(),debug:jest.fn(),trace:jest.fn(),wsTraffic:jest.fn()}),ns=e=>uo(Xt({userOptions:{project:is,token:rs,devTools:!1},SessionConstructor:Rr,runRootSaga:!1},e)),ss=()=>{const e={dispatch:console.log,connect:jest.fn(),disconnect:jest.fn(),execute:jest.fn()},t=new Ut,i=uo({userOptions:{project:is,token:rs,devTools:!1},SessionConstructor:jest.fn().mockImplementation((()=>e))});return i.dispatch(rr.initAction()),i.dispatch(rr.authSuccessAction()),{store:i,session:e,emitter:t,destroy:()=>i.dispatch(rr.destroyAction())}},as=e=>new Promise((t=>{setTimeout(t,e)})),cs={identity:"f3bc99df-2c3d-4fa4-b1dc-e8a8ffc579e6@e3fefa44-1bad-4be9-ad9b-1cbb9abd60c7.west-us",authorization:{type:"video",project_id:"8f0a119a-cda7-4497-a47d-c81493b824d4",project:"8f0a119a-cda7-4497-a47d-c81493b824d4",scopes:["video"],scope_id:"26675883-8499-4ee9-85eb-691c4aa209f8",resource:"9c80f1e8-9430-4070-a043-937eb3a96b38",join_as:"member",user_name:"Joe",room:{name:"lobby",display_name:"Lobby",scopes:["room.self.audio_mute","room.self.audio_unmute"],meta:{}},signature:"SGZtkRD9fvuBAOUp1UF56zESxdEvGT6qSGZtkRD9fvuBAOUp1UF56zESxdEvGT6q",media_allowed:"all",audio_allowed:"both",video_allowed:"both",meta:{}},protocol:"signalwire_SGZtkRD9fvuBAOUp1UF56zESxdEvGT6qSGZtkRD9fvuBAOUp1UF56zESxdEvGT6q_03e8c927-8ea3-4661-86d5-778c3e03296a_8f0a119a-cda7-4497-a47d-c81493b824d4",ice_servers:[{urls:"turn.swire.io:443",credential:"sFTwvi8ShXcYNOcyYjFy3ATIUpQ=",credentialType:"password",username:"1619521908:8f0a119a-cda7-4497-a47d-c81493b824d4"}]},ds=()=>vt(),ls=()=>pt(),us=Xt({},eo);const hs=()=>"undefined"!=typeof navigator&&!!navigator.mediaDevices,ms=()=>{if(!hs())throw new Error("The media devices API isn't supported in this environment");return navigator.mediaDevices},ps=()=>"function"==typeof ms().getUserMedia,gs=()=>"function"==typeof ms().getDisplayMedia,vs=()=>ms().getSupportedConstraints(),fs=e=>e&&e instanceof MediaStream,ys=()=>"sinkId"in HTMLMediaElement.prototype,bs=async(e,t)=>{if(null!==e)if("string"==typeof t)if(ys())try{return await e.setSinkId(t)}catch(i){throw"SecurityError"===i.name?vi().error(`You need to use HTTPS for selecting audio output device: ${i}`):vi().error(`Error: ${i}`),i}else vi().warn("Browser does not support output device selection.");else vi().warn(`Invalid speaker deviceId: '${t}'`);else vi().warn("No HTMLMediaElement to attach the speakerId")},_s=e=>{var t;fs(e)&&(null===(t=null==e?void 0:e.getTracks())||void 0===t||t.forEach(ws))},ws=e=>{e&&"live"===e.readyState&&(e.stop(),e.dispatchEvent(new Event("ended")))},ks={camera:"videoinput",microphone:"audioinput",speaker:"audiooutput"},Ss=e=>{if(e)return ks[e]},Cs=()=>ms().enumerateDevices(),Es=async e=>{let t=await Cs().catch((e=>[]));return e&&(t=t.filter((({kind:t})=>t===e))),t},Is=async e=>{if("permissions"in navigator&&"function"==typeof navigator.permissions.query&&e)try{return"granted"===(await navigator.permissions.query({name:e})).state}catch(Pa){}return(async e=>{const t=await Es(e);return t.length?t.every((({deviceId:e,label:t})=>Boolean(e&&t))):(vi().warn(`No ${e} devices to check for permissions!`),null)})(Ss(e))},Ms=()=>Is("camera"),xs=()=>Is("microphone"),Ps=()=>Is("speaker"),Ts=async(e={audio:!0,video:!0})=>{var t;try{const t=ms().getUserMedia(e),i=await(async e=>{const t=[];if((null==e?void 0:e.audio)&&t.push(xs()),(null==e?void 0:e.video)&&t.push(Ms()),t.length)return(await Promise.all(t)).every(Boolean);return!1})(e);if(i){const e=new Error("Timeout reading from your devices");return await Oi(t,5e3,e)}return await t}catch(i){switch(i.name){case"Error":vi().error(null!==(t=null==i?void 0:i.message)&&void 0!==t?t:"navigator.mediaDevices.getUserMedia doesn't seem to be supported.");break;case"NotFoundError":vi().error("No media tracks of the type specified were found that satisfy the given constraints.");break;case"NotReadableError":vi().error("Hardware error occurred at the operating system, browser, or Web page level which prevented access to the device. This could have been caused by having the Camera or Mic being user by another application.");break;case"OverconstrainedError":vi().error(`The constraint: ${i.constraint} cannot be met by the selected device.`),vi().info("List of available constraints:",vs());break;case"NotAllowedError":vi().error("The user has mostly likely denied access to the device. This could also happen if the browsing context is insecure (using HTTP rather than HTTPS)");break;case"TypeError":0===Object.keys(e).length?vi().error('Constraints can\'t be empty nor have "video" and "audio" set to false.'):vi().error("Please check that you are calling this method from a secure context (using HTTPS rather than HTTP).");break;case"SecurityError":vi().error("User media support is disabled on the Document on which getUserMedia() was called. The mechanism by which user media support is enabled and disabled is left up to the individual user agent.")}throw i}},Rs=e=>ms().getDisplayMedia(e),As=async e=>{try{const t=await Ts(e);_s(t)}catch(t){throw t}},Os=async(e,t=!1)=>Ws(e,t),Ls=()=>Os("camera"),js=()=>Os("microphone"),Vs=()=>Os("speaker"),Ds=(e,t={})=>{const i=[];return e.filter((({deviceId:e,kind:r,groupId:o})=>{var n;if(!e||t.targets&&!(null===(n=t.targets)||void 0===n?void 0:n.includes(r)))return!1;if(!o)return!0;const s=`${r}-${o}`,a=!(null==t?void 0:t.excludeDefault)||"default"!==e;return!(i.includes(s)||!a)&&(i.push(s),!0)}))},Ws=async(e,t=!1)=>{let i;if(!1===await Is(e)){const t={audio:!(r=e)||"all"===r||"microphone"===r||"speaker"===r,video:!r||"all"===r||"camera"===r};i=await Ts(t)}var r;const o=await Es(Ss(e));return i&&_s(i),!0===t?o:Ds(o)},Ns=()=>Ws("camera"),$s=()=>Ws("microphone"),Us=()=>Ws("speaker"),zs=async(e,t,i)=>{const r=await Ws(i,!0);for(let o=0;o<r.length;o++){const{deviceId:i,label:n}=r[o];if(e===i||t===n)return i}return null},Bs=e=>{const t=new Map;return e.forEach((e=>{e.deviceId&&t.set(e.deviceId,e)})),t},Hs={camera:Ms,microphone:xs,speaker:Ps},Fs=["camera","microphone","speaker"],qs=`Allowed targets are: '${Fs.join("', '")}'`,Js={speaker:ys},Ks=async e=>{var t;const i=(null!==(t=e.targets)&&void 0!==t?t:Fs).filter((e=>!!Fs.includes(e)||(vi().warn(`We'll ignore the "${e}" target as it is not allowed. ${qs}.`),!1)));if(!i.length)throw new Error(`At least one "target" is required for createDeviceWatcher(). ${qs}.`);const r=await(async e=>{const t=e.targets;return(await Promise.all(t.map((e=>Hs[e]())))).reduce(((e,i,r)=>{var o;const n=t[r];return e[!(n in Js)||(null===(o=Js[n])||void 0===o?void 0:o.call(Js))?"supported":"unsupported"].push([n,!!i]),e}),{supported:[],unsupported:[]})})({targets:i});if(r.unsupported.length>0&&i.length===r.unsupported.length)throw new Error(`The platform doesn't support "${i.join(", ")}" as target/s, which means it's not possible to watch for changes on those devices.`);if(r.supported.every((([e,t])=>!t)))throw new Error("You must ask the user for permissions before being able to listen for device changes. Try calling getUserMedia() before calling `createDeviceWatcher()`.");let o=[];const n=r.supported.reduce(((e,[t,i])=>(i?e.push(t):o.push(t),e)),[]);if(n.length!==i.length){const e=r.unsupported.length>0?`The platform doesn't support "${r.unsupported.map((([e])=>e)).join(", ")}" as target/s, which means it's not possible to watch for changes on those devices. `:"",t=o.length>0?`The user hasn't granted permissions for the following targets: ${o.join(", ")}. `:"";vi().warn(`${e}${t}We'll be watching for the following targets instead: "${n.join(", ")}"`)}return vi().debug(`Watching these targets: "${n.join(", ")}"`),n},Gs=async(e={})=>{const t=await Ks({targets:e.targets}),i=new Ut,r=await Cs(),o=null==t?void 0:t.reduce(((e,t)=>{const i=Ss(t);return i&&e.push(i),e}),[]);let n=Ds(r,{excludeDefault:!0,targets:o});return ms().addEventListener("devicechange",(async()=>{const e=await Cs(),t=n,r=Ds(e,{excludeDefault:!0,targets:o});n=r;const s=((e,t)=>{const i=Bs(e),r=Bs(e),o=[];vi().debug("[_getDeviceListDiff] <- oldDevices",e),vi().debug("[_getDeviceListDiff] -> newDevices",t);const n=t.filter((e=>{const t=e.deviceId,n=i.get(t);return n&&(r.delete(t),e.label!==n.label&&o.push(e)),void 0===n}));return{updated:o.map((e=>({type:"updated",payload:e}))),removed:Array.from(r,(([e,t])=>t)).map((e=>({type:"removed",payload:e}))),added:n.map((e=>({type:"added",payload:e})))}})(t,r),a=s.added.length>0,c=s.removed.length>0,d=s.updated.length>0;(a||c||d)&&i.emit("changed",{changes:s,devices:r}),a&&i.emit("added",{changes:s.added,devices:r}),c&&i.emit("removed",{changes:s.removed,devices:r}),d&&i.emit("updated",{changes:s.updated,devices:r})})),i},Zs=()=>Gs({targets:["microphone"]}),Xs=()=>Gs({targets:["speaker"]}),Qs=()=>Gs({targets:["camera"]}),Ys=e=>"function"==typeof(null==e?void 0:e.getTracks),ea=async e=>{const t=await(async e=>{if(Ys(e))return e;let t;return t="string"==typeof e?{audio:{deviceId:e}}:{audio:e},Ts(t)})(e);if(!t)throw new Error("Failed to get the audio stream");const i=new Ut,r=new(window.AudioContext||window.webkitAudioContext),o=(e=>{const t=e.createAnalyser();return t.fftSize=64,t.minDecibels=-90,t.maxDecibels=-10,t.smoothingTimeConstant=.85,t})(r);let n,s;try{r.createMediaStreamSource(t).connect(o)}catch(d){throw new Error("No audio track found")}t.getAudioTracks().forEach((e=>{e.addEventListener("ended",(()=>{i.emit("destroyed","disconnected")}))}));const a=()=>{try{const e=new Uint8Array(o.frequencyBinCount);o.getByteFrequencyData(e);const t=e.reduce(((e,t)=>e+t),0)/20;s!==t&&(s=t,i.emit("volumeChanged",Math.min(s,100))),n=requestAnimationFrame(a)}catch(Pa){i.emit("destroyed","error")}};n=requestAnimationFrame(a);const c=()=>{n&&cancelAnimationFrame(n),"closed"!==r.state&&r.close().catch((e=>{vi().error("Error closing the AudioContext",e)})),Ys(e)||t.getTracks().forEach((e=>e.stop())),i.emit("destroyed",null),i.removeAllListeners()};return new Proxy(i,{get:(e,t,i)=>"destroy"===t?c:Reflect.get(e,t,i)})},ta=async e=>(await Us()).find((t=>t.deviceId===e||"default"===t.deviceId&&""===e||""===t.deviceId&&"default"===e));var ia=i(7963),ra=i.n(ia);const oa=e=>/^m=audio/.test(e),na=e=>/^m=video/.test(e),sa=e=>e.replace(/\r\n/g,"\n").replace(/\r/g,"\n"),aa=(e,t)=>{const i=sa(e).split("\n");for(let r of i)if(r.startsWith(`m=${t}`))return!0;return!1},ca=e=>{const t="\r\n",i=e.split(t),r=i.findIndex((e=>/^a=rtpmap/.test(e)&&/opus\/48000/.test(e)));if(r<0)return e;const o=(e=>{const t=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),i=e.match(t);return i&&2==i.length?i[1]:null})(i[r]),n=new RegExp(`a=fmtp:${o}`),s=i.findIndex((e=>n.test(e)));return s>=0?/stereo=1;/.test(i[s])||(i[s]+="; stereo=1; sprop-stereo=1"):i[r]+=`${t}a=fmtp:${o} stereo=1; sprop-stereo=1`,i.join(t)},da=(e,t)=>{const i=sa(e).split("\n");let r=!1;const o=["inactive","recvonly","sendonly","sendrecv","stopped"];for(let n of i)if(n.startsWith("m="))r=n.startsWith(`m=${t}`);else if(r&&n.startsWith("a=")){const e=n.substring(2);if(o.includes(e))return e}return r?"sendrecv":"stopped"},la=({localSdp:e,remoteSdp:t,media:i})=>{const r=(e=>{switch(e){case"sendrecv":return"sendrecv";case"sendonly":return"recvonly";case"recvonly":return"sendonly";default:return"inactive"}})(da(e,i));return da(t,i)===r},ua=e=>{vi().info("RTCService.getUserMedia",e);const{audio:t,video:i}=e;if(t||i)return Ts(e)},ha=e=>{var t,i;return(null===(t=e.negotiateVideo)||void 0===t||t)&&(!e.remoteSdp||(i=e.remoteSdp,aa(i,"video")))},ma=e=>{var t,i;return(null===(t=e.negotiateAudio)||void 0===t||t)&&(!e.remoteSdp||(i=e.remoteSdp,aa(i,"audio")))},pa=async e=>{let t=(e=>{var t;return!!ma(e)&&(null===(t=e.audio)||void 0===t||t)})(e);const{micLabel:i="",micId:r}=e;if(r&&t){const e=await zs(r,i,"microphone").catch((e=>null));e&&("boolean"==typeof t&&(t={}),t.deviceId={exact:e})}let o=(e=>{var t;return!!ha(e)&&(null!==(t=e.video)&&void 0!==t?t:!!e.camId)})(e);const{camLabel:n="",camId:s}=e;if(s&&o){const e=await zs(s,n,"camera").catch((e=>null));e&&("boolean"==typeof o&&(o={}),o.deviceId={exact:e})}return{audio:t,video:o}},ga=(e,t)=>{const{disableUdpIceServers:i=!1}=t,r=e=>{const t="transport=udp";return Array.isArray(e)?e.filter((e=>!e.includes(t))):e.includes(t)?"":e};return e.map((e=>Object.assign(Object.assign({},e),{urls:i?r(e.urls):e.urls})))};class va{get logger(){return vi()}constructor(e,t){this.call=e,this.type=t,this.uuid=h(),this._negotiating=!1,this._processingRemoteSDP=!1,this._restartingIce=!1,this.logger.debug("New Peer with type:",this.type,"Options:",this.options),this._onIce=this._onIce.bind(this),this._onEndedTrackHandler=this._onEndedTrackHandler.bind(this),this.options.prevCallId&&(this.uuid=this.options.prevCallId),this.options.prevCallId=void 0,this.options.localStream&&fs(this.options.localStream)&&(this._localStream=this.options.localStream),this.rtcConfigPolyfill=this.config}get options(){return this.call.options}get watchMediaPacketsTimeout(){var e;return null!==(e=this.options.watchMediaPacketsTimeout)&&void 0!==e?e:2e3}get isNegotiating(){return this._negotiating}get localStream(){return this._localStream}set localStream(e){this._localStream=e}get remoteStream(){return this._remoteStream}get isOffer(){return"offer"===this.type}get isAnswer(){return"answer"===this.type}get isSimulcast(){return!0===this.options.simulcast}get isSfu(){return!0===this.options.sfu}get localVideoTrack(){const e=this._getSenderByKind("video");return(null==e?void 0:e.track)||null}get localAudioTrack(){const e=this._getSenderByKind("audio");return(null==e?void 0:e.track)||null}get remoteVideoTrack(){const e=this._getReceiverByKind("video");return(null==e?void 0:e.track)||null}get remoteAudioTrack(){const e=this._getReceiverByKind("audio");return(null==e?void 0:e.track)||null}get hasAudioSender(){return!!this._getSenderByKind("audio")}get hasVideoSender(){return!!this._getSenderByKind("video")}get hasAudioReceiver(){return!!this._getReceiverByKind("audio")}get hasVideoReceiver(){return!!this._getReceiverByKind("video")}get config(){const{rtcPeerConfig:e={}}=this.options,t=Object.assign({bundlePolicy:"max-compat",iceServers:ga(this.call.iceServers,{disableUdpIceServers:this.options.disableUdpIceServers}),sdpSemantics:"unified-plan"},e);return this.logger.debug("RTC config",t),t}get localSdp(){var e,t;return null===(t=null===(e=this.instance)||void 0===e?void 0:e.localDescription)||void 0===t?void 0:t.sdp}get remoteSdp(){var e,t;return null===(t=null===(e=this.instance)||void 0===e?void 0:e.remoteDescription)||void 0===t?void 0:t.sdp}get hasIceServers(){if(this.instance){const{iceServers:e=[]}=this.getConfiguration();return Boolean(null==e?void 0:e.length)}return!1}stopTrackSender(e){var t;try{const i=this._getSenderByKind(e);if(!i)return this.logger.info(`There is not a '${e}' sender to stop.`);i.track&&(ws(i.track),null===(t=this._localStream)||void 0===t||t.removeTrack(i.track))}catch(i){this.logger.error("RTCPeer stopTrackSender error",e,i)}}stopTrackReceiver(e){var t;try{const i=this._getReceiverByKind(e);if(!i)return this.logger.info(`There is not a '${e}' receiver to stop.`);i.track&&(ws(i.track),null===(t=this._remoteStream)||void 0===t||t.removeTrack(i.track))}catch(i){this.logger.error("RTCPeer stopTrackReceiver error",e,i)}}async restoreTrackSender(e){var t;try{const i=this._getSenderByKind(e);if(!i)return this.logger.info(`There is not a '${e}' sender to restore.`);if(i.track&&"ended"!==i.track.readyState)return this.logger.info(`There is already an active ${e} track.`);const r=await pa(this.options),o=await ua({[e]:r[e]});if(o&&fs(o)){const r=o.getTracks().find((t=>t.kind===e));r&&(await i.replaceTrack(r),null===(t=this._localStream)||void 0===t||t.addTrack(r))}}catch(i){this.logger.error("RTCPeer restoreTrackSender error",e,i)}}getDeviceId(e){try{const t=this._getSenderByKind(e);if(!t||!t.track)return null;const{deviceId:i=null}=t.track.getSettings();return i}catch(t){return this.logger.error("RTCPeer getDeviceId error",e,t),null}}getTrackSettings(e){try{const t=this._getSenderByKind(e);return t&&t.track?t.track.getSettings():null}catch(t){return this.logger.error("RTCPeer getTrackSettings error",e,t),null}}getTrackConstraints(e){try{const t=this._getSenderByKind(e);return t&&t.track?t.track.getConstraints():null}catch(t){return this.logger.error("RTCPeer getTrackConstraints error",e,t),null}}getDeviceLabel(e){try{const t=this._getSenderByKind(e);return t&&t.track?t.track.label:null}catch(t){return this.logger.error("RTCPeer getDeviceLabel error",e,t),null}}restartIceWithRelayOnly(){try{if(this.isAnswer)return this.logger.warn("Skip restartIceWithRelayOnly since we need to generate answer");const e=this.getConfiguration();if("relay"===e.iceTransportPolicy)return this.logger.warn("RTCPeer already with iceTransportPolicy relay only");const t=Object.assign(Object.assign({},e),{iceTransportPolicy:"relay"});this.setConfiguration(t),this.restartIce()}catch(e){this.logger.error("restartIceWithRelayOnly",e)}}restartIce(){if(this._negotiating||this._restartingIce)return this.logger.warn("Skip restartIce");this._restartingIce=!0,this.logger.debug("Restart ICE"),this.type="offer",this.instance.restartIce()}triggerResume(){this.logger.info("Probably half-open so force close from client"),this._resumeTimer?this.logger.info('[skipped] Already in "resume" state'):(this.call.emit("media.disconnected"),this.call.emit("media.reconnecting"),this.clearTimers(),this._resumeTimer=setTimeout((()=>{this.logger.warn("Disconnecting due to RECONNECTION_ATTEMPT_TIMEOUT"),this.call.emit("media.disconnected"),this.call.leaveReason="RECONNECTION_ATTEMPT_TIMEOUT",this.call.setState("hangup")}),12e3),this.call._closeWSConnection())}resetNeedResume(){this.clearResumeTimer(),this.options.watchMediaPackets&&this.startWatchMediaPackets()}stopWatchMediaPackets(){this._mediaWatcher&&this._mediaWatcher.stop()}startWatchMediaPackets(){var e;this.stopWatchMediaPackets(),this._mediaWatcher=(e=>{if(!e.hasAudioReceiver&&!e.hasVideoReceiver)return void vi().warn(`Missing receivers to inspect media for RTCPeer "${e.uuid}"`);vi().debug(`Start watching media for RTCPeer "${e.uuid}"`);let t,i=0,r=0,o=!0;const n=()=>{clearTimeout(t)},s=async()=>{var a,c;let d=0,l=0;try{const t=await e.instance.getStats(null),i=null===(a=e.remoteAudioTrack)||void 0===a?void 0:a.id,r=null===(c=e.remoteVideoTrack)||void 0===c?void 0:c.id;t.forEach((e=>{"inbound-rtp"===e.type&&"audio"===e.kind&&e.trackIdentifier===i&&(vi().trace(`audio inbound-rtp: packetsReceived: ${e.packetsReceived} (at ${e.lastPacketReceivedTimestamp})`),d=e.packetsReceived),"inbound-rtp"===e.type&&"video"===e.kind&&e.trackIdentifier===r&&(vi().trace(`video inbound-rtp: packetsReceived: ${e.packetsReceived} (at ${e.lastPacketReceivedTimestamp})`),l=e.packetsReceived)}))}catch(u){vi().warn("getStats error",u)}finally{d&&d<=i&&l&&l<=r?(vi().warn(`audioPacketsReceived: ${d} - previousAudioValue: ${i}`),vi().warn(`videoPacketsReceived: ${l} - previousVideoValue: ${r}`),e.triggerResume()):(i=null!=d?d:i,r=null!=l?l:r,n(),o&&"closed"!==e.instance.connectionState&&(t=setTimeout((()=>s()),e.watchMediaPacketsTimeout)))}};return{start:()=>{n(),s()},stop:()=>{o=!1,n()}}})(this),null===(e=this._mediaWatcher)||void 0===e||e.start()}async applyMediaConstraints(e,t){try{const i=this._getSenderByKind(e);if(!i||!i.track)return this.logger.info("No sender to apply constraints",e,t);if("live"===i.track.readyState){const r=Object.assign(Object.assign({},i.track.getConstraints()),t),o=this.getDeviceId(e);o&&!this.options.screenShare&&(r.deviceId={exact:o}),this.logger.info(`Apply ${e} constraints`,this.call.id,r),await i.track.applyConstraints(r)}}catch(i){this.logger.error("Error applying constraints",e,t)}}_getSenderByKind(e){var t;return(null===(t=this.instance)||void 0===t?void 0:t.getSenders)?this.instance.getSenders().find((({track:t})=>t&&t.kind===e)):(this.logger.warn("RTCPeerConnection.getSenders() not available."),null)}_getReceiverByKind(e){var t;return(null===(t=this.instance)||void 0===t?void 0:t.getReceivers)?this.instance.getReceivers().find((({track:t})=>t&&t.kind===e)):(this.logger.warn("RTCPeerConnection.getReceivers() not available."),null)}async startNegotiation(e=!1){var t,i,r;if(this._negotiating)return this.logger.warn("Skip twice onnegotiationneeded!");this._negotiating=!0;try{if((this.options.additionalDevice||this.options.screenShare)&&(null===(i=null===(t=this.instance)||void 0===t?void 0:t.getTransceivers)||void 0===i||i.call(t).forEach((e=>{e.direction="sendonly"}))),this.instance.removeEventListener("icecandidate",this._onIce),this.instance.addEventListener("icecandidate",this._onIce),this.isOffer){this.logger.debug("Trying to generate offer");const e={voiceActivityDetection:!1};this._supportsAddTransceiver()||(e.offerToReceiveAudio=this.options.negotiateAudio,e.offerToReceiveVideo=this.options.negotiateVideo);const t=await this.instance.createOffer(e);await this._setLocalDescription(t)}if(this.isAnswer){this.logger.debug("Trying to generate answer"),await this._setRemoteDescription({sdp:this.options.remoteSdp,type:"offer"});const e=await this.instance.createAnswer({voiceActivityDetection:!1});await this._setLocalDescription(e)}e&&this._sdpReady(),this.logger.info("iceGatheringState",this.instance.iceGatheringState),"gathering"===this.instance.iceGatheringState&&(this._iceTimeout=setTimeout((()=>{this._onIceTimeout()}),this.options.maxIceGatheringTimeout))}catch(o){this.logger.error(`Error creating ${this.type}:`,o),null===(r=this._pendingNegotiationPromise)||void 0===r||r.reject(o)}}onRemoteBye({code:e,message:t}){var i,r;const o={code:e,message:t};null===(i=this._rejectStartMethod)||void 0===i||i.call(this,o),null===(r=this._pendingNegotiationPromise)||void 0===r||r.reject(o),this.stop()}async onRemoteSdp(e){var t,i;if(this._processingRemoteSDP||this.remoteSdp&&this.remoteSdp===e)this.logger.warn("Ignore same remote SDP",e);else try{this._processingRemoteSDP=!0;const i=this.isOffer?"answer":"offer";await this._setRemoteDescription({sdp:e,type:i}),this._processingRemoteSDP=!1,this.isOffer&&(this._resolveStartMethod(),null===(t=this._pendingNegotiationPromise)||void 0===t||t.resolve()),this.resetNeedResume()}catch(r){this.logger.error(`Error handling remote SDP on call ${this.call.id}:`,r),this.call.hangup(),this._rejectStartMethod(r),null===(i=this._pendingNegotiationPromise)||void 0===i||i.reject(r)}}_setupRTCPeerConnection(){var e;this.instance||(this.instance=(e=this.config,new window.RTCPeerConnection(e)),this._attachListeners())}async start(){return new Promise((async(e,t)=>{var i;this._resolveStartMethod=e,this._rejectStartMethod=t;try{this._localStream=await this._retrieveLocalStream()}catch(o){return this._rejectStartMethod(o),null===(i=this._pendingNegotiationPromise)||void 0===i||i.reject(o),this.call.setState("hangup")}this._setupRTCPeerConnection();let r=!1;if(this._localStream&&fs(this._localStream)){const e=this._localStream.getAudioTracks();this.logger.debug("Local audio tracks: ",e);const t=this._localStream.getVideoTracks();if(this.logger.debug("Local video tracks: ",t),r=Boolean(e.length||t.length),this.isOffer&&this._supportsAddTransceiver()){const i={direction:this.options.negotiateAudio?"sendrecv":"sendonly",streams:[this._localStream]};this.logger.debug("Applying audioTransceiverParams",i),e.forEach((e=>{this.instance.addTransceiver(e,i)}));const r={direction:this.options.negotiateVideo?"sendrecv":"sendonly",streams:[this._localStream]};if(this.isSimulcast){const e=["0","1","2"];r.sendEncodings=e.map((e=>({active:!0,rid:e,scaleResolutionDownBy:6*Number(e)||1})))}if(this.logger.debug("Applying videoTransceiverParams",r),t.forEach((e=>{this.instance.addTransceiver(e,r)})),this.isSfu){const{msStreamsNumber:e=5}=this.options;this.logger.debug("Add ",e,"recvonly MS Streams"),r.direction="recvonly";for(let t=0;t<Number(e);t++)this.instance.addTransceiver("video",r)}}else if("function"==typeof this.instance.addTrack){const i=this._localStream;e.forEach((e=>this.instance.addTrack(e,i))),t.forEach((e=>this.instance.addTrack(e,i)))}else this.instance.addStream(this._localStream)}this.isOffer?(this.options.negotiateAudio&&this._checkMediaToNegotiate("audio"),this.options.negotiateVideo&&this._checkMediaToNegotiate("video"),this._supportsAddTransceiver()||r||this.startNegotiation()):this.startNegotiation()}))}detachAndStop(){var e;"function"==typeof(null===(e=this.instance)||void 0===e?void 0:e.getTransceivers)&&this.instance.getTransceivers().forEach((e=>{e.sender.track&&e.sender.track.stop(),e.receiver.track&&e.receiver.track.stop()})),this.stop()}stop(){var e,t,i;null===(e=this._localStream)||void 0===e||e.getTracks().forEach((e=>e.stop())),null===(t=this._remoteStream)||void 0===t||t.getTracks().forEach((e=>e.stop())),null===(i=this.instance)||void 0===i||i.close(),this.stopWatchMediaPackets()}_supportsAddTransceiver(){return"function"==typeof this.instance.addTransceiver}_checkMediaToNegotiate(e){if(!this._getSenderByKind(e)&&this._supportsAddTransceiver()){const t=this.instance.addTransceiver(e,{direction:"recvonly"});this.logger.debug("Add transceiver",e,t)}}async _sdpReady(){var e,t;if(clearTimeout(this._iceTimeout),!this.instance.localDescription)return void this.logger.error("Missing localDescription",this.instance);const{sdp:i}=this.instance.localDescription;if(-1===i.indexOf("candidate"))return this.logger.debug("No candidate - retry \n"),void this.startNegotiation(!0);if(!this._sdpIsValid())return this.logger.info("SDP ready but not valid"),void this._onIceTimeout();this.instance.removeEventListener("icecandidate",this._onIce);try{await this.call.onLocalSDPReady(this),this.isAnswer&&(this._resolveStartMethod(),null===(e=this._pendingNegotiationPromise)||void 0===e||e.resolve())}catch(r){this._rejectStartMethod(r),null===(t=this._pendingNegotiationPromise)||void 0===t||t.reject(r)}}_sdpIsValid(){return this.localSdp&&this.hasIceServers?(e=>{try{const t=/typ (?:srflx|prflx|relay)/,i=ra().getMediaSections(e);for(const e of i){if(!ra().splitLines(e).some((e=>0===e.indexOf("a=candidate")&&t.test(e))))return!1}return!0}catch(t){return vi().error("Error checking SDP",t),!1}})(this.localSdp):Boolean(this.localSdp)}_forceNegotiation(){this.logger.info("Force negotiation again"),this._negotiating=!1,this.startNegotiation()}_onIceTimeout(){var e;if(this._sdpIsValid())return void this._sdpReady();this.logger.info("ICE gathering timeout");const t=this.getConfiguration();if("relay"===t.iceTransportPolicy){this.logger.info('RTCPeer already with "iceTransportPolicy: relay"');const t={code:"ICE_GATHERING_FAILED",message:"Ice gathering timeout"};return this._rejectStartMethod(t),null===(e=this._pendingNegotiationPromise)||void 0===e||e.reject(t),void this.call.setState("destroy")}this.setConfiguration(Object.assign(Object.assign({},t),{iceTransportPolicy:"relay"})),this._forceNegotiation()}_onIce(e){if(this._iceTimeout&&clearTimeout(this._iceTimeout),!e.candidate)return this.instance.removeEventListener("icecandidate",this._onIce),void this._sdpReady();this.logger.debug("RTCPeer Candidate:",e.candidate),"host"===e.candidate.type?this._iceTimeout=setTimeout((()=>{this.instance.removeEventListener("icecandidate",this._onIce),this._onIceTimeout()}),this.options.maxIceGatheringTimeout):this._iceTimeout=setTimeout((()=>{this.instance.removeEventListener("icecandidate",this._onIce),this._sdpReady()}),this.options.iceGatheringTimeout)}_setLocalDescription(e){const{useStereo:t,googleMaxBitrate:i,googleMinBitrate:r,googleStartBitrate:o}=this.options;return e.sdp&&t&&(e.sdp=ca(e.sdp)),e.sdp&&i&&r&&o&&(e.sdp=((e,t,i,r)=>{const o=e.split("\r\n");return o.forEach(((e,n)=>{/^a=fmtp:\d*/.test(e)?o[n]+=`;x-google-max-bitrate=${t};x-google-min-bitrate=${i};x-google-start-bitrate=${r}`:/^a=mid:(1|video)/.test(e)&&(o[n]+=`\r\nb=AS:${t}`)})),o.join("\r\n")})(e.sdp,i,r,o)),this.instance.setLocalDescription(e)}_setRemoteDescription(e){e.sdp&&this.options.useStereo&&(e.sdp=ca(e.sdp)),e.sdp&&this.instance.localDescription&&(e.sdp=((e,t)=>{const i="\r\n",r=t.split(i),o=r.findIndex(oa),n=r.findIndex(na);if(-1==n||-1==o||o<n)return e;const s=e.split(i),a=s.findIndex(oa),c=s.findIndex(na),d=s.slice(a,c),l=s.slice(c,s.length-1);return[...s.slice(0,a),...l,...d,""].join(i)})(e.sdp,this.instance.localDescription.sdp));const t=e;return this.logger.debug("REMOTE SDP \n",`Type: ${e.type}`,"\n\n",e.sdp),this.instance.setRemoteDescription(t)}async _retrieveLocalStream(){if(fs(this.options.localStream))return this.options.localStream;const e=await pa(this.options);return ua(e)}_attachListeners(){this.instance.addEventListener("signalingstatechange",(()=>{switch(this.logger.debug("signalingState:",this.instance.signalingState),this.instance.signalingState){case"stable":this._negotiating=!1,this._restartingIce=!1,this.resetNeedResume(),"connected"===this.instance.connectionState&&this.emitMediaConnected();break;case"have-local-offer":"complete"===this.instance.iceGatheringState&&this._sdpReady();break;case"closed":delete this.instance;break;default:this._negotiating=!0}})),this.instance.addEventListener("connectionstatechange",(()=>{switch(this.logger.debug("connectionState:",this.instance.connectionState),this.instance.connectionState){case"connecting":this._connectionStateTimer=setTimeout((()=>{this.logger.warn("connectionState timed out"),this.restartIceWithRelayOnly()}),this.options.maxConnectionStateTimeout);break;case"connected":this.clearConnectionStateTimer(),this.emitMediaConnected();break;case"disconnected":this.logger.debug("[test] Prevent reattach!");break;case"failed":this.triggerResume()}})),this.instance.addEventListener("negotiationneeded",(()=>{this.logger.debug("Negotiation needed event"),this.startNegotiation()})),this.instance.addEventListener("iceconnectionstatechange",(()=>{this.logger.debug("iceConnectionState:",this.instance.iceConnectionState)})),this.instance.addEventListener("icegatheringstatechange",(()=>{this.logger.debug("iceGatheringState:",this.instance.iceGatheringState)})),this.instance.addEventListener("track",(e=>{this.call.emit("track",e),this.isSfu,this._remoteStream=e.streams[0]})),this.instance.addEventListener("addstream",(e=>{e.stream&&(this._remoteStream=e.stream)})),this._attachAudioTrackListener(),this._attachVideoTrackListener()}clearTimers(){this.clearResumeTimer(),this.clearWatchMediaPacketsTimer(),this.clearConnectionStateTimer()}clearConnectionStateTimer(){clearTimeout(this._connectionStateTimer)}clearWatchMediaPacketsTimer(){clearTimeout(this._watchMediaPacketsTimer)}clearResumeTimer(){clearTimeout(this._resumeTimer),this._resumeTimer=void 0}emitMediaConnected(){this.call.emit("media.connected")}_onEndedTrackHandler(e){const t=e.target,i="audio"===t.kind?"microphone":"camera";this.call.emit(`${i}.disconnected`,{deviceId:t.id,label:t.label})}_attachAudioTrackListener(){var e;null===(e=this.localStream)||void 0===e||e.getAudioTracks().forEach((e=>{e.addEventListener("ended",this._onEndedTrackHandler)}))}_attachVideoTrackListener(){var e;null===(e=this.localStream)||void 0===e||e.getVideoTracks().forEach((e=>{e.addEventListener("ended",this._onEndedTrackHandler)}))}_detachAudioTrackListener(){var e;null===(e=this.localStream)||void 0===e||e.getAudioTracks().forEach((e=>{e.removeEventListener("ended",this._onEndedTrackHandler)}))}_detachVideoTrackListener(){var e;null===(e=this.localStream)||void 0===e||e.getVideoTracks().forEach((e=>{e.removeEventListener("ended",this._onEndedTrackHandler)}))}setConfiguration(e){var t;this.rtcConfigPolyfill=e,this.instance&&"function"==typeof(null===(t=this.instance)||void 0===t?void 0:t.setConfiguration)&&this.instance.setConfiguration(e)}getConfiguration(){var e;return this.instance&&"function"==typeof(null===(e=this.instance)||void 0===e?void 0:e.getConfiguration)?this.instance.getConfiguration():this.rtcConfigPolyfill||this.config}}function fa(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(r=Object.getOwnPropertySymbols(e);o<r.length;o++)t.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(e,r[o])&&(i[r[o]]=e[r[o]])}return i}Object.create;Object.create;"function"==typeof SuppressedError&&SuppressedError;const ya=e=>_i(e.type),ba=function*(e){vi().debug("vertoEventWorker started");const{channels:t,instance:i,initialState:r}=e,{swEventChannel:o}=t,{rtcPeerId:n}=r;if(!n)throw new Error("Missing rtcPeerId for roomSubscribedWorker");const s=Wr.createCatchableSaga((function*(e){var t,r;const{id:o,method:s,params:a={}}=e.payload,{callID:c,nodeId:d}=a,l=i.getRTCPeerById(c);if(!l)return void vi().warn(`RTCPeer '${c}' not found for method: '${s}'`,a);const u=i.peer;switch(s){case"verto.media":case"verto.answer":if(l.uuid===(null==u?void 0:u.uuid)){const e="verto.media"===s?"early":"active";i.setState(e)}(null==a?void 0:a.sdp)&&l.onRemoteSdp(a.sdp),yield Be(jr.upsert({id:null===(t=e.payload.params)||void 0===t?void 0:t.callID,nodeId:null===(r=e.payload.params)||void 0===r?void 0:r.nodeId})),yield Fe([i,i.execute],{method:i._getRPCMethod(),params:{message:ir(o,s),node_id:d}});break;case"verto.bye":yield Fe([i,i.onVertoBye],{rtcPeerId:c,byeCause:null==a?void 0:a.cause,byeCauseCode:null==a?void 0:a.causeCode,redirectDestination:null==a?void 0:a.redirectDestination}),yield Fe([i,i.execute],{method:i._getRPCMethod(),params:{message:ir(o,s),node_id:d}});break;case"verto.ping":{const{nodeId:e}=a,t=fa(a,["nodeId"]);yield Fe([i,i.execute],{method:i._getRPCMethod(),params:{message:tr(t),node_id:e}});break}case"verto.mediaParams":{if(!c||!a.mediaParams){vi().warn("Invalid mediaParams event",a);break}const{audio:e,video:t}=a.mediaParams;l&&t&&l.applyMediaConstraints("video",t),l&&e&&l.applyMediaConstraints("audio",e);break}case"verto.display":i.setActiveRTCPeer(n),i.emit("verto.display",e.payload.params);break;default:return vi().warn(`Unknown Verto method: ${s}`,a)}}),(e=>{vi().error("Verto Error",e)}));for(;;){const e=yield ze(o,(e=>{var t;return!!ya(e)&&(null===(t=e.payload.params)||void 0===t?void 0:t.callID)===n}));yield qe(s,e)}vi().trace("vertoEventWorker ended")},_a=function*(e){vi().debug("roomSubscribedWorker started");const{channels:t,instance:i,initialState:r}=e,{swEventChannel:o}=t,{rtcPeerId:n}=r;if(!n)throw new Error("Missing rtcPeerId for roomSubscribedWorker");const s=yield ze(o,(e=>("video.room.subscribed"===e.type||"call.joined"===e.type)&&e.payload.call_id===n)),a=JSON.parse(JSON.stringify(s.payload));i.setActiveRTCPeer(n);const c=s.payload.room_session.id||s.payload.room_session.room_session_id;yield Be(jr.upsert({id:s.payload.call_id,roomId:s.payload.room_session.room_id,roomSessionId:c,memberId:s.payload.member_id,previewUrl:s.payload.room_session.preview_url})),i.emit("room.subscribed",s.payload),i.emit("room.joined",wa.call(i,a)),vi().debug("roomSubscribedWorker ended",n)};function wa(e){return["room_session","room"].forEach((t=>{e[t]&&e[t].recordings&&(e[t].recordings=(e[t].recordings||[]).map((t=>{let i=this.instanceMap.get(t.id);return i?i.setPayload({room_id:e.room.room_id,room_session_id:e.room_session.id,recording:t}):i=Co.createRoomSessionRecordingObject({store:this.store,payload:{room_id:e.room.room_id,room_session_id:e.room_session.id,recording:t}}),this.instanceMap.set(t.id,i),i}))),e[t]&&e[t].playbacks&&(e[t].playbacks=(e[t].playbacks||[]).map((t=>{let i=this.instanceMap.get(t.id);return i?i.setPayload({room_id:e.room.room_id,room_session_id:e.room_session.id,playback:t}):i=Co.createRoomSessionPlaybackObject({store:this.store,payload:{room_id:e.room.room_id,room_session_id:e.room_session.id,playback:t}}),this.instanceMap.set(t.id,i),i}))),e[t]&&e[t].streams&&(e[t].streams=(e[t].streams||[]).map((t=>{let i=this.instanceMap.get(t.id);return i?i.setPayload({room_id:e.room.room_id,room_session_id:e.room_session.id,stream:t}):i=Co.createRoomSessionStreamObject({store:this.store,payload:{room_id:e.room.room_id,room_session_id:e.room_session.id,stream:t}}),this.instanceMap.set(t.id,i),i})))})),e}const ka=function*(e){vi().debug("promoteDemoteWorker started");const{channels:t,instance:i,initialState:r}=e,{swEventChannel:o}=t,{rtcPeerId:n}=r;if(!n)throw new Error("Missing rtcPeerId for promoteDemoteWorker");const s=yield ze(o,(e=>("video.member.promoted"===e.type||"video.member.demoted"===e.type)&&e.payload.member_id===i.memberId));vi().debug("promoteDemoteWorker:",s.type,s.payload),yield Be(Mr.updateAuthorization(s.payload.authorization));const a=yield Ke(us.getAuthorization);if(!a)throw new Error(`Invalid authorization for '${s.type}'`);const{audio_allowed:c,video_allowed:d}=a;switch(s.type){case"video.member.promoted":i.updateMediaOptions({audio:"both"===c,video:"both"===d,negotiateAudio:"none"!==c,negotiateVideo:"none"!==d});break;case"video.member.demoted":i.updateMediaOptions({audio:!1,video:!1,negotiateAudio:"none"!==c,negotiateVideo:"none"!==d})}i._triggerNewRTCPeer(),vi().debug("promoteDemoteWorker ended",n)},Sa=function*(e){vi().debug("sessionAuthWorker started");const{instance:t}=e;switch((yield ze([rr.authSuccessAction.type,rr.authErrorAction.type])).type){case rr.authSuccessAction.type:yield Fe([t,t.resume]);break;case rr.authErrorAction.type:yield Fe([t,t.setState],"hangup")}vi().debug("sessionAuthWorker ended")},Ca={echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},Ea=Object.assign(Object.assign({},Ca),{noiseSuppression:!1,autoGainControl:!1,googAutoGainControl:!1}),Ia={width:{ideal:1280,min:320},height:{ideal:720,min:180},aspectRatio:{ideal:16/9}},Ma={destinationNumber:"room",remoteCallerName:"Outbound Call",remoteCallerNumber:"",callerName:"",callerNumber:"",audio:Ca,video:Ia,useStereo:!1,attach:!1,screenShare:!1,additionalDevice:!1,userVariables:{},requestTimeout:1e4,autoApplyMediaParams:!0,iceGatheringTimeout:2e3,maxIceGatheringTimeout:5e3,maxConnectionStateTimeout:3e3,watchMediaPackets:!0,watchMediaPacketsTimeout:2e3};class xa extends go{constructor(e){super(e),this.leaveReason=void 0,this.gotEarly=!1,this.state="new",this.prevState="new",this.rtcPeerMap=new Map,this.resuming=!1,this.onVertoBye=e=>{this.logger.debug("onVertoBye",e);const{rtcPeerId:t,byeCause:i="NORMAL_CLEARING",byeCauseCode:r="16",redirectDestination:o}=e;this.cause=String(i),this.causeCode=String(r);const n=this.getRTCPeerById(t);return n?o&&n.localSdp?(this.logger.debug("Redirect Destination to:",o,"for RTCPeer:",n.uuid),void this.executeInvite(n.localSdp,n.uuid,o)):(n.onRemoteBye({code:this.causeCode,message:this.cause}),void(this.activeRTCPeerId===(null==n?void 0:n.uuid)&&(this.logger.debug("onVertoBye go hangup"),this.setState("hangup")))):this.logger.warn("Invalid RTCPeer to hangup",e)},this.options=Object.assign(Object.assign({},Ma),e),this._checkDefaultMediaConstraints(),this.setState("new"),this.logger.trace("New Call with Options:",this.options),this._initPeer()}get id(){return this.__uuid}get active(){return"active"===this.state}get trying(){return"trying"===this.state}get memberId(){return this.component.memberId}get previewUrl(){return this.component.previewUrl}get roomId(){return this.component.roomId}get roomSessionId(){return this.component.roomSessionId}get nodeId(){return this.component.nodeId||this.options.nodeId}get callId(){var e;return(null===(e=this.peer)||void 0===e?void 0:e.uuid)||""}get localStream(){var e;return null===(e=this.peer)||void 0===e?void 0:e.localStream}set localStream(e){this.peer&&(this.peer.localStream=e)}get remoteStream(){var e;return null===(e=this.peer)||void 0===e?void 0:e.remoteStream}get iceServers(){var e,t;return null!==(t=null===(e=this.options)||void 0===e?void 0:e.iceServers)&&void 0!==t?t:this.select(us.getIceServers)}get component(){return this.select((e=>_o.getComponent(e,this.callId)))||{}}get cameraId(){return this.peer?this.peer.getDeviceId("video"):null}get cameraLabel(){return this.peer?this.peer.getDeviceLabel("video"):null}get cameraConstraints(){return this.peer?this.peer.getTrackConstraints("video"):null}get microphoneId(){return this.peer?this.peer.getDeviceId("audio"):null}get microphoneLabel(){return this.peer?this.peer.getDeviceLabel("audio"):null}get microphoneConstraints(){return this.peer?this.peer.getTrackConstraints("audio"):null}get withAudio(){var e;return Boolean(null===(e=this.peer)||void 0===e?void 0:e.hasAudioReceiver)}get withVideo(){var e;return Boolean(null===(e=this.peer)||void 0===e?void 0:e.hasVideoReceiver)}get localAudioTrack(){return this.peer?this.peer.localAudioTrack:null}get localVideoTrack(){return this.peer?this.peer.localVideoTrack:null}get peer(){return this.getRTCPeerById(this.activeRTCPeerId)}set peer(e){if(e){if(this.logger.debug("Set RTCPeer",e.uuid,e),this.rtcPeerMap.set(e.uuid,e),this.peer&&this.peer.instance&&this.callId!==e.uuid){const e=this.peer.uuid;this.logger.debug(">>> Stop old RTCPeer",e),this.hangup(e).catch(console.error),this.peer.detachAndStop()}this.logger.debug(">>> Replace RTCPeer with",e.uuid),this.activeRTCPeerId=e.uuid}else this.logger.warn("Invalid RTCPeer",e)}emit(e,...t){return super.emit(e,...t)}dialogParams(e){const{destinationNumber:t,attach:i,callerName:r,callerNumber:o,remoteCallerName:n,remoteCallerNumber:s,userVariables:a,screenShare:c,additionalDevice:d,pingSupported:l=!0}=this.options;return{dialogParams:{id:e,destinationNumber:t,attach:i,reattaching:i,callerName:r,callerNumber:o,remoteCallerName:n,remoteCallerNumber:s,userVariables:a,screenShare:c,additionalDevice:d,pingSupported:l,version:1e3}}}getRTCPeerById(e){return this.rtcPeerMap.get(e)}appendRTCPeer(e){return this.rtcPeerMap.set(e.uuid,e)}setActiveRTCPeer(e){this.peer=this.getRTCPeerById(e)}setLocalStream(e){return new Promise((async(t,i)=>{try{if(!this.peer||!this.localStream)return i(new Error("Invalid RTCPeerConnection."));if(!fs(e))return i(new Error("Invalid stream provided."));const r=this.localStream.getAudioTracks(),o=e.getAudioTracks();o.length<=0?this.logger.info("No audio track found in the stream provided. Audio will be unaffected."):(r.forEach((e=>{var t;ws(e),null===(t=this.localStream)||void 0===t||t.removeTrack(e)})),o.forEach((e=>{var t;null===(t=this.localStream)||void 0===t||t.addTrack(e)})));const n=this.localStream.getVideoTracks(),s=e.getVideoTracks();s.length<=0?this.logger.info("No video track found in the stream provided. Video will be unaffected."):(n.forEach((e=>{var t;ws(e),null===(t=this.localStream)||void 0===t||t.removeTrack(e)})),s.forEach((e=>{var t;null===(t=this.localStream)||void 0===t||t.addTrack(e)}))),await this.updateStream(this.localStream),this.logger.debug("setLocalStream done"),t(this.localStream)}catch(r){this.logger.error("setLocalStream",r),i(r)}}))}vertoExecute(e){return this.execute({method:this._getRPCMethod(),params:e})}_getRPCMethod(){const e=this.select(us.getAuthorization);return e&&Ni(e)?"webrtc.verto":"video.message"}async _triggerNewRTCPeer(){this.logger.debug("_triggerNewRTCPeer Start");try{this.logger.debug("Build a new RTCPeer");const e=this._buildPeer("offer");this.logger.debug("Trigger start for the new RTCPeer!"),await e.start()}catch(e){this.logger.error("Error building new RTCPeer to promote/demote",e)}}updateCamera(e){return this.applyConstraintsAndRefreshStream({video:Object.assign({aspectRatio:16/9},e)})}updateMicrophone(e){return this.applyConstraintsAndRefreshStream({audio:e})}_getTransceiverDirection(e){let t="inactive";return"audio"===e&&(t=this.options.audio&&this.options.negotiateAudio?"sendrecv":this.options.audio&&!this.options.negotiateAudio?"sendonly":!this.options.audio&&this.options.negotiateAudio?"recvonly":"inactive"),"video"===e&&(t=this.options.video&&this.options.negotiateVideo?"sendrecv":this.options.video&&!this.options.negotiateVideo?"sendonly":!this.options.video&&this.options.negotiateVideo?"recvonly":"inactive"),t}manageSendersWithConstraints(e){return!1===e.audio&&(this.logger.info("Switching off the microphone"),this.stopOutboundAudio()),!1===e.video&&(this.logger.info("Switching off the camera"),this.stopOutboundVideo()),e.audio||e.video}updateConstraints(e,{attempt:t=0}={}){return t>1?Promise.reject(new Error("Failed to update constraints")):new Promise((async(i,r)=>{var o;try{if(!this.peer)return r(new Error("Invalid RTCPeerConnection."));if(!Object.keys(e).length)return r(new Error("Invalid audio/video constraints."));this.logger.debug("updateConstraints trying constraints",this.__uuid,e);if(!this.manageSendersWithConstraints(e))return this.logger.debug("Either `video` and `audio` (or both) constraints were set to `false` so their corresponding senders (if any) were stopped"),i();let s,a={};null===(o=this.localStream)||void 0===o||o.getTracks().forEach((t=>{var i;a[t.kind]=t.getConstraints(),void 0!==e[t.kind]&&(this.logger.debug("updateConstraints stop old tracks first?"),this.logger.debug("Track readyState:",t.kind,t.readyState),ws(t),t.stop(),null===(i=this.localStream)||void 0===i||i.removeTrack(t))}));try{this.logger.info("updateConstraints with",e),s=await Ts(e)}catch(n){return this.logger.error("Error updating device constraints:",n.name,n.message,n),this.logger.info("Restoring previous constraints",a),await this.updateConstraints(a,{attempt:t+1}),r(n)}this.logger.debug("updateConstraints done"),i(s)}catch(n){this.logger.error("updateConstraints",n),r(n)}}))}async updateStream(e){try{if(!this.peer)throw new Error("Invalid RTCPeerConnection.");const t=this.localVideoTrack,i=this.localAudioTrack;this.logger.debug("updateStream got stream",e),this.localStream||(this.localStream=new MediaStream);const r=e.getTracks();this.logger.debug(`updateStream got ${r.length} tracks`);for(const e of r)this.logger.debug("updateStream apply track: ",e),await this.handleTransceiverForTrack(e),this.emitDeviceUpdatedEvents({newTrack:e,prevAudioTrack:i,prevVideoTrack:t});this.logger.debug("updateStream done")}catch(t){throw this.logger.error("updateStream error",t),t}}async handleTransceiverForTrack(e){var t,i;if(!this.peer)return this.logger.error("Invalid RTCPeerConnection");const r=this.peer.instance.getTransceivers().find((({mid:t,sender:i,receiver:r})=>i.track&&i.track.kind===e.kind?(this.logger.debug("Found transceiver by sender"),!0):r.track&&r.track.kind===e.kind?(this.logger.debug("Found transceiver by receiver"),!0):null===t&&(this.logger.debug("Found disassociated transceiver"),!0)));if(r){this.logger.debug("handleTransceiverForTrack got transceiver",r.currentDirection,r.mid),(null===(t=r.sender.track)||void 0===t?void 0:t.id)!==e.id&&(await r.sender.replaceTrack(e),this.logger.debug(`handleTransceiverForTrack replaceTrack for ${e.kind}`));const i=this._getTransceiverDirection(e.kind);r.direction!==i&&(r.direction=i,this.logger.debug(`handleTransceiverForTrack set direction to ${i}`)),this.replaceOldTrack(e)}else{this.logger.debug("handleTransceiverForTrack no transceiver found; addTransceiver and start dancing!");const t=this._getTransceiverDirection(e.kind);this.peer.type="offer",null===(i=this.localStream)||void 0===i||i.addTrack(e),this.peer.instance.addTransceiver(e,{direction:t,streams:[this.localStream]})}}replaceOldTrack(e){if(!this.peer||!this.localStream)return this.logger.error("Invalid RTCPeerConnection");this.peer._detachAudioTrackListener(),this.peer._detachVideoTrackListener(),this.localStream.getTracks().forEach((t=>{var i;t.kind===e.kind&&t.id!==e.id&&(this.logger.debug("replaceOldTrack stop old track and apply new one"),ws(t),null===(i=this.localStream)||void 0===i||i.removeTrack(t))})),this.localStream.addTrack(e),"audio"===e.kind&&(this.options.micId=e.getSettings().deviceId),"video"===e.kind&&(this.options.camId=e.getSettings().deviceId),this.peer._attachAudioTrackListener(),this.peer._attachVideoTrackListener()}emitDeviceUpdatedEvents({newTrack:e,prevAudioTrack:t,prevVideoTrack:i}){"audio"===e.kind?this.emit("microphone.updated",{previous:{deviceId:null==t?void 0:t.id,label:null==t?void 0:t.label},current:{deviceId:e.id,label:e.label}}):"video"===e.kind&&this.emit("camera.updated",{previous:{deviceId:null==i?void 0:i.id,label:null==i?void 0:i.label},current:{deviceId:e.id,label:e.label}})}async applyConstraintsAndRefreshStream(e){const t=await this.updateConstraints(e);t&&await this.updateStream(t)}runRTCPeerWorkers(e){this.runWorker("vertoEventWorker",{worker:ba,initialState:{rtcPeerId:e}});!(this.options.additionalDevice||this.options.screenShare)&&(this.runWorker("roomSubscribedWorker",{worker:_a,initialState:{rtcPeerId:e}}),this.runWorker("promoteDemoteWorker",{worker:ka,initialState:{rtcPeerId:e}}))}invite(){return new Promise((async(e,t)=>{this.direction="outbound",this.peer=this._buildPeer("offer");try{await this.peer.start(),e(this)}catch(i){this.logger.error("Invite error",i),t(i)}}))}answer(){return new Promise((async(e,t)=>{this.direction="inbound",this.peer||(this.peer=this._buildPeer("answer"));try{await this.peer.start(),e(this)}catch(i){this.logger.error("Answer error",i),t(i)}}))}onLocalSDPReady(e){if(!e.instance.localDescription)throw this.logger.error("Missing localDescription",e),new Error("Invalid RTCPeerConnection localDescription");const{type:t,sdp:i}=e.instance.localDescription,r=this._mungeSDP(i);switch(this.logger.debug("LOCAL SDP \n",`Type: ${t}`,"\n\n",r),t){case"offer":return this._watchSessionAuth(),!this.resuming&&e.instance.remoteDescription?this.executeUpdateMedia(r,e.uuid):this.executeInvite(r,e.uuid);case"answer":return this.executeAnswer(r,e.uuid);default:return this.logger.error(`Unknown SDP type: '${t}' on call ${this.id}`)}}_closeWSConnection(){this._watchSessionAuth(),this.store.dispatch(rr.sessionForceCloseAction())}_watchSessionAuth(){this.sessionAuthTask&&this.sessionAuthTask.cancel(),this.sessionAuthTask=this.runWorker("sessionAuthWorker",{worker:Sa})}async resume(){var e;if(this.logger.warn(`[resume] Call ${this.id}`),null===(e=this.peer)||void 0===e?void 0:e.instance){const{connectionState:e}=this.peer.instance;this.logger.debug(`[resume] connectionState for ${this.id} is '${e}'`),"closed"!==e&&(this.resuming=!0,this.peer.restartIce())}}async executeInvite(e,t,i){const r=this.getRTCPeerById(t);if(!r||r.instance.remoteDescription&&!this.resuming)throw new Error(`RTCPeer '${t}' already has a remoteDescription. Invalid invite.`);"new"===this.state&&this.setState("requesting");try{const r=this.options.screenShare?{layout:this.options.layout,positions:this.options.positions}:{},o=Gi(Object.assign(Object.assign(Object.assign({},this.dialogParams(t)),r),{sdp:e}));let n=[];n=this.options.screenShare?["video.room.screenshare"]:this.options.additionalDevice?["video.room.additionaldevice"]:this.getSubscriptions(),this.logger.debug("Subscribing to",n);const s=await this.vertoExecute({message:o,callID:t,node_id:null!=i?i:this.options.nodeId,subscribe:n});this.logger.debug("Invite response",s),this.resuming=!1}catch(o){throw this.setState("hangup"),o}}async executeAnswer(e,t,i){"new"===this.state&&this.setState("answering");try{const r=Yi(Object.assign(Object.assign({},this.dialogParams(t)),{sdp:e})),o=await this.vertoExecute({message:r,callID:t,node_id:null!=i?i:this.options.nodeId,subscribe:this.getSubscriptions()});this.logger.debug("Answer response",o),this.resuming=!1,this.setActiveRTCPeer(t)}catch(r){throw this.setState("hangup"),r}}async executeUpdateMedia(e,t){var i,r;try{const i=Xi(Object.assign(Object.assign({},this.dialogParams(t)),{sdp:e,action:"updateMedia"})),r=await this.vertoExecute({message:i,callID:t,node_id:this.nodeId});if(this.logger.debug("UpdateMedia response",r),!this.peer)return this.logger.error("Invalid RTCPeer to updateMedia");if(!r.sdp)return this.logger.error("UpdateMedia invalid SDP answer",r);await this.peer.onRemoteSdp(r.sdp)}catch(o){throw this.logger.error("UpdateMedia error",o),null===(r=null===(i=this.peer)||void 0===i?void 0:i._pendingNegotiationPromise)||void 0===r||r.reject(o),o}}async hangup(e){const t=null!=e?e:this.callId;if(!t)throw new Error("Invalid RTCPeer ID to hangup");try{const e=Zi(this.dialogParams(t));await this.vertoExecute({message:e,callID:t,node_id:this.nodeId})}catch(i){this.logger.error("Hangup error:",i)}finally{if(t!==this.callId)return this.logger.warn("Prevent setState hangup",t,this.callId);this.setState("hangup")}}async hangupAll(){const e=this.callId;if(!e)throw new Error("Invalid RTCPeer ID to hangup");try{const t=Zi(Object.assign({cause:"REJECT_ALL",causeCode:"825"},this.dialogParams(e)));await this.vertoExecute({message:t,callID:e,node_id:this.nodeId})}catch(t){this.logger.error("HangupAll error:",t)}finally{this.setState("hangup")}}async sendDigits(e){const t=this.callId;if(!t)throw new Error("Invalid RTCPeer ID to send DTMF");const i=Qi(Object.assign(Object.assign({},this.dialogParams(t)),{dtmf:e}));await this.vertoExecute({message:i,callID:t,node_id:this.nodeId})}doReinviteWithRelayOnly(){this.peer&&this.active&&this.peer.restartIceWithRelayOnly()}stopOutboundAudio(){this.peer&&this.active&&this.peer.stopTrackSender("audio")}restoreOutboundAudio(){this.peer&&this.active&&this.peer.restoreTrackSender("audio")}stopOutboundVideo(){this.peer&&this.active&&this.peer.stopTrackSender("video")}restoreOutboundVideo(){this.peer&&this.active&&this.peer.restoreTrackSender("video")}setState(e){switch(this.prevState=this.state,this.state=e,this.logger.trace(`Call ${this.id} state change from ${this.prevState} to ${this.state}`),this.emit(this.state,this),e){case"purge":case"destroy":this._finalize();break;case"hangup":this.setState("destroy")}}updateMediaOptions(e){this.logger.debug("updateMediaOptions",Object.assign({},e)),this.options=Object.assign(Object.assign({},this.options),e),this._checkDefaultMediaConstraints()}_mungeSDP(e){return(e=>{const t=/^a=candidate.*.local\ .*/;return e.split("\r\n").filter((e=>!t.test(e))).join("\r\n")})(e)}_checkDefaultMediaConstraints(){!0===this.options.video&&(this.options.video=Ia),!0===this.options.audio&&(this.options.audio=this.options.screenShare?Ea:Ca)}_initPeer(){this.options.remoteSdp&&(this.peer=this._buildPeer("answer"))}_buildPeer(e){const t=new va(this,e);return this.appendRTCPeer(t),this.runRTCPeerWorkers(t.uuid),t}_finalize(){this.rtcPeerMap.forEach((e=>{e.stop()})),this.rtcPeerMap.clear()}_upsertTransceiverByKind(e,t){if(!this.peer)return this.logger.error("Invalid RTCPeerConnection");let i=this.peer.instance.getTransceivers().find((e=>{var i,r;return(null===(i=e.sender.track)||void 0===i?void 0:i.kind)===t||(null===(r=e.receiver.track)||void 0===r?void 0:r.kind)===t}));if(i){if(i.direction===e)return void this.logger.info(`Transceiver ${t} has the same direction "${e}".`);i.direction=e,this.logger.info(`Updated ${t} transceiver to "${e}" mode.`)}else"inactive"!==e&&(this.peer.type="offer",i=this.peer.instance.addTransceiver(t,{direction:e}),this.logger.info(`Added ${t} transceiver in "${e}" mode.`));"stopped"===e||"inactive"===e?(this.peer.stopTrackReceiver(t),this.peer.stopTrackSender(t)):"sendonly"===e?this.peer.stopTrackReceiver(t):"recvonly"===e&&this.peer.stopTrackSender(t)}async updateMedia(e){var t,i,r,o,n,s;try{const{audio:n,video:s}=e;if(!this.peer)throw new Error("Invalid RTCPeerConnection");if(this.peer.isNegotiating)throw new Error("The peer is already negotiating the media!");const a=this.peer,c=new Promise(((e,t)=>{a._pendingNegotiationPromise={resolve:e,reject:t}})),d=["sendonly","sendrecv"].includes((null==n?void 0:n.direction)||""),l=["sendonly","sendrecv"].includes((null==s?void 0:s.direction)||""),u=["sendrecv","receive"].includes((null==n?void 0:n.direction)||""),h=["sendrecv","receive"].includes((null==s?void 0:s.direction)||"");if(this.updateMediaOptions(Object.assign(Object.assign(Object.assign(Object.assign({},n&&{audio:null!==(t=null==n?void 0:n.constraints)&&void 0!==t?t:d}),s&&{video:null!==(i=null==s?void 0:s.constraints)&&void 0!==i?i:l}),n&&{negotiateAudio:u}),s&&{negotiateVideo:h})),await this.applyConstraintsAndRefreshStream(Object.assign(Object.assign({},n&&{audio:null!==(r=null==n?void 0:n.constraints)&&void 0!==r?r:d}),s&&{video:null!==(o=null==s?void 0:s.constraints)&&void 0!==o?o:l})),n&&!d&&this._upsertTransceiverByKind(n.direction,"audio"),s&&!l&&this._upsertTransceiverByKind(s.direction,"video"),await this.peer.startNegotiation(),await c,!la({localSdp:this.peer.localSdp,remoteSdp:this.peer.remoteSdp,media:"audio"}))throw new Error("The server did not set the audio direction correctly");if(!la({localSdp:this.peer.localSdp,remoteSdp:this.peer.remoteSdp,media:"video"}))throw new Error("The server did not set the video direction correctly")}catch(a){throw null===(s=null===(n=this.peer)||void 0===n?void 0:n._pendingNegotiationPromise)||void 0===s||s.reject(a),a}}async setAudioDirection(e){if(!["sendonly","sendrecv","recvonly","inactive"].includes(e))throw new Error("Invalid direction specified");return this.updateMedia({audio:{direction:e}})}async setVideoDirection(e){if(!["sendonly","sendrecv","recvonly","inactive"].includes(e))throw new Error("Invalid direction specified");return this.updateMedia({video:{direction:e}})}async hold(){const e=Xi(Object.assign(Object.assign({},this.dialogParams(this.callId)),{action:"hold"}));await this.vertoExecute({message:e,callID:this.callId,node_id:this.nodeId})}async unhold(){const e=Xi(Object.assign(Object.assign({},this.dialogParams(this.callId)),{action:"unhold"}));this.vertoExecute({message:e,callID:this.callId,node_id:this.nodeId})}}function Pa(e){this.message=e}Pa.prototype=new Error,Pa.prototype.name="InvalidCharacterError";var Ta="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new Pa("'atob' failed: The string to be decoded is not correctly encoded.");for(var i,r,o=0,n=0,s="";r=t.charAt(n++);~r&&(i=o%4?64*i+r:r,o++%4)?s+=String.fromCharCode(255&i>>(-2*o&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return s};function Ra(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(Ta(e).replace(/(.)/g,(function(e,t){var i=t.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i})))}(t)}catch(e){return Ta(t)}}function Aa(e){this.message=e}Aa.prototype=new Error,Aa.prototype.name="InvalidTokenError";const Oa=function(e,t){if("string"!=typeof e)throw new Aa("Invalid token specified");var i=!0===(t=t||{}).header?0:1;try{return JSON.parse(Ra(e.split(".")[i]))}catch(e){throw new Aa("Invalid token specified: "+e.message)}};var La=Object.defineProperty,ja=Object.defineProperties,Va=Object.getOwnPropertyDescriptors,Da=Object.getOwnPropertySymbols,Wa=Object.prototype.hasOwnProperty,Na=Object.prototype.propertyIsEnumerable,$a=(e,t,i)=>t in e?La(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Ua=(e,t)=>{for(var i in t||(t={}))Wa.call(t,i)&&$a(e,i,t[i]);if(Da)for(var i of Da(t))Na.call(t,i)&&$a(e,i,t[i]);return e},za=(e,t)=>ja(e,Va(t)),Ba=(e,t)=>{var i={};for(var r in e)Wa.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&Da)for(var r of Da(e))t.indexOf(r)<0&&Na.call(e,r)&&(i[r]=e[r]);return i},Ha=(e,t)=>{for(var i in t)La(e,i,{get:t[i],enumerable:!0})},Fa=(e,t,i)=>$a(e,"symbol"!=typeof t?t+"":t,i);Ha({},{ChatMember:()=>Fn,ChatMessage:()=>Hn,Client:()=>sd});var qa=rr.createAction("swJs/audioSetSpeakerAction"),Ja=({speakerId:e})=>function*({instance:t,runSaga:i}){if("undefined"!=typeof Audio)try{const r=t.getAudioEl();let o;const n=function(n){if("audio"===n.track.kind)o=i(Ga,{track:n.track,element:r,speakerId:e,room:t})};t.on("track",n),t.once("destroy",(()=>{null==o||o.cancel()}))}catch(r){vi().error("audioElementSaga",r)}else vi().warn("`Audio` is not supported on this environment.")};function*Ka({element:e,room:t}){const i=rr.getCustomSagaActionType(t.__uuid,qa);for(;;){const o=yield ze([i]);try{if(o.type===i){const i=yield Fe(bs,e,o.payload);t.emit(`${oi}.speaker.updated`,o.payload),t.settleCustomSagaTrigger({dispatchId:o.dispatchId,payload:i,kind:"resolve"})}}catch(r){t.settleCustomSagaTrigger({dispatchId:o.dispatchId,payload:r,kind:"reject"}),vi().error(r)}}}function*Ga({track:e,element:t,speakerId:i,room:r}){(({track:e,element:t})=>{t.autoplay=!0,t.playsinline=!0,t.srcObject=new MediaStream([e]),e.addEventListener("ended",(()=>{t.srcObject=null,t.remove()}))})({track:e,element:t}),i&&bs(t,i).catch((()=>{})),yield qe(Ka,{element:t,room:r})}var Za=function*(e){vi().trace("videoManagerRoomsWorker started");const{instance:t,action:{type:i,payload:r}}=e,o={rooms:r.rooms.map((e=>Ci(e)))};t.emit(Pi(i),o),vi().trace("videoManagerRoomsWorker ended")},Xa=function*(e){vi().trace("videoManagerRoomWorker started");const{instance:t,action:{type:i,payload:r}}=e;t.emit(Pi(i),Ci(r)),vi().trace("videoManagerRoomWorker ended")},Qa=function*(e){vi().trace("videoManagerWorker started");const{channels:{swEventChannel:t}}=e;function*i(t){const{type:i}=t;switch(i){case"video-manager.rooms.subscribed":yield qe(Za,Ua({action:t},e));break;case"video-manager.room.added":case"video-manager.room.deleted":case"video-manager.room.ended":case"video-manager.room.started":case"video-manager.room.updated":yield qe(Xa,Ua({action:t},e));break;default:vi().warn(`Unknown video-manager event: "${i}"`)}}for(;;){const e=yield ze(t,(e=>e.type.startsWith("video-manager.")));yield qe(i,e)}vi().trace("videoManagerWorker ended")},Ya=class extends fo{constructor(e){super(e),this.runWorker("videoManagerWorker",{worker:Qa})}getSubscriptions(){const e=this.eventNames().map((e=>`video-manager.${e}`));return Vi(e)}},ec={echoCancellation:!0,noiseSuppression:!1,autoGainControl:!1,googAutoGainControl:!1},tc="sw-sdk-",ic="sw-overlay-",rc=e=>`${ic}${e}`,oc=xi(class extends xa{join(){return super.invite()}leave(){return super.hangup()}},{audioMute:Co.audioMuteMember,audioUnmute:Co.audioUnmuteMember,videoMute:Co.videoMuteMember,videoUnmute:Co.videoUnmuteMember,setMicrophoneVolume:Co.setInputVolumeMember,setInputVolume:Co.setInputVolumeMember,setInputSensitivity:Co.setInputSensitivityMember}),nc=()=>{},sc="memberList.updated",ac=(e=>{const t=e.split(".")[0];return e.split(".").reduce(((e,i)=>(e.push(i),i===t&&e.push(ni),e)),[]).join(".")})((({event:e,namespace:t})=>("string"==typeof e&&(e=Ii({event:e,namespace:t}),e=yi(e)),e))({event:sc})),cc=["video.room.joined","video.member.joined","video.member.left","video.member.updated"],dc=(e,t)=>{const i=(e=>Vi(cc).filter((t=>!e.includes(t))))(t);i.forEach((t=>{e.once(t,nc)}));const r=({members:t})=>{e.emit(sc,{members:t})};e.on(ac,r);return{cleanup:()=>{e.off(ac,r)}}};function*lc({swEventChannel:e,instance:t}){const i=new Map;function*r(e){const r="video.room.joined"===e.type?e.payload.room_session.id:e.payload.room_session_id,o=(({action:e,memberList:t})=>{const i=(e=>"video.room.joined"===e.type?e.payload.room_session.members:[e.payload.member])(e);"video.member.left"===e.type?i.forEach((e=>{t.delete(e.id)})):i.forEach((e=>{t.set(e.id,e)}));return Array.from(t.values())})({action:e,memberList:i}),n={room_session_id:r,members:o};t.emit(ac,n)}for(;;){const t=yield ze(e,(({type:e})=>{return t=e,cc.includes(t);var t}));yield qe(r,t)}}var uc=function*({channels:{swEventChannel:e},instance:t}){const i=t.getSubscriptions();if(!(e=>e.some((e=>e.includes(sc))))(i))return;const{cleanup:r}=dc(t,i);yield qe(lc,{swEventChannel:e,instance:t}),t.once("destroy",(()=>{r()}))},hc=function*(e){vi().trace("childMemberJoinedWorker started");const{channels:t,instance:i,initialState:r,onDone:o,onFail:n}=e,{swEventChannel:s}=t,{parentId:a}=r;if(!a)throw new Error("Missing parentId for childMemberJoinedWorker");const c=yield ze(s,(e=>"video.member.joined"===e.type&&e.payload.member.parent_id===a)),{member:d}=c.payload;if(null==d?void 0:d.parent_id){const e=yield Ke(_o.getComponentsById);Object.values(e).find((e=>"memberId"in e&&e.memberId===d.parent_id))?(yield Be(jr.upsert({id:i.callId,roomId:c.payload.room_id,roomSessionId:c.payload.room_session_id,memberId:d.id})),null==o||o()):null==n||n({error:new Error("Unknown parent_id")})}vi().trace("childMemberJoinedWorker ended")},mc=function*(e){vi().trace("videoStreamWorker started");const{instance:t,action:{type:i,payload:r},instanceMap:{get:o,set:n,remove:s}}=e;let a=o(r.stream.id);switch(a?a.setPayload(r):a=Co.createRoomSessionStreamObject({store:t.store,payload:r}),n(r.stream.id,a),i){case"video.stream.started":t.emit("stream.started",a);break;case"video.stream.ended":t.emit("stream.ended",a),s(r.stream.id);break;default:vi().warn(`Unknown video.stream event: "${i}"`)}vi().trace("videoStreamWorker ended")},pc=function*(e){vi().trace("videoRecordWorker started");const{instance:t,action:{type:i,payload:r},instanceMap:{get:o,set:n,remove:s}}=e;let a=o(r.recording.id);a?a.setPayload(r):a=Co.createRoomSessionRecordingObject({store:t.store,payload:r}),n(r.recording.id,a);const c=Pi(i);switch(i){case"video.recording.started":case"video.recording.updated":t.emit(c,a);break;case"video.recording.ended":t.emit(c,a),s(r.recording.id);break;default:vi().warn(`Unknown video.stream event: "${i}"`)}vi().trace("videoRecordWorker ended")},gc=function*(e){vi().trace("videoPlaybackWorker started");const{instance:t,action:{type:i,payload:r},instanceMap:{get:o,set:n,remove:s}}=e;let a=o(r.playback.id);a?a.setPayload(r):a=Co.createRoomSessionPlaybackObject({store:t.store,payload:r}),n(r.playback.id,a);const c=Pi(i);switch(i){case"video.playback.started":case"video.playback.updated":t.emit(c,a);break;case"video.playback.ended":t.emit(c,a),s(r.playback.id);break;default:vi().warn(`Unknown video.stream event: "${i}"`)}vi().trace("videoPlaybackWorker ended")},vc=function*(e){vi().trace("videoWorker started");const{channels:t,instance:i}=e,{swEventChannel:r}=t;function*o(t){const{type:r,payload:o}=t;switch(r){case"video.room.subscribed":return void(yield qe(Gn.memberPositionWorker,za(Ua({},e),{instance:i,initialState:o})));case"video.playback.started":case"video.playback.updated":case"video.playback.ended":return void(yield qe(gc,Ua({action:t},e)));case"video.recording.started":case"video.recording.updated":case"video.recording.ended":return void(yield qe(pc,Ua({action:t},e)));case"video.stream.ended":case"video.stream.started":return void(yield qe(mc,Ua({action:t},e)));case"video.room.audience_count":return void i.emit("room.audienceCount",o);case"video.member.talking":{const{member:e}=o;if("talking"in e){const t=e.talking?"started":"ended";i.emit(`member.talking.${t}`,o);const r=e.talking?"start":"stop";i.emit(`member.talking.${r}`,o)}break}case"video.layout.changed":i.currentLayoutEvent=t.payload}const n=Pi(r,"video");i.emit(n,o)}const n=e=>e.type.startsWith("video.");for(;;){const e=yield ze(r,n);yield qe(o,e)}vi().trace("videoWorker ended")},fc=class extends xa{constructor(){super(...arguments),Fa(this,"_screenShareList",new Set),Fa(this,"_audioEl"),Fa(this,"_overlayMap"),Fa(this,"_localVideoOverlay")}get audioEl(){return this._audioEl}set overlayMap(e){this._overlayMap=e}get overlayMap(){return this._overlayMap}set localVideoOverlay(e){this._localVideoOverlay=e}get localVideoOverlay(){return this._localVideoOverlay}get screenShareList(){return Array.from(this._screenShareList)}_attachSpeakerTrackListener(){ys()&&Xs().then((e=>{e.on("removed",(async e=>{var t,i;const r=this._audioEl.sinkId,o=e.changes.find((e=>{const t=e.payload.deviceId;return t===r||""===t&&"default"===r||"default"===t&&""===r}));if(o){this.emit("speaker.disconnected",{deviceId:o.payload.deviceId,label:o.payload.label}),await(null==(i=(t=this._audioEl).setSinkId)?void 0:i.call(t,""));const e=await ta("default");if(!(null==e?void 0:e.deviceId))return;this.emit("speaker.updated",{previous:{deviceId:o.payload.deviceId,label:o.payload.label},current:{deviceId:e.deviceId,label:e.label}})}}))}))}_finalize(){this._screenShareList.clear(),super._finalize()}async hangup(e){return this._screenShareList.forEach((e=>{e.leave()})),super.hangup(e)}leave(){return this.hangup()}attachPreConnectWorkers(){this.runWorker("memberListUpdated",{worker:uc})}getAudioEl(){return this._audioEl||(this._audioEl=new Audio,this._attachSpeakerTrackListener()),this._audioEl}getMemberOverlay(e){return this.overlayMap.get(rc(e))}async startScreenShare(e={}){return new Promise((async(t,i)=>{var r;const{autoJoin:o=!0,audio:n=!1,video:s=!0,layout:a,positions:c}=e;try{const e=await Rs({audio:!0===n?ec:n,video:s}),d=za(Ua({},this.options),{screenShare:!0,recoverCall:!1,localStream:e,remoteStream:void 0,userVariables:za(Ua({},(null==(r=this.options)?void 0:r.userVariables)||{}),{memberCallId:this.callId,memberId:this.memberId}),layout:a,positions:c}),l=co({store:this.store,Component:oc})(d);return e.getVideoTracks().forEach((e=>{e.addEventListener("ended",(()=>{l&&l.active&&l.leave()}))})),l.once("destroy",(()=>{l.emit("room.left"),this._screenShareList.delete(l)})),l.runWorker("childMemberJoinedWorker",{worker:hc,onDone:()=>t(l),onFail:i,initialState:{parentId:this.memberId}}),this._screenShareList.add(l),o?await l.join():t(l)}catch(d){this.logger.error("ScreenShare Error",d),i(d)}}))}updateSpeaker({deviceId:e}){const t=this.audioEl.sinkId;return this.once(`${oi}.speaker.updated`,(async e=>{const i=await ta(t),r=await ta(e),o=(null==r?void 0:r.deviceId)===(null==i?void 0:i.deviceId);(null==r?void 0:r.deviceId)&&!o&&this.emit("speaker.updated",{previous:{deviceId:null==i?void 0:i.deviceId,label:null==i?void 0:i.label},current:{deviceId:r.deviceId,label:r.label}})})),this.triggerCustomSaga(qa(e))}},yc=xi(class extends xa{join(){return super.invite()}leave(){return super.hangup()}},{audioMute:Co.audioMuteMember,audioUnmute:Co.audioUnmuteMember,videoMute:Co.videoMuteMember,videoUnmute:Co.videoUnmuteMember,setInputVolume:Co.setInputVolumeMember,setMicrophoneVolume:Co.setInputVolumeMember,setInputSensitivity:Co.setInputSensitivityMember}),bc=class extends fc{constructor(e){super(e),Fa(this,"_deviceList",new Set),Fa(this,"_currentLayoutEvent"),this.initWorker()}set currentLayoutEvent(e){this._currentLayoutEvent=e}get currentLayoutEvent(){return this._currentLayoutEvent}get currentLayout(){var e;return null==(e=this._currentLayoutEvent)?void 0:e.layout}get currentPosition(){var e,t;return null==(t=null==(e=this._currentLayoutEvent)?void 0:e.layout.layers.find((e=>e.member_id===this.memberId)))?void 0:t.position}get deviceList(){return Array.from(this._deviceList)}get interactivityMode(){return this.select((({session:e})=>{var t;const{authorization:i}=e;return null!=(t=null==i?void 0:i.join_as)?t:""}))}get permissions(){return this.select((({session:e})=>{var t,i;const{authorization:r}=e;return null!=(i=null==(t=null==r?void 0:r.room)?void 0:t.scopes)?i:[]}))}initWorker(){this.runWorker("videoWorker",{worker:vc})}getSubscriptions(){const e=this.eventNames().map((e=>`video.${String(e)}`));return Vi(e)}_finalize(){this._deviceList.clear(),super._finalize()}async hangup(e){return this._deviceList.forEach((e=>{e.leave()})),super.hangup(e)}join(){return super.invite()}getLayoutList(){return this.getLayouts()}getMemberList(){return this.getMembers()}async createScreenShareObject(e={}){return this.startScreenShare(e)}addCamera(e={}){const t=e,{autoJoin:i=!0}=t,r=Ba(t,["autoJoin"]);return this.addDevice({autoJoin:i,video:r})}addMicrophone(e={}){const t=e,{autoJoin:i=!0}=t,r=Ba(t,["autoJoin"]);return this.addDevice({autoJoin:i,audio:r})}async addDevice(e={}){return new Promise((async(t,i)=>{var r;const{autoJoin:o=!0,audio:n=!1,video:s=!1}=e;if(!n&&!s)throw new TypeError("At least one of `audio` or `video` must be requested.");const a=za(Ua({},this.options),{localStream:void 0,remoteStream:void 0,audio:n,video:s,additionalDevice:!0,recoverCall:!1,userVariables:za(Ua({},(null==(r=this.options)?void 0:r.userVariables)||{}),{memberCallId:this.callId,memberId:this.memberId})}),c=co({store:this.store,Component:yc})(a);c.once("destroy",(()=>{c.emit("room.left"),this._deviceList.delete(c)}));try{return c.runWorker("childMemberJoinedWorker",{worker:hc,onDone:()=>t(c),onFail:i,initialState:{parentId:this.memberId}}),this._deviceList.add(c),o?await c.join():t(c)}catch(d){this.logger.error("RoomDevice Error",d),i(d)}}))}},_c=xi(bc,{audioMute:Co.audioMuteMember,audioUnmute:Co.audioUnmuteMember,videoMute:Co.videoMuteMember,videoUnmute:Co.videoUnmuteMember,deaf:Co.deafMember,undeaf:Co.undeafMember,setInputVolume:Co.setInputVolumeMember,setOutputVolume:Co.setOutputVolumeMember,setMicrophoneVolume:Co.setInputVolumeMember,setSpeakerVolume:Co.setOutputVolumeMember,setInputSensitivity:Co.setInputSensitivityMember,removeMember:Co.removeMember,removeAllMembers:Co.removeAllMembers,getMembers:Co.getMembers,getLayouts:Co.getLayouts,setLayout:Co.setLayout,setPositions:Co.setPositions,setMemberPosition:Co.setMemberPosition,hideVideoMuted:Co.hideVideoMuted,showVideoMuted:Co.showVideoMuted,getRecordings:Co.getRecordings,startRecording:Co.startRecording,getPlaybacks:Co.getPlaybacks,play:Co.play,setHideVideoMuted:Co.setHideVideoMuted,getMeta:Co.getMeta,setMeta:Co.setMeta,updateMeta:Co.updateMeta,deleteMeta:Co.deleteMeta,getMemberMeta:Co.getMemberMeta,setMemberMeta:Co.setMemberMeta,updateMemberMeta:Co.updateMemberMeta,deleteMemberMeta:Co.deleteMemberMeta,promote:Co.promote,demote:Co.demote,getStreams:Co.getStreams,startStream:Co.startStream,lock:Co.lock,unlock:Co.unlock,setRaisedHand:Co.setRaisedHand,setPrioritizeHandraise:Co.setPrioritizeHandraise}),wc=e=>e instanceof bc,kc=()=>{if(window&&window.sessionStorage)return window.sessionStorage},Sc=e=>{var t;let i="";try{const r=Oa(e);i=null!=(t=null==r?void 0:r.r)?t:""}catch(Pa){try{i=Oa(e,{header:!0}).typ||""}catch(o){0,i=""}}const r=Boolean(i);return{authStateKey:r&&`as-${i}`,protocolKey:r&&`pt-${i}`,callIdKey:r&&`ci-${i}`}},Cc="ci-SAT",Ec=function*(e){vi().debug("wsClientWorker started");const{channels:t,initialState:i,instance:r}=e,{swEventChannel:o}=t,{handleIncomingInvite:n}=i;function*s(e){r.emit(e.type,e.payload)}function*a(e){n(e.payload.params)}const c=e=>"webrtc.message"===e.type&&"verto.invite"===e.payload.method;try{for(;;){const e=yield ze(o,(()=>!0));yield qe(s,e),c(e)&&(vi().debug("Receiving a call over WebSocket",e),yield qe(a,e))}}finally{vi().trace("wsClientWorker ended")}},Ic=function*(e){vi().debug("conversationWorker started");const{channels:{swEventChannel:t},initialState:i}=e,{conversation:r}=i,o=e=>e.type.startsWith("conversation.");for(;;){const e=yield ze(t,o);r.handleEvent(e.payload)}vi().trace("conversationWorker ended")},Mc=class extends go{constructor(e){super(e),Fa(this,"_payload"),this._payload=e.payload}get id(){return this._payload.member.member_id}get callId(){return this._payload.member.call_id}get nodeId(){return this._payload.member.node_id}get memberId(){return this.id}get roomSessionId(){return this._payload.room_session_id}get roomId(){return this._payload.room_id}get parentId(){return this._payload.member.parent_id}get name(){return this._payload.member.name}get type(){return this._payload.member.type}get requestedPosition(){return this._payload.member.requested_position}get currentPosition(){return this._payload.member.current_position}get meta(){return this._payload.member.meta}get handraised(){return this._payload.member.handraised}get talking(){return this._payload.member.talking}get audioMuted(){return this._payload.member.audio_muted}get videoMuted(){return this._payload.member.video_muted}get deaf(){return this._payload.member.deaf}get visible(){return this._payload.member.visible}get inputVolume(){return this._payload.member.input_volume}get outputVolume(){return this._payload.member.output_volume}get inputSensitivity(){return this._payload.member.input_sensitivity}get subscriberData(){return this._payload.member.subscriber_data}setPayload(e){const t=za(Ua(Ua({},this._payload),e),{member:Ua(Ua({},this._payload.member),e.member)});this._payload=t}},xc=e=>co({store:e.store,Component:Mc})(e),Pc=function*(e){vi().trace("callLeftWorker started");const{action:{payload:t},instance:i,instanceMap:r}=e,{room_session_id:o}=t;r.getAll().forEach((([e,t])=>{t instanceof Mc&&t.roomSessionId===o&&r.remove(e)})),i.emit("call.left",t),i.emit("room.left",t),vi().trace("callLeftWorker ended")},Tc=function*(e){vi().trace("fabricMemberWorker started");const{instance:t,action:{type:i,payload:r},instanceMap:{get:o,set:n,remove:s}}=e,a=r.member.member_id;let c=o(a);if(c||"member.talking"===i||(c=xc({store:t.store,payload:r})),c&&c.setPayload(r),n(a,c),i.startsWith("member.updated.")){const e=Ei(i);t.emit(e,r)}switch(i){case"member.joined":case"member.updated":case"member.talking":t.emit(i,r);break;case"member.left":t.emit(i,r),s(a)}vi().trace("fabricMemberWorker ended")},Rc=e=>({id:e.member_id,room_id:e.room_id,room_session_id:e.room_session_id,name:e.name,type:e.type,handraised:e.handraised,visible:e.visible,audio_muted:e.audio_muted,video_muted:e.video_muted,deaf:e.deaf,input_volume:e.input_volume,output_volume:e.output_volume,input_sensitivity:e.input_sensitivity,meta:e.meta,talking:e.talking,current_position:e.current_position,requested_position:e.requested_position,parent_id:e.parent_id}),Ac=e=>za(Ua({},Rc(e)),{updated:e.updated.map((e=>"member_id"===e?"id":e))}),Oc=e=>({room_id:e.room_id,room_session_id:e.room_session_id,event_channel:e.event_channel,name:e.name,recording:e.recording,hide_video_muted:e.hide_video_muted,preview_url:e.preview_url,recordings:e.recordings,playbacks:e.playbacks,streams:e.streams,prioritize_handraise:e.prioritize_handraise}),Lc=e=>({id:e.id,display_name:e.display_name,room_id:e.room_id,room_session_id:e.room_session_id,event_channel:e.event_channel,name:e.name,recording:e.recording,recordings:e.recordings,playbacks:e.playbacks,hide_video_muted:e.hide_video_muted,preview_url:e.preview_url,layout_name:e.layout_name,locked:e.locked,meta:e.meta,members:e.members.map(Rc),streaming:e.streaming,streams:e.streams,prioritize_handraise:e.prioritize_handraise,updated:e.updated}),jc=class{constructor(e){this._flags=e}get on(){return this._flags.some((e=>!e.endsWith(".off")))}get off(){return this._flags.some((e=>!e.endsWith(".on")))}},Vc=class{constructor(e,t){this._flags=e,this._memberType=t,Fa(this,"_muteAudio"),Fa(this,"_muteVideo"),Fa(this,"_deaf"),Fa(this,"_raisehand")}get muteAudio(){var e;return this._muteAudio=null!=(e=this._muteAudio)?e:new jc(this._flags.filter((e=>e===this._memberType||e===`${this._memberType}.mute`||e.startsWith(`${this._memberType}.mute.audio`)))),this._muteAudio}get muteVideo(){var e;return this._muteVideo=null!=(e=this._muteVideo)?e:new jc(this._flags.filter((e=>e===this._memberType||e===`${this._memberType}.mute`||e.startsWith(`${this._memberType}.mute.video`)))),this._muteVideo}get microphoneVolume(){return this._flags.some((e=>e===this._memberType||e===`${this._memberType}.microphone`||e.startsWith(`${this._memberType}.microphone.volume`)))}get microphoneSensitivity(){return this._flags.some((e=>e===this._memberType||e===`${this._memberType}.microphone`||e.startsWith(`${this._memberType}.microphone.sensitivity`)))}get speakerVolume(){return this._flags.some((e=>e===this._memberType||e===`${this._memberType}.speaker`||e.startsWith(`${this._memberType}.speaker.volume`)))}get deaf(){var e;return this._deaf=null!=(e=this._deaf)?e:new jc(this._flags.filter((e=>e===this._memberType||e.startsWith(`${this._memberType}.deaf`)))),this._deaf}get raisehand(){var e;return this._raisehand=null!=(e=this._raisehand)?e:new jc(this._flags.filter((e=>e===this._memberType||e.startsWith(`${this._memberType}.raisehand`)))),this._raisehand}get position(){return this._flags.some((e=>e===this._memberType||e.startsWith(`${this._memberType}.position`)))}get meta(){return this._flags.some((e=>e===this._memberType||e.startsWith(`${this._memberType}.meta`)))}get remove(){return this._flags.some((e=>e===this._memberType||e.startsWith(`${this._memberType}.remove`)))}},Dc=class{constructor(e){this._flags=e,Fa(this,"_self"),Fa(this,"_member"),Fa(this,"_vmutedHide"),Fa(this,"_lock")}_buildMemberCapability(e){return new Vc(this._flags.filter((t=>t.startsWith(e))),e)}get self(){var e;return this._self=null!=(e=this._self)?e:this._buildMemberCapability("self"),this._self}get member(){var e;return this._member=null!=(e=this._member)?e:this._buildMemberCapability("member"),this._member}get end(){return this._flags.some((e=>"end"===e))}get setLayout(){return this._flags.some((e=>e.startsWith("layout")))}get sendDigit(){return this._flags.some((e=>e.startsWith("digit")))}get vmutedHide(){var e;return this._vmutedHide=null!=(e=this._vmutedHide)?e:new jc(this._flags.filter((e=>e.startsWith("vmuted")))),this._vmutedHide}get lock(){var e;return this._lock=null!=(e=this._lock)?e:new jc(this._flags.filter((e=>e.startsWith("lock")))),this._lock}get device(){return this._flags.some((e=>"device"===e))}get screenshare(){return this._flags.some((e=>"screenshare"===e))}},Wc=function*(e){var t;vi().trace("callJoinWorker started");const{action:i,instanceMap:r,instance:o}=e,{payload:n}=i,{get:s,set:a}=r;var c,d;yield qe(Gn.memberPositionWorker,za(Ua({},e),{initialState:(c=n,{call_id:c.call_id,member_id:c.member_id,room:za(Ua({},Oc(c.room_session)),{members:c.room_session.members.map(Rc)}),room_session:za(Ua({},Lc(c.room_session)),{members:c.room_session.members.map(Rc)})}),dispatcher:function*(t,i){const r=Pi(t,"video"),o=za(Ua({},i),{member:za(Ua({},i.member),{member_id:i.member.id})});yield qe(Tc,za(Ua({},e),{action:{type:r,payload:o}}))}})),null==(t=n.room_session.members)||t.forEach((e=>{let t=s(e.member_id);t?t.setPayload({member:e,room_id:n.room_id,room_session_id:n.room_session_id}):t=xc({store:o.store,payload:{member:e,room_id:n.room_id,room_session_id:n.room_session_id}}),a(e.member_id,t)})),o.member=s(n.member_id),o.capabilities=(d=n.capabilities,new Dc(d));const l=za(Ua({},n),{capabilities:o.capabilities});o.emit("call.joined",l),vi().trace("callJoinWorker ended")},Nc=function*(e){const{action:t,channels:{swEventChannel:i},instance:r}=e,o=t.payload.call_id,n=t.payload.room_session_id;function*s(t){const{type:o,payload:n}=t;switch(o){case"call.joined":break;case"call.left":return yield Fe(Pc,za(Ua({},e),{action:t})),!0;case"call.updated":r.emit(o,n),r.emit("room.updated",n);break;case"call.play":case"call.connect":case"call.room":r.emit(o,n);break;case"member.joined":case"member.left":{yield qe(Tc,za(Ua({},e),{action:t}));const r=(e=>{return{type:`video.${e.type}`,payload:(t=e.payload,{room_session_id:t.room_session_id,room_id:t.room_id,member:Rc(t.member)})};var t})(t);yield Be(i,r);break}case"member.updated":{const e=(e=>{return{type:`video.${e.type}`,payload:(t=e.payload,{room_session_id:t.room_session_id,room_id:t.room_id,member:Ac(t.member)})};var t})(t);yield Be(i,e);break}case"layout.changed":{r.currentLayoutEvent=t.payload,r.emit(o,n);const e=(e=>({type:`video.${e.type}`,payload:e.payload}))(t);yield Be(i,e);break}case"member.talking":yield qe(Tc,za(Ua({},e),{action:t}));break;default:vi().warn("Got an unknown fabric event",t)}return!1}vi().debug(`callSegmentWorker started for: callId ${o}, roomSessionId ${n}`),yield qe(Wc,za(Ua({},e),{action:t}));const a=e=>{const{type:t,payload:i}=e,r=t.startsWith("call.")||t.startsWith("member.")||t.startsWith("layout."),s="call_id"in i&&o===i.call_id,a=n===i.room_session_id;return!(!r||!s&&!a)};for(;;){const e=yield ze(i,a),t=yield qe(s,e);if(yield(c=t,Ue(Oe,c)))return}var c},$c=function*(e){vi().trace("fabricWorker started");const{channels:{swEventChannel:t},instance:i}=e;function*r(t){const{type:r,payload:o}=t;switch(r){case"call.joined":if(!i.selfMember){const e=xc({store:i.store,payload:{member:t.payload.room_session.members.find((e=>e.member_id===t.payload.member_id)),room_id:t.payload.room_id,room_session_id:t.payload.room_session_id}});i.selfMember=e}yield qe(Nc,za(Ua({},e),{instance:i,action:t}));break;case"call.state":i.emit(r,o)}}let o=!1;const n=e=>{if("call.state"===e.type)return!0;if("call.joined"!==e.type)return!1;if(!o){return e.payload.call_id===e.payload.origin_call_id&&(o=!0,!0)}return!0};for(;;){const e=yield ze(t,n);yield qe(r,e)}vi().trace("fabricWorker ended")},Uc=(e,t)=>!(null==e?void 0:e.memberId)||e.memberId===t.member.id;var zc={audioMute:function(e){var t,i;if(!(Uc(e,this)?null==(t=this.capabilities)?void 0:t.self.muteAudio.off:null==(i=this.capabilities)?void 0:i.member.muteAudio.off))throw new Kr("Missing audio mute capability")},audioUnmute:function(e){var t,i;if(!(Uc(e,this)?null==(t=this.capabilities)?void 0:t.self.muteAudio.on:null==(i=this.capabilities)?void 0:i.member.muteAudio.on))throw new Kr("Missing audio unmute capability")},videoMute:function(e){var t,i;if(!(Uc(e,this)?null==(t=this.capabilities)?void 0:t.self.muteVideo.off:null==(i=this.capabilities)?void 0:i.member.muteVideo.off))throw new Kr("Missing video mute capability")},videoUnmute:function(e){var t,i;if(!(Uc(e,this)?null==(t=this.capabilities)?void 0:t.self.muteVideo.on:null==(i=this.capabilities)?void 0:i.member.muteVideo.on))throw new Kr("Missing video unmute capability")},deaf:function(e){var t,i;if(!(Uc(e,this)?null==(t=this.capabilities)?void 0:t.self.deaf.on:null==(i=this.capabilities)?void 0:i.member.deaf.on))throw new Kr("Missing deaf capability")},undeaf:function(e){var t,i;if(!(Uc(e,this)?null==(t=this.capabilities)?void 0:t.self.deaf.off:null==(i=this.capabilities)?void 0:i.member.deaf.off))throw new Kr("Missing undeaf capability")},removeMember:function(e){var t;if(!(null==e?void 0:e.memberId))throw new TypeError('Invalid or missing "memberId" argument');if(!(null==(t=this.capabilities)?void 0:t.member.remove))throw new Kr("Missing remove member capability")},setRaisedHand:function(e){var t,i,r,o;const{raised:n=!0}=e||{},s=Uc(e,this),a=s?null==(t=this.capabilities)?void 0:t.self.raisehand.on:null==(i=this.capabilities)?void 0:i.member.raisehand.on,c=s?null==(r=this.capabilities)?void 0:r.self.raisehand.off:null==(o=this.capabilities)?void 0:o.member.raisehand.off;if(n&&!a)throw new Kr("Missing raisehand capability");if(!n&&!c)throw new Kr("Missing lowerhand capability")},setLayout:function(){var e;if(!(null==(e=this.capabilities)?void 0:e.setLayout))throw new Kr("Missing setLayout capability")},setInputVolume:function(e){var t,i,r,o;if(!(Uc(e,this)?null==(i=null==(t=this.capabilities)?void 0:t.self)?void 0:i.microphoneVolume:null==(o=null==(r=this.capabilities)?void 0:r.member)?void 0:o.microphoneVolume))throw new Kr("Missing setInputVolume capability");if(e.volume<-50||e.volume>50)throw new RangeError("The volume ranges from -50 to 50")},setOutputVolume:function(e){var t,i,r,o;if(!(Uc(e,this)?null==(i=null==(t=this.capabilities)?void 0:t.self)?void 0:i.speakerVolume:null==(o=null==(r=this.capabilities)?void 0:r.member)?void 0:o.speakerVolume))throw new Kr("Missing setOutputVolume capability");if(e.volume<-50||e.volume>50)throw new RangeError("The volume ranges from -50 to 50")},setInputSensitivity:function(e){var t,i;if(!(Uc(e,this)?null==(t=this.capabilities)?void 0:t.self.microphoneSensitivity:null==(i=this.capabilities)?void 0:i.member.microphoneSensitivity))throw new Kr("Missing setInputSensitivity capability");if(e.value<0||e.value>100)throw new RangeError("The sensitivity value ranges from 0 to 100")},setPositions:function(e){var t,i;if(e.positions&&!Object.keys(e.positions).length)throw new TypeError("Invalid positions specified");if(!(Object.keys(e.positions).some((e=>["self",`${this.memberId}`].includes(e)))?null==(t=this.capabilities)?void 0:t.self.position:null==(i=this.capabilities)?void 0:i.member.position))throw new Kr("Missing setPositions capability")},lock:function(){var e;if(!(null==(e=this.capabilities)?void 0:e.lock.on))throw new Kr("Missing lock capability")},unlock:function(){var e;if(!(null==(e=this.capabilities)?void 0:e.lock.off))throw new Kr("Missing unlock capability")}};var Bc=class extends fc{constructor(e){super(e),Fa(this,"_self"),Fa(this,"_member"),Fa(this,"_currentLayoutEvent"),Fa(this,"_capabilities"),this.initWorker()}get memberId(){var e;return null==(e=this._member)?void 0:e.memberId}set currentLayoutEvent(e){this._currentLayoutEvent=e}get currentLayoutEvent(){return this._currentLayoutEvent}get currentLayout(){var e;return null==(e=this._currentLayoutEvent)?void 0:e.layout}get currentPosition(){var e,t;return null==(t=null==(e=this._currentLayoutEvent)?void 0:e.layout.layers.find((e=>e.member_id===this.memberId)))?void 0:t.position}get capabilities(){return this._capabilities}set capabilities(e){this._capabilities=e}get selfMember(){return this._self}set selfMember(e){this._self=e}set member(e){this._member=e}get member(){return this._member}initWorker(){this.runWorker("fabricWorker",{worker:$c}),this.runWorker("makeAudioElement",{worker:Ja({speakerId:this.options.speakerId})})}async join(){var e,t;return this.options.attach&&(this.options.prevCallId=null!=(t=null==(e=kc())?void 0:e.getItem(Cc))?t:void 0),this.logger.debug(`Tying to reattach to previuos call? ${!!this.options.prevCallId} - prevCallId: ${this.options.prevCallId}`),super.invite()}executeAction(e,t={}){var i,r,o;const{method:n,channel:s,memberId:a,extraParams:c={}}=e,d=a?this.instanceMap.get(a):this.member;if(!d)throw new Error("No target param found to execute");return this.execute({method:n,params:Ua(za(Ua({},s&&{channels:[s]}),{self:{member_id:null==(i=this.selfMember)?void 0:i.id,call_id:null==(r=this.selfMember)?void 0:r.callId,node_id:null==(o=this.selfMember)?void 0:o.nodeId},target:{member_id:d.id,call_id:d.callId,node_id:d.nodeId}}),c)},t)}async resume(){var e;if(this.logger.warn(`[resume] Call ${this.id}`),null==(e=this.peer)?void 0:e.instance){const{connectionState:e}=this.peer.instance;this.logger.debug(`[resume] connectionState for ${this.id} is '${e}'`),["closed","failed","disconnected"].includes(e)&&(this.resuming=!0,this.peer.restartIce())}}async start(){return new Promise((async(e,t)=>{try{this.once("room.subscribed",(t=>{var i;null==(i=kc())||i.setItem(Cc,t.call_id),e()})),this.once("destroy",(()=>{var e;null==(e=kc())||e.removeItem(Cc)})),await this.join()}catch(i){this.logger.error("WSClient call start",i),t(i)}}))}async audioMute(e){return this.executeAction({method:"call.mute",channel:"audio",memberId:null==e?void 0:e.memberId})}async audioUnmute(e){return this.executeAction({method:"call.unmute",channel:"audio",memberId:null==e?void 0:e.memberId})}async videoMute(e){return this.executeAction({method:"call.mute",channel:"video",memberId:null==e?void 0:e.memberId})}async videoUnmute(e){return this.executeAction({method:"call.unmute",channel:"video",memberId:null==e?void 0:e.memberId})}async deaf(e){return this.executeAction({method:"call.deaf",memberId:null==e?void 0:e.memberId})}async undeaf(e){return this.executeAction({method:"call.undeaf",memberId:null==e?void 0:e.memberId})}async getLayouts(){return this.executeAction({method:"call.layout.list"},{transformResolve:e=>({layouts:e.layouts})})}async getMembers(){return this.executeAction({method:"call.member.list"},{transformResolve:e=>({members:e.members})})}async removeMember(e){return this.executeAction({method:"call.member.remove",memberId:e.memberId})}async setRaisedHand(e){const{raised:t=!0,memberId:i}=e||{};return this.executeAction({method:t?"call.raisehand":"call.lowerhand",memberId:i})}async setLayout(e){const t={layout:e.name,positions:e.positions};return this.executeAction({method:"call.layout.set",extraParams:t})}async setInputVolume(e){return this.executeAction({method:"call.microphone.volume.set",memberId:e.memberId,extraParams:{volume:e.volume}})}async setOutputVolume(e){return this.executeAction({method:"call.speaker.volume.set",memberId:e.memberId,extraParams:{volume:e.volume}})}async setInputSensitivity(e){return this.executeAction({method:"call.microphone.sensitivity.set",memberId:e.memberId,extraParams:{sensitivity:e.value}})}async setPositions(e){var t,i,r;const o=[];if(Object.entries(e.positions).forEach((([e,t])=>{const i="self"===e?this.member:this.instanceMap.get(e);i&&o.push({target:{member_id:i.id,call_id:i.callId,node_id:i.nodeId},position:t})})),!o.length)throw new Error("Invalid targets");return this.execute({method:"call.member.position.set",params:{self:{member_id:null==(t=this.selfMember)?void 0:t.id,call_id:null==(i=this.selfMember)?void 0:i.callId,node_id:null==(r=this.selfMember)?void 0:r.nodeId},targets:o}})}async lock(){return this.executeAction({method:"call.lock"})}async unlock(){return this.executeAction({method:"call.unlock"})}},Hc=e=>e instanceof Bc,Fc=e=>{const t=co({store:e.store,Component:Bc})(e);return new Proxy(t,{get(e,t,i){if("string"==typeof t&&t in zc){const i=e,r=i[t];if("function"==typeof r)return async function(...e){const o=zc[t];return o&&o.apply(i,e),r.apply(i,e)}}return Reflect.get(e,t,i)}})},qc=class{constructor(e){Fa(this,"id"),Fa(this,"_domElement"),Fa(this,"_status"),this.id=e.id,this._status="hidden"}get userId(){return this.id.split(ic)[1]}get domElement(){return this._domElement}set domElement(e){vi().debug("Setting domElement for ",this.id),this._domElement=e}get status(){return this._status}set status(e){this._status=e}hide(){if(!this.domElement)return vi().warn("Missing overlay to hide");this.domElement.style.opacity="0",this.status="hidden"}show(){if(!this.domElement)return vi().warn("Missing overlay to show");this.domElement.style.opacity="1",this.status="visible"}},Jc=class extends qc{constructor(e){super(e),Fa(this,"_mirrored"),Fa(this,"_room"),this._mirrored=e.mirrorLocalVideoOverlay,this._room=e.room,this.fabricMemberVideoMutedHandler=this.fabricMemberVideoMutedHandler.bind(this),this.videoMemberVideoMutedHandler=this.videoMemberVideoMutedHandler.bind(this),this.attachListeners()}get userId(){return this.id.split(tc)[1]}get mirrored(){return this._mirrored}attachListeners(){Hc(this._room)?this._room.on("member.updated.videoMuted",this.fabricMemberVideoMutedHandler):wc(this._room)&&this._room.on("member.updated.videoMuted",this.videoMemberVideoMutedHandler)}detachListeners(){Hc(this._room)?this._room.off("member.updated.videoMuted",this.fabricMemberVideoMutedHandler):wc(this._room)&&this._room.off("member.updated.videoMuted",this.videoMemberVideoMutedHandler)}memberVideoMutedHandler(e,t){try{e===this._room.memberId&&(t?this.hide():this.show())}catch(i){vi().error("Error handling videoMuted in LocalVideoOverlay",i)}}fabricMemberVideoMutedHandler(e){this.memberVideoMutedHandler(e.member.member_id,e.member.video_muted)}videoMemberVideoMutedHandler(e){this.memberVideoMutedHandler(e.member.id,e.member.video_muted)}setMediaStream(e){if(!this.domElement)return vi().warn("Missing local overlay to set the stream");const t=this.domElement.querySelector("video");t&&(t.srcObject=e)}setMirror(e=this._mirrored){if(!this.domElement||!this.domElement.firstChild)return vi().warn("Missing local overlay to set the mirror");const t=this.domElement.firstChild;t.style.transform=e?"scale(-1, 1)":"scale(1, 1)",t.style.webkitTransform=e?"scale(-1, 1)":"scale(1, 1)",this._mirrored=e}},Kc=()=>{const e=document.createElement("video");return e.muted=!0,e.autoplay=!0,e.playsInline=!0,e.addEventListener("pause",(()=>{e.play().catch((t=>{vi().error("Video Element Paused",e,t)}))})),e},Gc=({x:e,y:t,width:i,height:r})=>({top:`${t}%`,left:`${e}%`,width:`${i}%`,height:`${r}%`}),Zc=({location:e})=>{const{top:t,left:i,width:r,height:o}=Gc(e),n=document.createElement("div");return n.style.position="absolute",n.style.overflow="hidden",n.style.top=t,n.style.left=i,n.style.width=r,n.style.height=o,n},Xc=({location:e,element:t})=>{const{top:i,left:r,width:o,height:n}=Gc(e);return t.style.top=i,t.style.left=r,t.style.width=o,t.style.height=n,t},Qc=({video:e,rootElement:t,paddingWrapper:i})=>{const r=function(e,t=0,i){let r=null,o=null;const n=function(){r&&(clearTimeout(r),o=null,r=null)},s=function(){if(!t)return e.apply(this,arguments);const s=this,a=arguments,c=i&&!r;return n(),o=function(){e.apply(s,a)},r=setTimeout((function(){if(r=null,!c){const e=o;return o=null,null==e?void 0:e()}}),t),c&&o?o():void 0};return s.cancel=n,s.flush=function(){const e=o;n(),e&&e()},s}((({width:t,height:r})=>{const o=e.videoHeight/e.videoWidth*100;if(i){const n=r/t*100;i.style.paddingBottom=`${n>o?o:n}%`,i.style.width=((t,i)=>{const r=e.videoWidth/e.videoHeight;return r>t/i?"100%":i*r+"px"})(t,r)}}),100),o=new ResizeObserver((e=>{e.forEach((e=>{if(e.contentBoxSize){const{inlineSize:t,blockSize:i}=Array.isArray(e.contentBoxSize)?e.contentBoxSize[0]:e.contentBoxSize;r({width:t,height:i})}else e.contentRect&&r({width:e.contentRect.width,height:e.contentRect.height})}))})),n=()=>{const e=t.clientWidth,i=t.clientHeight;r({width:e,height:i})};return{start:()=>{o.observe(t),e.addEventListener("resize",n)},stop:()=>{o.disconnect(),e.removeEventListener("resize",n)}}},Yc=async e=>{var t;try{const{room:i,rootElement:r,applyLocalVideoOverlay:o=!0,applyMemberOverlay:n=!0,mirrorLocalVideoOverlay:s=!0}=e;let a=!1;const c=new Map,d=h();let l;r?l=r:(l=document.createElement("div"),l.id=`rootElement-${d}`);const u=(e=>`${tc}${e}`)(d),m=new Jc({id:u,mirrorLocalVideoOverlay:s,room:i});o&&c.set(u,m);const p=(e=>{const{applyLocalVideoOverlay:t,applyMemberOverlay:i,overlayMap:r,localVideoOverlay:o,mirrorLocalVideoOverlay:n,rootElement:s}=e;return async e=>{vi().debug("Process layout.changed");try{const{layout:a,memberId:c,localStream:d}=e,{layers:l=[]}=a,u=s.querySelector(".mcuLayers"),m=document.createDocumentFragment(),p=new Set;if(t){const e=l.find((({member_id:e})=>e===c)),t=o.id;let i=o.domElement;if(p.add(t),e){if(i)vi().debug("Update local video overlay"),Xc({location:e,element:i});else{vi().debug("Build local video overlay"),i=Zc({location:e}),i.id=t;const r=Kc();r.srcObject=d,r.disablePictureInPicture=!0,r.style.width="100%",r.style.height="100%",r.style.pointerEvents="none",r.style.objectFit="cover",i.appendChild(r),o.domElement=i,n&&o.setMirror()}const r=d.getVideoTracks().filter((e=>e.enabled&&"live"===e.readyState)).length>0;r&&e.visible?(o.setMediaStream(d),o.show()):o.hide(),m.appendChild(i)}else vi().warn("Local video overlay location not found"),o.status="hidden",i&&o.hide()}i&&l.forEach((e=>{const t=e.member_id;if(!t)return;const i=rc(t);p.add(i);let o=r.get(i);if(o&&o.domElement)vi().debug("Update an overlay for ",t),Xc({location:e,element:o.domElement});else{vi().debug("Build an overlay for ",t),o=new qc({id:i}),r.set(i,o);const n=Zc({location:e});n.id=`${i}-${h()}`,o.domElement=n}e.visible?o.show():o.hide(),m.appendChild(o.domElement)})),r.forEach(((e,t)=>{p.has(t)||(e.domElement&&e.domElement.parentNode&&e.domElement.parentNode.removeChild(e.domElement),r.delete(t))})),u&&(u.innerHTML="",u.appendChild(m))}catch(a){vi().error("Layout Changed Error",a)}}})({applyLocalVideoOverlay:o,applyMemberOverlay:n,overlayMap:c,localVideoOverlay:m,mirrorLocalVideoOverlay:s,rootElement:l}),g=e=>{var t;(null==(t=i.peer)?void 0:t.hasVideoSender)&&i.localStream?p({layout:e.layout,localStream:i.localStream,memberId:i.memberId}):m.hide()},v=e=>{vi().debug("Received layout.changed - videoTrack",a),a&&g(e)},f=async e=>{a=!0,await ed({applyLocalVideoOverlay:o,applyMemberOverlay:n,rootElement:l,track:e});const t=i.currentLayoutEvent;t&&g(t)},y=null==(t=i.peer)?void 0:t.remoteVideoTrack;y&&await f(y);const b=async function(e){"video"===e.track.kind&&await f(e.track)},_=()=>{(e=>{for(;e.firstChild;)e.removeChild(e.firstChild)})(l),c.clear(),i.overlayMap=c,(Hc(i)||wc(i))&&(i.off("track",b),i.off("layout.changed",v),i.off("destroy",_)),m.detachListeners()};return(Hc(i)||wc(i))&&(i.on("track",b),i.on("layout.changed",v),i.once("destroy",_)),i.overlayMap=c,i.localVideoOverlay=m,{element:l,overlayMap:c,localVideoOverlay:m,unsubscribe:_}}catch(i){throw vi().error("Unable to build the video element"),i}},ed=async e=>{try{const{applyLocalVideoOverlay:t,applyMemberOverlay:i,track:r,rootElement:o}=e,n=Kc();if((({track:e,element:t})=>{t.srcObject=new MediaStream([e]),e.addEventListener("ended",(()=>{t.srcObject=null,t.remove()}))})({element:n,track:r}),n.style.width="100%",n.style.maxHeight="100%",o.querySelector(".mcuContent"))return void vi().debug("MCU Content already there");const s=document.createElement("div");s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.right="0",s.style.bottom="0",s.appendChild(n);const a=document.createElement("div");a.classList.add("paddingWrapper"),a.style.paddingBottom="56.25%",a.style.position="relative",a.style.width="100%",a.appendChild(s);let c=null;(t||i)&&(c=document.createElement("div"),c.classList.add("mcuLayers"),c.style.display="none",a.appendChild(c));const d=document.createElement("div");d.classList.add("mcuContent"),d.style.position="relative",d.style.width="100%",d.style.height="100%",d.style.margin="0 auto",d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="center",d.appendChild(a),o.style.width="100%",o.style.height="100%",o.appendChild(d),vi().debug("MCU readyState 1 >>",n.readyState),n.readyState===HTMLMediaElement.HAVE_NOTHING&&(vi().debug("Wait for the MCU to be ready"),await(({element:e})=>new Promise((t=>{e.addEventListener("canplay",(function i(){e.removeEventListener("canplay",i),t()})),e.addEventListener("resize",(function i(){e.removeEventListener("resize",i),t()}))})))({element:n})),vi().debug("MCU is ready..");const l=Qc({rootElement:o,video:n,paddingWrapper:a});l.start(),r.addEventListener("ended",(()=>{l&&l.stop()})),c&&(c.style.display="block")}catch(t){vi().error("Handle video track error",t)}},td=class extends vo{constructor(){super(...arguments),Fa(this,"_videoManager"),Fa(this,"_chat"),Fa(this,"_pubSub")}get rooms(){return{makeRoomObject:e=>{const t=e,{rootElement:i,applyLocalVideoOverlay:r=!0,applyMemberOverlay:o=!0,mirrorLocalVideoOverlay:n=!0,stopCameraWhileMuted:s=!0,stopMicrophoneWhileMuted:a=!0}=t,c=Ba(t,["rootElement","applyLocalVideoOverlay","applyMemberOverlay","mirrorLocalVideoOverlay","stopCameraWhileMuted","stopMicrophoneWhileMuted"]),d=[];d.push(Ja({speakerId:c.speakerId}));const l=(u=za(Ua({},c),{store:this.store,customSagas:d}),co({store:u.store,customSagas:u.customSagas,Component:_c})(u));var u;if(i)try{Yc({applyLocalVideoOverlay:r,applyMemberOverlay:o,mirrorLocalVideoOverlay:n,room:l,rootElement:i})}catch(h){this.logger.error("Unable to build the video element automatically")}return l.on("room.subscribed",(e=>{var t;const i=null==(t=e.room_session.members)?void 0:t.find((e=>e.id===l.memberId));if(null==i?void 0:i.audio_muted)try{l.stopOutboundAudio()}catch(h){this.logger.error("Error handling audio_muted",h)}if(null==i?void 0:i.video_muted)try{l.stopOutboundVideo()}catch(h){this.logger.error("Error handling video_muted",h)}})),a&&l.on("member.updated.audio_muted",(({member:e})=>{try{e.id===l.memberId&&"audio_muted"in e&&(e.audio_muted?l.stopOutboundAudio():l.restoreOutboundAudio())}catch(h){this.logger.error("Error handling audio_muted",h)}})),s&&l.on("member.updated.video_muted",(({member:e})=>{try{e.id===l.memberId&&"video_muted"in e&&(e.video_muted?l.stopOutboundVideo():l.restoreOutboundVideo())}catch(h){this.logger.error("Error handling video_muted",h)}})),l}}}get chat(){return this._chat||(this._chat=kn.createBaseChatObject({store:this.store})),this._chat}get pubSub(){return this._pubSub||(this._pubSub=Ln.createBasePubSubObject({store:this.store})),this._pubSub}get videoManager(){return this._videoManager||(this._videoManager=(e=>{const t=co({store:e.store,Component:Ya})(e);return new Proxy(t,{get:(e,t,i)=>"_eventsNamespace"===t?"":"eventChannel"===t?"video-manager.rooms":Reflect.get(e,t,i)})})(this.options)),this._videoManager}reauthenticate(e){this.store.dispatch(rr.reauthAction({token:e}))}},id="function"==typeof CloseEvent?CloseEvent:class{constructor(e,t={}){this.type=e,ri(this,"code"),ri(this,"reason"),ri(this,"wasClean"),this.code=void 0===t.code?0:t.code,this.reason=void 0===t.reason?"":t.reason,this.wasClean=void 0!==t.wasClean&&t.wasClean}},rd=class extends Ar{constructor(e){var t;let i={};try{i=Oa(e.token,{header:!0})}catch(Pa){0}super(za(Ua({},e),{host:(null==i?void 0:i.ch)||e.host})),this.options=e,Fa(this,"WebSocketConstructor",WebSocket),Fa(this,"CloseEventConstructor",id),Fa(this,"agent","@signalwire/js/browser/3.29.0-dev.202504181547.b1d63f1.0"),Fa(this,"tokenTyp"),this.tokenTyp=null!=(t=i.typ)?t:"VRT"}get allowReattach(){var e;return!1!==(null==(e=this.options)?void 0:e.reattach)&&(this.isVRT()||this.isSAT())}async retrieveRelayProtocol(){var e,t;if(!this.allowReattach)return"";const{protocolKey:i}=Sc(this.options.token);return i?(this.logger.trace("Search protocol for",i),null!=(t=null==(e=kc())?void 0:e.getItem(i))?t:""):""}async persistRelayProtocol(){var e;if(!this.allowReattach)return;const{protocolKey:t}=Sc(this.options.token);t&&(this.logger.trace("Persist protocol",t,this.relayProtocol),null==(e=kc())||e.setItem(t,this.relayProtocol))}async retrieveSwAuthorizationState(){var e,t;const{authStateKey:i}=Sc(this.options.token);return i&&null!=(t=null==(e=kc())?void 0:e.getItem(i))?t:""}async persistSwAuthorizationState(e){var t;if(!this.allowReattach)return;const{authStateKey:i}=Sc(this.options.token);i&&(this.logger.trace("Persist auth state",i,e),null==(t=kc())||t.setItem(i,e))}_onSocketClose(e){var t,i,r;if("unknown"===this.status||"disconnected"===this.status){const{protocolKey:e,authStateKey:o,callIdKey:n}=Sc(this.options.token);this.logger.debug("Cleaning up storage"),e&&(this.logger.debug("Remove protocolKey",e),null==(t=kc())||t.removeItem(e)),o&&(this.logger.debug("Remove authStateKey",o),null==(i=kc())||i.removeItem(o)),n&&(this.logger.debug("Remove callIdKey",n),null==(r=kc())||r.removeItem(n))}super._onSocketClose(e)}isVRT(){return"VRT"===this.tokenTyp}isSAT(){return"SAT"===this.tokenTyp}},od=e=>{const t=za(Ua({},e),{emitter:lo()}),i=uo({userOptions:t,SessionConstructor:rd});return co({store:i,Component:td})(t)},nd=["subscribe","publish","getMessages","getMembers","getMemberState","getAllowedChannels","setMemberState"],sd=function(e){const t=od(e),i={_session:t,disconnect:()=>t.disconnect()};return new Proxy(t.chat,{get:(e,r,o)=>r in i?i[r]:nd.includes(r)?(e=>async(...i)=>(await t.connect(),t.chat[e](...i)))(r):Reflect.get(e,r,o)})};Ha({},{Client:()=>cd,PubSubMessage:()=>dd});Object.keys(yo).map((e=>`member.updated.${e}`));var ad=["getAllowedChannels","subscribe","publish"],cd=function(e){const t=od(e),i={_session:t,disconnect:()=>t.disconnect()};return new Proxy(t.pubSub,{get:(e,r,o)=>r in i?i[r]:ad.includes(r)?(e=>async(...i)=>(await t.connect(),t.pubSub[e](...i)))(r):Reflect.get(e,r,o)})},dd=Ln.PubSubMessage;Ha({},{SignalWire:()=>Md,isFabricRoomSession:()=>Hc});var ld=0,ud=0,hd=0,md=3e4;async function pd(e,t,i,r,o){const n=await Ri({asyncCallable:()=>fetch(e,t),maxRetries:i,validator:e=>{if(!e.ok&&e.status>=500)throw new Jr(e.status,e.statusText)},delayFn:Ti({initialDelay:r,variation:o})});if(!n.ok){if(401===n.status)throw new qr(n.status,"Unauthorized");let e;try{e=await n.json()}catch(Pa){}const t=(null==e?void 0:e.errors)?JSON.stringify(e.errors):"Not Found";throw new Jr(n.status,t,e)}try{n.parsedBody=await n.json()}catch(Pa){}return n}var gd=(e,t=pd)=>{var i=e,{baseUrl:r,maxApiRequestRetries:o=ld,apiRequestRetriesDelay:n=ud,apiRequestRetriesDelayIncrement:s=hd,timeout:a=md}=i,c=Ba(i,["baseUrl","maxApiRequestRetries","apiRequestRetriesDelay","apiRequestRetriesDelayIncrement","timeout"]);return async(e,i)=>{const d=Ua(Ua(Ua({},(null==i?void 0:i.body)?{"Content-Type":"application/json"}:{}),c.headers),null==i?void 0:i.headers),l=vd(za(Ua(Ua({},c),i),{headers:d}));let u;if(a){const e=new AbortController,t=e.signal;l.signal=t,u=setTimeout((()=>{e.abort()}),a)}try{return{body:(await t(fd({path:e,baseUrl:r,searchParams:null==i?void 0:i.searchParams}),l,o,n,s)).parsedBody}}catch(Pa){throw Pa}finally{u&&clearTimeout(u)}}},vd=e=>Object.entries(e).reduce(((e,[t,i])=>{return"body"===t?za(Ua({},e),{body:(r=i,"string"==typeof r?r:JSON.stringify(r))}):null!=i?za(Ua({},e),{[t]:i}):e;var r}),{}),fd=({path:e,baseUrl:t,searchParams:i})=>{const r=new URL(e,t);return i&&Object.entries(i).forEach((([e,t])=>{null!=t&&r.searchParams.append(e,t)})),r.toString()};function yd(e,t){const i=async e=>{if(!e)return Promise.resolve(void 0);const{body:i}=await t(e);return yd(i,t)};return{data:e.data,self:async()=>{const{self:t}=e.links;return i(t)},nextPage:async()=>{const{next:t}=e.links;return i(t)},prevPage:async()=>{const{prev:t}=e.links;return i(t)},firstPage:async()=>{const{first:t}=e.links;return i(t)},hasNext:Boolean(e.links.next),hasPrev:Boolean(e.links.prev)}}function bd(e,t){const i=t.toString();return i?`${e}?${i}`:e}var _d=class{constructor(e){this.options=e,Fa(this,"httpClient"),this.httpClient=gd({baseUrl:`https://${this.httpHost}`,headers:{Authorization:`Bearer ${this.options.token}`},maxApiRequestRetries:this.options.maxApiRequestRetries,apiRequestRetriesDelay:this.options.apiRequestRetriesDelay,apiRequestRetriesDelayIncrement:this.options.apiRequestRetriesDelayIncrement})}get fetch(){return this.httpClient}get httpHost(){let e={};try{e=Oa(this.options.token,{header:!0})}catch(Pa){0}const t=this.options.host||(null==e?void 0:e.ch);return t?`fabric.${t.split(".").splice(1).join(".")}`:"fabric.signalwire.com"}async getAddress(e){let t="/api/fabric/addresses";var i;(i=e)&&"name"in i?t=`${t}?name=${e.name}`:(e=>e&&"id"in e)(e)&&(t=`${t}/${e.id}`);const{body:r}=await this.httpClient(t);if((e=>e&&"data"in e)(r)){if(!r.data[0])throw new Jr(404,"Not Found");return r.data[0]}return r}async getAddresses(e){const{type:t,displayName:i,pageSize:r,sortBy:o,sortOrder:n}=e||{};const s=new URLSearchParams;t&&s.append("type",t),i&&s.append("display_name",i),r&&s.append("page_size",r.toString()),o&&s.append("sort_by",o),n&&s.append("sort_order",n);const a=bd("/api/fabric/addresses",s);vi().debug(`[getAddresses] query URL ${a}`);const{body:c}=await this.httpClient(a);return yd(c,this.httpClient)}async registerDevice(e){const{deviceType:t,deviceToken:i}=e,{body:r}=await this.httpClient("/subscriber/devices",{method:"POST",body:{device_type:t,device_token:i}});return r}async unregisterDevice(e){const{id:t}=e,i=`/subscriber/devices/${t}`;await this.httpClient(i,{method:"DELETE"})}async getSubscriberInfo(){const{body:e}=await this.httpClient("/api/fabric/subscriber/info");return e}},wd=class{constructor(e,t){this.conversation=e,this.payload=t}get id(){return this.payload.id}get addressId(){return this.payload.address_id}get createdAt(){return this.payload.created_at}get lastMessageAt(){return this.payload.last_message_at}get metadata(){return this.payload.metadata}get name(){return this.payload.name}sendMessage(e){return this.conversation.sendMessage({addressId:this.id,text:e.text})}getMessages(e){return this.conversation.getConversationMessages(Ua({addressId:this.id},e))}},kd=10,Sd=class{constructor(e){Fa(this,"httpClient"),Fa(this,"wsClient"),Fa(this,"callbacks",new Set),Fa(this,"chatSubscriptions",{}),Fa(this,"lookupCache",new Map),this.httpClient=e.httpClient,this.wsClient=e.wsClient,this.wsClient.runWorker("conversationWorker",{worker:Ic,initialState:{conversation:this}})}lookupUsername(e){var t,i;return Date.now()-(null!=(i=null==(t=this.lookupCache.get(e))?void 0:t.lastRequested)?i:0)>=18e4&&this.lookupCache.set(e,{lastRequested:Date.now(),promise:this.httpClient.getAddress({id:e})}),async()=>{var t,i;return null==(i=await(null==(t=this.lookupCache.get(e))?void 0:t.promise))?void 0:i.display_name}}handleEvent(e){if("chat"===e.subtype){const t=this.chatSubscriptions[e.conversation_id];(null==t?void 0:t.size)&&t.forEach((t=>t(e)))}this.callbacks.size&&this.callbacks.forEach((t=>{t(e)}))}async sendMessage(e){try{const{addressId:t,text:i}=e,r="/api/fabric/messages",{body:o}=await this.httpClient.fetch(r,{method:"POST",body:{conversation_id:t,text:i}});return o}catch(t){throw new Error("Error sending message to conversation!",t)}}async getConversations(e){try{const{pageSize:t}=e||{},i="/api/fabric/conversations",r=new URLSearchParams;t&&r.append("page_size",t.toString());const{body:o}=await this.httpClient.fetch(bd(i,r)),n=this,s=o.data.map((e=>new wd(n,e)));return yd(za(Ua({},o),{data:s}),this.httpClient.fetch)}catch(t){throw new Error("Error fetching the conversation history!",t)}}async getMessages(e){try{const{pageSize:t}=e||{},i="/api/fabric/messages",r=new URLSearchParams;t&&r.append("page_size",t.toString());const{body:o}=await this.httpClient.fetch(bd(i,r));return yd(o,this.httpClient.fetch)}catch(t){throw new Error("Error fetching the conversation messages!",t)}}async getConversationMessages(e){try{const{addressId:t,pageSize:i}=e||{},r=`/api/fabric/conversations/${t}/messages`,o=new URLSearchParams;i&&o.append("page_size",i.toString());const{body:n}=await this.httpClient.fetch(bd(r,o));return yd(n,this.httpClient.fetch)}catch(t){throw new Error("Error fetching the conversation messages!",t)}}async getChatMessages(e){const{addressId:t,pageSize:i=kd}=e,r=async(e,o=[],n=!0)=>{var s;let a=[...o];const c=e=>e.conversation_id===t&&"chat"===e.subtype;let d;d=await(null==e?void 0:e());let l=null!=(s=null==d?void 0:d.data.filter(c))?s:[],u=i-a.length;for(let t=0;t<l.length&&t<u;t++)a.push(l[t]);for(;a.length<i&&(null==d?void 0:d.hasNext)&&(d=await(n?null==d?void 0:d.nextPage():null==d?void 0:d.prevPage()),d&&d.data.length);){u=i-a.length,l=d.data.filter(c);for(let e=0;e<l.length&&e<u;e++)a.push(l[e])}let h=[];return u<l.length&&(h=l.slice(u)),a=await Promise.all(a.map((async e=>e.from_address_id?za(Ua({},e),{user_name:await this.lookupUsername(e.from_address_id)()}):e))),{data:a,hasNext:!!(null==d?void 0:d.hasNext)||!!h.length,hasPrev:!!(null==d?void 0:d.hasPrev),nextPage:()=>r(null==d?void 0:d.nextPage,h),prevPage:()=>r(null==d?void 0:d.prevPage,h,!1),self:()=>r(null==d?void 0:d.self,h),firstPage:()=>r(null==d?void 0:d.firstPage,h)}};return r((()=>this.getConversationMessages({addressId:t,pageSize:i})))}async subscribe(e){return this.callbacks.add(e),{unsubscribe:()=>this.callbacks.delete(e)}}async subscribeChatMessages(e){const{addressId:t,onMessage:i}=e;return t in this.chatSubscriptions||(this.chatSubscriptions[t]=new Set),this.chatSubscriptions[t].add(i),{unsubscribe:()=>this.chatSubscriptions[t].delete(i)}}async joinConversation(e){try{const{addressId:t}=e,i="/api/fabric/conversations/join",{body:r}=await this.httpClient.fetch(i,{method:"POST",body:{conversation_id:t}});return r}catch(t){throw new Error("Error joining a conversation!",t)}}},Cd=class{constructor(e){this.options=e,Fa(this,"_client"),Fa(this,"_pendingInvites",{}),Fa(this,"_handlers",{}),this._client=e.client}_buildNotification(e){const t=async t=>new Promise(((i,r)=>{delete this._pendingInvites[e.callID];try{const r=this.options.buildInboundCall(e,t);r.answer(),i(r)}catch(Pa){r(Pa)}})),i=()=>(delete this._pendingInvites[e.callID],this.options.executeVertoBye(e.callID,e.nodeId));return{invite:{details:e,accept:e=>t(e),reject:()=>i()}}}setNotificationHandlers(e){this._handlers.all=e.all,(e.pushNotification&&this._handlers.all!=e.pushNotification||!e.pushNotification)&&(this._handlers.pushNotification=e.pushNotification),(e.websocket&&this._handlers.all!=e.websocket||!e.websocket)&&(this._handlers.websocket=e.websocket)}handleIncomingInvite(e){var t,i;if(e.callID in this._pendingInvites)return void this._client.logger.debug(`skiping nottification for pending invite to callID: ${e.callID}`);if(this._pendingInvites[e.callID]=e,!this._handlers.all&&!this._handlers[e.source])return void this._client.logger.warn("Skiping nottification due to no listeners");const r=this._buildNotification(e);null==(i=(t=this._handlers).all)||i.call(t,r);const o=this._handlers[e.source];null==o||o(r)}},Ed=class extends rd{constructor(e){super(e),this.options=e,Fa(this,"connectVersion",Bi)}get signature(){if(this._rpcConnectResult){const{authorization:e}=this._rpcConnectResult;return e.jti}}async _checkTokenExpiration(){}async reauthenticate(){if(this.logger.debug("Session Reauthenticate",{ready:this.ready,expired:this.expired}),!this.ready||this.expired)return this.connect();const e={project:this._rpcConnectResult.authorization.project_id,jwt_token:this.options.token};try{const t=await this.execute(Fi(e));this._rpcConnectResult=Ua(Ua({},this._rpcConnectResult),t)}catch(t){throw t}}async execute(e){return Ri({asyncCallable:()=>super.execute(e),maxRetries:this.options.maxApiRequestRetries,delayFn:Ti({initialDelay:this.options.apiRequestRetriesDelay,variation:this.options.apiRequestRetriesDelayIncrement}),expectedErrorHandler:e=>{var t;return!!(null==(t=null==e?void 0:e.message)?void 0:t.startsWith("Authentication failed"))}})}},Id=class extends vo{constructor(e){super((e=>{const t=uo({userOptions:e,SessionConstructor:Ed});return za(Ua({},e),{store:t})})(e)),this.wsClientOptions=e,Fa(this,"_incomingCallManager"),Fa(this,"_disconnected",!1),this._incomingCallManager=new Cd({client:this,buildInboundCall:this.buildInboundCall.bind(this),executeVertoBye:this.executeVertoBye.bind(this)}),this.runWorker("wsClientWorker",{worker:Ec,initialState:{handleIncomingInvite:e=>{this._incomingCallManager.handleIncomingInvite(Ua({source:"websocket"},e))}}})}makeFabricObject(e){const t=e,{rootElement:i,applyLocalVideoOverlay:r=!0,applyMemberOverlay:o=!0,stopCameraWhileMuted:n=!0,stopMicrophoneWhileMuted:s=!0,mirrorLocalVideoOverlay:a=!0}=t,c=Ba(t,["rootElement","applyLocalVideoOverlay","applyMemberOverlay","stopCameraWhileMuted","stopMicrophoneWhileMuted","mirrorLocalVideoOverlay"]),d=Fc(za(Ua({},c),{store:this.store}));if(i)try{Yc({applyLocalVideoOverlay:r,applyMemberOverlay:o,mirrorLocalVideoOverlay:a,room:d,rootElement:i})}catch(l){this.logger.error("Unable to build the video element automatically")}return d.on("room.subscribed",(e=>{var t;const i=null==(t=e.room_session.members)?void 0:t.find((e=>e.id===d.memberId||e.member_id===d.memberId));if(null==i?void 0:i.audio_muted)try{d.stopOutboundAudio()}catch(l){this.logger.error("Error handling audio_muted",l)}if(null==i?void 0:i.video_muted)try{d.stopOutboundVideo()}catch(l){this.logger.error("Error handling video_muted",l)}})),s&&d.on("member.updated.audioMuted",(({member:e})=>{try{e.member_id===d.memberId&&"audio_muted"in e&&(e.audio_muted?d.stopOutboundAudio():d.restoreOutboundAudio())}catch(l){this.logger.error("Error handling audio_muted",l)}})),n&&d.on("member.updated.videoMuted",(({member:e})=>{try{e.member_id===d.memberId&&"video_muted"in e&&(e.video_muted?d.stopOutboundVideo():d.restoreOutboundVideo())}catch(l){this.logger.error("Error handling video_muted",l)}})),d}buildOutboundCall(e){var t,i,r,o,n;const[s,a]=e.to.split("?");if(!s)throw new Error("Invalid destination address");let c=!1,d=!1;"video"===new URLSearchParams(a).get("channel")&&(c=!0,d=!0);const l=this.makeFabricObject({audio:null==(t=e.audio)||t,video:null!=(i=e.video)?i:c,negotiateAudio:null==(r=e.negotiateAudio)||r,negotiateVideo:null!=(o=e.negotiateVideo)?o:d,rootElement:e.rootElement||this.wsClientOptions.rootElement,applyLocalVideoOverlay:!0,applyMemberOverlay:!0,stopCameraWhileMuted:!0,stopMicrophoneWhileMuted:!0,watchMediaPackets:!1,destinationNumber:e.to,nodeId:e.nodeId,attach:null!=(n=e.attach)&&n,disableUdpIceServers:e.disableUdpIceServers||!1,userVariables:e.userVariables||this.wsClientOptions.userVariables});return l.once("destroy",(()=>{this.logger.debug("RTC Connection Destroyed"),l.destroy()})),this.session.once("session.disconnected",(()=>{this.logger.debug("Session Disconnected"),l.destroy(),this.destroy()})),l.attachPreConnectWorkers(),l}buildInboundCall(e,t){var i,r,o,n;const s=this.makeFabricObject({audio:null==(i=t.audio)||i,video:null==(r=t.video)||r,negotiateAudio:null==(o=t.negotiateAudio)||o,negotiateVideo:null==(n=t.negotiateVideo)||n,rootElement:t.rootElement||this.wsClientOptions.rootElement,applyLocalVideoOverlay:!0,applyMemberOverlay:!0,stopCameraWhileMuted:!0,stopMicrophoneWhileMuted:!0,watchMediaPackets:!1,nodeId:e.nodeId,remoteSdp:e.sdp,prevCallId:e.callID,disableUdpIceServers:t.disableUdpIceServers||!1,userVariables:t.userVariables||this.wsClientOptions.userVariables});return s.once("destroy",(()=>{this.logger.debug("RTC Connection Destroyed"),s.destroy()})),this.session.once("session.disconnected",(()=>{this.logger.debug("Session Disconnected"),s.destroy(),this.destroy()})),s.attachPreConnectWorkers(),s}async executeVertoBye(e,t){try{return await this.execute({method:"webrtc.verto",params:{callID:e,node_id:t,message:Zi({cause:"USER_BUSY",causeCode:"17",dialogParams:{callID:e}})}})}catch(i){throw this.logger.warn("The call is not available anymore",e),i}}async executeVertoSubscribe(e,t){try{return await this.execute({method:"webrtc.verto",params:{callID:e,node_id:t,subscribe:[],message:er({sessid:e,eventChannel:[]})}})}catch(i){throw this.logger.warn("The call is not available anymore",e),i}}disconnect(){return new Promise(((e,t)=>{this._disconnected&&e(),this.session.once("session.disconnected",(()=>{this.destroy(),e(),this._disconnected=!0})),super.disconnect()}))}async dial(e){return new Promise((async(t,i)=>{try{t(this.buildOutboundCall(e))}catch(r){this.logger.error("Unable to connect and dial a call",r),i(r)}}))}async reattach(e){return new Promise((async(t,i)=>{try{t(this.buildOutboundCall(za(Ua({},e),{attach:!0})))}catch(r){this.logger.error("Unable to connect and reattach a call",r),i(r)}}))}handlePushNotification(e){return new Promise((async(t,i)=>{const{decrypted:r,type:o}=e;"call_invite"!==o&&(this.logger.warn("Unknown notification type",e),i("Unknown notification type")),this.logger.debug("handlePushNotification",e);const{params:{params:n},node_id:s}=r;try{try{await this.executeVertoSubscribe(n.callID,s)}catch(a){this.logger.warn("Verto Subscribe",a)}this._incomingCallManager.handleIncomingInvite(Ua({source:"pushNotification",nodeId:s},n)),t({resultType:"inboundCall"})}catch(a){i(a)}}))}updateToken(e){return new Promise(((t,i)=>{this.session.once("session.auth_error",(e=>{i(e)})),this.session.once("session.connected",(()=>{t()})),this.store.dispatch(rr.reauthAction({token:e}))}))}async online({incomingCallHandlers:e}){return this._incomingCallManager.setNotificationHandlers(e),this.execute({method:"subscriber.online",params:{}})}offline(){return this._incomingCallManager.setNotificationHandlers({}),this.execute({method:"subscriber.offline",params:{}})}},Md=(()=>{let e=null;return t=>(e||(e=new Promise((async(i,r)=>{try{const r=Ua({maxApiRequestRetries:10,apiRequestRetriesDelay:300,apiRequestRetriesDelayIncrement:100},t),o=new Id(r),n=new _d(r),s=new Sd({httpClient:n,wsClient:o});await o.connect(),i({registerDevice:n.registerDevice.bind(n),unregisterDevice:n.unregisterDevice.bind(n),getSubscriberInfo:n.getSubscriberInfo.bind(n),disconnect:async()=>{await o.disconnect(),e=null},online:o.online.bind(o),offline:o.offline.bind(o),dial:o.dial.bind(o),reattach:o.reattach.bind(o),handlePushNotification:o.handlePushNotification.bind(o),updateToken:o.updateToken.bind(o),address:{getAddresses:n.getAddresses.bind(n),getAddress:n.getAddress.bind(n)},conversation:{getConversations:s.getConversations.bind(s),getMessages:s.getMessages.bind(s),getConversationMessages:s.getConversationMessages.bind(s),subscribe:s.subscribe.bind(s),sendMessage:s.sendMessage.bind(s),join:s.joinConversation.bind(s)},chat:{getMessages:s.getChatMessages.bind(s),subscribe:s.subscribeChatMessages.bind(s),sendMessage:s.sendMessage.bind(s),join:s.joinConversation.bind(s)},on:o.on.bind(o),off:o.off.bind(o),__httpClient:n,__wsClient:o})}catch(o){r(o)}})).catch((t=>{throw e=null,t}))),e)})();Ha({},{RoomSession:()=>Ld,createClient:()=>od,createRoomObject:()=>Pd,isVideoRoomSession:()=>wc,joinRoom:()=>Td});var xd={aspectRatio:{ideal:16/9}},Pd=e=>new Promise((async(t,i)=>{const r=e,{audio:o=!0,video:n=!0,iceServers:s,rootElementId:a,applyLocalVideoOverlay:c=!0,autoJoin:d=!1,stopCameraWhileMuted:l=!0,stopMicrophoneWhileMuted:u=!0,speakerId:h}=r,m=Ba(r,["audio","video","iceServers","rootElementId","applyLocalVideoOverlay","autoJoin","stopCameraWhileMuted","stopMicrophoneWhileMuted","speakerId"]),p=od(Ua({},m));if(await p.connect(),!p)return;let g;if(a){const e=document.getElementById(a);e?g=e:(g=document.body,vi().warn(`We couldn't find an element with id: ${a}: using 'document.body' instead.`))}const v=p.rooms.makeRoomObject({audio:o,video:!0===n?xd:n,negotiateAudio:!0,negotiateVideo:!0,iceServers:s,rootElement:g,applyLocalVideoOverlay:c,stopCameraWhileMuted:l,stopMicrophoneWhileMuted:u,speakerId:h});v.once("destroy",(()=>{v.emit("room.left"),p.disconnect()}));const f=()=>new Promise((async(e,t)=>{try{v.once("room.subscribed",(t=>{e(v)})),await v.join()}catch(i){vi().error("Join",i),p.disconnect(),t(i)}})),y=new Proxy(v,{get:(e,t,i)=>"join"===t?f:Reflect.get(e,t,i)});if(d)try{await y.join(),t(y)}catch(b){i(b)}else t(y)})),Td=e=>Pd(za(Ua({},e),{autoJoin:!0})),Rd=["audioMute","audioUnmute","deaf","getLayouts","getMembers","getRecordings","hideVideoMuted","leave","removerMember","restoreOutboundAudio","restoreOutboundVideo","setInputSensitivity","setInputVolume","setLayout","setPositions","setMemberPosition","setOutputVolume","showVideoMuted","startRecording","stopOutboundAudio","stopOutboundVideo","undeaf","videoMute","videoUnmute","setMicrophoneVolume","setSpeakerVolume","getMeta","setMeta","updateMeta","deleteMeta","getMemberMeta","setMemberMeta","updateMemberMeta","deleteMemberMeta","promote","demote","lock","unlock"],Ad=["member.joined","layout.changed"],Od=()=>{},Ld=function(e){const t=e,{audio:i=!0,video:r=!0,iceServers:o,rootElement:n,applyLocalVideoOverlay:s=!0,mirrorLocalVideoOverlay:a=!1,stopCameraWhileMuted:c=!0,stopMicrophoneWhileMuted:d=!0,speakerId:l,destinationNumber:u,localStream:h,watchMediaPackets:m,watchMediaPacketsTimeout:p,disableUdpIceServers:g=!1}=t,v=Ba(t,["audio","video","iceServers","rootElement","applyLocalVideoOverlay","mirrorLocalVideoOverlay","stopCameraWhileMuted","stopMicrophoneWhileMuted","speakerId","destinationNumber","localStream","watchMediaPackets","watchMediaPacketsTimeout","disableUdpIceServers"]);["audio","video"].forEach((t=>{t in e&&vi().warn(`The '${t}' parameter on the RoomSession constructor is deprecated. Set it on the '.join()' function instead.`)}));const f=!1!==(null==e?void 0:e.reattach),{callIdKey:y}=Sc(v.token),b={joined:({call_id:e})=>{var t;f&&y&&(null==(t=kc())||t.setItem(y,e))},init:()=>{f&&w.on("room.subscribed",b.joined),w.options.prevCallId=b.getPrevCallId()},destroy:()=>{var e;f&&(w.off("room.subscribed",b.joined),y&&(null==(e=kc())||e.removeItem(y)))},getPrevCallId:()=>{var e,t;if(f&&y)return null!=(t=null==(e=kc())?void 0:e.getItem(y))?t:void 0}},_=od(v),w=_.rooms.makeRoomObject({negotiateAudio:!0,negotiateVideo:!0,iceServers:o,rootElement:n,applyLocalVideoOverlay:s,mirrorLocalVideoOverlay:a,stopCameraWhileMuted:c,stopMicrophoneWhileMuted:d,speakerId:l,destinationNumber:u,localStream:h,watchMediaPackets:m,watchMediaPacketsTimeout:p,prevCallId:b.getPrevCallId(),disableUdpIceServers:g});w.once("destroy",(()=>{w.emit("room.left",{reason:w.leaveReason}),b.destroy(),_.disconnect()})),_.session.once("session.disconnected",(()=>{w.destroy()}));const k={join:e=>new Promise((async(t,o)=>{var n,s,a;try{w.attachPreConnectWorkers(),await _.connect();const c=null!=(n=null==e?void 0:e.audio)?n:i,d=null!=(s=null==e?void 0:e.video)?s:r,l=_._sessionAuthorization;if(vi().debug("getJoinMediaParams authorization?",l),l&&"video"===l.type){const t=(e=>{const{authorization:t,audio:i=!0,video:r=!0,sendAudio:o,sendVideo:n,receiveAudio:s,receiveVideo:a}=e;vi().debug("getJoinMediaParams options",Ua({},e));const{audio_allowed:c,video_allowed:d,join_as:l}=t,u="member"===(null!=l?l:"member"),h=u&&"both"===c,m=u&&"both"===d,p="none"!==c,g="none"!==d,v=Boolean(null!=o?o:i),f=Boolean(null!=n?n:r),y=Boolean(null!=s?s:i),b=Boolean(null!=a?a:r);return!h&&v&&vi().info("Not allowed to send audio on this room. Default values will be used."),!m&&f&&vi().info("Not allowed to send video on this room. Default values will be used."),!p&&y&&vi().info("Not allowed to receive video from the room. Default values will be used."),!g&&b&&vi().info("Not allowed to receive video from the room. Default values will be used."),{mustSendAudio:h&&v,mustSendVideo:m&&f,mustRecvAudio:p&&y,mustRecvVideo:g&&b}})(Ua({authorization:l,sendAudio:Boolean(c),sendVideo:Boolean(d)},e));if(a=t,!Object.values(a).some(Boolean))return _.disconnect(),o(new Error(`Invalid arguments to join the room. The token used has join_as: '${l.join_as}'. \n${JSON.stringify(e,null,2)}\n`));vi().debug("Set mediaOptions",t),w.updateMediaOptions({audio:!!t.mustSendAudio&&(c||!0),video:!!t.mustSendVideo&&(d||!0),negotiateAudio:t.mustRecvAudio,negotiateVideo:t.mustRecvVideo})}w.once("room.subscribed",(()=>{t(w)})),b.init(),Ad.forEach((e=>w.once(e,Od))),await w.join()}catch(c){vi().error("RoomSession Join",c),_.disconnect(),o(c)}}))};return new Proxy(w,{get(e,t,i){if(t in k)return k[t];if(!e.active&&Rd.includes(t))throw new Error(`Tried to access the property/method "${t}" before the room was connected. Please call roomSession.join() first.`);return Reflect.get(e,t,i)}})},jd={};Ha(jd,{checkCameraPermissions:()=>Ms,checkMicrophonePermissions:()=>xs,checkPermissions:()=>Is,checkSpeakerPermissions:()=>Ps,createCameraDeviceWatcher:()=>Qs,createDeviceWatcher:()=>Gs,createMicrophoneAnalyzer:()=>ea,createMicrophoneDeviceWatcher:()=>Zs,createSpeakerDeviceWatcher:()=>Xs,enumerateDevices:()=>Cs,enumerateDevicesByKind:()=>Es,getCameraDevices:()=>Ns,getCameraDevicesWithPermissions:()=>Ls,getDevices:()=>Ws,getDevicesWithPermissions:()=>Os,getDisplayMedia:()=>Rs,getMicrophoneDevices:()=>$s,getMicrophoneDevicesWithPermissions:()=>js,getSpeakerDevices:()=>Us,getSpeakerDevicesWithPermissions:()=>Vs,getSupportedConstraints:()=>vs,getUserMedia:()=>Ts,requestPermissions:()=>As,setMediaElementSinkId:()=>bs,stopStream:()=>_s,stopTrack:()=>ws,supportsGetDisplayMedia:()=>gs,supportsGetUserMedia:()=>ps,supportsMediaDevices:()=>hs,supportsMediaOutput:()=>ys});var Vd=Object.defineProperty,Dd=(e,t,i)=>((e,t,i)=>t in e?Vd(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);function Wd(e,...t){const i=e.reduce(((e,i,r)=>e+i+(t[r]||"")),"");return function(){const e=(new DOMParser).parseFromString(i,"text/html");if(!e.body.firstChild)throw new Error("Invalid HTML template");const t={};e.body.querySelectorAll("[name]").forEach((e=>{const i=e.getAttribute("name");i&&(t[i]=e,e.removeAttribute("name"))}));const r=document.createDocumentFragment();for(;e.body.firstChild;)r.appendChild(e.body.firstChild);return t}}const Nd=class e{constructor(){Dd(this,"styles",new Map)}static getInstance(){return e.instance||(e.instance=new e),e.instance}register(e){const t=e.length,i=t>40?`${t}:${e.slice(0,20)}:${e.slice(-20)}`:`${t}:${e}`;this.styles.has(i)||this.styles.set(i,e)}apply(e){const t=document.createElement("style");t.textContent=Array.from(this.styles.values()).join("\n"),e.appendChild(t)}};Dd(Nd,"instance");const $d=Nd.getInstance();$d.register('.modal-container{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#000000ed;display:flex;align-items:center;justify-content:center;animation:fadeIn .3s ease-out forwards;z-index:1000}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}@keyframes fadeOut{0%{opacity:1}to{opacity:0}}@keyframes springIn{0%{transform:scale(.4);opacity:0}60%{transform:scale(1.08);opacity:1}80%{transform:scale(.98)}to{transform:scale(1);opacity:1}}@keyframes springOut{0%{transform:scale(1);opacity:1}40%{transform:scale(1.08);opacity:1}to{transform:scale(.4);opacity:0}}.modal{position:relative;border-radius:8px;width:90%;max-width:1700px;max-height:90vh;overflow:hidden;animation:springIn .8s cubic-bezier(.22,1.2,.36,1) forwards}@media (min-width: 2000px) and (max-height: 700px){.modal{max-width:900px}}@media (min-width: 1000px) and (max-height: 400px){.modal{max-width:700px}}.modal-container.closing{animation:fadeOut .3s ease-out forwards}.modal.closing{animation:springOut .8s cubic-bezier(.22,1.2,.36,1) forwards}.video-panel{position:relative;width:calc(100% - 300px);display:flex;flex-direction:column;align-items:center;overflow:hidden;justify-content:center}@media (min-width: 801px){.video-panel{padding-bottom:50px}}.video-panel-background{content:"";position:absolute;top:0;right:0;bottom:0;left:0;z-index:-100;background-color:#000;background-image:url(data:image/webp;base64,UklGRv4BAABXRUJQVlA4IPIBAAAQDgCdASpkADgAPm0wlEgkIqIlpvVbQLANiWUIcAF/N0SNSoFwLlO5RP2YPzaIbnj2FRb+bYMVMO2hQaOhoOYVcYas+y/tUm1/zmSSq5AUjQJ+cqL2Z4Z7qXLgXDAOWYT82r5bm+2mFDM38Q0ruBiEoVE+LSAJdoHQAP7gQtoYHET/VcymFbJngGPQnLANH4pBKeNTCNh83JD/q72P9SVEf91Mx4GHZGI07V8EIhDuJRWajJcwkrY9epV7HluQk5qhMElwzHER6a3Zc/OaBy35/gKiNW/4Wd0oEovwE2r9jyX1HImaWtlcTNyPPjyqvi7m5rKNN82p/S01kcM9spuizE4Pba01gNXE5vPW68xKBA/5rLkd/4UosKilKe9PXgPgEgNiTV8tlHZ33yDJQSojodoGsBvOsVgYm06hOx2FqbPFSVY/2mjEsBcCuGQAy1+sBIt2FygUENMwQ4jSOFHEQZ7C9Sc/t1gIlR2bZtNtp1BWIQW/Iu6DDMwjSSTX4qjCwnN6/sqzlv0ZFBAKVIX4uy9DbwSWFKGKqDlsrbAmVFaioKHX3IX/Xm49jyIK7/0PIre8rpPO7DBAX5JbGQCYg8mbG2uf5xTT1gAWy0N4hyjd8bt6FFnL6eUOrt6Hjzy5gP+/8lb0glwD14Mjd9AAAAA=);background-size:cover;background-position:center;transform:scale(1.1);filter:blur(10px);transition:transform .2s linear,filter .2s linear}.video-panel-background.loaded{transform:scale(1);filter:blur(0)}.video-area{position:relative;width:100%;padding-top:56.25%}.local-video-content{position:absolute;bottom:60px;right:10px;width:min(230px,22%);max-height:40%;overflow:hidden;z-index:10;transform:translateZ(0);-webkit-transform:translateZ(0);cursor:pointer;transition:transform .3s ease}@media (min-width: 801px){.local-video-content{position:fixed;bottom:60px;right:310px}}@media (max-width: 600px){.local-video-content{width:40%}}.local-video-content:hover{cursor:alias;transform:translateZ(0) scale(1.02)}.local-video-content video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;transform:translateZ(0) scaleX(-1);-webkit-transform:translateZ(0) scaleX(-1);transition:transform .5s cubic-bezier(.4,0,.2,1);border-radius:8px}.local-video-content.flipped video{transform:translateZ(0) scaleX(1);-webkit-transform:translateZ(0) scaleX(1)}.video-content{position:absolute;top:0;left:0;width:100%;height:100%}.video-controls{height:50px;width:100%;position:relative}@media (min-width: 801px){.video-controls{position:fixed;bottom:0;width:calc(100% - 300px);left:0}}.chat-panel{position:absolute;top:0;right:0;bottom:0;width:300px;background:#f5f5f5;overflow-y:auto}@media (max-width: 800px){.modal{margin:20px;max-height:none;max-width:none;display:grid;grid-template-columns:1fr 300px;overflow:hidden}.video-panel{width:100%}.chat-panel{position:static;width:auto}}@media (max-width: 800px) and (orientation: portrait){.modal{width:calc(100% - 40px);height:calc(100% - 40px);grid-template-columns:1fr;grid-template-rows:auto 1fr}}@media (max-width: 800px) and (orientation: landscape){.modal{grid-template-columns:1fr 250px}}@media (max-width: 800px) and (max-height: 400px){.modal{width:calc(100vw - 40px);height:calc(100vh - 40px);margin:20px;max-width:none;max-height:none}.controls{position:fixed;bottom:0;left:0;width:calc(100% - 250px)}}.chat-panel{background:linear-gradient(135deg,#022677,#9c063a)}.chat{display:flex;flex-direction:column;padding:15px;font-family:Inter,sans-serif;font-size:15px}.message{margin-bottom:5px;padding:8px 12px;border-radius:10px;max-width:80%;color:#fff;position:relative;min-width:60%;min-height:15px;line-height:1.3}.message>.tail{position:absolute;bottom:2px;right:0;width:10px;height:10px;display:none;transform:scale(.6)}.message>.tail svg{fill:#044ef4}.message-received>.tail{transform:scaleX(-1) scale(.5);left:0}.message-received>.tail svg{fill:#f72a72}.message-received{background:#f72a72;align-self:flex-start}.message-sent{background:#044ef4;align-self:flex-end}.message-received+.message-sent,.message-sent+.message-received{margin-top:15px}.message-sent:has(+.message-received),.message-sent:last-child{border-bottom-right-radius:2px}.message-sent:has(+.message-received) .tail,.message-sent:last-child .tail{display:block}.message-received:has(+.message-sent),.message-received:last-child{border-bottom-left-radius:2px}.message-received:has(+.message-sent) .tail,.message-received:last-child .tail{display:block}@keyframes heartbeat{0%{opacity:.8;transform:scale(1)}50%{opacity:1;transform:scale(1.01)}to{opacity:.8;transform:scale(1)}}.message.in-progress{animation:heartbeat 1.5s ease-in-out infinite}.controls{display:flex;gap:8px;background:#0009;height:50px;justify-content:center;align-items:center}.control-group{display:flex;align-items:center}.control-button{width:40px;height:40px;border-radius:50%;border:none;background:#ffffff1a;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.control-group .control-button{border-radius:20px 0 0 20px;margin-right:1px}.standalone{border-radius:50%!important;margin-right:0}.device-select-button{height:40px;border-radius:0 20px 20px 0;border:none;background:#ffffff1a;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.control-button:hover,.device-select-button:hover{background:#fff3}.control-button svg{width:24px;height:24px;color:#fff}.device-select-button svg{width:12px;height:12px;color:#fff}.hangup{border-radius:50%!important;background:#f44}.hangup:hover{background:#f66}.device-menu{position:absolute;bottom:100%;left:50%;transform:translate(-50%);margin-bottom:8px;background:#000000e6;border-radius:8px;padding:8px;min-width:200px;z-index:1000}.device-option{font-size:15px;font-family:sans-serif;color:#fff;padding:6px 4px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px}.device-option.selected{font-weight:700}.device-option:hover{background:#ffffff1a}.device-option svg{width:16px;height:16px;color:#007bff;flex-shrink:0}.muted-icon,.unmuted-icon{display:flex;align-items:center;justify-content:center}#menuContainer,.device-select-wrapper{position:relative}.device-select-button:disabled{opacity:.5;cursor:not-allowed;pointer-events:none}.loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}.loading-icon{color:#fff}.loading-icon svg{animation:spin 3s linear infinite}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.error-message{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;background:#fff;padding:0;border-radius:12px;box-shadow:0 8px 24px #0003;max-width:90%;min-width:400px;font-family:Inter,sans-serif;display:flex;flex-direction:column}@media (max-width: 768px){.error-message{transform:translate(-50%,calc(-50% - 50px));min-width:unset}}.error-message .error-header{display:flex;justify-content:flex-start;align-items:center;padding:16px 24px;border-bottom:1px solid #eee}.error-message .error-header .error-title{margin:0;font-size:18px;font-weight:600;color:#111}.error-message .error-content{padding:24px;display:flex;flex-direction:column;gap:24px}.error-message .error-content .error-text{font-size:15px;color:#333;line-height:1.5;text-align:left}.error-message .error-content .action-button{align-self:flex-end;padding:10px 24px;border:none;border-radius:6px;background:#044ef4;color:#fff;font-family:Inter,sans-serif;font-size:14px;font-weight:500;cursor:pointer;transition:background-color .2s ease,transform .1s ease}.error-message .error-content .action-button:hover{background:#0446db}.error-message .error-content .action-button:active{transform:scale(.98);background:#033ec2}.modal-container:has(.error) .modal{filter:blur(4px)}.user-form-container{position:absolute;top:calc(50% + 25px);left:50%;transform:translate(-50%,-50%);background:#fffffff2;padding:25px;border-radius:8px;box-shadow:0 2px 10px #0000001a;z-index:1000;font-family:Inter,sans-serif;width:min(400px,90%);opacity:1;transition:opacity .3s ease-out}@media (max-width: 800px),(max-height: 600px){.user-form-container{position:absolute;top:0;left:0;width:calc(100% - 50px);height:100%;transform:none;border-radius:0;display:flex;align-items:center;justify-content:center}}.user-form-container.fade-out{opacity:0}.user-form-container .close-button{position:absolute;top:0;right:1px;background:transparent;border:none;cursor:pointer;padding:4px;color:#666;transition:color .2s}.user-form-container .close-button:hover{color:#333}.user-form-container .close-button svg{width:24px;height:24px}.user-form{margin-top:10px;display:flex;flex-direction:column;gap:1rem;width:100%}.user-form input{width:100%;padding:.75rem;border:1px solid #ddd;border-radius:4px;font-size:1rem;font-family:inherit;box-sizing:border-box;background-color:#fff;color:#333}@media (max-width: 480px){.user-form input{padding:.6rem;font-size:.95rem}}.form-helper-text{color:#666;margin-bottom:16px;text-align:center}.form-buttons{display:flex;gap:12px;justify-content:center;margin-top:.5rem}.form-buttons button{padding:.75rem 1.5rem;border-radius:4px;font-size:1rem;cursor:pointer;transition:all .2s;font-family:inherit}@media (max-width: 480px){.form-buttons button{padding:.6rem 1.2rem;font-size:.95rem}}.skip-button{background:transparent;border:2px solid #044ef4;color:#044ef4}.skip-button:hover{background:#044ef41a}.submit-button{background:#044ef4;color:#fff;border:none}.submit-button:hover{background:#033ec2}');const Ud=Wd`
  <div class="modal-container" name="modalContainer">
    <div class="modal" name="modal">
      <div class="video-panel" name="videoPanel">
        <div class="video-panel-background" name="videoPanelBackground"></div>
        <div class="local-video-content" name="localVideoArea">
          <!-- Local Video area -->
        </div>
        <div class="video-area">
          <div class="video-content" name="videoArea">
            <!-- Remote Video area -->
          </div>
        </div>
        <div class="video-controls" name="controlsPanel">
          <!-- Controls panel -->
        </div>
      </div>
      <div class="chat-panel" name="chatPanel"></div>
    </div>
  </div>
`;const zd=Wd`
  <div class="loading" name="loading">
    <div class="loading-icon">${'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 256 256" height="50px" width="50px" xmlns="http://www.w3.org/2000/svg">\n  <path d="M140,32V64a12,12,0,0,1-24,0V32a12,12,0,0,1,24,0Zm33.25,62.75a12,12,0,0,0,8.49-3.52L204.37,68.6a12,12,0,0,0-17-17L164.77,74.26a12,12,0,0,0,8.48,20.49ZM224,116H192a12,12,0,0,0,0,24h32a12,12,0,0,0,0-24Zm-42.26,48.77a12,12,0,1,0-17,17l22.63,22.63a12,12,0,0,0,17-17ZM128,180a12,12,0,0,0-12,12v32a12,12,0,0,0,24,0V192A12,12,0,0,0,128,180ZM74.26,164.77,51.63,187.4a12,12,0,0,0,17,17l22.63-22.63a12,12,0,1,0-17-17ZM76,128a12,12,0,0,0-12-12H32a12,12,0,0,0,0,24H64A12,12,0,0,0,76,128ZM68.6,51.63a12,12,0,1,0-17,17L74.26,91.23a12,12,0,0,0,17-17Z"></path>\n</svg>'}</div>
  </div>
`;class Bd{constructor(){Dd(this,"entries",[]),Dd(this,"lastSpoken",null)}}class Hd{constructor(){Dd(this,"state"),Dd(this,"aiPartialResult",null),Dd(this,"userPartialResult",null),this.state=new Bd}getHistory(){const e=[...this.state.entries];return this.aiPartialResult&&this.userPartialResult?"user"===this.state.lastSpoken?(e.push(this.aiPartialResult),e.push(this.userPartialResult)):(e.push(this.userPartialResult),e.push(this.aiPartialResult)):this.aiPartialResult?e.push(this.aiPartialResult):this.userPartialResult&&e.push(this.userPartialResult),e}handleEvent(e,t,i){switch(e){case"ai.response_utterance":this.aiPartialResult?this.aiPartialResult.text+=" "+t:this.aiPartialResult={type:"ai",text:t,state:"partial"},this.state.lastSpoken="ai";break;case"ai.completion":this.aiPartialResult&&(this.state.entries.push({...this.aiPartialResult,state:"complete"}),this.aiPartialResult=null),this.state.lastSpoken=i?"user":"ai";break;case"ai.partial_result":this.userPartialResult={type:"user",text:t,state:"partial"},this.state.lastSpoken="user";break;case"ai.speech_detect":this.userPartialResult&&(this.state.entries.push({...this.userPartialResult,state:"complete",text:t}),this.userPartialResult=null),this.state.lastSpoken="user"}this.onUpdate()}onUpdate(){}}class Fd{constructor(){Dd(this,"devices",[]),Dd(this,"loading",!1),Dd(this,"selectedMicrophone",null),Dd(this,"selectedCamera",null),Dd(this,"selectedSpeaker",null),Dd(this,"isAudioMuted",!1),Dd(this,"isVideoMuted",!1),Dd(this,"isSpeakerMuted",!1),Dd(this,"currentVideoAspectRatio",null)}get audioinput(){return this.devices.filter((e=>"audioinput"===e.kind))}get audiooutput(){return this.devices.filter((e=>"audiooutput"===e.kind))}get videoinput(){return this.devices.filter((e=>"videoinput"===e.kind))}}const qd=class e{constructor(){Dd(this,"state",new Fd),Dd(this,"call",null),Dd(this,"deviceWatcher",null),Dd(this,"permissionStream",null)}static getInstance(){return e.instance||(e.instance=new e),e.instance}async getPermissions(e=!0){try{const t=await jd.getUserMedia({audio:!0,video:e});return this.permissionStream&&this.permissionStream.getTracks().forEach((e=>e.stop())),this.permissionStream=t,{success:!0}}catch(Ra){return console.error("Error getting permissions:",Ra),{success:!1,message:Ra instanceof Error?Ra.message:"Failed to get device permissions"}}}async setup(e){this.permissionStream&&(this.permissionStream.getTracks().forEach((e=>e.stop())),this.permissionStream=null),this.state.loading=!0,this.call=e;try{await this._updateDevicesList(),await this._updateSelectedDevices(),this.updateVideoAspectRatio(),this.deviceWatcher=await jd.createDeviceWatcher(),this.deviceWatcher.on("changed",(async()=>{await this._updateDevicesList(),await this._updateSelectedDevices(),this.updateVideoAspectRatio(),this.onChange()})),this.state.loading=!1,this.onLoad()}catch(Ra){console.error("Error in setup:",Ra),this.state.loading=!1}}async _updateDevicesList(){var e,t,i,r;const o=await jd.enumerateDevices();if(this.state.devices=o,this.call){if(this.state.isVideoMuted){const i=this.call.localVideoTrack||(null==(t=null==(e=this.call.localStream)?void 0:e.getVideoTracks())?void 0:t[0]);i&&(i.enabled=!1)}if(this.state.isAudioMuted){const e=this.call.localAudioTrack||(null==(r=null==(i=this.call.localStream)?void 0:i.getAudioTracks())?void 0:r[0]);e&&(e.enabled=!1)}}}async _updateSelectedDevices(){const{audioinput:e,audiooutput:t,videoinput:i}=this.state;!this.state.selectedMicrophone&&e.length>0&&(this.state.selectedMicrophone=e[0]),!this.state.selectedCamera&&i.length>0&&(this.state.selectedCamera=i[0]),!this.state.selectedSpeaker&&t.length>0&&(this.state.selectedSpeaker=t[0]),this.state.selectedMicrophone=e.find((e=>{var t;return e.deviceId===(null==(t=this.state.selectedMicrophone)?void 0:t.deviceId)}))||e[0]||null,this.state.selectedCamera=i.find((e=>{var t;return e.deviceId===(null==(t=this.state.selectedCamera)?void 0:t.deviceId)}))||i[0]||null,this.state.selectedSpeaker=t.find((e=>{var t;return e.deviceId===(null==(t=this.state.selectedSpeaker)?void 0:t.deviceId)}))||t[0]||null}updateVideoAspectRatio(){var e;if(null==(e=this.call)||!e.localStream)return;const t=this.call.localStream.getVideoTracks()[0];if(!t)return;const i=t.getSettings(),r=i.aspectRatio||(i.width&&i.height?i.width/i.height:null);r!==this.state.currentVideoAspectRatio&&(this.state.currentVideoAspectRatio=r,this.onAspectRatioChange(r||null))}onLoad(){}onChange(){}onAspectRatioChange(e){console.log("onAspectRatioChange",e)}async updateCamera(e){const t=this.state.devices.find((t=>t.deviceId===e&&"videoinput"===t.kind));if(!t||!this.call)return!1;try{return await this.call.updateCamera({deviceId:e}),this.state.selectedCamera=t,this.updateVideoAspectRatio(),this.onChange(),!0}catch(i){return console.error("Error updating camera:",i),!1}}async updateMicrophone(e){const t=this.state.devices.find((t=>t.deviceId===e&&"audioinput"===t.kind));if(!t||!this.call)return!1;try{return await this.call.updateMicrophone({deviceId:e}),this.state.selectedMicrophone=t,this.onChange(),!0}catch(i){return console.error("Error updating microphone:",i),!1}}async updateSpeaker(e){const t=this.state.devices.find((t=>t.deviceId===e&&"audiooutput"===t.kind));if(!t||!this.call)return!1;try{return await this.call.updateSpeaker({deviceId:e}),this.state.selectedSpeaker=t,this.onChange(),!0}catch(i){return console.error("Error updating speaker:",i),!1}}async toggleVideo(){var e;if(this.call)try{const e=await this.getSelf();null!=e&&e.videoMuted?await this.call.videoUnmute():await this.call.videoMute(),this.state.isVideoMuted=!this.state.isVideoMuted,this.onChange()}catch(Ra){console.error("Failed to toggle video via call method, trying fallback:",Ra);try{const t=this.call.localVideoTrack;if(t)return t.enabled=this.state.isVideoMuted,this.state.isVideoMuted=!this.state.isVideoMuted,void this.onChange();const i=this.call.localStream,r=null==(e=null==i?void 0:i.getVideoTracks())?void 0:e[0];if(r)return r.enabled=this.state.isVideoMuted,this.state.isVideoMuted=!this.state.isVideoMuted,void this.onChange();console.error("No video track available for fallback muting")}catch(t){console.error("Failed to toggle video via fallback method:",t)}}}async toggleAudio(){var e;if(this.call)try{const e=await this.getSelf();null!=e&&e.audioMuted?await this.call.audioUnmute():await this.call.audioMute(),this.state.isAudioMuted=!this.state.isAudioMuted,this.onChange()}catch(Ra){console.error("Failed to toggle audio via call method, trying fallback:",Ra);try{const t=this.call.localAudioTrack;if(t)return t.enabled=this.state.isAudioMuted,this.state.isAudioMuted=!this.state.isAudioMuted,void this.onChange();const i=this.call.localStream,r=null==(e=null==i?void 0:i.getAudioTracks())?void 0:e[0];if(r)return r.enabled=this.state.isAudioMuted,this.state.isAudioMuted=!this.state.isAudioMuted,void this.onChange();console.error("No audio track available for fallback muting")}catch(t){console.error("Failed to toggle audio via fallback method:",t)}}}async toggleSpeaker(){if(this.call)try{const e=await this.getSelf();null!=e&&e.deaf?await this.call.undeaf():await this.call.deaf(),this.state.isSpeakerMuted=!this.state.isSpeakerMuted,this.onChange()}catch(Pa){console.error("Failed to toggle speaker via deaf/undeaf, trying fallback:",Pa);try{this.call.audioEl&&(this.call.audioEl.muted=!this.state.isSpeakerMuted,this.state.isSpeakerMuted=!this.state.isSpeakerMuted,this.onChange())}catch(Ra){console.error("Failed to toggle speaker via fallback method:",Ra)}}}async getSelf(){if(!this.call)return null;const e=await this.call.getMembers();return null==e?void 0:e.members.find((e=>{var t;return e.id===(null==(t=this.call)?void 0:t.memberId)}))}reset(){var e,t,i;this.deviceWatcher&&(this.deviceWatcher.off("changed"),this.deviceWatcher=null),this.permissionStream&&(this.permissionStream.getTracks().forEach((e=>e.stop())),this.permissionStream=null),null!=(e=this.call)&&e.localStream&&this.call.localStream.getTracks().forEach((e=>{e.stop()})),null!=(t=this.call)&&t.localVideoTrack&&this.call.localVideoTrack.stop(),null!=(i=this.call)&&i.localAudioTrack&&this.call.localAudioTrack.stop(),this.call=null,this.state=new Fd,this.onLoad=()=>{},this.onChange=()=>{},this.onAspectRatioChange=()=>{}}};Dd(qd,"instance");const Jd=qd.getInstance();class Kd{constructor(e,t){Dd(this,"client",null),Dd(this,"callDetails",null),Dd(this,"chat",null),Dd(this,"currentCall",null),Dd(this,"token",null),Dd(this,"userVariables",null),this.callDetails=e,this.token=t}async getWidgetToken(e){const t=await fetch("https://embeds.signalwire.com/api/fabric/embeds/tokens",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e})});if(!t.ok)throw new Error("Failed to authenticate embeds token");return(await t.json()).token}getLocalVideoTrack(){var e;return null==(e=this.currentCall)?void 0:e.localVideoTrack}getLocalAudioTrack(){var e;return null==(e=this.currentCall)?void 0:e.localAudioTrack}async setupClient(){if(!this.token)throw new Error("Token is not set");let e=this.token;this.token.startsWith("c2c_")&&(e=await this.getWidgetToken(this.token));const t=await Md({token:e});return t.on("ai.partial_result",(e=>{var t;null==(t=this.chat)||t.handleEvent("ai.partial_result",e.text??"",e.barged??!1)})),t.on("ai.speech_detect",(e=>{var t;const i=e.text.replace(/\{confidence=[\d.]+\}/,"");null==(t=this.chat)||t.handleEvent("ai.speech_detect",i,"normal"!==e.type)})),t.on("ai.completion",(e=>{var t;null==(t=this.chat)||t.handleEvent("ai.completion",e.text??"","barged"===e.type)})),t.on("ai.response_utterance",(e=>{var t;null==(t=this.chat)||t.handleEvent("ai.response_utterance",e.utterance??"",!1)})),this.client=t,t}addUserVariables(e){this.userVariables={...this.userVariables,...e}}async dial(e,t,i){["ci-SAT","pt-SAT","as-SAT"].forEach((e=>sessionStorage.removeItem(e)));const r=await this.setupClient();if(this.chat=new Hd,!this.callDetails)throw new Error("Call details are not set");const o={callOriginHref:window.location.href,...this.userVariables},n=await r.dial({to:this.callDetails.destination,rootElement:e,audio:this.callDetails.supportsAudio,video:this.callDetails.supportsVideo,negotiateVideo:this.callDetails.supportsVideo,userVariables:o});return this.currentCall=n,console.info("Call started",this.currentCall,"with user variables",o),n.on("call.joined",(()=>{if(window.call=n,null!=n&&n.localStream){Jd.updateVideoAspectRatio();const{localVideo:e}=Wd`<video
          autoplay
          playsinline
          muted
          name="localVideo"
        ></video>`();e.onloadedmetadata=()=>{Jd.onAspectRatioChange(e.videoWidth/e.videoHeight)},e.srcObject=n.localStream,i(e)}})),n.on("call.updated",(()=>{console.log("call.updated",n)})),this.chat&&(this.chat.onUpdate=()=>{var e;t((null==(e=this.chat)?void 0:e.getHistory())??[])}),n}async start(){var e;if(!this.client)throw new Error("Client is not set");await(null==(e=this.currentCall)?void 0:e.start())}async hangup(){var e;if(!this.currentCall)throw new Error("Call is not set");await(null==(e=this.currentCall)?void 0:e.hangup())}reset(){this.client&&(this.client.off("ai.partial_result"),this.client.off("ai.speech_detect"),this.client.off("ai.completion"),this.client.off("ai.response_utterance"),this.client.disconnect()),this.currentCall=null,this.client=null,this.chat=null}}const Gd='<svg xmlns="http://www.w3.org/000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n  <path d="M18 15l-6-6-6 6"/>\n</svg> ',Zd=Wd`
  <div name="controlsContainer">
    <div class="controls">
      <div class="control-group">
        <button class="control-button video-button" name="videoButton">
          <span class="muted-icon" style="display: none;">${'<svg  viewBox="0 0 24 24"><path fill="currentColor" d="M3.27,2L2,3.27L4.73,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16C16.2,18 16.39,17.92 16.54,17.82L19.73,21L21,19.73M21,6.5L17,10.5V7A1,1 0 0,0 16,6H9.82L21,17.18V6.5Z"></path></svg>'}</span>
          <span class="unmuted-icon">${'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z"></path></svg>'}</span>
        </button>
        <div class="device-select-wrapper">
          <button
            class="device-select-button video-devices-button"
            name="videoDevicesButton"
          >
            ${Gd}
          </button>
          <div
            class="device-menu"
            name="videoDevicesMenu"
            style="display: none;"
          >
            <!-- Populated via JS -->
          </div>
        </div>
      </div>

      <div class="control-group">
        <button class="control-button mic-button" name="micButton">
          <span class="muted-icon" style="display: none;"
            >${'<svg  viewBox="0 0 24 24"><title>microphone-off</title><path d="M19,11C19,12.19 18.66,13.3 18.1,14.28L16.87,13.05C17.14,12.43 17.3,11.74 17.3,11H19M15,11.16L9,5.18V5A3,3 0 0,1 12,2A3,3 0 0,1 15,5V11L15,11.16M4.27,3L21,19.73L19.73,21L15.54,16.81C14.77,17.27 13.91,17.58 13,17.72V21H11V17.72C7.72,17.23 5,14.41 5,11H6.7C6.7,14 9.24,16.1 12,16.1C12.81,16.1 13.6,15.91 14.31,15.58L12.65,13.92L12,14A3,3 0 0,1 9,11V10.28L3,4.27L4.27,3Z" style="fill: currentcolor;"></path></svg>'}</span
          >
          <span class="unmuted-icon">${'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n  <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z" fill="currentColor"/>\n</svg> '}</span>
        </button>
        <div class="device-select-wrapper">
          <button
            class="device-select-button mic-devices-button"
            name="micDevicesButton"
          >
            ${Gd}
          </button>
          <div class="device-menu" name="micDevicesMenu" style="display: none;">
            <!-- Populated via JS -->
          </div>
        </div>
      </div>

      <div class="control-group">
        <button class="control-button speaker-button" name="speakerButton">
          <span class="muted-icon" style="display: none;"
            >${'<svg viewBox="0 0 24 24"><path d="M12,4L9.91,6.09L12,8.18M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.53C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.5,12.43 16.5,12.21 16.5,12Z" style="fill: currentcolor;"></path></svg>'}</span
          >
          <span class="unmuted-icon">${'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n  <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" fill="currentColor"/>\n</svg> '}</span>
        </button>
        <div class="device-select-wrapper">
          <button
            class="device-select-button speaker-devices-button"
            name="speakerDevicesButton"
          >
            ${Gd}
          </button>
          <div
            class="device-menu"
            name="speakerDevicesMenu"
            style="display: none;"
          >
            <!-- Populated via JS -->
          </div>
        </div>
      </div>

      <button class="control-button hangup" name="hangupButton">
        ${'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="200px" width="200px" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1-.29-.7c0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.67-1.85.996.996 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"></path></svg>'}
      </button>
    </div>
  </div>
`;function Xd(e,t){const i=t.scrollHeight-t.clientHeight<=t.scrollTop+300,r=t.scrollTop,o=e.map((e=>`<div class="message ${"user"===e.type?"message-sent":"message-received"} ${"partial"===e.state?"in-progress":""}">${e.text}<div class="tail"><svg width="25" height="27" viewBox="0 0 25 27" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M25 26C14.5 14.5 12.5 4.5 12.5 0H0V13C0 13 10 26.5 25 26Z"/>\n</svg>\n</div></div> `)).join(""),{chatContainer:n,chat:s}=Wd`
    <div name="chatContainer" class="chat-container">
      <div class="chat" name="chat">${o}</div>
    </div>
  `();null!==t.querySelector(".chat")?function(e,t){const i=e.children,r=t.children;for(let o=0;o<r.length;o++){const e=r[o],n=i[o];n?(e.innerHTML=n.innerHTML,e.className=n.className):(console.warn("chat.ui.ts: simple_diff: chat state changed in unexpected way."),t.removeChild(e))}for(let o=r.length;o<i.length;o++)t.appendChild(i[o].cloneNode(!0))}(s,t.querySelector(".chat")):t.appendChild(n),i?t.scrollTo({top:t.scrollHeight,behavior:"smooth"}):t.scrollTop=r}const Qd=Wd`<div class="error-message" name="errorModal">
  <div class="error-header">
    <h3 class="error-title" name="titleEl"></h3>
  </div>
  <div class="error-content">
    <div class="error-text" name="messageEl"></div>
    <button class="action-button" name="closeButton">Close</button>
  </div>
</div> `;function Yd(e,t,i){const{errorModal:r,closeButton:o,titleEl:n,messageEl:s}=Qd();return n.textContent=e,s.textContent=t,null==o||o.addEventListener("click",(()=>{i()})),r}const el=Wd`
  <div class="user-form-container" name="userFormContainer">
    <button type="button" class="close-button" name="closeButton">
      ${'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n</svg> '}
    </button>

    <form class="user-form" name="userForm">
      <input type="text" name="userName" placeholder="Your Name" />
      <input
        type="email"
        name="userEmail"
        placeholder="Your Email (optional)"
      />
      <input
        type="tel"
        name="userPhone"
        placeholder="Your Phone Number (optional)"
      />
      <div class="form-buttons">
        <button type="button" name="skipButton" class="skip-button">
          Skip
        </button>
        <button type="submit" class="submit-button">Start Call</button>
      </div>
    </form>
  </div>
`;class tl extends HTMLElement{constructor(){super(),Dd(this,"callOngoing",!1),Dd(this,"callLoading",!1),Dd(this,"shadow",this.attachShadow({mode:"open"})),Dd(this,"callDetails",null),Dd(this,"call",null),Dd(this,"containerElement",null),Dd(this,"modalContainer",null),Dd(this,"previousOverflowStyle",""),Dd(this,"token",null),Dd(this,"userVariables",null),this.setupDOM(),$d.apply(this.shadow)}static get observedAttributes(){return["token","buttonId","callDetails","userVariables"]}attributeChangedCallback(e,t,i){switch(e){case"token":this.token=i;break;case"callDetails":try{this.callDetails=JSON.parse(i)}catch{console.error("Invalid JSON in callDetails attribute"),this.callDetails=null}break;case"userVariables":try{const e=JSON.parse(i);this.userVariables=e,this.call&&this.call.addUserVariables(e)}catch{console.error("Invalid JSON in userVariables attribute"),this.userVariables=null}}}connectedCallback(){const e=this.getAttribute("token");this.token=e;const t=this.getAttribute("buttonId");if(t){const e=e=>{e.classList.contains("demo-button-disabled")&&e.classList.remove("demo-button-disabled"),e.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.setupCall()}))},i=document.getElementById(t);i?e(i):new MutationObserver(((i,r)=>{const o=document.getElementById(t);o&&(e(o),r.disconnect())})).observe(document.body,{childList:!0,subtree:!0})}try{const e=this.getAttribute("callDetails");if(null===e)throw new Error("callDetails attribute is required");this.callDetails=JSON.parse(e)}catch{console.error("Invalid JSON in callDetails attribute"),this.callDetails=null}try{const e=this.getAttribute("userVariables");e&&(this.userVariables=JSON.parse(e))}catch{console.error("Invalid JSON in userVariables attribute"),this.userVariables=null}this.callDetails&&this.token&&(this.call=new Kd(this.callDetails,this.token),this.userVariables&&this.call.addUserVariables(this.userVariables))}closeModal(){if(this.modalContainer){const e=this.modalContainer.querySelector(".modal");this.modalContainer.classList.add("closing"),null==e||e.classList.add("closing"),setTimeout((()=>{var e,t;Jd.reset(),null==(e=this.modalContainer)||e.remove(),this.modalContainer=null,document.body.style.overflow=this.previousOverflowStyle,this.callOngoing=!1,null==(t=this.call)||t.reset()}),800)}}async setupCall(){var e;if(this.callOngoing)return void console.warn("Call is already ongoing; nop");if(null===this.callDetails||null===this.call)return void console.warn("No call or Call details provided");this.callOngoing=!0,this.callLoading=!0,this.previousOverflowStyle=document.body.style.overflow,document.body.style.overflow="hidden";const{modalContainer:t,videoPanel:i,videoArea:r,localVideoArea:o,controlsPanel:n,chatPanel:s}=function(){const{modalContainer:e,videoPanel:t,videoArea:i,localVideoArea:r,controlsPanel:o,chatPanel:n,videoPanelBackground:s}=Ud();r.addEventListener("click",(()=>{r.classList.toggle("flipped")}));const a=Wd`<img
    name="image"
    src="https://developer.signalwire.com/img/call-widget/sw_background.webp"
  />`,{image:c}=a(),d=()=>{s.classList.add("loaded"),s.style.backgroundImage=`url(${c.src})`};return"decode"in c?c.decode().then(d).catch((()=>{d()})):c.onload=d,{modalContainer:e,videoPanel:t,videoArea:i,localVideoArea:r,controlsPanel:o,chatPanel:n}}();this.modalContainer=t,null==(e=this.containerElement)||e.appendChild(t);const a="false"!==this.getAttribute("collectUserDetails"),c=async e=>{var t,a,c,d,l,u,h;e&&(null==(t=this.call)||t.addUserVariables(e)),this.renderLoading(this.callLoading,i);const m=await Jd.getPermissions((null==(a=this.callDetails)?void 0:a.supportsVideo)??!1);if(!m.success){console.error("Error getting permissions");const e=Yd("Error Accessing Devices",m.message||"Error getting device permissions. Please grant this page access and try again.",(()=>this.closeModal()));return void(null==(c=this.modalContainer)||c.appendChild(e))}let p=null;try{p=await(null==(d=this.call)?void 0:d.dial(r,(function(e){Xd(e,s)}),(function(e){o.appendChild(e)})))??null}catch(v){console.error("Error setting up call",v);const e=Yd("Error","Error creating the call. Please refresh the page and try again.",(()=>this.closeModal()));return void(null==(l=this.modalContainer)||l.appendChild(e))}p&&await Jd.setup(p),Jd.onAspectRatioChange=e=>{e&&o&&(o.style.aspectRatio=`${e}`)};const g=await async function(e){Jd.onChange=h;const{controlsContainer:t,videoButton:i,micButton:r,speakerButton:o,hangupButton:n,videoDevicesButton:s,micDevicesButton:a,speakerDevicesButton:c,videoDevicesMenu:d,micDevicesMenu:l,speakerDevicesMenu:u}=Zd();function h(){const{isVideoMuted:e,isAudioMuted:t,isSpeakerMuted:n,videoinput:h,audioinput:p,audiooutput:g,selectedCamera:v,selectedMicrophone:f,selectedSpeaker:y}=Jd.state;function b(e,t){const i=e.querySelector(".muted-icon"),r=e.querySelector(".unmuted-icon");i&&r&&(i.style.display=t?"block":"none",r.style.display=t?"none":"block")}b(i,e),b(r,t),b(o,n),s.style.display=h.length>0?"block":"none",s.disabled=e,i.classList.toggle("standalone",0===h.length),a.style.display=p.length>0?"block":"none",a.disabled=t,r.classList.toggle("standalone",0===p.length),c.style.display=g.length>0?"block":"none",c.disabled=n,o.classList.toggle("standalone",0===g.length),m(d,h,v,"camera"),m(l,p,f,"microphone"),m(u,g,y,"speaker")}function m(e,t,i,r){e.innerHTML=t.map((e=>`\n      <div class="device-option ${e.deviceId===(null==i?void 0:i.deviceId)?"selected":""}" data-device-id="${e.deviceId}">\n        ${e.deviceId===(null==i?void 0:i.deviceId)?'<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n  <path d="M13.3333 4L6 11.3333L2.66667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n</svg> ':""}\n        ${e.label||`${r} ${t.indexOf(e)+1}`}\n      </div>\n    `)).join("")}function p(e,t,i){e.addEventListener("click",(e=>{e.stopPropagation(),[d,l,u].forEach((e=>{e!==t&&(e.style.display="none")})),t.style.display="none"===t.style.display?"block":"none"})),t.addEventListener("click",(async e=>{const r=e.target.closest(".device-option");if(r){const e=r.getAttribute("data-device-id");e&&(await i(e),t.style.display="none")}}))}return i.addEventListener("click",(()=>Jd.toggleVideo())),r.addEventListener("click",(()=>Jd.toggleAudio())),o.addEventListener("click",(()=>Jd.toggleSpeaker())),n.addEventListener("click",(()=>null==e?void 0:e())),p(s,d,(e=>Jd.updateCamera(e))),p(a,l,(e=>Jd.updateMicrophone(e))),p(c,u,(e=>Jd.updateSpeaker(e))),document.addEventListener("click",(()=>{d.style.display="none",l.style.display="none",u.style.display="none"})),h(),t}((async()=>{var e;try{await(null==(e=this.call)?void 0:e.hangup())}catch(t){console.error("Error hanging up call. Force terminating call.",t)}this.closeModal()}));null==p||p.on("room.left",(()=>{this.closeModal()})),null==p||p.on("destroy",(()=>{this.closeModal()})),n.appendChild(g);try{await(null==(u=this.call)?void 0:u.start())}catch(v){console.error("Error starting call",v);const e=Yd("Error","Error starting the call. This is possibly due to network issues. Please refresh the page and try again.",(()=>this.closeModal()));return void(null==(h=this.modalContainer)||h.appendChild(e))}this.callLoading=!1,this.renderLoading(this.callLoading,i)};if(a){const e=function({onSubmit:e,onClose:t}){const{userFormContainer:i,userName:r,userEmail:o,userPhone:n,skipButton:s,closeButton:a}=el(),c=e=>{i.classList.add("fade-out"),setTimeout((()=>{i.remove(),e()}),300)};a.addEventListener("click",(()=>{c(t)})),s.addEventListener("click",(()=>{const t={userName:"",userEmail:"",userPhone:""};c((()=>e(t)))}));const d=i.querySelector("form");return null==d||d.addEventListener("submit",(async t=>{t.preventDefault();const i={userName:r.value,userEmail:o.value,userPhone:n.value};c((()=>e(i)))})),{userFormContainer:i,destroy:()=>c((()=>{}))}}({onSubmit:e=>{c(e)},onClose:()=>{this.closeModal()}});r.appendChild(e.userFormContainer)}else await c()}renderLoading(e,t){var i;if(e){const{loading:e}=zd();t.appendChild(e)}else null==(i=t.querySelector(".loading"))||i.remove()}setupDOM(){const e=document.createElement("div");this.shadow.appendChild(e),this.containerElement=e}disconnectedCallback(){this.closeModal()}}customElements.define("c2c-widget",tl)},7963:e=>{"use strict";const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){const i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((e=>0===e.indexOf(i)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const i={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let r=8;r<t.length;r+=2)switch(t[r]){case"raddr":i.relatedAddress=t[r+1];break;case"rport":i.relatedPort=parseInt(t[r+1],10);break;case"tcptype":i.tcpType=t[r+1];break;case"ufrag":i.ufrag=t[r+1],i.usernameFragment=t[r+1];break;default:void 0===i[t[r]]&&(i[t[r]]=t[r+1])}return i},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const i=e.component;"rtp"===i?t.push(1):"rtcp"===i?t.push(2):t.push(i),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let i;const r=e.substring(e.indexOf(" ")+1).split(";");for(let o=0;o<r.length;o++)i=r[o].trim().split("="),t[i[0].trim()]=i[1];return t},t.writeFmtp=function(e){let t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const r=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t)})),t+="a=fmtp:"+i+" "+r.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),i={ssrc:parseInt(e.substring(7,t),10)},r=e.indexOf(":",t);return r>-1?(i.attribute=e.substring(t+1,r),i.value=e.substring(r+1)):i.attribute=e.substring(t+1),i},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){const r=t.matchPrefix(e+i,"a=ice-ufrag:")[0],o=t.matchPrefix(e+i,"a=ice-pwd:")[0];return r&&o?{usernameFragment:r.substring(12),password:o.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(e)[0].split(" ");i.profile=r[2];for(let n=3;n<r.length;n++){const o=r[n],s=t.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(s){const r=t.parseRtpMap(s),n=t.matchPrefix(e,"a=fmtp:"+o+" ");switch(r.parameters=n.length?t.parseFmtp(n[0]):{},r.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(t.parseRtcpFb),i.codecs.push(r),r.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(r.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{i.headerExtensions.push(t.parseExtmap(e))}));const o=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return i.codecs.forEach((e=>{o.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),i},t.writeRtpDescription=function(e,i){let r="";r+="m="+e+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((e=>{r+=t.writeRtpMap(e),r+=t.writeFmtp(e),r+=t.writeRtcpFb(e)}));let o=0;return i.codecs.forEach((e=>{e.maxptime>o&&(o=e.maxptime)})),o>0&&(r+="a=maxptime:"+o+"\r\n"),i.headerExtensions&&i.headerExtensions.forEach((e=>{r+=t.writeExtmap(e)})),r},t.parseRtpEncodingParameters=function(e){const i=[],r=t.parseRtpParameters(e),o=-1!==r.fecMechanisms.indexOf("RED"),n=-1!==r.fecMechanisms.indexOf("ULPFEC"),s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=s.length>0&&s[0].ssrc;let c;const d=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));d.length>0&&d[0].length>1&&d[0][0]===a&&(c=d[0][1]),r.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c}),i.push(t),o&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:n?"red+ulpfec":"red"},i.push(t))}})),0===i.length&&a&&i.push({ssrc:a});let l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substring(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,i.forEach((e=>{e.maxBitrate=l}))),i},t.parseRtcpParameters=function(e){const i={},r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const o=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=o.length>0,i.compound=0===o.length;const n=t.matchPrefix(e,"a=rtcp-mux");return i.mux=n.length>0,i},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let i;const r=t.matchPrefix(e,"a=msid:");if(1===r.length)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const o=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return o.length>0?(i=o[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},t.parseSctpDescription=function(e){const i=t.parseMLine(e),r=t.matchPrefix(e,"a=max-message-size:");let o;r.length>0&&(o=parseInt(r[0].substring(19),10)),isNaN(o)&&(o=65536);const n=t.matchPrefix(e,"a=sctp-port:");if(n.length>0)return{port:parseInt(n[0].substring(12),10),protocol:i.fmt,maxMessageSize:o};const s=t.matchPrefix(e,"a=sctpmap:");if(s.length>0){const e=s[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:o}}},t.writeSctpDescription=function(e,t){let i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,i,r){let o;const n=void 0!==i?i:2;o=e||t.generateSessionId();return"v=0\r\no="+(r||"thisisadapterortc")+" "+o+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,i){const r=t.splitLines(e);for(let t=0;t<r.length;t++)switch(r[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[t].substring(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const i=t.splitLines(e)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){const i=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const i=t.splitLines(e);for(let t=0;t<i.length;t++)if(i[t].length<2||"="!==i[t].charAt(1))return!1;return!0},e.exports=t},9443:e=>{"use strict";var t=Object.prototype.hasOwnProperty,i="~";function r(){}function o(e,t,i){this.fn=e,this.context=t,this.once=i||!1}function n(e,t,r,n,s){if("function"!=typeof r)throw new TypeError("The listener must be a function");var a=new o(r,n||e,s),c=i?i+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function a(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(i=!1)),a.prototype.eventNames=function(){var e,r,o=[];if(0===this._eventsCount)return o;for(r in e=this._events)t.call(e,r)&&o.push(i?r.slice(1):r);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o},a.prototype.listeners=function(e){var t=i?i+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var o=0,n=r.length,s=new Array(n);o<n;o++)s[o]=r[o].fn;return s},a.prototype.listenerCount=function(e){var t=i?i+e:e,r=this._events[t];return r?r.fn?1:r.length:0},a.prototype.emit=function(e,t,r,o,n,s){var a=i?i+e:e;if(!this._events[a])return!1;var c,d,l=this._events[a],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,o),!0;case 5:return l.fn.call(l.context,t,r,o,n),!0;case 6:return l.fn.call(l.context,t,r,o,n,s),!0}for(d=1,c=new Array(u-1);d<u;d++)c[d-1]=arguments[d];l.fn.apply(l.context,c)}else{var h,m=l.length;for(d=0;d<m;d++)switch(l[d].once&&this.removeListener(e,l[d].fn,void 0,!0),u){case 1:l[d].fn.call(l[d].context);break;case 2:l[d].fn.call(l[d].context,t);break;case 3:l[d].fn.call(l[d].context,t,r);break;case 4:l[d].fn.call(l[d].context,t,r,o);break;default:if(!c)for(h=1,c=new Array(u-1);h<u;h++)c[h-1]=arguments[h];l[d].fn.apply(l[d].context,c)}}return!0},a.prototype.on=function(e,t,i){return n(this,e,t,i,!1)},a.prototype.once=function(e,t,i){return n(this,e,t,i,!0)},a.prototype.removeListener=function(e,t,r,o){var n=i?i+e:e;if(!this._events[n])return this;if(!t)return s(this,n),this;var a=this._events[n];if(a.fn)a.fn!==t||o&&!a.once||r&&a.context!==r||s(this,n);else{for(var c=0,d=[],l=a.length;c<l;c++)(a[c].fn!==t||o&&!a[c].once||r&&a[c].context!==r)&&d.push(a[c]);d.length?this._events[n]=1===d.length?d[0]:d:s(this,n)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=i?i+e:e,this._events[t]&&s(this,t)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=i,a.EventEmitter=a,e.exports=a}}]);