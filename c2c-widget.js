var im=Object.defineProperty,nm=(e,t,r)=>t in e?im(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,P=(e,t,r)=>nm(e,"symbol"!=typeof t?t+"":t,r);!function(){"use strict";function e(e,...t){const r=e.reduce(((e,r,i)=>e+r+(t[i]||"")),"");return function(){const e=(new DOMParser).parseFromString(r,"text/html");if(!e.body.firstChild)throw new Error("Invalid HTML template");const t={};e.body.querySelectorAll("[name]").forEach((e=>{const r=e.getAttribute("name");r&&(t[r]=e,e.removeAttribute("name"))}));const i=document.createDocumentFragment();for(;e.body.firstChild;)i.appendChild(e.body.firstChild);return t}}const t=class e{constructor(){P(this,"styles",new Map)}static getInstance(){return e.instance||(e.instance=new e),e.instance}register(e){const t=e.length,r=t>40?`${t}:${e.slice(0,20)}:${e.slice(-20)}`:`${t}:${e}`;this.styles.has(r)||this.styles.set(r,e)}apply(e){const t=document.createElement("style");t.textContent=Array.from(this.styles.values()).join("\n"),e.appendChild(t)}};P(t,"instance");const r=t.getInstance();r.register('.modal-container{position:fixed;top:0;left:0;width:100%;height:100%;background-color:#000000ed;display:flex;align-items:center;justify-content:center;animation:fadeIn .3s ease-out forwards;z-index:1000}@keyframes fadeIn{0%{opacity:0}to{opacity:1}}@keyframes fadeOut{0%{opacity:1}to{opacity:0}}@keyframes springIn{0%{transform:scale(.4);opacity:0}60%{transform:scale(1.08);opacity:1}80%{transform:scale(.98)}to{transform:scale(1);opacity:1}}@keyframes springOut{0%{transform:scale(1);opacity:1}40%{transform:scale(1.08);opacity:1}to{transform:scale(.4);opacity:0}}.modal{position:relative;border-radius:8px;width:90%;max-width:1700px;max-height:90vh;overflow:hidden;animation:springIn .8s cubic-bezier(.22,1.2,.36,1) forwards}@media (min-width: 2000px) and (max-height: 700px){.modal{max-width:900px}}@media (min-width: 1000px) and (max-height: 400px){.modal{max-width:700px}}.modal-container.closing{animation:fadeOut .3s ease-out forwards}.modal.closing{animation:springOut .8s cubic-bezier(.22,1.2,.36,1) forwards}.video-panel{position:relative;width:calc(100% - 300px);display:flex;flex-direction:column;align-items:center;overflow:hidden;justify-content:center}@media (min-width: 801px){.video-panel{padding-bottom:50px}}.video-panel-background{content:"";position:absolute;top:0;right:0;bottom:0;left:0;z-index:-100;background-color:#000;background-image:url(data:image/webp;base64,UklGRv4BAABXRUJQVlA4IPIBAAAQDgCdASpkADgAPm0wlEgkIqIlpvVbQLANiWUIcAF/N0SNSoFwLlO5RP2YPzaIbnj2FRb+bYMVMO2hQaOhoOYVcYas+y/tUm1/zmSSq5AUjQJ+cqL2Z4Z7qXLgXDAOWYT82r5bm+2mFDM38Q0ruBiEoVE+LSAJdoHQAP7gQtoYHET/VcymFbJngGPQnLANH4pBKeNTCNh83JD/q72P9SVEf91Mx4GHZGI07V8EIhDuJRWajJcwkrY9epV7HluQk5qhMElwzHER6a3Zc/OaBy35/gKiNW/4Wd0oEovwE2r9jyX1HImaWtlcTNyPPjyqvi7m5rKNN82p/S01kcM9spuizE4Pba01gNXE5vPW68xKBA/5rLkd/4UosKilKe9PXgPgEgNiTV8tlHZ33yDJQSojodoGsBvOsVgYm06hOx2FqbPFSVY/2mjEsBcCuGQAy1+sBIt2FygUENMwQ4jSOFHEQZ7C9Sc/t1gIlR2bZtNtp1BWIQW/Iu6DDMwjSSTX4qjCwnN6/sqzlv0ZFBAKVIX4uy9DbwSWFKGKqDlsrbAmVFaioKHX3IX/Xm49jyIK7/0PIre8rpPO7DBAX5JbGQCYg8mbG2uf5xTT1gAWy0N4hyjd8bt6FFnL6eUOrt6Hjzy5gP+/8lb0glwD14Mjd9AAAAA=);background-size:cover;background-position:center;transform:scale(1.1);filter:blur(10px);transition:transform .2s linear,filter .2s linear}.video-panel-background.loaded{transform:scale(1);filter:blur(0)}.video-area{position:relative;width:100%;padding-top:56.25%}.local-video-content{position:absolute;bottom:60px;right:10px;width:min(230px,22%);max-height:40%;overflow:hidden;z-index:10;transform:translateZ(0);-webkit-transform:translateZ(0);cursor:pointer;transition:transform .3s ease}@media (min-width: 801px){.local-video-content{position:fixed;bottom:60px;right:310px}}@media (max-width: 600px){.local-video-content{width:40%}}.local-video-content:hover{cursor:alias;transform:translateZ(0) scale(1.02)}.local-video-content video{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;transform:translateZ(0) scaleX(-1);-webkit-transform:translateZ(0) scaleX(-1);transition:transform .5s cubic-bezier(.4,0,.2,1);border-radius:8px}.local-video-content.flipped video{transform:translateZ(0) scaleX(1);-webkit-transform:translateZ(0) scaleX(1)}.video-content{position:absolute;top:0;left:0;width:100%;height:100%}.video-controls{height:50px;width:100%;position:relative}@media (min-width: 801px){.video-controls{position:fixed;bottom:0;width:calc(100% - 300px);left:0}}.chat-panel{position:absolute;top:0;right:0;bottom:0;width:300px;background:#f5f5f5;overflow-y:auto}@media (max-width: 800px){.modal{margin:20px;max-height:none;max-width:none;display:grid;grid-template-columns:1fr 300px;overflow:hidden}.video-panel{width:100%}.chat-panel{position:static;width:auto}}@media (max-width: 800px) and (orientation: portrait){.modal{width:calc(100% - 40px);height:calc(100% - 40px);grid-template-columns:1fr;grid-template-rows:auto 1fr}}@media (max-width: 800px) and (orientation: landscape){.modal{grid-template-columns:1fr 250px}}@media (max-width: 800px) and (max-height: 400px){.modal{width:calc(100vw - 40px);height:calc(100vh - 40px);margin:20px;max-width:none;max-height:none}.controls{position:fixed;bottom:0;left:0;width:calc(100% - 250px)}}.chat-panel{background:linear-gradient(135deg,#022677,#9c063a)}.chat{display:flex;flex-direction:column;padding:15px;font-family:Inter,sans-serif;font-size:15px}.message{margin-bottom:5px;padding:8px 12px;border-radius:10px;max-width:80%;color:#fff;position:relative;min-width:60%;min-height:15px;line-height:1.3;text-align:center}.message>.tail{position:absolute;bottom:2px;right:0;width:10px;height:10px;display:none;transform:scale(.6)}.message>.tail svg{fill:#044ef4}.message-received>.tail{transform:scaleX(-1) scale(.5);left:0}.message-received>.tail svg{fill:#f72a72}.message-received{background:#f72a72;align-self:flex-start}.message-sent{background:#044ef4;align-self:flex-end}.message-received+.message-sent,.message-sent+.message-received{margin-top:15px}.message-sent:has(+.message-received),.message-sent:last-child{border-bottom-right-radius:2px}.message-sent:has(+.message-received) .tail,.message-sent:last-child .tail{display:block}.message-received:has(+.message-sent),.message-received:last-child{border-bottom-left-radius:2px}.message-received:has(+.message-sent) .tail,.message-received:last-child .tail{display:block}@keyframes heartbeat{0%{opacity:.8;transform:scale(1)}50%{opacity:1;transform:scale(1.01)}to{opacity:.8;transform:scale(1)}}.message.in-progress{animation:heartbeat 1.5s ease-in-out infinite}.controls{display:flex;gap:8px;background:#0009;height:50px;justify-content:center;align-items:center}.control-group{display:flex;align-items:center}.control-button{width:40px;height:40px;border-radius:50%;border:none;background:#ffffff1a;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.control-group .control-button{border-radius:20px 0 0 20px;margin-right:1px}.standalone{border-radius:50%!important;margin-right:0}.device-select-button{height:40px;border-radius:0 20px 20px 0;border:none;background:#ffffff1a;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.control-button:hover,.device-select-button:hover{background:#fff3}.control-button svg{width:24px;height:24px;color:#fff}.device-select-button svg{width:12px;height:12px;color:#fff}.hangup{border-radius:50%!important;background:#f44}.hangup:hover{background:#f66}.device-menu{position:absolute;bottom:100%;left:50%;transform:translate(-50%);margin-bottom:8px;background:#000000e6;border-radius:8px;padding:8px;min-width:200px;z-index:1000}.device-option{font-size:15px;font-family:sans-serif;color:#fff;padding:6px 4px;cursor:pointer;border-radius:4px;display:flex;align-items:center;gap:8px}.device-option.selected{font-weight:700}.device-option:hover{background:#ffffff1a}.device-option svg{width:16px;height:16px;color:#007bff;flex-shrink:0}.muted-icon,.unmuted-icon{display:flex;align-items:center;justify-content:center}#menuContainer,.device-select-wrapper{position:relative}.device-select-button:disabled{opacity:.5;cursor:not-allowed;pointer-events:none}.loading{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}.loading-icon{color:#fff}.loading-icon svg{animation:spin 3s linear infinite}@keyframes spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.error-message{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:1000;background:#fff;padding:0;border-radius:12px;box-shadow:0 8px 24px #0003;max-width:90%;min-width:400px;font-family:Inter,sans-serif;display:flex;flex-direction:column}@media (max-width: 768px){.error-message{transform:translate(-50%,calc(-50% - 50px));min-width:unset}}.error-message .error-header{display:flex;justify-content:flex-start;align-items:center;padding:16px 24px;border-bottom:1px solid #eee}.error-message .error-header .error-title{margin:0;font-size:18px;font-weight:600;color:#111}.error-message .error-content{padding:24px;display:flex;flex-direction:column;gap:24px}.error-message .error-content .error-text{font-size:15px;color:#333;line-height:1.5;text-align:left}.error-message .error-content .action-button{align-self:flex-end;padding:10px 24px;border:none;border-radius:6px;background:#044ef4;color:#fff;font-family:Inter,sans-serif;font-size:14px;font-weight:500;cursor:pointer;transition:background-color .2s ease,transform .1s ease}.error-message .error-content .action-button:hover{background:#0446db}.error-message .error-content .action-button:active{transform:scale(.98);background:#033ec2}.modal-container:has(.error) .modal{filter:blur(4px)}');const i=e`
  <div class="modal-container" name="modalContainer">
    <div class="modal" name="modal">
      <div class="video-panel" name="videoPanel">
        <div class="video-panel-background" name="videoPanelBackground"></div>
        <div class="local-video-content" name="localVideoArea">
          <!-- Local Video area -->
        </div>
        <div class="video-area">
          <div class="video-content" name="videoArea">
            <!-- Remote Video area -->
          </div>
        </div>
        <div class="video-controls" name="controlsPanel">
          <!-- Controls panel -->
        </div>
      </div>
      <div class="chat-panel" name="chatPanel"></div>
    </div>
  </div>
`;const o=e`
  <div class="loading" name="loading">
    <div class="loading-icon">${'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 256 256" height="50px" width="50px" xmlns="http://www.w3.org/2000/svg">\n  <path d="M140,32V64a12,12,0,0,1-24,0V32a12,12,0,0,1,24,0Zm33.25,62.75a12,12,0,0,0,8.49-3.52L204.37,68.6a12,12,0,0,0-17-17L164.77,74.26a12,12,0,0,0,8.48,20.49ZM224,116H192a12,12,0,0,0,0,24h32a12,12,0,0,0,0-24Zm-42.26,48.77a12,12,0,1,0-17,17l22.63,22.63a12,12,0,0,0,17-17ZM128,180a12,12,0,0,0-12,12v32a12,12,0,0,0,24,0V192A12,12,0,0,0,128,180ZM74.26,164.77,51.63,187.4a12,12,0,0,0,17,17l22.63-22.63a12,12,0,1,0-17-17ZM76,128a12,12,0,0,0-12-12H32a12,12,0,0,0,0,24H64A12,12,0,0,0,76,128ZM68.6,51.63a12,12,0,1,0-17,17L74.26,91.23a12,12,0,0,0,17-17Z"></path>\n</svg>'}</div>
  </div>
`;function n(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var s,a={exports:{}};var c,d,l,u=(s||(s=1,d=a.exports,l=function(){var e=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],o={},n=null;function s(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch{return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(){for(var r=this.getLevel(),o=0;o<i.length;o++){var n=i[o];this[n]=o<r?e:this.methodFactory(n,r,this.name)}if(this.log=this.debug,typeof console===t&&r<this.levels.SILENT)return"No console available for logging"}function d(e){return function(){typeof console!==t&&(c.call(this),this[e].apply(this,arguments))}}function l(i,o,n){return function(i){return"debug"===i&&(i="log"),typeof console!==t&&("trace"===i&&r?a:void 0!==console[i]?s(console,i):void 0!==console.log?s(console,"log"):e)}(i)||d.apply(this,arguments)}function u(e,r){var s,a,d,u=this,h="loglevel";function m(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch{}if(typeof e===t)try{var r=window.document.cookie,i=encodeURIComponent(h),o=r.indexOf(i+"=");-1!==o&&(e=/^([^;]+)/.exec(r.slice(o+i.length+1))[1])}catch{}return void 0===u.levels[e]&&(e=void 0),e}}function p(e){var t=e;if("string"==typeof t&&void 0!==u.levels[t.toUpperCase()]&&(t=u.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=u.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=r||l,u.getLevel=function(){return d??a??s},u.setLevel=function(e,r){return d=p(e),!1!==r&&function(e){var r=(i[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=r)}catch{}try{window.document.cookie=encodeURIComponent(h)+"="+r+";"}catch{}}}(d),c.call(u)},u.setDefaultLevel=function(e){a=p(e),m()||u.setLevel(e,!1)},u.resetLevel=function(){d=null,function(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch{}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}(),c.call(u)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)},u.rebuild=function(){if(n!==u&&(s=p(n.getLevel())),c.call(u),n===u)for(var e in o)o[e].rebuild()},s=p(n?n.getLevel():"WARN");var g=m();null!=g&&(d=p(g)),c.call(u)}(n=new u).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=o[e];return t||(t=o[e]=new u(e,n.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return n.noConflict=function(){return typeof window!==t&&window.log===n&&(window.log=h),n},n.getLoggers=function(){return o},n.default=n,n},(c=a).exports?c.exports=l():d.log=l()),a.exports);const h=n(u);let m;const p=new Uint8Array(16);function g(){if(!m&&(m=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!m))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return m(p)}const v=[];for(let P=0;P<256;++P)v.push((P+256).toString(16).slice(1));const f={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function y(e,t,r){if(f.randomUUID&&!e)return f.randomUUID();const i=(e=e||{}).random||(e.rng||g)();return i[6]=15&i[6]|64,i[8]=63&i[8]|128,function(e,t=0){return v[e[t+0]]+v[e[t+1]]+v[e[t+2]]+v[e[t+3]]+"-"+v[e[t+4]]+v[e[t+5]]+"-"+v[e[t+6]]+v[e[t+7]]+"-"+v[e[t+8]]+v[e[t+9]]+"-"+v[e[t+10]]+v[e[t+11]]+v[e[t+12]]+v[e[t+13]]+v[e[t+14]]+v[e[t+15]]}(i)}function b(e){return b="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},b(e)}function _(e){var t=function(e,t){if("object"!=b(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t);if("object"!=b(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==b(t)?t:t+""}function w(e,t,r){return(t=_(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function k(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,i)}return r}function S(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?k(Object(r),!0).forEach((function(t){w(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):k(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function C(e){return"Minified Redux error #"+e+"; visit https://redux.js.org/Errors?code="+e+" for the full message or use the non-minified dev environment for full errors. "}var E="function"==typeof Symbol&&Symbol.observable||"@@observable",I=function(){return Math.random().toString(36).substring(7).split("").join(".")},M={INIT:"@@redux/INIT"+I(),REPLACE:"@@redux/REPLACE"+I(),PROBE_UNKNOWN_ACTION:function(){return"@@redux/PROBE_UNKNOWN_ACTION"+I()}};function T(e,t,r){var i;if("function"==typeof t&&"function"==typeof r||"function"==typeof r&&"function"==typeof arguments[3])throw new Error(C(0));if("function"==typeof t&&typeof r>"u"&&(r=t,t=void 0),typeof r<"u"){if("function"!=typeof r)throw new Error(C(1));return r(T)(e,t)}if("function"!=typeof e)throw new Error(C(2));var o=e,n=t,s=[],a=s,c=!1;function d(){a===s&&(a=s.slice())}function l(){if(c)throw new Error(C(3));return n}function u(e){if("function"!=typeof e)throw new Error(C(4));if(c)throw new Error(C(5));var t=!0;return d(),a.push(e),function(){if(t){if(c)throw new Error(C(6));t=!1,d();var r=a.indexOf(e);a.splice(r,1),s=null}}}function h(e){if(!function(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}(e))throw new Error(C(7));if(typeof e.type>"u")throw new Error(C(8));if(c)throw new Error(C(9));try{c=!0,n=o(n,e)}finally{c=!1}for(var t=s=a,r=0;r<t.length;r++){(0,t[r])()}return e}return h({type:M.INIT}),(i={dispatch:h,subscribe:u,getState:l,replaceReducer:function(e){if("function"!=typeof e)throw new Error(C(10));o=e,h({type:M.REPLACE})}})[E]=function(){var e,t=u;return(e={subscribe:function(e){if("object"!=typeof e||null===e)throw new Error(C(11));function r(){e.next&&e.next(l())}return r(),{unsubscribe:t(r)}}})[E]=function(){return this},e},i}var x=T;function A(e){for(var t=Object.keys(e),r={},i=0;i<t.length;i++){var o=t[i];"function"==typeof e[o]&&(r[o]=e[o])}var n,s=Object.keys(r);try{!function(e){Object.keys(e).forEach((function(t){var r=e[t];if(typeof r(void 0,{type:M.INIT})>"u")throw new Error(C(12));if(typeof r(void 0,{type:M.PROBE_UNKNOWN_ACTION()})>"u")throw new Error(C(13))}))}(r)}catch(a){n=a}return function(e,t){if(void 0===e&&(e={}),n)throw n;for(var i=!1,o={},a=0;a<s.length;a++){var c=s[a],d=r[c],l=e[c],u=d(l,t);if(typeof u>"u")throw t&&t.type,new Error(C(14));o[c]=u,i=i||u!==l}return(i=i||s.length!==Object.keys(e).length)?o:e}}function R(e,t){return function(){return t(e.apply(this,arguments))}}function O(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce((function(e,t){return function(){return e(t.apply(void 0,arguments))}}))}function L(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return function(e){return function(){var r=e.apply(void 0,arguments),i=function(){throw new Error(C(15))},o={getState:r.getState,dispatch:function(){return i.apply(void 0,arguments)}},n=t.map((function(e){return e(o)}));return i=O.apply(void 0,n)(r.dispatch),S(S({},r),{},{dispatch:i})}}}const j=Object.freeze(Object.defineProperty({__proto__:null,__DO_NOT_USE__ActionTypes:M,applyMiddleware:L,bindActionCreators:function(e,t){if("function"==typeof e)return R(e,t);if("object"!=typeof e||null===e)throw new Error(C(16));var r={};for(var i in e){var o=e[i];"function"==typeof o&&(r[i]=R(o,t))}return r},combineReducers:A,compose:O,createStore:T,legacy_createStore:x},Symbol.toStringTag,{value:"Module"}));var V=function(e){return"@@redux-saga/"+e},D=V("CANCEL_PROMISE"),W=V("CHANNEL_END"),N=V("IO"),$=V("MATCH"),U=V("MULTICAST"),B=V("SAGA_ACTION"),z=V("SELF_CANCELLATION"),H=V("TASK"),F=V("TASK_CANCEL"),q=V("TERMINATE"),K=V("LOCATION");function J(){return J=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)({}).hasOwnProperty.call(r,i)&&(e[i]=r[i])}return e},J.apply(null,arguments)}var G=function(e){return null==e},Z=function(e){return null!=e},Q=function(e){return"function"==typeof e},X=function(e){return"string"==typeof e},Y=Array.isArray,ee=function(e){return e&&Q(e.then)},te=function(e){return e&&Q(e.next)&&Q(e.throw)},re=function e(t){return t&&(X(t)||ne(t)||Q(t)||Y(t)&&t.every(e))},ie=function(e){return e&&Q(e.take)&&Q(e.close)},oe=function(e){return Q(e)&&e.hasOwnProperty("toString")},ne=function(e){return!!e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype},se=function(e){return ie(e)&&e[U]},ae=function(e){return function(){return e}}(!0),ce=function(){},de=function(e){return e},le=function(e,t){J(e,t),Object.getOwnPropertySymbols&&Object.getOwnPropertySymbols(t).forEach((function(r){e[r]=t[r]}))};function ue(e,t){var r=e.indexOf(t);r>=0&&e.splice(r,1)}function he(e){var t=!1;return function(){t||(t=!0,e())}}var me=function(e){throw e},pe=function(e){return{value:e,done:!0}};function ge(e,t,r){void 0===t&&(t=me),void 0===r&&(r="iterator");var i={meta:{name:r},next:e,throw:t,return:pe,isSagaIterator:!0};return typeof Symbol<"u"&&(i[Symbol.iterator]=function(){return i}),i}function ve(e,t){var r=t.sagaStack;console.error(e),console.error(r)}var fe=function(e){return Array.apply(null,new Array(e))},ye=function(e){return function(t){return e(Object.defineProperty(t,B,{value:!0}))}},be=function(e){return e===q},_e=function(e){return e===F},we=function(e){return be(e)||_e(e)};function ke(e,t){var r,i=Object.keys(e),o=i.length,n=0,s=Y(e)?fe(o):{},a={};return i.forEach((function(e){var i=function(i,a){r||(a||we(i)?(t.cancel(),t(i,a)):(s[e]=i,++n===o&&(r=!0,t(s))))};i.cancel=ce,a[e]=i})),t.cancel=function(){r||(r=!0,i.forEach((function(e){return a[e].cancel()})))},a}function Se(e){return{name:e.name||"anonymous",location:Ce(e)}}function Ce(e){return e[K]}function Ee(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return 0===t.length?function(e){return e}:1===t.length?t[0]:t.reduce((function(e,t){return function(){return e(t.apply(void 0,arguments))}}))}var Ie={isEmpty:ae,put:ce,take:ce};var Me=function(e){return function(e,t){void 0===e&&(e=10);var r=new Array(e),i=0,o=0,n=0,s=function(t){r[o]=t,o=(o+1)%e,i++},a=function(){if(0!=i){var t=r[n];return r[n]=null,i--,n=(n+1)%e,t}},c=function(){for(var e=[];i;)e.push(a());return e};return{isEmpty:function(){return 0==i},put:function(a){var d;if(i<e)s(a);else switch(t){case 1:throw new Error("Channel's Buffer overflow!");case 3:r[o]=a,n=o=(o+1)%e;break;case 4:d=2*e,r=c(),i=r.length,o=r.length,n=0,r.length=d,e=d,s(a)}},take:a,flush:c}}(e,4)},Pe="TAKE",Te="PUT",xe="ALL",Ae="CALL",Re="FORK",Oe="JOIN",Le="SELECT",je="CANCELLED",Ve=function(e,t){var r;return(r={})[N]=!0,r.combinator=!1,r.type=e,r.payload=t,r};function De(e,t){return void 0===e&&(e="*"),re(e)?(Z(t)&&console.warn("take(pattern) takes one argument but two were provided. Consider passing an array for listening to several action types"),Ve(Pe,{pattern:e})):se(e)&&Z(t)&&re(t)?Ve(Pe,{channel:e,pattern:t}):ie(e)?(Z(t)&&console.warn("take(channel) takes one argument but two were provided. Second argument is ignored."),Ve(Pe,{channel:e})):void 0}function We(e,t){return G(t)&&(t=e,e=void 0),Ve(Te,{channel:e,action:t})}function Ne(e,t){var r,i=null;return Q(e)?r=e:(Y(e)?(i=e[0],r=e[1]):(i=e.context,r=e.fn),i&&X(r)&&Q(i[r])&&(r=i[r])),{context:i,fn:r,args:t}}function $e(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];return Ve(Ae,Ne(e,r))}function Ue(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];return Ve(Re,Ne(e,r))}function Be(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];return function(e){return Ve(Re,J({},e.payload,{detached:!0}))}(Ue.apply(void 0,[e].concat(r)))}function ze(e){return Ve(Oe,e)}function He(e){void 0===e&&(e=de);for(var t=arguments.length,r=new Array(t>1?t-1:0),i=1;i<t;i++)r[i-1]=arguments[i];return Ve(Le,{selector:e,args:r})}function Fe(){return Ve(je,{})}var qe=[],Ke=0;function Je(e){try{Qe(),e()}finally{Xe()}}function Ge(e){qe.push(e),Ke||(Qe(),Ye())}function Ze(e){try{return Qe(),e()}finally{Ye()}}function Qe(){Ke++}function Xe(){Ke--}function Ye(){Xe();for(var e;!Ke&&void 0!==(e=qe.shift());)Je(e)}var et=function(e){return function(t){return e.some((function(e){return nt(e)(t)}))}},tt=function(e){return function(t){return e(t)}},rt=function(e){return function(t){return t.type===String(e)}},it=function(e){return function(t){return t.type===e}},ot=function(){return ae};function nt(e){var t="*"===e?ot:X(e)?rt:Y(e)?et:oe(e)?rt:Q(e)?tt:ne(e)?it:null;if(null===t)throw new Error("invalid pattern: "+e);return t(e)}var st={type:W},at=function(e){return e&&e.type===W};function ct(e){void 0===e&&(e=Me());var t=!1,r=[];return{take:function(i){t&&e.isEmpty()?i(st):e.isEmpty()?(r.push(i),i.cancel=function(){ue(r,i)}):i(e.take())},put:function(i){if(!t){if(0===r.length)return e.put(i);r.shift()(i)}},flush:function(r){t&&e.isEmpty()?r(st):r(e.flush())},close:function(){if(!t){t=!0;var e=r;r=[];for(var i=0,o=e.length;i<o;i++){(0,e[i])(st)}}}}}function dt(e,t){void 0===t&&(t=Ie);var r,i=!1,o=ct(t),n=function(){i||(i=!0,Q(r)&&r(),o.close())};return r=he(r=e((function(e){at(e)?n():o.put(e)}))),i&&r(),{take:o.take,flush:o.flush,close:n}}function lt(){var e,t=!1,r=[],i=r,o=function(){i===r&&(i=r.slice())},n=function(){t=!0;var e=r=i;i=[],e.forEach((function(e){e(st)}))};return(e={})[U]=!0,e.put=function(e){if(!t){if(at(e))return void n();for(var o=r=i,s=0,a=o.length;s<a;s++){var c=o[s];c[$](e)&&(c.cancel(),c(e))}}},e.take=function(e,r){void 0===r&&(r=ot),t?e(st):(e[$]=r,o(),i.push(e),e.cancel=he((function(){o(),ue(i,e)})))},e.close=n,e}function ut(){var e=lt(),t=e.put;return e.put=function(e){e[B]?t(e):Ge((function(){t(e)}))},e}var ht=0,mt=1,pt=2,gt=3;function vt(e,t){var r=e[D];Q(r)&&(t.cancel=r),e.then(t,(function(e){t(e,!0)}))}var ft,yt=0,bt=function(){return++yt};function _t(e){e.isRunning()&&e.cancel()}var wt=((ft={})[Pe]=function(e,t,r){var i=t.channel,o=void 0===i?e.channel:i,n=t.pattern,s=t.maybe,a=function(e){e instanceof Error?r(e,!0):!at(e)||s?r(e):r(q)};try{o.take(a,Z(n)?nt(n):null)}catch(c){return void r(c,!0)}r.cancel=a.cancel},ft[Te]=function(e,t,r){var i=t.channel,o=t.action,n=t.resolve;Ge((function(){var t;try{t=(i?i.put:e.dispatch)(o)}catch(s){return void r(s,!0)}n&&ee(t)?vt(t,r):r(t)}))},ft[xe]=function(e,t,r,i){var o=i.digestEffect,n=yt,s=Object.keys(t);if(0!==s.length){var a=ke(t,r);s.forEach((function(e){o(t[e],n,a[e],e)}))}else r(Y(t)?[]:{})},ft.RACE=function(e,t,r,i){var o=i.digestEffect,n=yt,s=Object.keys(t),a=Y(t)?fe(s.length):{},c={},d=!1;s.forEach((function(e){var t=function(t,i){d||(i||we(t)?(r.cancel(),r(t,i)):(r.cancel(),d=!0,a[e]=t,r(a)))};t.cancel=ce,c[e]=t})),r.cancel=function(){d||(d=!0,s.forEach((function(e){return c[e].cancel()})))},s.forEach((function(e){d||o(t[e],n,c[e],e)}))},ft[Ae]=function(e,t,r,i){var o=t.context,n=t.fn,s=t.args,a=i.task;try{var c=n.apply(o,s);if(ee(c))return void vt(c,r);if(te(c))return void Rt(e,c,a.context,yt,Se(n),!1,r);r(c)}catch(d){r(d,!0)}},ft.CPS=function(e,t,r){var i=t.context,o=t.fn,n=t.args;try{var s=function(e,t){G(e)?r(t):r(e,!0)};o.apply(i,n.concat(s)),s.cancel&&(r.cancel=s.cancel)}catch(a){r(a,!0)}},ft[Re]=function(e,t,r,i){var o=t.context,n=t.fn,s=t.args,a=t.detached,c=i.task,d=function(e){var t=e.context,r=e.fn,i=e.args;try{var o=r.apply(t,i);if(te(o))return o;var n=!1;return ge((function(e){return n?{value:e,done:!0}:(n=!0,{value:o,done:!ee(o)})}))}catch(a){return ge((function(){throw a}))}}({context:o,fn:n,args:s}),l=function(e,t){return e.isSagaIterator?{name:e.meta.name}:Se(t)}(d,n);Ze((function(){var t=Rt(e,d,c.context,yt,l,a,void 0);a?r(t):t.isRunning()?(c.queue.addTask(t),r(t)):t.isAborted()?c.queue.abort(t.error()):r(t)}))},ft[Oe]=function(e,t,r,i){var o=i.task,n=function(e,t){if(e.isRunning()){var r={task:o,cb:t};t.cancel=function(){e.isRunning()&&ue(e.joiners,r)},e.joiners.push(r)}else e.isAborted()?t(e.error(),!0):t(e.result())};if(Y(t)){if(0===t.length)return void r([]);var s=ke(t,r);t.forEach((function(e,t){n(e,s[t])}))}else n(t,r)},ft.CANCEL=function(e,t,r,i){var o=i.task;t===z?_t(o):Y(t)?t.forEach(_t):_t(t),r()},ft[Le]=function(e,t,r){var i=t.selector,o=t.args;try{r(i.apply(void 0,[e.getState()].concat(o)))}catch(n){r(n,!0)}},ft.ACTION_CHANNEL=function(e,t,r){var i=t.pattern,o=ct(t.buffer),n=nt(i),s=function t(r){at(r)||e.channel.take(t,n),o.put(r)},a=o.close;o.close=function(){s.cancel(),a()},e.channel.take(s,n),r(o)},ft[je]=function(e,t,r,i){r(i.task.isCancelled())},ft.FLUSH=function(e,t,r){t.flush(r)},ft.GET_CONTEXT=function(e,t,r,i){r(i.task.context[t])},ft.SET_CONTEXT=function(e,t,r,i){var o=i.task;le(o.context,t),r()},ft);function kt(e,t){return e+"?"+t}function St(e){var t=e.name,r=e.location;return r?t+"  "+kt(r.fileName,r.lineNumber):t}function Ct(e){var t=function(e,t){var r;return(r=[]).concat.apply(r,t.map(e))}((function(e){return e.cancelledTasks}),e);return t.length?["Tasks cancelled due to error:"].concat(t).join("\n"):""}var Et=null,It=[],Mt=function(e){e.crashedEffect=Et,It.push(e)},Pt=function(){Et=null,It.length=0},Tt=function(e){Et=e},xt=function(){var e=It[0],t=It.slice(1),r=e.crashedEffect?function(e){var t=Ce(e);return t?t.code+"  "+kt(t.fileName,t.lineNumber):""}(e.crashedEffect):null;return["The above error occurred in task "+St(e.meta)+(r?" \n when executing effect "+r:"")].concat(t.map((function(e){return"    created by "+St(e.meta)})),[Ct(It)]).join("\n")};function At(e,t,r,i,o,n,s){var a;void 0===s&&(s=ce);var c,d,l=ht,u=null,h=[],m=Object.create(r),p=function(e,t,r){var i,o=[],n=!1;function s(e){t(),c(),r(e,!0)}function a(t){o.push(t),t.cont=function(a,c){n||(ue(o,t),t.cont=ce,c?s(a):(t===e&&(i=a),o.length||(n=!0,r(i))))}}function c(){n||(n=!0,o.forEach((function(e){e.cont=ce,e.cancel()})),o=[])}return a(e),{addTask:a,cancelAll:c,abort:s,getTasks:function(){return o}}}(t,(function(){h.push.apply(h,p.getTasks().map((function(e){return e.meta.name})))}),g);function g(t,r){if(r){if(l=pt,Mt({meta:o,cancelledTasks:h}),v.isRoot){var i=xt();Pt(),e.onError(t,{sagaStack:i})}d=t,u&&u.reject(t)}else t===F?l=mt:l!==mt&&(l=gt),c=t,u&&u.resolve(t);v.cont(t,r),v.joiners.forEach((function(e){e.cb(t,r)})),v.joiners=null}var v=((a={})[H]=!0,a.id=i,a.meta=o,a.isRoot=n,a.context=m,a.joiners=[],a.queue=p,a.cancel=function(){l===ht&&(l=mt,p.cancelAll(),g(F,!1))},a.cont=s,a.end=g,a.setContext=function(e){le(m,e)},a.toPromise=function(){return u||(u=function(){var e={};return e.promise=new Promise((function(t,r){e.resolve=t,e.reject=r})),e}(),l===pt?u.reject(d):l!==ht&&u.resolve(c)),u.promise},a.isRunning=function(){return l===ht},a.isCancelled=function(){return l===mt||l===ht&&t.status===mt},a.isAborted=function(){return l===pt},a.result=function(){return c},a.error=function(){return d},a);return v}function Rt(e,t,r,i,o,n,s){var a=e.finalizeRunEffect((function(t,r,i){if(ee(t))vt(t,i);else if(te(t))Rt(e,t,d.context,r,o,!1,i);else if(t&&t[N]){(0,wt[t.type])(e,t.payload,i,l)}else i(t)}));u.cancel=ce;var c={meta:o,cancel:function(){c.status===ht&&(c.status=mt,u(F))},status:ht},d=At(e,c,r,i,o,n,s),l={task:d,digestEffect:h};return s&&(s.cancel=d.cancel),u(),d;function u(e,r){try{var o;r?(o=t.throw(e),Pt()):_e(e)?(c.status=mt,u.cancel(),o=Q(t.return)?t.return(F):{done:!0,value:F}):o=be(e)?Q(t.return)?t.return():{done:!0}:t.next(e),o.done?(c.status!==mt&&(c.status=gt),c.cont(o.value)):h(o.value,i,u)}catch(n){if(c.status===mt)throw n;c.status=pt,c.cont(n,!0)}}function h(t,r,i,o){void 0===o&&(o="");var n,s=bt();function c(r,o){n||(n=!0,i.cancel=ce,e.sagaMonitor&&(o?e.sagaMonitor.effectRejected(s,r):e.sagaMonitor.effectResolved(s,r)),o&&Tt(t),i(r,o))}e.sagaMonitor&&e.sagaMonitor.effectTriggered({effectId:s,parentEffectId:r,label:o,effect:t}),c.cancel=ce,i.cancel=function(){n||(n=!0,c.cancel(),c.cancel=ce,e.sagaMonitor&&e.sagaMonitor.effectCancelled(s))},a(t,s,c)}}function Ot(e,t){for(var r=e.channel,i=void 0===r?ut():r,o=e.dispatch,n=e.getState,s=e.context,a=void 0===s?{}:s,c=e.sagaMonitor,d=e.effectMiddlewares,l=e.onError,u=void 0===l?ve:l,h=arguments.length,m=new Array(h>2?h-2:0),p=2;p<h;p++)m[p-2]=arguments[p];var g,v=t.apply(void 0,m),f=bt();if(c&&(c.rootSagaStarted=c.rootSagaStarted||ce,c.effectTriggered=c.effectTriggered||ce,c.effectResolved=c.effectResolved||ce,c.effectRejected=c.effectRejected||ce,c.effectCancelled=c.effectCancelled||ce,c.actionDispatched=c.actionDispatched||ce,c.rootSagaStarted({effectId:f,saga:t,args:m})),d){var y=Ee.apply(void 0,d);g=function(e){return function(t,r,i){return y((function(t){return e(t,r,i)}))(t)}}}else g=de;var b={channel:i,dispatch:ye(o),getState:n,sagaMonitor:c,onError:u,finalizeRunEffect:g};return Ze((function(){var e=Rt(b,v,a,f,Se(t),!0,void 0);return c&&c.effectResolved(f,e),e}))}var Lt,jt={exports:{}};var Vt=(Lt||(Lt=1,function(e){var t=Object.prototype.hasOwnProperty,r="~";function i(){}function o(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function n(e,t,i,n,s){if("function"!=typeof i)throw new TypeError("The listener must be a function");var a=new o(i,n||e,s),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new i:delete e._events[t]}function a(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(r=!1)),a.prototype.eventNames=function(){var e,i,o=[];if(0===this._eventsCount)return o;for(i in e=this._events)t.call(e,i)&&o.push(r?i.slice(1):i);return Object.getOwnPropertySymbols?o.concat(Object.getOwnPropertySymbols(e)):o},a.prototype.listeners=function(e){var t=r?r+e:e,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var o=0,n=i.length,s=new Array(n);o<n;o++)s[o]=i[o].fn;return s},a.prototype.listenerCount=function(e){var t=r?r+e:e,i=this._events[t];return i?i.fn?1:i.length:0},a.prototype.emit=function(e,t,i,o,n,s){var a=r?r+e:e;if(!this._events[a])return!1;var c,d,l=this._events[a],u=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),u){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,i),!0;case 4:return l.fn.call(l.context,t,i,o),!0;case 5:return l.fn.call(l.context,t,i,o,n),!0;case 6:return l.fn.call(l.context,t,i,o,n,s),!0}for(d=1,c=new Array(u-1);d<u;d++)c[d-1]=arguments[d];l.fn.apply(l.context,c)}else{var h,m=l.length;for(d=0;d<m;d++)switch(l[d].once&&this.removeListener(e,l[d].fn,void 0,!0),u){case 1:l[d].fn.call(l[d].context);break;case 2:l[d].fn.call(l[d].context,t);break;case 3:l[d].fn.call(l[d].context,t,i);break;case 4:l[d].fn.call(l[d].context,t,i,o);break;default:if(!c)for(h=1,c=new Array(u-1);h<u;h++)c[h-1]=arguments[h];l[d].fn.apply(l[d].context,c)}}return!0},a.prototype.on=function(e,t,r){return n(this,e,t,r,!1)},a.prototype.once=function(e,t,r){return n(this,e,t,r,!0)},a.prototype.removeListener=function(e,t,i,o){var n=r?r+e:e;if(!this._events[n])return this;if(!t)return s(this,n),this;var a=this._events[n];if(a.fn)a.fn===t&&(!o||a.once)&&(!i||a.context===i)&&s(this,n);else{for(var c=0,d=[],l=a.length;c<l;c++)(a[c].fn!==t||o&&!a[c].once||i&&a[c].context!==i)&&d.push(a[c]);d.length?this._events[n]=1===d.length?d[0]:d:s(this,n)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&s(this,t)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=r,a.EventEmitter=a,e.exports=a}(jt)),jt.exports);const Dt=n(Vt);var Wt=Object.defineProperty,Nt=Object.defineProperties,$t=Object.getOwnPropertyDescriptor,Ut=Object.getOwnPropertyDescriptors,Bt=Object.getOwnPropertyNames,zt=Object.getOwnPropertySymbols,Ht=Object.prototype.hasOwnProperty,Ft=Object.prototype.propertyIsEnumerable,qt=(e,t,r)=>t in e?Wt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Kt=(e,t)=>{for(var r in t||(t={}))Ht.call(t,r)&&qt(e,r,t[r]);if(zt)for(var r of zt(t))Ft.call(t,r)&&qt(e,r,t[r]);return e},Jt=(e,t)=>Nt(e,Ut(t)),Gt=(e,t)=>{var r={};for(var i in e)Ht.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&zt)for(var i of zt(e))t.indexOf(i)<0&&Ft.call(e,i)&&(r[i]=e[i]);return r},Zt=(e,t)=>{for(var r in t)Wt(e,r,{get:t[r],enumerable:!0})},Qt=(e,t,r)=>(((e,t,r,i)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let o of Bt(t))!Ht.call(e,o)&&o!==r&&Wt(e,o,{get:()=>t[o],enumerable:!(i=$t(t,o))||i.enumerable})})(e,t,"default"),r),Xt=(e,t,r)=>qt(e,"symbol"!=typeof t?t+"":t,r),Yt="__local__",er="__synthetic__",tr="chat",rr=h.getLogger("signalwire"),ir=rr.methodFactory;rr.methodFactory=(e,t,r)=>{const i=ir(e,t,r);return function(...e){e.unshift((new Date).toISOString(),"-"),i.apply(void 0,e)}};var or=rr.getLevel();rr.setLevel(or);var nr,sr={},ar=()=>nr??rr,cr=({type:e,payload:t})=>{const r=ar(),{logWsTraffic:i}=sr||{};if(!i)return;const o=(e=>!("method"in e&&"signalwire.ping"===e.method))(t)?JSON.stringify(t,null,2):t;return r.info(`${e.toUpperCase()}: \n`,o,"\n")},dr=()=>{const e=ar();return new Proxy(e,{get:(e,t,r)=>"wsTraffic"===t?cr:Reflect.get(e,t,r)})},lr=/[A-Z]/g,ur=["webrtc.message"],hr=e=>ur.includes(e),mr=/^2[0-9][0-9]$/,pr=(e,t)=>{const{result:r={},error:i}=e;if(i)return{error:i};const{code:o,node_id:n,result:s=null}=r;return o&&!mr.test(o)?{error:r}:null===s?(t&&(r.node_id=t),{result:r}):s?s.jsonrpc?pr(s,n):{result:s}:{result:r}},gr={propsToUpdateValue:["updated","layers","members","recordings","playbacks"]},vr=(e,t=gr)=>null!=e&&e.__sw_symbol||null!=e&&e.__sw_proxy?e:Object.entries(e).reduce(((e,[r,i])=>{const o=fr(r);return"object"==typeof i&&i?Array.isArray(i)?t.propsToUpdateValue.includes(r)?e[o]=i.map((e=>"string"==typeof e?fr(e):vr(e))):e[o]=i:e[o]=vr(i):(e=>e.endsWith("At"))(o)?e[o]=(e=>{if(typeof e>"u")return e;const t=new Date(1e3*e);return isNaN(t.getTime())?e:t})(i):e[o]=i,e}),{}),fr=e=>e.includes("_")?e.split("_").reduce(((e,t,r)=>{const i=t.trim().charAt(0),o=t.substr(1).toLowerCase();return`${e}${0===r?i.toLowerCase():i.toUpperCase()}${o}`}),""):e,yr=({namespace:e,event:t})=>!e||t.startsWith(e)?t:`${e}:${t}`,br=e=>{const{event_type:t,params:r,node_id:i}=e;if("queuing.relay.tasks"===t)return{type:t,payload:e};if(hr(t)&&null!=r&&r.jsonrpc){const e=r;return e.params&&(e.params.nodeId=i),{type:t,payload:e}}return{type:t,payload:r}},_r=(e,t)=>(Object.keys(t).forEach((t=>{if(e.prototype.hasOwnProperty(t))throw new Error(`[extendComponent] Duplicated method name: ${t}`)})),Object.defineProperties(e.prototype,t),e);var wr=(e,t)=>{if(t&&"string"==typeof t){const r=new RegExp(`^${t}.`);return e.replace(r,"")}const r=e.split(".");return r.length>1?(r.shift(),r.join(".")):e},kr=/^(ws|wss):\/\//,Sr=(e,t,r)=>{let i=null;return Promise.race([e,new Promise(((e,o)=>i=setTimeout(o,t,r)))]).finally((()=>clearTimeout(i)))},Cr=["video.member.updated","video.member.talking"],Er=["video.room.joined","video.track","video.active","video.answering","video.destroy","video.early","video.hangup","video.held","video.new","video.purge","video.recovering","video.requesting","video.ringing","video.trying","video.media.connected","video.media.reconnecting","video.media.disconnected","video.microphone.updated","video.camera.updated","video.speaker.updated","video.microphone.disconnected","video.camera.disconnected","video.speaker.disconnected"],Ir=e=>{const t=e.map((e=>{if("string"==typeof e){const t=(e=>{const t=e.split(":");return t[t.length-1]})(e);return Er.includes(t)||(e=>e.includes(er))(t)||Mr(t)||(e=>e.includes("session."))(t)?null:Cr.find((e=>t.startsWith(e)))||t}return e}));return Array.from(new Set(t)).filter(Boolean)},Mr=e=>e.includes(Yt),Pr=e=>typeof e<"u"&&"jti"in e,Tr=e=>{var t;return Kt({jsonrpc:"2.0",id:null!=(t=e.id)?t:y()},e)},xr=e=>Kt({jsonrpc:"2.0"},e),Ar={major:3,minor:0,revision:0},Rr={major:4,minor:0,revision:0},Or=e=>Tr({method:"signalwire.connect",params:Kt({version:Ar,event_acks:!0},e)}),Lr=e=>Tr({method:"signalwire.reauthenticate",params:{authentication:e}}),jr={id:"callID",destinationNumber:"destination_number",remoteCallerName:"remote_caller_id_name",remoteCallerNumber:"remote_caller_id_number",callerName:"caller_id_name",callerNumber:"caller_id_number"},Vr=e=>{if(e.hasOwnProperty("dialogParams")){const t=e.dialogParams,{remoteSdp:r,localStream:i,remoteStream:o}=t,n=Gt(t,["remoteSdp","localStream","remoteStream"]);for(const e in jr)e&&n.hasOwnProperty(e)&&(n[jr[e]]=n[e],delete n[e]);e.dialogParams=n}return e},Dr=e=>(t={})=>Tr({method:e,params:Vr(t)}),Wr=Dr("verto.invite"),Nr=Dr("verto.bye"),$r=Dr("verto.modify"),Ur=Dr("verto.info"),Br=Dr("verto.answer"),zr=Dr("verto.subscribe"),Hr=Dr("verto.pong"),Fr=(e,t)=>xr({id:e,result:{method:t}}),qr={};Zt(qr,{authErrorAction:()=>ei,authExpiringAction:()=>ri,authSuccessAction:()=>ti,createAction:()=>Jr,destroyAction:()=>Xr,getCustomSagaActionType:()=>di,initAction:()=>Qr,makeCustomSagaAction:()=>ci,reauthAction:()=>Yr,sessionDisconnectedAction:()=>oi,sessionForceCloseAction:()=>si,sessionReconnectingAction:()=>ni,socketMessageAction:()=>ii});var Kr={};function Jr(e,t){function r(...r){if(t){let i=t(...r);if(!i)throw new Error("prepareAction did not return an object");return Kt(Kt({type:e,payload:i.payload},"meta"in i&&{meta:i.meta}),"error"in i&&{error:i.error})}return{type:e,payload:r[0]}}return r.toString=()=>`${e}`,r.type=e,r.match=t=>t.type===e,r}Zt(Kr,{configureStore:()=>Zr,createAction:()=>Jr}),Qt(Kr,j);var Gr=typeof window<"u"&&window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__?window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__:function(){if(0!==arguments.length)return"object"==typeof arguments[0]?O:O.apply(null,arguments)};function Zr(e){const t=function(){return[]},{reducer:r,middleware:i=t(),devTools:o=!0,preloadedState:n,enhancers:s}=e||{};let a;if("function"==typeof r)a=r;else{if(!function(e){if("object"!=typeof e||null===e)return!1;let t=Object.getPrototypeOf(e);if(null===t)return!0;let r=t;for(;null!==Object.getPrototypeOf(r);)r=Object.getPrototypeOf(r);return t===r}(r))throw new Error('"reducer" is a required argument, and must be a function or an object of functions that can be passed to combineReducers');a=A(r)}let c=i;"function"==typeof c&&(c=c(t));const d=L(...c);let l=O;o&&(l=Gr(Kt({trace:!1},"object"==typeof o&&o)));let u=[d];Array.isArray(s)?u=[d,...s]:"function"==typeof s&&(u=s(u));return T(a,n,l(...u))}var Qr=Jr("swSdk/init"),Xr=Jr("swSdk/destroy"),Yr=Jr("swSdk/reauth"),ei=Jr("auth/error"),ti=Jr("auth/success"),ri=Jr("auth/expiring"),ii=Jr("socket/message"),oi=Jr("session.disconnected"),ni=Jr("session.reconnecting"),si=Jr("session.forceClose"),ai=(e,t)=>`${t.type}/${e}`,ci=(e,t)=>Jt(Kt({},t),{type:ai(e,t)}),di=(e,t)=>ai(e,t);function li(e){const t={},r=[];let i;const o={addCase(e,r){const i="string"==typeof e?e:e.type;if(i in t)throw new Error("addCase cannot be called with two reducers for the same action type");return t[i]=r,o},addMatcher:(e,t)=>(r.push({matcher:e,reducer:t}),o),addDefaultCase:e=>(i=e,o)};return e(o),[t,r,i]}function ui(e){const{name:t}=e;if(!t)throw new Error("`name` is a required option for createSlice");const r=e.initialState,i=e.reducers||{},o=Object.keys(i),n={},s={},a={};function c(){const[t={},i=[],o]="function"==typeof e.extraReducers?li(e.extraReducers):[e.extraReducers],n=Kt(Kt({},t),s);return function(e,t,r=[],i){let o,[n,s,a]="function"==typeof t?li(t):[t,r,i];function c(e=o(),t){let r=[n[t.type],...s.filter((({matcher:e})=>e(t))).map((({reducer:e})=>e))];return 0===r.filter((e=>!!e)).length&&(r=[a]),r.reduce(((e,r)=>r?r(e,t):e),e)}return o=function(e){return"function"==typeof e}(e)?()=>e():()=>e,c.getInitialState=o,c}(r,n,i,o)}let d;return o.forEach((e=>{const r=i[e],o=function(e,t){return`${e}/${t}`}(t,e);let c,d;"reducer"in r?(c=r.reducer,d=r.prepare):c=r,n[e]=c,s[o]=c,a[e]=d?Jr(o,d):Jr(o)})),{name:t,reducer:(e,t)=>(d||(d=c()),d(e,t)),actions:a,caseReducers:n,getInitialState:()=>(d||(d=c()),d.getInitialState())}}var hi=({name:e="",initialState:t,reducers:r,extraReducers:i})=>ui({name:e,initialState:t,reducers:r,extraReducers:e=>{e.addCase(Xr.type,(()=>t)),"function"==typeof i&&i(e)}});function mi(e){return[Qr.type,Yr.type].includes(e.type)}var pi=hi({name:"session",initialState:{protocol:"",iceServers:[],authStatus:"unknown",authState:void 0,authError:void 0,authCount:0},reducers:{connected:(e,{payload:t})=>{var r,i;return Jt(Kt({},e),{authStatus:"authorized",authState:null==t?void 0:t.authorization,authCount:e.authCount+1,protocol:null!=(r=null==t?void 0:t.protocol)?r:"",iceServers:null!=(i=null==t?void 0:t.ice_servers)?i:[]})},authStatus:(e,{payload:t})=>Jt(Kt({},e),{authStatus:t}),updateAuthState:(e,{payload:t})=>Jt(Kt({},e),{authState:t})},extraReducers:e=>{e.addCase(ei.type,((e,{payload:t})=>Jt(Kt({},e),{authStatus:"unauthorized",authError:t.error}))),e.addMatcher(mi,(e=>Jt(Kt({},e),{authStatus:"authorizing"})))}}),{actions:gi,reducer:vi}=pi,fi=Symbol("BaseSession"),yi=()=>1e3*((e,t)=>Math.floor(Math.random()*(t-e+1)+e))(1,4),bi=class{constructor(e){var t,r;this.options=e,Xt(this,"__sw_symbol",fi),Xt(this,"uuid",y()),Xt(this,"WebSocketConstructor"),Xt(this,"CloseEventConstructor"),Xt(this,"agent"),Xt(this,"connectVersion",Ar),Xt(this,"_rpcConnectResult"),Xt(this,"_requests",new Map),Xt(this,"_socket",null),Xt(this,"_host","wss://relay.signalwire.com"),Xt(this,"_executeTimeoutMs",1e4),Xt(this,"_executeTimeoutError",Symbol.for("sw-execute-timeout")),Xt(this,"_executeQueue",new Set),Xt(this,"_swConnectError",Symbol.for("sw-connect-error")),Xt(this,"_executeConnectionClosed",Symbol.for("sw-execute-connection-closed")),Xt(this,"_checkPingDelay",15e3),Xt(this,"_checkPingTimer",null),Xt(this,"_reconnectTimer"),Xt(this,"_status","unknown"),Xt(this,"_sessionChannel"),Xt(this,"wsOpenHandler"),Xt(this,"wsCloseHandler"),Xt(this,"wsErrorHandler");const{host:i,logLevel:o="info",sessionChannel:n}=e;i&&(this._host=(e=>`${kr.test(e)?"":"wss://"}${e}`)(i)),n&&(this._sessionChannel=n),o&&(null==(r=(t=this.logger).setLevel)||r.call(t,o)),this._onSocketOpen=this._onSocketOpen.bind(this),this._onSocketError=this._onSocketError.bind(this),this._onSocketClose=this._onSocketClose.bind(this),this._onSocketMessage=this._onSocketMessage.bind(this),this.execute=this.execute.bind(this),this.connect=this.connect.bind(this),this.wsOpenHandler=e=>{var t;null==(t=this._socket)||t.removeEventListener("open",this.wsOpenHandler),this._onSocketOpen(e)},this.wsCloseHandler=e=>{var t;null==(t=this._socket)||t.removeEventListener("close",this.wsCloseHandler),this._onSocketClose(e)},this.wsErrorHandler=e=>{var t;null==(t=this._socket)||t.removeEventListener("error",this.wsErrorHandler),this._onSocketError(e)}}get host(){return this._host}get rpcConnectResult(){return this._rpcConnectResult}get relayProtocol(){var e,t;return null!=(t=null==(e=this._rpcConnectResult)?void 0:e.protocol)?t:""}get signature(){if(this._rpcConnectResult){const{authorization:e}=this._rpcConnectResult;return e.signature}}get logger(){return dr()}get connecting(){var e;return 0===(null==(e=this._socket)?void 0:e.readyState)}get connected(){var e;return 1===(null==(e=this._socket)?void 0:e.readyState)}get closing(){var e;return 2===(null==(e=this._socket)?void 0:e.readyState)}get closed(){return!this._socket||3===this._socket.readyState}get status(){return this._status}get idle(){return"idle"===this._status}get ready(){return!(this.idle||!this.connected)}set token(e){this.options.token=e}connect(){if(null==this||!this.WebSocketConstructor)throw new Error("Missing WebSocketConstructor");if(null==this||!this.CloseEventConstructor)throw new Error("Missing CloseEventConstructor");this._clearTimers(),this.connecting||this.connected?this.logger.warn("Session already connected."):(this._removeSocketListeners(),this.destroySocket(),this._clearCheckPingTimer(),this._socket=this._createSocket(),this._addSocketListeners())}_createSocket(){return new this.WebSocketConstructor(this._host)}destroySocket(){this._socket&&(this._socket.close(),this.wsCloseHandler(new this.CloseEventConstructor("close",{reason:"Client-side closed"})),this._socket=null)}_addSocketListeners(){if(!this._socket)return this.logger.debug("Invalid socket instance to add listeners");this._removeSocketListeners(),this._socket.addEventListener("open",this.wsOpenHandler),this._socket.addEventListener("close",this.wsCloseHandler),this._socket.addEventListener("error",this.wsErrorHandler),this._socket.addEventListener("message",this._onSocketMessage)}_removeSocketListeners(){if(!this._socket)return this.logger.debug("Invalid socket instance to remove listeners");this._socket.removeEventListener("open",this.wsOpenHandler),this._socket.removeEventListener("close",this.wsCloseHandler),this._socket.removeEventListener("error",this.wsErrorHandler),this._socket.removeEventListener("message",this._onSocketMessage)}disconnect(){this._socket&&!this.closing?(this._status="disconnecting",this._checkCurrentStatus()):this.logger.debug("Session not connected or already in closing state.")}execute(e){if("disconnecting"===this._status)return this.logger.warn("Reject request because the session is disconnecting",e),Promise.reject({code:"400",message:"The SDK session is disconnecting"});if("disconnected"===this._status)return Promise.reject({code:"400",message:"The SDK is disconnected"});let t=Promise.resolve();return"params"in e&&(t=new Promise(((t,r)=>{this._requests.set(e.id,{rpcRequest:e,resolve:t,reject:r})}))),this.ready?(this._send(e),Sr(t,this._executeTimeoutMs,this._executeTimeoutError).catch((t=>{if(t===this._executeConnectionClosed)throw this._executeConnectionClosed;if(t!==this._executeTimeoutError)throw t;if("method"in e&&"signalwire.connect"===e.method)throw this._swConnectError;if(this._checkCurrentStatus(),this.logger.error("Request Timeout",e),"disconnected"===this.status)return this.logger.debug("Request failed because the session is disconnected",this.status,this._socket);this._closeConnection("reconnecting")}))):(this._addToExecuteQueue(e),this.connect(),t)}get _connectParams(){return{agent:this.agent,version:this.connectVersion,authentication:{project:this.options.project,token:this.options.token}}}async authenticate(){var e,t;const r=this._connectParams;this._relayProtocolIsValid()&&(r.protocol=this.relayProtocol),null!=(e=this.options.topics)&&e.length?r.contexts=this.options.topics:null!=(t=this.options.contexts)&&t.length&&(r.contexts=this.options.contexts),this._rpcConnectResult=await this.execute(Or(r))}authError(e){this._removeSocketListeners(),this.dispatch(ei({error:e}))}forceClose(){return this._removeSocketListeners(),this._closeConnection("reconnecting")}async _onSocketOpen(e){this.logger.debug("_onSocketOpen",e.type);try{this._status="unknown",this._clearTimers(),await this.authenticate(),this._status="connected",this._flushExecuteQueue(),this.dispatch(ti())}catch(d){if(d===this._swConnectError||d===this._executeConnectionClosed)return void this.logger.debug("Invalid connect or connection closed. Waiting for retry.");this.logger.error("Auth Error",d),this.authError(d)}}_onSocketError(e){this.logger.debug("_onSocketError",e)}_onSocketClose(e){this.logger.debug("_onSocketClose",e.type,e.code,e.reason),"disconnected"!==this._status&&(this._status="reconnecting",this.dispatch(ni()),this._clearTimers(),this._clearPendingRequests(),this._reconnectTimer=setTimeout((()=>{this.connect()}),yi())),this._socket=null}_clearTimers(){clearTimeout(this._reconnectTimer)}_clearPendingRequests(){this.logger.debug("_clearPendingRequests",this._requests.size),this._requests.forEach((({reject:e})=>{e(this._executeConnectionClosed)}))}_onSocketMessage(e){const t=this.decode(e.data);if(this.logger.wsTraffic({type:"recv",payload:t}),(e=>!(e=>!!e.method)(e))(t)){const e=this._requests.get(t.id);if(e){const{rpcRequest:r,resolve:i,reject:o}=e;this._requests.delete(t.id);const{result:n,error:s}=(({response:e,request:t})=>{const{result:r={},error:i}=e;return i?{error:i}:"signalwire.connect"===t.method?{result:r}:pr(e)})({response:t,request:r});return this._checkCurrentStatus(),s?o(s):i(n)}return this.logger.warn("Unknown request for",t)}switch(t.method){case"signalwire.ping":return this._pingHandler(t);case"signalwire.disconnect":this.execute((e=>xr({id:e,result:{}}))(t.id)).catch((e=>{this.logger.error("SwDisconnect Error",e)})).finally((()=>{this._status="idle"}));break;default:this._eventAcknowledgingHandler(t).catch((e=>this.logger.error("Event Acknowledging Error",e))),this.dispatch(ii(t))}}dispatch(e){if(!this._sessionChannel)throw new Error("Session channel does not exist");this._sessionChannel.put(e)}_relayProtocolIsValid(){var e;return this.signature&&(null==(e=null==this?void 0:this.relayProtocol)?void 0:e.split("_")[1])===this.signature}encode(e){return JSON.stringify(e)}decode(e){return(e=>{if("string"!=typeof e)return e;try{return JSON.parse(e)}catch{return e}})(e)}async onSwAuthorizationState(e){this.persistSwAuthorizationState(e)}async retrieveSwAuthorizationState(){return""}async persistSwAuthorizationState(e){}_send(e){this.logger.wsTraffic({type:"send",payload:e}),this._socket.send(this.encode(e))}_addToExecuteQueue(e){this.logger.warn("Request queued waiting for session to reconnect",e),this._executeQueue.add(e)}_flushExecuteQueue(){if(this._executeQueue.size){if(!this.ready)return this.logger.warn("Session not ready to flush the queue."),void this._closeConnection("reconnecting");this.logger.debug(`${this._executeQueue.size} messages to flush`),this._executeQueue.forEach((e=>{this._send(e),this._executeQueue.delete(e)})),this._executeQueue.clear()}}_clearCheckPingTimer(){clearTimeout(this._checkPingTimer)}async _pingHandler(e){var t;this._clearCheckPingTimer(),this._checkPingTimer=setTimeout((()=>{this.logger.debug("Timeout waiting for ping"),this._closeConnection("reconnecting")}),this._checkPingDelay),await this.execute(((e,t)=>xr({id:e,result:{timestamp:t||Date.now()/1e3}}))(e.id,null==(t=null==e?void 0:e.params)?void 0:t.timestamp))}async _eventAcknowledgingHandler(e){const{method:t,id:r}=e;return"signalwire.event"===t?this.execute((e=>xr({id:e,result:{}}))(r)):Promise.resolve()}_checkCurrentStatus(){switch(this._status){case"disconnecting":if(this._requests.size>0)return;this._requests.clear(),this._closeConnection("disconnected");break;case"disconnected":this.dispatch(oi());break;case"reconnecting":this.wsCloseHandler(new this.CloseEventConstructor("close",{reason:"Client-side closed"}))}}_closeConnection(e){this._clearCheckPingTimer(),this.logger.debug("Close Connection:",e),this._status=e,this.dispatch(gi.authStatus("disconnected"===e?"unauthorized":"unknown")),this._removeSocketListeners(),this.destroySocket(),this._checkCurrentStatus()}},_i=class extends bi{constructor(e){super(e),this.options=e,Xt(this,"_expiredDiffSeconds",0),Xt(this,"_refreshTokenNotificationDiff",120),Xt(this,"_checkTokenExpirationDelay",2e4),Xt(this,"_checkTokenExpirationTimer",null),this._checkTokenExpiration=this._checkTokenExpiration.bind(this),this.reauthenticate=this.reauthenticate.bind(this)}get expiresAt(){var e;if(null==this||!this._rpcConnectResult)return 0;const{authorization:t}=this._rpcConnectResult,r=null!=(e=Pr(t)?t.fabric_subscriber.expires_at:null==t?void 0:t.expires_at)?e:0;if("string"==typeof r){const e=Date.parse(r);if(!isNaN(e))return Math.floor(e/1e3)}return r}get expiresIn(){const e=Math.floor(Date.now()/1e3);return this.expiresAt-e}get expired(){return this.expiresAt>0&&this.expiresIn<=this._expiredDiffSeconds}async authenticate(){const e=Jt(Kt({},this._connectParams),{authentication:{jwt_token:this.options.token}});if(this._relayProtocolIsValid())e.protocol=this.relayProtocol;else{const t=await this.retrieveRelayProtocol();t&&(e.protocol=t)}if(e.protocol){const t=await this.retrieveSwAuthorizationState();t&&(e.authorization_state=t)}try{this._rpcConnectResult=await this.execute(Or(e)),await this.persistRelayProtocol(),await this._checkTokenExpiration()}catch(d){throw this.logger.debug("BaseJWTSession authenticate error",d),d}}async retrieveRelayProtocol(){return""}async persistRelayProtocol(){}async reauthenticate(){if(this.logger.debug("Session Reauthenticate",{ready:this.ready,expired:this.expired}),!this.ready||this.expired)return this.connect();const e={project:this._rpcConnectResult.authorization.project_id,jwt_token:this.options.token};try{this._rpcConnectResult=await this.execute(Lr(e))}catch(d){throw clearTimeout(this._checkTokenExpirationTimer),d}}_onSocketClose(e){clearTimeout(this._checkTokenExpirationTimer),super._onSocketClose(e)}async _checkTokenExpiration(){if(!this.expiresAt)return;const e=this.options.onRefreshToken;if(this.expiresIn<=this._refreshTokenNotificationDiff)if(this.dispatch(ri()),"function"==typeof e)try{const t=await e();this.dispatch(Yr({token:t}))}catch(d){this.logger.error(d)}else this.logger.warn("The token is going to expire!");clearTimeout(this._checkTokenExpirationTimer),this.expired||(this._checkTokenExpirationTimer=setTimeout(this._checkTokenExpiration,this._checkTokenExpirationDelay))}},wi={};Zt(wi,{authErrorAction:()=>ei,authExpiringAction:()=>ri,authSuccessAction:()=>ti,configureStore:()=>Gi,connect:()=>Ki,createAction:()=>Jr,createCatchableSaga:()=>Ti,createRestartableSaga:()=>Mi,destroyAction:()=>Xr,eventChannel:()=>dt,getCustomSagaActionType:()=>di,initAction:()=>Qr,makeCustomSagaAction:()=>ci,reauthAction:()=>Yr,sessionDisconnectedAction:()=>oi,sessionForceCloseAction:()=>si,sessionReconnectingAction:()=>ni,socketMessageAction:()=>ii});var ki=hi({name:"components",initialState:{byId:{}},reducers:{upsert:(e,{payload:t})=>t.id in e.byId?Jt(Kt({},e),{byId:Jt(Kt({},e.byId),{[t.id]:Kt(Kt({},e.byId[t.id]),t)})}):Jt(Kt({},e),{byId:Jt(Kt({},e.byId),{[t.id]:t})}),cleanup:(e,{payload:t})=>Jt(Kt({},e),{byId:Object.entries(e.byId).reduce(((e,[r,i])=>(t.ids.includes(r)||(e[r]=i),e)),{})})}}),{actions:Si,reducer:Ci}=ki,Ei=(0,Kr.combineReducers)({components:Ci,session:vi}),Ii={};Zt(Ii,{createCatchableSaga:()=>Ti,createRestartableSaga:()=>Mi,eventChannel:()=>dt});var Mi=e=>function*(){Be((function*(){for(;;)try{dr().debug("Run a restartable saga"),yield $e(e),dr().debug("One of the restartable saga has ended. Restarting..")}catch(d){dr().error("Restartable Saga Error",d)}}))},Pi=e=>dr().error("Catchable Saga Error",e),Ti=(e,t=Pi)=>function*(...r){try{yield $e(e,...r)}catch(i){t(i)}},xi=e=>hr(null==e?void 0:e.event_type),Ai=e=>{var t;return!(null==(t=null==e?void 0:e.event_type)||!t.startsWith("video."))},Ri=e=>"signalwire.authorization.state"===(null==e?void 0:e.event_type);function*Oi({sessionChannel:e,swEventChannel:t,session:r}){function*i(e){if(yield We(t,br(e)),!xi(e)&&!Ai(e)){if(Ri(e))return void r.onSwAuthorizationState(e.params.authorization_state);yield We({type:e.event_type,payload:e})}}dr().debug("sessionChannelWatcher [started]");const o=Ti((function*(e){if(e.type!==ii.type)return void(yield We(e));const{method:t,params:r}=e.payload;if("signalwire.event"!==t)return dr().debug(`Unknown message: ${t}`,e);yield Ue(i,r)}),(e=>{dr().error("Channel Error",e)}));for(;;)try{for(;;){const t=yield De(e);yield Ue(o,t)}}catch(n){dr().error("sessionChannelWorker error:",n)}finally{dr().debug("sessionChannelWorker [finally]")}}var Li=class e extends Error{constructor(t,r){super(r),this.code=t,this.message=r,Xt(this,"name","AuthError"),Object.setPrototypeOf(this,e.prototype)}},ji=class e extends Error{constructor(t,r,i){super(r),this.code=t,this.message=r,this.response=i,Xt(this,"name","HttpError"),Object.setPrototypeOf(this,e.prototype)}};function*Vi({initSession:e,sessionEmitter:t,userOptions:r,channels:i}){var o;dr().debug("sessionSaga [started]");const n=e(),s=i.swEventChannel,a=i.sessionChannel;let c=[];if(null!=(o=r.workers)&&o.length)try{const e=r.workers.map((e=>$e(Mi(e))));c=yield function(e){var t=Ve(xe,e);return t.combinator=!0,t}(e)}catch(u){dr().error("Error running custom workers",u)}const d=yield Ue(Oi,{session:n,sessionChannel:a,swEventChannel:s}),l=yield Ue(Wi,{session:n,sessionEmitter:t,sessionChannel:a,userOptions:r});n.connect(),yield De(Xr.type),n.disconnect(),yield De(oi.type),t.emit("session.disconnected"),l.cancel(),d.cancel(),c.forEach((e=>e.cancel())),s.close(),a.close(),dr().debug("sessionSaga [ended]")}function*Di({session:e,token:t,sessionEmitter:r}){try{e.reauthenticate&&(e.token=t,yield $e(e.reauthenticate),yield We(gi.connected(e.rpcConnectResult)),r.emit("session.connected"))}catch(i){dr().error("Reauthenticate Error",i),e.authError(i)}}function*Wi(e){dr().debug("sessionStatusWatcher [started]");const{session:t,sessionEmitter:r}=e;try{for(;;){const i=yield De([ti.type,ei.type,ri.type,Yr.type,ni.type,si.type]);switch(dr().debug("sessionStatusWatcher",i.type,i.payload),i.type){case ti.type:yield We(gi.connected(t.rpcConnectResult)),r.emit("session.connected");break;case ei.type:yield Ue(Ni,Jt(Kt({},e),{action:i}));break;case ri.type:r.emit("session.expiring");break;case Yr.type:yield Ue(Di,{session:t,token:i.payload.token,sessionEmitter:r});break;case ni.type:r.emit("session.reconnecting");break;case si.type:t.forceClose()}}}finally{(yield Fe())&&dr().debug("sessionStatusWatcher [cancelled]")}}function*Ni(e){dr().debug("sessionAuthErrorSaga [started]");try{const{action:t,sessionEmitter:r}=e,{error:i}=t.payload,o=i?new Li(i.code,i.message):new Error("Unauthorized");r.emit("session.auth_error",o)}finally{(yield Fe())&&dr().debug("sessionAuthErrorSaga [cancelled]")}}var $i=e=>function*({userOptions:t,channels:r}){for(dr().debug("rootSaga [started]"),t.logger&&(e=>{nr=e})(t.logger),t.debug&&(e=>{null!=e?Object.assign(sr,e):sr={}})(t.debug);;){yield De(Qr.type);try{yield $e(Vi,Jt(Kt({},e),{userOptions:t,channels:r}));break}catch(i){dr().error("RootSaga Error:",i)}finally{(yield Fe())&&dr().debug("rootSaga [cancelled]"),dr().debug("Reboot rootSaga")}}dr().debug("rootSaga [finished]")},Ui={};Zt(Ui,{getAuthError:()=>Fi,getAuthState:()=>qi,getAuthStatus:()=>Hi,getIceServers:()=>Bi,getSession:()=>zi});var Bi=({session:e})=>{var t;return null!=(t=null==e?void 0:e.iceServers)?t:[]},zi=e=>e.session,Hi=({session:e})=>e.authStatus,Fi=({session:e})=>e.authError,qi=({session:e})=>e.authState,Ki=e=>{const{sessionListeners:t={},store:r,Component:i,customSagas:o=[]}=e,n=Object.keys(t);return e=>{const s=new i(Jt(Kt({},e),{store:r})),a=new Map;let c=!0;const d=r.subscribe((()=>{const e=r.getState(),i=zi(e);for(const r of n){if(!1===c)return;const e=`session.${r}`,o=a.get(e),n=i[r];if(void 0!==n&&o!==n){a.set(e,n);const o=t[r];"string"==typeof o?s[o](i):"function"==typeof o&&o(i)}}})),l=null==o?void 0:o.map((e=>r.runSaga(e,{instance:s,runSaga:r.runSaga})));return s.destroyer=()=>{c=!1,d(),a.clear(),null!=l&&l.length&&l.forEach((e=>e.cancel()))},s}},Ji=()=>new Dt;Qt(wi,Kr);var Gi=e=>{var t;const{userOptions:r,SessionConstructor:i,preloadedState:o={},runRootSaga:n=!0}=e,s=function(e){var t,r=void 0===e?{}:e,i=r.context,o=void 0===i?{}:i,n=r.channel,s=void 0===n?ut():n,a=r.sagaMonitor,c=function(e,t){if(null==e)return{};var r={};for(var i in e)if({}.hasOwnProperty.call(e,i)){if(-1!==t.indexOf(i))continue;r[i]=e[i]}return r}(r,["context","channel","sagaMonitor"]);function d(e){var r=e.getState,i=e.dispatch;return t=Ot.bind(null,J({},c,{context:o,channel:s,dispatch:i,getState:r,sagaMonitor:a})),function(e){return function(t){a&&a.actionDispatched&&a.actionDispatched(t);var r=e(t);return s.put(t),r}}}return d.run=function(){return t.apply(void 0,arguments)},d.setContext=function(e){le(o,e)},d}({sagaMonitor:r.sagaMonitor}),a=lt(),c=ct(),d={swEventChannel:a,sessionChannel:c},l=Zr({devTools:null==(t=null==r?void 0:r.devTools)||t,reducer:Ei,preloadedState:o,middleware:e=>e().concat(s)}),u=(()=>{const e=new Map;return{get:t=>e.get(t),set:(t,r)=>(e.set(t,r),e),remove:t=>(e.delete(t),e),getAll:()=>Array.from(e.entries()),deleteAll:()=>(e.clear(),e)}})(),{initSession:h,getSession:m,sessionEmitter:p}=(e=>{const{SessionConstructor:t,userOptions:r,sessionChannel:i}=e,o=Ji();let n=null;return{session:n,initSession:()=>(n=new t(Jt(Kt({},r),{sessionChannel:i})),n),getSession:()=>(n||dr().warn("Session does not exist!"),n),sessionEmitter:o}})({userOptions:r,sessionChannel:c,SessionConstructor:i});if(n){const e=$i({initSession:h,sessionEmitter:p});s.run(e,{userOptions:r,channels:d})}return Jt(Kt({},l),{runSaga:(e,t)=>s.run(e,Jt(Kt({},t),{channels:d,getSession:m,instanceMap:u})),channels:d,instanceMap:u,sessionEmitter:p})},Zi=function*(e){const{initialState:t,onDone:r,onFail:i,getSession:o}=e,{requestId:n,method:s,params:a}=t,c=o();if(!c){const e=new Error("Session does not exist!");return dr().error(e),void(null==i||i(e))}try{let e=(({method:e,params:t})=>Tr({method:e,params:t}))({id:n,method:s,params:a});const t=yield $e(c.execute,e);null==r||r(t)}catch(d){dr().warn("Execute error: ",d),null==i||i(d)}},Qi=e=>e,Xi=Symbol("BaseComponent"),Yi=class{constructor(e){this.options=e,Xt(this,"__sw_symbol",Xi),Xt(this,"uuid",y()),Xt(this,"_customSagaTriggers",new Map),Xt(this,"_destroyer"),Xt(this,"eventEmitter"),Xt(this,"_runningWorkers",[]),Xt(this,"_workers",new Map),this.eventEmitter=new Dt}get __uuid(){return this.uuid}get logger(){return dr()}set destroyer(e){this._destroyer=e}get store(){return this.options.store}get instanceMap(){return this.store.instanceMap}get emitter(){return this.eventEmitter}get sessionEmitter(){return this.store.sessionEmitter}get session(){return this.sessionEmitter}on(e,t){return this.emitter.on(e,t)}once(e,t){return this.emitter.once(e,t)}off(e,t){return this.emitter.off(e,t)}removeAllListeners(e){return e?this.off(e):(this.eventNames().forEach((e=>{this.off(e)})),this.emitter)}eventNames(){return this.emitter.eventNames()}sessionEventNames(){return this.sessionEmitter.eventNames()}getSubscriptions(){return Ir(this.eventNames())}emit(e,...t){return this.emitter.emit(e,...t)}listenerCount(e){return this.emitter.listenerCount(e)}destroy(){var e;null==(e=this._destroyer)||e.call(this),this.removeAllListeners(),this.detachWorkers()}execute({method:e,params:t},{transformParams:r=Qi,transformResolve:i=Qi,transformReject:o=Qi}={transformParams:Qi,transformResolve:Qi,transformReject:Qi}){return new Promise(((n,s)=>{const a=y();this.runWorker("executeActionWorker",{worker:Zi,onDone:e=>n(i(e)),onFail:e=>s(o(e)),initialState:{requestId:a,componentId:this.__uuid,method:e,params:r(t)}})}))}triggerCustomSaga(e){return new Promise(((t,r)=>{const i=y();this._customSagaTriggers.set(i,{resolve:t,reject:r}),this.store.dispatch(Kt({dispatchId:i},ci(this.__uuid,e)))}))}settleCustomSagaTrigger({dispatchId:e,payload:t,kind:r}){const i=this._customSagaTriggers.get(e);i&&(i[r](t),this._customSagaTriggers.delete(e))}select(e){return e(this.store.getState())}getStateProperty(e){return this[e]}get _sessionAuthStatus(){return Hi(this.store.getState())}get _sessionAuthState(){return qi(this.store.getState())}_waitUntilSessionAuthorized(){switch(Hi(this.store.getState())){case"authorized":return Promise.resolve(this);case"unknown":case"authorizing":return new Promise(((e,t)=>{const r=this.store.subscribe((()=>{const i=Hi(this.store.getState()),o=Fi(this.store.getState());if("authorized"===i)e(this),r();else if("unauthorized"===i){const e=o?new Li(o.code,o.message):new Error("Unauthorized");t(e),r()}}))}));case"unauthorized":return Promise.reject(new Error("Unauthorized"))}}runWorker(e,t){return this._workers.has(e)?dr().warn(`[runWorker] Worker with name ${e} has already been registerd.`):this._setWorker(e,t),this._attachWorker(e,t)}_setWorker(e,t){this._workers.set(e,t)}_attachWorker(e,t){var r=t,{worker:i}=r,o=Gt(r,["worker"]);const n=this.store.runSaga(i,Kt({instance:this,runSaga:this.store.runSaga},o));return this._runningWorkers.push(n),this._workers.delete(e),n}detachWorkers(){this._runningWorkers.forEach((e=>{e.cancel()})),this._runningWorkers=[]}},eo=class extends Yi{constructor(e){super(e),this.options=e}connect(){const e=Hi(this.store.getState());return("unknown"===e||"unauthorized"===e)&&this.store.dispatch(Qr()),this._waitUntilSessionAuthorized()}disconnect(){this.store.dispatch(Xr())}removeAllListeners(e){return this.sessionEventNames().forEach((e=>{this.sessionEmitter.off(e)})),super.removeAllListeners(e)}},to=class extends Yi{constructor(e){super(e),this.options=e,Xt(this,"subscribeMethod","signalwire.subscribe"),Xt(this,"subscribeParams",{}),Xt(this,"_latestExecuteParams");const t=()=>{this._latestExecuteParams=void 0};super.session.on("session.connected",t),super.session.on("session.disconnected",t),super.session.on("session.reconnecting",t)}shouldExecuteSubscribe(e){return!this._latestExecuteParams||JSON.stringify(e)!==JSON.stringify(this._latestExecuteParams)}async subscribe(){await this._waitUntilSessionAuthorized();const e=this.getSubscriptions();if(0===e.length)return void this.logger.debug("`subscribe()` was called without any listeners attached.");const t={method:this.subscribeMethod,params:Jt(Kt({},this.subscribeParams),{event_channel:this.getStateProperty("eventChannel"),events:e})};if(this.shouldExecuteSubscribe(t))return this._latestExecuteParams=t,new Promise((async(e,r)=>{try{return await this.execute(t),e(void 0)}catch(i){return r(i)}}));this.logger.debug("BaseConsumer.subscribe() - Skipped .execute() since the execParams are exactly the same as last time")}},ro={audio_muted:!0,video_muted:!0,deaf:!0,visible:!0,input_volume:1,output_volume:1,input_sensitivity:1};Object.keys(ro).map((e=>`video.member.updated.${e}`));var io=vr(ro);Object.keys(io).map((e=>`member.updated.${e}`));var oo={};Zt(oo,{getComponent:()=>no,getComponentsById:()=>so,getComponentsToCleanup:()=>ao});var no=({components:e},t)=>{var r;return null==(r=e.byId)?void 0:r[t]},so=({components:e})=>e.byId,ao=e=>{const t=so(e);let r=[];return Object.keys(t).forEach((e=>{(t[e].responses||t[e].errors)&&r.push(e)})),r};Object.keys({audioMuted:!0,videoMuted:!0,deaf:!0,visible:!0,inputVolume:1,outputVolume:1,inputSensitivity:1}).map((e=>`member.updated.${e}`));var co={};Zt(co,{RoomSessionPlaybackAPI:()=>rn,RoomSessionRecordingAPI:()=>en,RoomSessionStreamAPI:()=>nn,audioMuteMember:()=>Lo,audioUnmuteMember:()=>jo,createRoomSessionPlaybackObject:()=>on,createRoomSessionRecordingObject:()=>tn,createRoomSessionStreamObject:()=>sn,deafMember:()=>Wo,deleteMemberMeta:()=>Xo,deleteMeta:()=>xo,demote:()=>Fo,getLayouts:()=>mo,getMemberMeta:()=>Go,getMembers:()=>po,getMeta:()=>Mo,getPlaybacks:()=>Co,getRecordings:()=>ko,getStreams:()=>Ao,hideVideoMuted:()=>fo,lock:()=>bo,play:()=>Eo,promote:()=>Ho,removeAllMembers:()=>Jo,removeMember:()=>Ko,setDeaf:()=>$o,setHideVideoMuted:()=>wo,setInputSensitivityMember:()=>zo,setInputVolumeMember:()=>Uo,setLayout:()=>go,setMemberMeta:()=>Zo,setMemberPosition:()=>qo,setMeta:()=>Po,setOutputVolumeMember:()=>Bo,setPositions:()=>vo,setPrioritizeHandraise:()=>Oo,setRaisedHand:()=>Yo,showVideoMuted:()=>yo,startRecording:()=>So,startStream:()=>Ro,undeafMember:()=>No,unlock:()=>_o,updateMemberMeta:()=>Qo,updateMeta:()=>To,videoMuteMember:()=>Vo,videoUnmuteMember:()=>Do});var lo=()=>{},uo=(e,t={})=>({value:function(r={}){return this.execute({method:e,params:Kt({room_session_id:this.roomSessionId},r)},t)}}),ho=(e,t={})=>({value:function(r={}){var i=r,{memberId:o}=i,n=Gt(i,["memberId"]);return this.execute({method:e,params:Kt({room_session_id:this.roomSessionId,member_id:o||this.memberId},n)},t)}}),mo=uo("video.list_available_layouts",{transformResolve:e=>({layouts:e.layouts})}),po=uo("video.members.get",{transformResolve:e=>({members:e.members})}),go=uo("video.set_layout",{transformResolve:lo}),vo=uo("video.set_position",{transformResolve:lo}),fo=uo("video.hide_video_muted",{transformResolve:lo}),yo=uo("video.show_video_muted",{transformResolve:lo}),bo=uo("video.lock",{transformResolve:lo}),_o=uo("video.unlock",{transformResolve:lo}),wo={value:function(e){return this.execute({method:e?"video.hide_video_muted":"video.show_video_muted",params:{room_session_id:this.roomSessionId}},{transformResolve:lo})}},ko={value:function(){return new Promise((async(e,t)=>{try{const{recordings:t}=await this.execute({method:"video.recording.list",params:{room_session_id:this.roomSessionId}}),r=[];t.forEach((e=>{let t=this.instanceMap.get(e.id);t?t.setPayload({room_id:this.roomId,room_session_id:this.roomSessionId,recording:e}):t=tn({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,recording:e}}),r.push(t),this.instanceMap.set(t.id,t)})),e({recordings:r})}catch(l){t(l)}}))}},So={value:function(){return new Promise((async(e,t)=>{try{const{recording:t}=await this.execute({method:"video.recording.start",params:{room_session_id:this.roomSessionId}}),r=tn({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,recording:t}});this.instanceMap.set(r.id,r),e(r)}catch(l){t(l)}}))}},Co={value:function(){return new Promise((async(e,t)=>{try{const{playbacks:t}=await this.execute({method:"video.playback.list",params:{room_session_id:this.roomSessionId}}),r=[];t.forEach((e=>{let t=this.instanceMap.get(e.id);t?t.setPayload({room_id:this.roomId,room_session_id:this.roomSessionId,playback:e}):t=on({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,playback:e}}),r.push(t),this.instanceMap.set(t.id,t)})),e({playbacks:r})}catch(l){t(l)}}))}},Eo={value:function(e){var t=e,{seekPosition:r,currentTimecode:i}=t,o=Gt(t,["seekPosition","currentTimecode"]);return new Promise((async(e,t)=>{try{const t=r||i,{playback:n}=await this.execute({method:"video.playback.start",params:Kt({room_session_id:this.roomSessionId,seek_position:t},o)}),s=on({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,playback:n}});this.instanceMap.set(s.id,s),e(s)}catch(n){t(n)}}))}},Io=e=>uo(e,{transformResolve:lo,transformParams:e=>{const t=e,{room_session_id:r}=t;return{room_session_id:r,meta:Gt(t,["room_session_id"])}}}),Mo=uo("video.get_meta",{transformResolve:({meta:e})=>({meta:e})}),Po=Io("video.set_meta"),To=Io("video.update_meta"),xo={value:function(e){return this.execute({method:"video.delete_meta",params:{room_session_id:this.roomSessionId,keys:e}})}},Ao={value:function(){return new Promise((async(e,t)=>{try{const{streams:t}=await this.execute({method:"video.stream.list",params:{room_session_id:this.roomSessionId}}),r=[];t.forEach((e=>{let t=this.instanceMap.get(e.id);t?t.setPayload({room_id:this.roomId,room_session_id:this.roomSessionId,stream:e}):t=sn({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,stream:e}}),r.push(t),this.instanceMap.set(t.id,t)})),e({streams:r})}catch(l){t(l)}}))}},Ro={value:function(e){return new Promise((async(t,r)=>{try{const{stream:r}=await this.execute({method:"video.stream.start",params:Kt({room_session_id:this.roomSessionId},e)}),i=sn({store:this.store,payload:{room_id:this.roomId,room_session_id:this.roomSessionId,stream:r}});this.instanceMap.set(i.id,i),t({stream:i})}catch(i){r(i)}}))}},Oo={value:function(e){return this.execute({method:"video.prioritize_handraise",params:{room_session_id:this.roomSessionId,enable:e}})}},Lo=ho("video.member.audio_mute",{transformResolve:lo}),jo=ho("video.member.audio_unmute",{transformResolve:lo}),Vo=ho("video.member.video_mute",{transformResolve:lo}),Do=ho("video.member.video_unmute",{transformResolve:lo}),Wo=ho("video.member.deaf",{transformResolve:lo}),No=ho("video.member.undeaf",{transformResolve:lo}),$o={value:function(e){return this.execute({method:e?"video.member.deaf":"video.member.undeaf",params:{room_session_id:this.roomSessionId,member_id:this.memberId}},{transformResolve:lo})}},Uo=ho("video.member.set_input_volume",{transformResolve:lo}),Bo=ho("video.member.set_output_volume",{transformResolve:lo}),zo=ho("video.member.set_input_sensitivity",{transformResolve:lo}),Ho={value:function(e){var t=e,{memberId:r,mediaAllowed:i,joinAudioMuted:o,joinVideoMuted:n}=t,s=Gt(t,["memberId","mediaAllowed","joinAudioMuted","joinVideoMuted"]);return this.execute({method:"video.member.promote",params:Kt({room_session_id:this.roomSessionId,member_id:r,media_allowed:i,join_audio_muted:o,join_video_muted:n},s)},{transformResolve:lo})}},Fo={value:function({memberId:e,mediaAllowed:t}){return this.execute({method:"video.member.demote",params:{room_session_id:this.roomSessionId,member_id:e,media_allowed:t}},{transformResolve:lo})}},qo=ho("video.member.set_position",{transformResolve:lo}),Ko={value:function(e){var t=e,{memberId:r}=t,i=Gt(t,["memberId"]);if(!r)throw new TypeError('Invalid or missing "memberId" argument');return this.execute({method:"video.member.remove",params:Kt({room_session_id:this.roomSessionId,member_id:r},i)},{transformResolve:lo})}},Jo={value:function(){return this.execute({method:"video.member.remove",params:{room_session_id:this.roomSessionId,member_id:"all"}},{transformResolve:lo})}},Go=ho("video.member.get_meta",{transformResolve:({meta:e})=>({meta:e})}),Zo=ho("video.member.set_meta",{transformResolve:lo}),Qo=ho("video.member.update_meta",{transformResolve:lo}),Xo=ho("video.member.delete_meta",{transformResolve:lo}),Yo={value:function(e){const{raised:t=!0,memberId:r=this.memberId}=e||{};if(!r)throw new TypeError('Invalid or missing "memberId" argument');return this.execute({method:t?"video.member.raisehand":"video.member.lowerhand",params:{room_session_id:this.roomSessionId,member_id:r}},{transformResolve:lo})}},en=class extends Yi{constructor(e){super(e),Xt(this,"_payload"),this._payload=e.payload}get id(){return this._payload.recording.id}get roomId(){return this._payload.room_id}get roomSessionId(){return this._payload.room_session_id}get state(){return this._payload.recording.state}get duration(){return this._payload.recording.duration}get startedAt(){if(this._payload.recording.started_at)return new Date(1e3*this._payload.recording.started_at)}get endedAt(){if(this._payload.recording.ended_at)return new Date(1e3*this._payload.recording.ended_at)}setPayload(e){this._payload=e}async pause(){await this.execute({method:"video.recording.pause",params:{room_session_id:this.getStateProperty("roomSessionId"),recording_id:this.getStateProperty("id")}})}async resume(){await this.execute({method:"video.recording.resume",params:{room_session_id:this.getStateProperty("roomSessionId"),recording_id:this.getStateProperty("id")}})}async stop(){await this.execute({method:"video.recording.stop",params:{room_session_id:this.getStateProperty("roomSessionId"),recording_id:this.getStateProperty("id")}})}},tn=e=>Ki({store:e.store,Component:en})(e),rn=class extends Yi{constructor(e){super(e),Xt(this,"_payload"),this._payload=e.payload}get id(){return this._payload.playback.id}get roomId(){return this._payload.room_id}get roomSessionId(){return this._payload.room_session_id}get url(){return this._payload.playback.url}get state(){return this._payload.playback.state}get volume(){return this._payload.playback.volume}get startedAt(){if(this._payload.playback.started_at)return new Date(1e3*this._payload.playback.started_at)}get endedAt(){if(this._payload.playback.ended_at)return new Date(1e3*this._payload.playback.ended_at)}get position(){return this._payload.playback.position}get seekable(){return this._payload.playback.seekable}setPayload(e){this._payload=e}async pause(){await this.execute({method:"video.playback.pause",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id")}})}async resume(){await this.execute({method:"video.playback.resume",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id")}})}async stop(){await this.execute({method:"video.playback.stop",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id")}})}async setVolume(e){await this.execute({method:"video.playback.set_volume",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),volume:e}})}async seek(e){await this.execute({method:"video.playback.seek_absolute",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),position:Math.abs(e)}})}async forward(e=5e3){await this.execute({method:"video.playback.seek_relative",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),position:Math.abs(e)}})}async rewind(e=5e3){await this.execute({method:"video.playback.seek_relative",params:{room_session_id:this.getStateProperty("roomSessionId"),playback_id:this.getStateProperty("id"),position:-Math.abs(e)}})}},on=e=>Ki({store:e.store,Component:rn})(e),nn=class extends Yi{constructor(e){super(e),Xt(this,"_payload"),this._payload=e.payload}get id(){return this._payload.stream.id}get roomId(){return this._payload.room_id}get roomSessionId(){return this._payload.room_session_id}get state(){return this._payload.stream.state}get duration(){return this._payload.stream.duration}get url(){return this._payload.stream.url}get startedAt(){if(this._payload.stream.started_at)return new Date(1e3*this._payload.stream.started_at)}get endedAt(){if(this._payload.stream.ended_at)return new Date(1e3*this._payload.stream.ended_at)}setPayload(e){this._payload=e}async stop(){await this.execute({method:"video.stream.stop",params:{room_session_id:this.getStateProperty("roomSessionId"),stream_id:this.getStateProperty("id")}})}},sn=e=>Ki({store:e.store,Component:nn})(e),an={};Zt(an,{BaseChatAPI:()=>Mn,BaseChatConsumer:()=>In,ChatMember:()=>xn,ChatMessage:()=>Tn,applyCommonMethods:()=>On,createBaseChatObject:()=>Pn,getMemberState:()=>yn,getMembers:()=>gn,getMessages:()=>pn,publish:()=>mn,setMemberState:()=>fn});var cn=e=>{const t=!e||Array.isArray(e)?e:[e];return Array.isArray(t)?t.map((e=>({name:e}))):[]},dn=e=>Array.isArray(e)||"string"==typeof e,ln=()=>{},un=(e,t={})=>({value:function(r={}){return this.execute({method:e,params:r},t)}}),hn=(e,t={})=>({value:function(r={}){var i=r,{memberId:o}=i,n=Gt(i,["memberId"]);return this.execute({method:e,params:Kt({member_id:o},n)},t)}}),mn=un("chat.publish",{transformResolve:ln}),pn=un("chat.messages.get",{transformResolve:e=>({messages:e.messages.map((e=>vr(e))),cursor:e.cursor})}),gn=un("chat.members.get",{transformResolve:e=>({members:e.members.map((e=>vr(e)))})}),vn=e=>{const t=dn(null==e?void 0:e.channels)?cn(e.channels):void 0;return Jt(Kt({},e),{channels:t})},fn=hn("chat.member.set_state",{transformResolve:ln,transformParams:vn}),yn=hn("chat.member.get_state",{transformResolve:e=>({channels:e.channels}),transformParams:vn}),bn={};Zt(bn,{BasePubSubConsumer:()=>kn,PubSubMessage:()=>Cn,createBasePubSubObject:()=>Sn});var _n=function*(e){dr().trace("pubSubWorker started");const{instance:t,channels:{swEventChannel:r}}=e;function*i(e){const{type:r,payload:i}=e;switch(r){case`${tr}.channel.message`:{const{channel:e,message:r}=i,o=r,{member:n}=o,s=Gt(o,["member"]),a=vr(Jt(Kt({},s),{channel:e})),c=new Cn(a);t.emit("message",c);break}default:dr().warn(`Unknown pubsub event: "${r}"`)}}const o=e=>e.type.startsWith(`${tr}.`);for(;;){const e=yield De(r,o);yield Ue(i,e)}dr().trace("pubSubWorker ended")},wn=e=>e.map((e=>({name:e}))),kn=class extends to{constructor(e){super(e),Xt(this,"subscribeMethod",`${tr}.subscribe`),this.initWorker()}initWorker(){this.runWorker("pubSub",{worker:_n})}_getChannelsParam(e,t){const r=!e||Array.isArray(e)?e:[e];if(!Array.isArray(r)||0===r.length)throw new Error(`Please specify one or more channels when calling .${t}()`);return{channels:wn(r)}}_setSubscribeParams(e){this.subscribeParams=Kt(Kt({},this.subscribeParams),e)}_getSubscribeParams({channels:e}){return Kt({},this._getChannelsParam(e,"subscribe"))}_getUnsubscribeParams({channels:e}){const t=this._getChannelsParam(e,"unsubscribe");return Kt({},t)}_checkMissingSubscriptions(){0===this.getSubscriptions().length&&(this.logger.info("Subscribe was called before any listeners were attached. Move `.subscribe()` right after your event listeners to suppress this message."),this.once("message",(()=>{})))}getSubscriptions(){const e=this.eventNames().map((e=>`${tr}.${String(e)}`));return Ir(e)}async subscribe(e){this._checkMissingSubscriptions();const t=this._getSubscribeParams({channels:e});return this._setSubscribeParams(t),super.subscribe()}async unsubscribe(e){if("unknown"===this._sessionAuthStatus||"unauthorized"===this._sessionAuthStatus)throw new Error("You must be authenticated to unsubscribe from a channel");const t=this._getUnsubscribeParams({channels:e});return new Promise((async(e,r)=>{const i=this.getSubscriptions();if(i.length>0){const e={method:`${tr}.unsubscribe`,params:Jt(Kt({},t),{events:i})};try{await this.execute(e)}catch(o){return r(o)}}else this.logger.warn("`unsubscribe()` was called without any listeners attached.");return e()}))}updateToken(e){return new Promise(((t,r)=>{this.session.once("session.auth_error",(e=>{r(e)})),this.session.once("session.connected",(()=>{t()})),this.store.dispatch(qr.reauthAction({token:e}))}))}publish(e){return this.execute({method:`${tr}.publish`,params:e})}async getAllowedChannels(){await this._waitUntilSessionAuthorized();const e=this.select(qi);return e&&"channels"in e&&e.channels?e.channels:{}}},Sn=e=>Ki({store:e.store,Component:kn})(e),Cn=class{constructor(e){this.payload=e}get id(){return this.payload.id}get channel(){return this.payload.channel}get content(){return this.payload.content}get meta(){return this.payload.meta}get publishedAt(){return this.payload.publishedAt}},En=function*(e){dr().trace("chatWorker started");const{instance:t,channels:{swEventChannel:r}}=e;function*i(e){const{type:r,payload:i}=e;switch(r){case"chat.channel.message":{const{channel:e,message:r}=i,o=vr(Jt(Kt({},r),{channel:e})),n=new Tn(o);t.emit("message",n);break}case"chat.member.joined":case"chat.member.updated":case"chat.member.left":{const{member:e}=i,o=vr(e),n=new xn(o),s=wr(r);t.emit(s,n);break}default:dr().warn(`Unknown chat event: "${r}"`)}}const o=e=>e.type.startsWith("chat.");for(;;){const e=yield De(r,o);yield Ue(i,e)}dr().trace("chatWorker ended")},In=class extends kn{constructor(e){super(e),Xt(this,"subscribeMethod","chat.subscribe")}initWorker(){this.runWorker("chat",{worker:En})}},Mn=_r(In,{publish:mn,getMembers:gn,getMessages:pn,setMemberState:fn,getMemberState:yn}),Pn=e=>Ki({store:e.store,Component:Mn})(e),Tn=class extends Cn{get member(){return this.payload.member}},xn=class{constructor(e){this.payload=e}get id(){return this.payload.id}get channel(){return this.payload.channel}get state(){var e;return null!=(e=this.payload.state)?e:{}}},An=e=>{const t=dn(null==e?void 0:e.channels)?cn(e.channels):void 0;return Jt(Kt({},e),{channels:t})},Rn=()=>{};function On(e){return class extends e{getMembers(e){return this._client.execute({method:"chat.members.get",params:e},{transformResolve:e=>({members:e.members.map((e=>vr(e)))})})}getMessages(e){return this._client.execute({method:"chat.messages.get",params:e},{transformResolve:e=>({messages:e.messages.map((e=>vr(e))),cursor:e.cursor})})}setMemberState(e={}){var t=e,{memberId:r}=t,i=Gt(t,["memberId"]);return this._client.execute({method:"chat.member.set_state",params:Kt({member_id:r},i)},{transformResolve:Rn,transformParams:An})}getMemberState(e={}){var t=e,{memberId:r}=t,i=Gt(t,["memberId"]);return this._client.execute({method:"chat.member.get_state",params:Kt({member_id:r},i)},{transformResolve:e=>({channels:e.channels}),transformParams:An})}}}var Ln={};Zt(Ln,{memberPositionWorker:()=>Wn,memberUpdatedWorker:()=>Dn});var jn=function*(e,t,r){const i=wr(e);r.emit(i,t)};function*Vn(e){const{action:t,memberList:r,instance:i,dispatcher:o=jn}=e,n=t.payload.layout.layers,s={};n.forEach((e=>{var t;const i=e.member_id;if(!i)return;const o=r.get(i);o&&e.position!==(null==(t=o.member)?void 0:t.current_position)?(Nn({memberList:r,memberId:i,currentPosition:e.position}),s[i]=!0):s[i]=!1}));for(const[a,c]of r)if(s[a])yield null==o?void 0:o("video.member.updated",c,i);else if(void 0===s[a]){const e=Nn({memberList:r,memberId:a,currentPosition:"off-canvas"});if(!e)return;yield null==o?void 0:o("video.member.updated",e,i)}}function*Dn({action:e,memberList:t,instance:r,dispatcher:i=jn}){var o,n;const s=e.payload.member.id,a=Nn({memberList:t,memberId:s,currentPosition:null==(n=null==(o=t.get(s))?void 0:o.member)?void 0:n.current_position});if(!a)return;const{member:{updated:c=[]}}=e.payload,d=Jt(Kt({},a),{member:Kt(Kt({},a.member),e.payload.member)});t.set(s,d);for(const l of c){const t=`${e.type}.${l}`;yield null==i?void 0:i(t,d,r)}yield null==i?void 0:i(e.type,d,r)}var Wn=function*({instance:e,channels:t,initialState:r,getSession:i,instanceMap:o,dispatcher:n=jn}){if(!r)return;const{swEventChannel:s}=t;let a=$n(r);const c=e=>{a.has(e.member.id)||a.set(e.member.id,e)};for(;;){const r=yield De(s,(e=>"video.member.joined"===e.type||"video.member.updated"===e.type||"video.member.left"===e.type||"video.layout.changed"===e.type));switch(r.type){case"video.member.joined":c(r.payload);break;case"video.member.updated":c(r.payload),yield Ue(Dn,{action:r,channels:t,memberList:a,instance:e,getSession:i,instanceMap:o,dispatcher:n});break;case"video.member.left":{const e=r.payload.member;a.delete(e.id);break}case"video.layout.changed":yield Ue(Vn,{action:r,channels:t,memberList:a,instance:e,dispatcher:n})}}},Nn=({memberList:e,memberId:t,currentPosition:r})=>{const i=e.get(t);if(!i)return;if(!r)return i;const o=Jt(Kt({},i),{member:Jt(Kt({},null==i?void 0:i.member),{current_position:r})});return e.set(t,o),o},$n=e=>{const t=e.room_session.members,r=new Map;return t.forEach((t=>{const i=t.id,o=e.room_session.id||e.room_session.room_session_id;r.set(i,{room_id:e.room_session.room_id,room_session_id:o,member:t})})),r};Zt({},{configureFullStack:()=>Fn,configureJestStore:()=>Hn,createMockedLogger:()=>zn,createSessionChannel:()=>Gn,createSwEventChannel:()=>Jn,rpcConnectResultVRT:()=>Kn,wait:()=>qn});var Un="8f0a119a-cda7-4497-a47d-c81493b824d4",Bn="<VRT>",zn=()=>({fatal:jest.fn(),error:jest.fn(),warn:jest.fn(),info:jest.fn(),debug:jest.fn(),trace:jest.fn(),wsTraffic:jest.fn()}),Hn=e=>Gi(Kt({userOptions:{project:Un,token:Bn,devTools:!1},SessionConstructor:bi,runRootSaga:!1},e)),Fn=()=>{const e={dispatch:console.log,connect:jest.fn(),disconnect:jest.fn(),execute:jest.fn()},t=new Dt,r=Gi({userOptions:{project:Un,token:Bn,devTools:!1},SessionConstructor:jest.fn().mockImplementation((()=>e))});return r.dispatch(qr.initAction()),r.dispatch(qr.authSuccessAction()),{store:r,session:e,emitter:t,destroy:()=>r.dispatch(qr.destroyAction())}},qn=e=>new Promise((t=>{setTimeout(t,e)})),Kn={identity:"f3bc99df-2c3d-4fa4-b1dc-e8a8ffc579e6@e3fefa44-1bad-4be9-ad9b-1cbb9abd60c7.west-us",authorization:{type:"video",project_id:"8f0a119a-cda7-4497-a47d-c81493b824d4",project:"8f0a119a-cda7-4497-a47d-c81493b824d4",scopes:["video"],scope_id:"26675883-8499-4ee9-85eb-691c4aa209f8",resource:"9c80f1e8-9430-4070-a043-937eb3a96b38",join_as:"member",user_name:"Joe",room:{name:"lobby",display_name:"Lobby",scopes:["room.self.audio_mute","room.self.audio_unmute"],meta:{}},signature:"SGZtkRD9fvuBAOUp1UF56zESxdEvGT6qSGZtkRD9fvuBAOUp1UF56zESxdEvGT6q",media_allowed:"all",audio_allowed:"both",video_allowed:"both",meta:{}},protocol:"signalwire_SGZtkRD9fvuBAOUp1UF56zESxdEvGT6qSGZtkRD9fvuBAOUp1UF56zESxdEvGT6q_03e8c927-8ea3-4661-86d5-778c3e03296a_8f0a119a-cda7-4497-a47d-c81493b824d4",ice_servers:[{urls:"turn.swire.io:443",credential:"sFTwvi8ShXcYNOcyYjFy3ATIUpQ=",credentialType:"password",username:"1619521908:8f0a119a-cda7-4497-a47d-c81493b824d4"}]},Jn=()=>lt(),Gn=()=>ct(),Zn=Kt({},Ui);const Qn=()=>typeof navigator<"u"&&!!navigator.mediaDevices,Xn=()=>{if(!Qn())throw new Error("The media devices API isn't supported in this environment");return navigator.mediaDevices},Yn=()=>"function"==typeof Xn().getUserMedia,es=()=>"function"==typeof Xn().getDisplayMedia,ts=()=>Xn().getSupportedConstraints(),rs=e=>e&&e instanceof MediaStream,is=()=>"sinkId"in HTMLMediaElement.prototype,os=async(e,t)=>{if(null!==e)if("string"==typeof t)if(is())try{return await e.setSinkId(t)}catch(l){throw"SecurityError"===l.name?dr().error(`You need to use HTTPS for selecting audio output device: ${l}`):dr().error(`Error: ${l}`),l}else dr().warn("Browser does not support output device selection.");else dr().warn(`Invalid speaker deviceId: '${t}'`);else dr().warn("No HTMLMediaElement to attach the speakerId")},ns=e=>{var t;rs(e)&&(null===(t=null==e?void 0:e.getTracks())||void 0===t||t.forEach(ss))},ss=e=>{e&&"live"===e.readyState&&(e.stop(),e.dispatchEvent(new Event("ended")))},as={camera:"videoinput",microphone:"audioinput",speaker:"audiooutput"},cs=e=>{if(e)return as[e]},ds=()=>Xn().enumerateDevices(),ls=async e=>{let t=await ds().catch((e=>[]));return e&&(t=t.filter((({kind:t})=>t===e))),t},us=async e=>{if("permissions"in navigator&&"function"==typeof navigator.permissions.query&&e)try{return"granted"===(await navigator.permissions.query({name:e})).state}catch{}return(async e=>{const t=await ls(e);return t.length?t.every((({deviceId:e,label:t})=>!(!e||!t))):(dr().warn(`No ${e} devices to check for permissions!`),null)})(cs(e))},hs=()=>us("camera"),ms=()=>us("microphone"),ps=()=>us("speaker"),gs=async(e={audio:!0,video:!0})=>{var t;try{const t=Xn().getUserMedia(e);if(await(async e=>{const t=[];return null!=e&&e.audio&&t.push(ms()),null!=e&&e.video&&t.push(hs()),!!t.length&&(await Promise.all(t)).every(Boolean)})(e)){const e=new Error("Timeout reading from your devices");return await Sr(t,5e3,e)}return await t}catch(l){switch(l.name){case"Error":dr().error(null!==(t=null==l?void 0:l.message)&&void 0!==t?t:"navigator.mediaDevices.getUserMedia doesn't seem to be supported.");break;case"NotFoundError":dr().error("No media tracks of the type specified were found that satisfy the given constraints.");break;case"NotReadableError":dr().error("Hardware error occurred at the operating system, browser, or Web page level which prevented access to the device. This could have been caused by having the Camera or Mic being user by another application.");break;case"OverconstrainedError":dr().error(`The constraint: ${l.constraint} cannot be met by the selected device.`),dr().info("List of available constraints:",ts());break;case"NotAllowedError":dr().error("The user has mostly likely denied access to the device. This could also happen if the browsing context is insecure (using HTTP rather than HTTPS)");break;case"TypeError":0===Object.keys(e).length?dr().error('Constraints can\'t be empty nor have "video" and "audio" set to false.'):dr().error("Please check that you are calling this method from a secure context (using HTTPS rather than HTTP).");break;case"SecurityError":dr().error("User media support is disabled on the Document on which getUserMedia() was called. The mechanism by which user media support is enabled and disabled is left up to the individual user agent.")}throw l}},vs=e=>Xn().getDisplayMedia(e),fs=async e=>{try{const t=await gs(e);ns(t)}catch(d){throw d}},ys=async(e,t=!1)=>Ss(e,t),bs=()=>ys("camera"),_s=()=>ys("microphone"),ws=()=>ys("speaker"),ks=(e,t={})=>{const r=[];return e.filter((({deviceId:e,kind:i,groupId:o})=>{var n;if(!e||t.targets&&(null===(n=t.targets)||void 0===n||!n.includes(i)))return!1;if(!o)return!0;const s=`${i}-${o}`,a=null==t||!t.excludeDefault||"default"!==e;return!(r.includes(s)||!a)&&(r.push(s),!0)}))},Ss=async(e,t=!1)=>{let r;if(!1===await us(e)){const t=(e=>({audio:!e||"all"===e||"microphone"===e||"speaker"===e,video:!e||"all"===e||"camera"===e}))(e);r=await gs(t)}const i=await ls(cs(e));return r&&ns(r),!0===t?i:ks(i)},Cs=()=>Ss("camera"),Es=()=>Ss("microphone"),Is=()=>Ss("speaker"),Ms=async(e,t,r)=>{const i=await Ss(r,!0);for(let o=0;o<i.length;o++){const{deviceId:r,label:n}=i[o];if(e===r||t===n)return r}return null},Ps=e=>{const t=new Map;return e.forEach((e=>{e.deviceId&&t.set(e.deviceId,e)})),t},Ts={camera:hs,microphone:ms,speaker:ps},xs=["camera","microphone","speaker"],As=`Allowed targets are: '${xs.join("', '")}'`,Rs={speaker:is},Os=async e=>{var t;const r=(null!==(t=e.targets)&&void 0!==t?t:xs).filter((e=>!!xs.includes(e)||(dr().warn(`We'll ignore the "${e}" target as it is not allowed. ${As}.`),!1)));if(!r.length)throw new Error(`At least one "target" is required for createDeviceWatcher(). ${As}.`);const i=await(async e=>{const t=e.targets;return(await Promise.all(t.map((e=>Ts[e]())))).reduce(((e,r,i)=>{var o;const n=t[i];return e[!(n in Rs)||(null===(o=Rs[n])||void 0===o?void 0:o.call(Rs))?"supported":"unsupported"].push([n,!!r]),e}),{supported:[],unsupported:[]})})({targets:r});if(i.unsupported.length>0&&r.length===i.unsupported.length)throw new Error(`The platform doesn't support "${r.join(", ")}" as target/s, which means it's not possible to watch for changes on those devices.`);if(i.supported.every((([e,t])=>!t)))throw new Error("You must ask the user for permissions before being able to listen for device changes. Try calling getUserMedia() before calling `createDeviceWatcher()`.");let o=[];const n=i.supported.reduce(((e,[t,r])=>(r?e.push(t):o.push(t),e)),[]);if(n.length!==r.length){const e=i.unsupported.length>0?`The platform doesn't support "${i.unsupported.map((([e])=>e)).join(", ")}" as target/s, which means it's not possible to watch for changes on those devices. `:"",t=o.length>0?`The user hasn't granted permissions for the following targets: ${o.join(", ")}. `:"";dr().warn(`${e}${t}We'll be watching for the following targets instead: "${n.join(", ")}"`)}return dr().debug(`Watching these targets: "${n.join(", ")}"`),n},Ls=async(e={})=>{const t=await Os({targets:e.targets}),r=new Dt,i=await ds(),o=null==t?void 0:t.reduce(((e,t)=>{const r=cs(t);return r&&e.push(r),e}),[]);let n=ks(i,{excludeDefault:!0,targets:o});return Xn().addEventListener("devicechange",(async()=>{const e=await ds(),t=n,i=ks(e,{excludeDefault:!0,targets:o});n=i;const s=((e,t)=>{const r=Ps(e),i=Ps(e),o=[];dr().debug("[_getDeviceListDiff] <- oldDevices",e),dr().debug("[_getDeviceListDiff] -> newDevices",t);const n=t.filter((e=>{const t=e.deviceId,n=r.get(t);return n&&(i.delete(t),e.label!==n.label&&o.push(e)),void 0===n}));return{updated:o.map((e=>({type:"updated",payload:e}))),removed:Array.from(i,(([e,t])=>t)).map((e=>({type:"removed",payload:e}))),added:n.map((e=>({type:"added",payload:e})))}})(t,i),a=s.added.length>0,c=s.removed.length>0,d=s.updated.length>0;(a||c||d)&&r.emit("changed",{changes:s,devices:i}),a&&r.emit("added",{changes:s.added,devices:i}),c&&r.emit("removed",{changes:s.removed,devices:i}),d&&r.emit("updated",{changes:s.updated,devices:i})})),r},js=()=>Ls({targets:["microphone"]}),Vs=()=>Ls({targets:["speaker"]}),Ds=()=>Ls({targets:["camera"]}),Ws=e=>"function"==typeof(null==e?void 0:e.getTracks),Ns=async e=>{const t=await(async e=>{if(Ws(e))return e;let t;return t="string"==typeof e?{audio:{deviceId:e}}:{audio:e},gs(t)})(e);if(!t)throw new Error("Failed to get the audio stream");const r=new Dt,i=new(window.AudioContext||window.webkitAudioContext),o=(e=>{const t=e.createAnalyser();return t.fftSize=64,t.minDecibels=-90,t.maxDecibels=-10,t.smoothingTimeConstant=.85,t})(i);let n,s;try{i.createMediaStreamSource(t).connect(o)}catch{throw new Error("No audio track found")}t.getAudioTracks().forEach((e=>{e.addEventListener("ended",(()=>{r.emit("destroyed","disconnected")}))}));const a=()=>{try{const e=new Uint8Array(o.frequencyBinCount);o.getByteFrequencyData(e);const t=e.reduce(((e,t)=>e+t),0)/20;s!==t&&(s=t,r.emit("volumeChanged",Math.min(s,100))),n=requestAnimationFrame(a)}catch{r.emit("destroyed","error")}};n=requestAnimationFrame(a);const c=()=>{n&&cancelAnimationFrame(n),"closed"!==i.state&&i.close().catch((e=>{dr().error("Error closing the AudioContext",e)})),Ws(e)||t.getTracks().forEach((e=>e.stop())),r.emit("destroyed",null),r.removeAllListeners()};return new Proxy(r,{get:(e,t,r)=>"destroy"===t?c:Reflect.get(e,t,r)})},$s=async e=>(await Is()).find((t=>t.deviceId===e||"default"===t.deviceId&&""===e||""===t.deviceId&&"default"===e));var Us,Bs={exports:{}};var zs=(Us||(Us=1,function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const r=t.splitSections(e);return r&&r[0]},t.getMediaSections=function(e){const r=t.splitSections(e);return r.shift(),r},t.matchPrefix=function(e,r){return t.splitLines(e).filter((e=>0===e.indexOf(r)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const r={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let i=8;i<t.length;i+=2)switch(t[i]){case"raddr":r.relatedAddress=t[i+1];break;case"rport":r.relatedPort=parseInt(t[i+1],10);break;case"tcptype":r.tcpType=t[i+1];break;case"ufrag":r.ufrag=t[i+1],r.usernameFragment=t[i+1];break;default:void 0===r[t[i]]&&(r[t[i]]=t[i+1])}return r},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const r=e.component;"rtp"===r?t.push(1):"rtcp"===r?t.push(2):t.push(r),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let r;const i=e.substring(e.indexOf(" ")+1).split(";");for(let o=0;o<i.length;o++)r=i[o].trim().split("="),t[r[0].trim()]=r[1];return t},t.writeFmtp=function(e){let t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const i=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)})),t+="a=fmtp:"+r+" "+i.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),r={ssrc:parseInt(e.substring(7,t),10)},i=e.indexOf(":",t);return i>-1?(r.attribute=e.substring(t+1,i),r.value=e.substring(i+1)):r.attribute=e.substring(t+1),r},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const r=t.matchPrefix(e,"a=mid:")[0];if(r)return r.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,r){return{role:"auto",fingerprints:t.matchPrefix(e+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,r){return t.matchPrefix(e+r,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,r){const i=t.matchPrefix(e+r,"a=ice-ufrag:")[0],o=t.matchPrefix(e+r,"a=ice-pwd:")[0];return i&&o?{usernameFragment:i.substring(12),password:o.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=t.splitLines(e)[0].split(" ");r.profile=i[2];for(let n=3;n<i.length;n++){const o=i[n],s=t.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(s){const i=t.parseRtpMap(s),n=t.matchPrefix(e,"a=fmtp:"+o+" ");switch(i.parameters=n.length?t.parseFmtp(n[0]):{},i.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(t.parseRtcpFb),r.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(i.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach((e=>{r.headerExtensions.push(t.parseExtmap(e))}));const o=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return r.codecs.forEach((e=>{o.forEach((t=>{e.rtcpFeedback.find((e=>e.type===t.type&&e.parameter===t.parameter))||e.rtcpFeedback.push(t)}))})),r},t.writeRtpDescription=function(e,r){let i="";i+="m="+e+" ",i+=r.codecs.length>0?"9":"0",i+=" "+(r.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=r.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",r.codecs.forEach((e=>{i+=t.writeRtpMap(e),i+=t.writeFmtp(e),i+=t.writeRtcpFb(e)}));let o=0;return r.codecs.forEach((e=>{e.maxptime>o&&(o=e.maxptime)})),o>0&&(i+="a=maxptime:"+o+"\r\n"),r.headerExtensions&&r.headerExtensions.forEach((e=>{i+=t.writeExtmap(e)})),i},t.parseRtpEncodingParameters=function(e){const r=[],i=t.parseRtpParameters(e),o=-1!==i.fecMechanisms.indexOf("RED"),n=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),a=s.length>0&&s[0].ssrc;let c;const d=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substring(17).split(" ").map((e=>parseInt(e,10)))));d.length>0&&d[0].length>1&&d[0][0]===a&&(c=d[0][1]),i.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:a,codecPayloadType:parseInt(e.parameters.apt,10)};a&&c&&(t.rtx={ssrc:c}),r.push(t),o&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:a,mechanism:n?"red+ulpfec":"red"},r.push(t))}})),0===r.length&&a&&r.push({ssrc:a});let l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substring(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substring(5),10)*.95-16e3:void 0,r.forEach((e=>{e.maxBitrate=l}))),r},t.parseRtcpParameters=function(e){const r={},i=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];i&&(r.cname=i.value,r.ssrc=i.ssrc);const o=t.matchPrefix(e,"a=rtcp-rsize");r.reducedSize=o.length>0,r.compound=0===o.length;const n=t.matchPrefix(e,"a=rtcp-mux");return r.mux=n.length>0,r},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let r;const i=t.matchPrefix(e,"a=msid:");if(1===i.length)return r=i[0].substring(7).split(" "),{stream:r[0],track:r[1]};const o=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return o.length>0?(r=o[0].value.split(" "),{stream:r[0],track:r[1]}):void 0},t.parseSctpDescription=function(e){const r=t.parseMLine(e),i=t.matchPrefix(e,"a=max-message-size:");let o;i.length>0&&(o=parseInt(i[0].substring(19),10)),isNaN(o)&&(o=65536);const n=t.matchPrefix(e,"a=sctp-port:");if(n.length>0)return{port:parseInt(n[0].substring(12),10),protocol:r.fmt,maxMessageSize:o};const s=t.matchPrefix(e,"a=sctpmap:");if(s.length>0){const e=s[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:o}}},t.writeSctpDescription=function(e,t){let r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,r,i){let o;const n=void 0!==r?r:2;return o=e||t.generateSessionId(),"v=0\r\no="+(i||"thisisadapterortc")+" "+o+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,r){const i=t.splitLines(e);for(let t=0;t<i.length;t++)switch(i[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[t].substring(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const r=t.splitLines(e)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(e){const r=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const r=t.splitLines(e);for(let t=0;t<r.length;t++)if(r[t].length<2||"="!==r[t].charAt(1))return!1;return!0},e.exports=t}(Bs)),Bs.exports);const Hs=n(zs),Fs=e=>/^m=audio/.test(e),qs=e=>/^m=video/.test(e),Ks=e=>e.replace(/\r\n/g,"\n").replace(/\r/g,"\n"),Js=(e,t)=>{const r=Ks(e).split("\n");for(let i of r)if(i.startsWith(`m=${t}`))return!0;return!1},Gs=e=>{const t="\r\n",r=e.split(t),i=r.findIndex((e=>/^a=rtpmap/.test(e)&&/opus\/48000/.test(e)));if(i<0)return e;const o=(e=>{const t=new RegExp("a=rtpmap:(\\d+) \\w+\\/\\d+"),r=e.match(t);return r&&2==r.length?r[1]:null})(r[i]),n=new RegExp(`a=fmtp:${o}`),s=r.findIndex((e=>n.test(e)));return s>=0?/stereo=1;/.test(r[s])||(r[s]+="; stereo=1; sprop-stereo=1"):r[i]+=`${t}a=fmtp:${o} stereo=1; sprop-stereo=1`,r.join(t)},Zs=(e,t)=>{const r=Ks(e).split("\n");let i=!1;const o=["inactive","recvonly","sendonly","sendrecv","stopped"];for(let n of r)if(n.startsWith("m="))i=n.startsWith(`m=${t}`);else if(i&&n.startsWith("a=")){const e=n.substring(2);if(o.includes(e))return e}return i?"sendrecv":"stopped"},Qs=({localSdp:e,remoteSdp:t,media:r})=>{const i=(e=>{switch(e){case"sendrecv":return"sendrecv";case"sendonly":return"recvonly";case"recvonly":return"sendonly";default:return"inactive"}})(Zs(e,r));return Zs(t,r)===i},Xs=e=>{dr().info("RTCService.getUserMedia",e);const{audio:t,video:r}=e;if(t||r)return gs(e)},Ys=e=>{var t;return(null===(t=e.negotiateVideo)||void 0===t||t)&&(!e.remoteSdp||(e=>Js(e,"video"))(e.remoteSdp))},ea=e=>{var t;return(null===(t=e.negotiateAudio)||void 0===t||t)&&(!e.remoteSdp||(e=>Js(e,"audio"))(e.remoteSdp))},ta=async e=>{let t=(e=>{var t;return!!ea(e)&&(null===(t=e.audio)||void 0===t||t)})(e);const{micLabel:r="",micId:i}=e;if(i&&t){const e=await Ms(i,r,"microphone").catch((e=>null));e&&("boolean"==typeof t&&(t={}),t.deviceId={exact:e})}let o=(e=>{var t;return!!Ys(e)&&(null!==(t=e.video)&&void 0!==t?t:!!e.camId)})(e);const{camLabel:n="",camId:s}=e;if(s&&o){const e=await Ms(s,n,"camera").catch((e=>null));e&&("boolean"==typeof o&&(o={}),o.deviceId={exact:e})}return{audio:t,video:o}},ra=(e,t)=>{const{disableUdpIceServers:r=!1}=t,i=e=>{const t="transport=udp";return Array.isArray(e)?e.filter((e=>!e.includes(t))):e.includes(t)?"":e};return e.map((e=>Object.assign(Object.assign({},e),{urls:r?i(e.urls):e.urls})))};class ia{get logger(){return dr()}constructor(e,t){this.call=e,this.type=t,this.uuid=y(),this._negotiating=!1,this._processingRemoteSDP=!1,this._restartingIce=!1,this.logger.debug("New Peer with type:",this.type,"Options:",this.options),this._onIce=this._onIce.bind(this),this._onEndedTrackHandler=this._onEndedTrackHandler.bind(this),this.options.prevCallId&&(this.uuid=this.options.prevCallId),this.options.prevCallId=void 0,this.options.localStream&&rs(this.options.localStream)&&(this._localStream=this.options.localStream),this.rtcConfigPolyfill=this.config}get options(){return this.call.options}get watchMediaPacketsTimeout(){var e;return null!==(e=this.options.watchMediaPacketsTimeout)&&void 0!==e?e:2e3}get isNegotiating(){return this._negotiating}get localStream(){return this._localStream}set localStream(e){this._localStream=e}get remoteStream(){return this._remoteStream}get isOffer(){return"offer"===this.type}get isAnswer(){return"answer"===this.type}get isSimulcast(){return!0===this.options.simulcast}get isSfu(){return!0===this.options.sfu}get localVideoTrack(){const e=this._getSenderByKind("video");return(null==e?void 0:e.track)||null}get localAudioTrack(){const e=this._getSenderByKind("audio");return(null==e?void 0:e.track)||null}get remoteVideoTrack(){const e=this._getReceiverByKind("video");return(null==e?void 0:e.track)||null}get remoteAudioTrack(){const e=this._getReceiverByKind("audio");return(null==e?void 0:e.track)||null}get hasAudioSender(){return!!this._getSenderByKind("audio")}get hasVideoSender(){return!!this._getSenderByKind("video")}get hasAudioReceiver(){return!!this._getReceiverByKind("audio")}get hasVideoReceiver(){return!!this._getReceiverByKind("video")}get config(){const{rtcPeerConfig:e={}}=this.options,t=Object.assign({bundlePolicy:"max-compat",iceServers:ra(this.call.iceServers,{disableUdpIceServers:this.options.disableUdpIceServers}),sdpSemantics:"unified-plan"},e);return this.logger.debug("RTC config",t),t}get localSdp(){var e,t;return null===(t=null===(e=this.instance)||void 0===e?void 0:e.localDescription)||void 0===t?void 0:t.sdp}get remoteSdp(){var e,t;return null===(t=null===(e=this.instance)||void 0===e?void 0:e.remoteDescription)||void 0===t?void 0:t.sdp}get hasIceServers(){if(this.instance){const{iceServers:e=[]}=this.getConfiguration();return!(null==e||!e.length)}return!1}stopTrackSender(e){var t;try{const r=this._getSenderByKind(e);if(!r)return this.logger.info(`There is not a '${e}' sender to stop.`);r.track&&(ss(r.track),null===(t=this._localStream)||void 0===t||t.removeTrack(r.track))}catch(r){this.logger.error("RTCPeer stopTrackSender error",e,r)}}stopTrackReceiver(e){var t;try{const r=this._getReceiverByKind(e);if(!r)return this.logger.info(`There is not a '${e}' receiver to stop.`);r.track&&(ss(r.track),null===(t=this._remoteStream)||void 0===t||t.removeTrack(r.track))}catch(r){this.logger.error("RTCPeer stopTrackReceiver error",e,r)}}async restoreTrackSender(e){var t;try{const r=this._getSenderByKind(e);if(!r)return this.logger.info(`There is not a '${e}' sender to restore.`);if(r.track&&"ended"!==r.track.readyState)return this.logger.info(`There is already an active ${e} track.`);const i=await ta(this.options),o=await Xs({[e]:i[e]});if(o&&rs(o)){const i=o.getTracks().find((t=>t.kind===e));i&&(await r.replaceTrack(i),null===(t=this._localStream)||void 0===t||t.addTrack(i))}}catch(r){this.logger.error("RTCPeer restoreTrackSender error",e,r)}}getDeviceId(e){try{const t=this._getSenderByKind(e);if(!t||!t.track)return null;const{deviceId:r=null}=t.track.getSettings();return r}catch(l){return this.logger.error("RTCPeer getDeviceId error",e,l),null}}getTrackSettings(e){try{const t=this._getSenderByKind(e);return t&&t.track?t.track.getSettings():null}catch(l){return this.logger.error("RTCPeer getTrackSettings error",e,l),null}}getDeviceLabel(e){try{const t=this._getSenderByKind(e);return t&&t.track?t.track.label:null}catch(l){return this.logger.error("RTCPeer getDeviceLabel error",e,l),null}}restartIceWithRelayOnly(){try{if(this.isAnswer)return this.logger.warn("Skip restartIceWithRelayOnly since we need to generate answer");const e=this.getConfiguration();if("relay"===e.iceTransportPolicy)return this.logger.warn("RTCPeer already with iceTransportPolicy relay only");const t=Object.assign(Object.assign({},e),{iceTransportPolicy:"relay"});this.setConfiguration(t),this.restartIce()}catch(d){this.logger.error("restartIceWithRelayOnly",d)}}restartIce(){if(this._negotiating||this._restartingIce)return this.logger.warn("Skip restartIce");this._restartingIce=!0,this.logger.debug("Restart ICE"),this.type="offer",this.instance.restartIce()}triggerResume(){this.logger.info("Probably half-open so force close from client"),this._resumeTimer?this.logger.info('[skipped] Already in "resume" state'):(this.call.emit("media.disconnected"),this.call.emit("media.reconnecting"),this.clearTimers(),this._resumeTimer=setTimeout((()=>{this.logger.warn("Disconnecting due to RECONNECTION_ATTEMPT_TIMEOUT"),this.call.emit("media.disconnected"),this.call.leaveReason="RECONNECTION_ATTEMPT_TIMEOUT",this.call.setState("hangup")}),12e3),this.call._closeWSConnection())}resetNeedResume(){this.clearResumeTimer(),this.options.watchMediaPackets&&this.startWatchMediaPackets()}stopWatchMediaPackets(){this._mediaWatcher&&this._mediaWatcher.stop()}startWatchMediaPackets(){var e;this.stopWatchMediaPackets(),this._mediaWatcher=(e=>{if(!e.hasAudioReceiver&&!e.hasVideoReceiver)return void dr().warn(`Missing receivers to inspect media for RTCPeer "${e.uuid}"`);dr().debug(`Start watching media for RTCPeer "${e.uuid}"`);let t,r=0,i=0,o=!0;const n=()=>{clearTimeout(t)},s=async()=>{var a,c;let d=0,l=0;try{const t=await e.instance.getStats(null),r=null===(a=e.remoteAudioTrack)||void 0===a?void 0:a.id,i=null===(c=e.remoteVideoTrack)||void 0===c?void 0:c.id;t.forEach((e=>{"inbound-rtp"===e.type&&"audio"===e.kind&&e.trackIdentifier===r&&(dr().trace(`audio inbound-rtp: packetsReceived: ${e.packetsReceived} (at ${e.lastPacketReceivedTimestamp})`),d=e.packetsReceived),"inbound-rtp"===e.type&&"video"===e.kind&&e.trackIdentifier===i&&(dr().trace(`video inbound-rtp: packetsReceived: ${e.packetsReceived} (at ${e.lastPacketReceivedTimestamp})`),l=e.packetsReceived)}))}catch(u){dr().warn("getStats error",u)}finally{d&&d<=r&&l&&l<=i?(dr().warn(`audioPacketsReceived: ${d} - previousAudioValue: ${r}`),dr().warn(`videoPacketsReceived: ${l} - previousVideoValue: ${i}`),e.triggerResume()):(r=d??r,i=l??i,n(),o&&"closed"!==e.instance.connectionState&&(t=setTimeout((()=>s()),e.watchMediaPacketsTimeout)))}};return{start:()=>{n(),s()},stop:()=>{o=!1,n()}}})(this),null===(e=this._mediaWatcher)||void 0===e||e.start()}async applyMediaConstraints(e,t){try{const r=this._getSenderByKind(e);if(!r||!r.track)return this.logger.info("No sender to apply constraints",e,t);if("live"===r.track.readyState){const i=Object.assign(Object.assign({},r.track.getConstraints()),t),o=this.getDeviceId(e);o&&!this.options.screenShare&&(i.deviceId={exact:o}),this.logger.info(`Apply ${e} constraints`,this.call.id,i),await r.track.applyConstraints(i)}}catch{this.logger.error("Error applying constraints",e,t)}}_getSenderByKind(e){var t;return null!==(t=this.instance)&&void 0!==t&&t.getSenders?this.instance.getSenders().find((({track:t})=>t&&t.kind===e)):(this.logger.warn("RTCPeerConnection.getSenders() not available."),null)}_getReceiverByKind(e){var t;return null!==(t=this.instance)&&void 0!==t&&t.getReceivers?this.instance.getReceivers().find((({track:t})=>t&&t.kind===e)):(this.logger.warn("RTCPeerConnection.getReceivers() not available."),null)}async startNegotiation(e=!1){var t,r,i;if(this._negotiating)return this.logger.warn("Skip twice onnegotiationneeded!");this._negotiating=!0;try{if((this.options.additionalDevice||this.options.screenShare)&&(null===(r=null===(t=this.instance)||void 0===t?void 0:t.getTransceivers)||void 0===r||r.call(t).forEach((e=>{e.direction="sendonly"}))),this.instance.removeEventListener("icecandidate",this._onIce),this.instance.addEventListener("icecandidate",this._onIce),this.isOffer){this.logger.debug("Trying to generate offer");const e={voiceActivityDetection:!1};this._supportsAddTransceiver()||(e.offerToReceiveAudio=this.options.negotiateAudio,e.offerToReceiveVideo=this.options.negotiateVideo);const t=await this.instance.createOffer(e);await this._setLocalDescription(t)}if(this.isAnswer){this.logger.debug("Trying to generate answer"),await this._setRemoteDescription({sdp:this.options.remoteSdp,type:"offer"});const e=await this.instance.createAnswer({voiceActivityDetection:!1});await this._setLocalDescription(e)}e&&this._sdpReady(),this.logger.info("iceGatheringState",this.instance.iceGatheringState),"gathering"===this.instance.iceGatheringState&&(this._iceTimeout=setTimeout((()=>{this._onIceTimeout()}),this.options.maxIceGatheringTimeout))}catch(o){this.logger.error(`Error creating ${this.type}:`,o),null===(i=this._pendingNegotiationPromise)||void 0===i||i.reject(o)}}onRemoteBye({code:e,message:t}){var r,i;const o={code:e,message:t};null===(r=this._rejectStartMethod)||void 0===r||r.call(this,o),null===(i=this._pendingNegotiationPromise)||void 0===i||i.reject(o),this.stop()}async onRemoteSdp(e){var t,r;if(this._processingRemoteSDP||this.remoteSdp&&this.remoteSdp===e)this.logger.warn("Ignore same remote SDP",e);else try{this._processingRemoteSDP=!0;const r=this.isOffer?"answer":"offer";await this._setRemoteDescription({sdp:e,type:r}),this._processingRemoteSDP=!1,this.isOffer&&(this._resolveStartMethod(),null===(t=this._pendingNegotiationPromise)||void 0===t||t.resolve()),this.resetNeedResume()}catch(i){this.logger.error(`Error handling remote SDP on call ${this.call.id}:`,i),this.call.hangup(),this._rejectStartMethod(i),null===(r=this._pendingNegotiationPromise)||void 0===r||r.reject(i)}}_setupRTCPeerConnection(){this.instance||(this.instance=(e=>new window.RTCPeerConnection(e))(this.config),this._attachListeners())}async start(){return new Promise((async(e,t)=>{var r;this._resolveStartMethod=e,this._rejectStartMethod=t;try{this._localStream=await this._retrieveLocalStream()}catch(o){return this._rejectStartMethod(o),null===(r=this._pendingNegotiationPromise)||void 0===r||r.reject(o),this.call.setState("hangup")}this._setupRTCPeerConnection();let i=!1;if(this._localStream&&rs(this._localStream)){const e=this._localStream.getAudioTracks();this.logger.debug("Local audio tracks: ",e);const t=this._localStream.getVideoTracks();if(this.logger.debug("Local video tracks: ",t),i=!(!e.length&&!t.length),this.isOffer&&this._supportsAddTransceiver()){const r={direction:this.options.negotiateAudio?"sendrecv":"sendonly",streams:[this._localStream]};this.logger.debug("Applying audioTransceiverParams",r),e.forEach((e=>{this.instance.addTransceiver(e,r)}));const i={direction:this.options.negotiateVideo?"sendrecv":"sendonly",streams:[this._localStream]};if(this.isSimulcast){const e=["0","1","2"];i.sendEncodings=e.map((e=>({active:!0,rid:e,scaleResolutionDownBy:6*Number(e)||1})))}if(this.logger.debug("Applying videoTransceiverParams",i),t.forEach((e=>{this.instance.addTransceiver(e,i)})),this.isSfu){const{msStreamsNumber:e=5}=this.options;this.logger.debug("Add ",e,"recvonly MS Streams"),i.direction="recvonly";for(let t=0;t<Number(e);t++)this.instance.addTransceiver("video",i)}}else if("function"==typeof this.instance.addTrack){const r=this._localStream;e.forEach((e=>this.instance.addTrack(e,r))),t.forEach((e=>this.instance.addTrack(e,r)))}else this.instance.addStream(this._localStream)}this.isOffer?(this.options.negotiateAudio&&this._checkMediaToNegotiate("audio"),this.options.negotiateVideo&&this._checkMediaToNegotiate("video"),!this._supportsAddTransceiver()&&!i&&this.startNegotiation()):this.startNegotiation()}))}detachAndStop(){var e;"function"==typeof(null===(e=this.instance)||void 0===e?void 0:e.getTransceivers)&&this.instance.getTransceivers().forEach((e=>{e.sender.track&&e.sender.track.stop(),e.receiver.track&&e.receiver.track.stop()})),this.stop()}stop(){var e,t,r;null===(e=this._localStream)||void 0===e||e.getTracks().forEach((e=>e.stop())),null===(t=this._remoteStream)||void 0===t||t.getTracks().forEach((e=>e.stop())),null===(r=this.instance)||void 0===r||r.close(),this.stopWatchMediaPackets()}_supportsAddTransceiver(){return"function"==typeof this.instance.addTransceiver}_checkMediaToNegotiate(e){if(!this._getSenderByKind(e)&&this._supportsAddTransceiver()){const t=this.instance.addTransceiver(e,{direction:"recvonly"});this.logger.debug("Add transceiver",e,t)}}async _sdpReady(){var e,t;if(clearTimeout(this._iceTimeout),!this.instance.localDescription)return void this.logger.error("Missing localDescription",this.instance);const{sdp:r}=this.instance.localDescription;if(-1===r.indexOf("candidate"))return this.logger.debug("No candidate - retry \n"),void this.startNegotiation(!0);if(!this._sdpIsValid())return this.logger.info("SDP ready but not valid"),void this._onIceTimeout();this.instance.removeEventListener("icecandidate",this._onIce);try{await this.call.onLocalSDPReady(this),this.isAnswer&&(this._resolveStartMethod(),null===(e=this._pendingNegotiationPromise)||void 0===e||e.resolve())}catch(i){this._rejectStartMethod(i),null===(t=this._pendingNegotiationPromise)||void 0===t||t.reject(i)}}_sdpIsValid(){return this.localSdp&&this.hasIceServers?(e=>{try{const t=/typ (?:srflx|prflx|relay)/,r=Hs.getMediaSections(e);for(const e of r)if(!Hs.splitLines(e).some((e=>0===e.indexOf("a=candidate")&&t.test(e))))return!1;return!0}catch(d){return dr().error("Error checking SDP",d),!1}})(this.localSdp):!!this.localSdp}_forceNegotiation(){this.logger.info("Force negotiation again"),this._negotiating=!1,this.startNegotiation()}_onIceTimeout(){var e;if(this._sdpIsValid())return void this._sdpReady();this.logger.info("ICE gathering timeout");const t=this.getConfiguration();if("relay"===t.iceTransportPolicy){this.logger.info('RTCPeer already with "iceTransportPolicy: relay"');const t={code:"ICE_GATHERING_FAILED",message:"Ice gathering timeout"};return this._rejectStartMethod(t),null===(e=this._pendingNegotiationPromise)||void 0===e||e.reject(t),void this.call.setState("destroy")}this.setConfiguration(Object.assign(Object.assign({},t),{iceTransportPolicy:"relay"})),this._forceNegotiation()}_onIce(e){if(this._iceTimeout&&clearTimeout(this._iceTimeout),!e.candidate)return this.instance.removeEventListener("icecandidate",this._onIce),void this._sdpReady();this.logger.debug("RTCPeer Candidate:",e.candidate),"host"===e.candidate.type?this._iceTimeout=setTimeout((()=>{this.instance.removeEventListener("icecandidate",this._onIce),this._onIceTimeout()}),this.options.maxIceGatheringTimeout):this._iceTimeout=setTimeout((()=>{this.instance.removeEventListener("icecandidate",this._onIce),this._sdpReady()}),this.options.iceGatheringTimeout)}_setLocalDescription(e){const{useStereo:t,googleMaxBitrate:r,googleMinBitrate:i,googleStartBitrate:o}=this.options;return e.sdp&&t&&(e.sdp=Gs(e.sdp)),e.sdp&&r&&i&&o&&(e.sdp=((e,t,r,i)=>{const o=e.split("\r\n");return o.forEach(((e,n)=>{/^a=fmtp:\d*/.test(e)?o[n]+=`;x-google-max-bitrate=${t};x-google-min-bitrate=${r};x-google-start-bitrate=${i}`:/^a=mid:(1|video)/.test(e)&&(o[n]+=`\r\nb=AS:${t}`)})),o.join("\r\n")})(e.sdp,r,i,o)),this.instance.setLocalDescription(e)}_setRemoteDescription(e){e.sdp&&this.options.useStereo&&(e.sdp=Gs(e.sdp)),e.sdp&&this.instance.localDescription&&(e.sdp=((e,t)=>{const r="\r\n",i=t.split(r),o=i.findIndex(Fs),n=i.findIndex(qs);if(-1==n||-1==o||o<n)return e;const s=e.split(r),a=s.findIndex(Fs),c=s.findIndex(qs),d=s.slice(a,c),l=s.slice(c,s.length-1);return[...s.slice(0,a),...l,...d,""].join(r)})(e.sdp,this.instance.localDescription.sdp));const t=e;return this.logger.debug("REMOTE SDP \n",`Type: ${e.type}`,"\n\n",e.sdp),this.instance.setRemoteDescription(t)}async _retrieveLocalStream(){if(rs(this.options.localStream))return this.options.localStream;const e=await ta(this.options);return Xs(e)}_attachListeners(){this.instance.addEventListener("signalingstatechange",(()=>{switch(this.logger.debug("signalingState:",this.instance.signalingState),this.instance.signalingState){case"stable":this._negotiating=!1,this._restartingIce=!1,this.resetNeedResume(),"connected"===this.instance.connectionState&&this.emitMediaConnected();break;case"have-local-offer":"complete"===this.instance.iceGatheringState&&this._sdpReady();break;case"closed":delete this.instance;break;default:this._negotiating=!0}})),this.instance.addEventListener("connectionstatechange",(()=>{switch(this.logger.debug("connectionState:",this.instance.connectionState),this.instance.connectionState){case"connecting":this._connectionStateTimer=setTimeout((()=>{this.logger.warn("connectionState timed out"),this.restartIceWithRelayOnly()}),this.options.maxConnectionStateTimeout);break;case"connected":this.clearConnectionStateTimer(),this.emitMediaConnected();break;case"disconnected":this.logger.debug("[test] Prevent reattach!");break;case"failed":this.triggerResume()}})),this.instance.addEventListener("negotiationneeded",(()=>{this.logger.debug("Negotiation needed event"),this.startNegotiation()})),this.instance.addEventListener("iceconnectionstatechange",(()=>{this.logger.debug("iceConnectionState:",this.instance.iceConnectionState)})),this.instance.addEventListener("icegatheringstatechange",(()=>{this.logger.debug("iceGatheringState:",this.instance.iceGatheringState)})),this.instance.addEventListener("track",(e=>{this.call.emit("track",e),this.isSfu,this._remoteStream=e.streams[0]})),this.instance.addEventListener("addstream",(e=>{e.stream&&(this._remoteStream=e.stream)})),this._attachAudioTrackListener(),this._attachVideoTrackListener()}clearTimers(){this.clearResumeTimer(),this.clearWatchMediaPacketsTimer(),this.clearConnectionStateTimer()}clearConnectionStateTimer(){clearTimeout(this._connectionStateTimer)}clearWatchMediaPacketsTimer(){clearTimeout(this._watchMediaPacketsTimer)}clearResumeTimer(){clearTimeout(this._resumeTimer),this._resumeTimer=void 0}emitMediaConnected(){this.call.emit("media.connected")}_onEndedTrackHandler(e){const t=e.target,r="audio"===t.kind?"microphone":"camera";this.call.emit(`${r}.disconnected`,{deviceId:t.id,label:t.label})}_attachAudioTrackListener(){var e;null===(e=this.localStream)||void 0===e||e.getAudioTracks().forEach((e=>{e.addEventListener("ended",this._onEndedTrackHandler)}))}_attachVideoTrackListener(){var e;null===(e=this.localStream)||void 0===e||e.getVideoTracks().forEach((e=>{e.addEventListener("ended",this._onEndedTrackHandler)}))}_detachAudioTrackListener(){var e;null===(e=this.localStream)||void 0===e||e.getAudioTracks().forEach((e=>{e.removeEventListener("ended",this._onEndedTrackHandler)}))}_detachVideoTrackListener(){var e;null===(e=this.localStream)||void 0===e||e.getVideoTracks().forEach((e=>{e.removeEventListener("ended",this._onEndedTrackHandler)}))}setConfiguration(e){var t;this.rtcConfigPolyfill=e,this.instance&&"function"==typeof(null===(t=this.instance)||void 0===t?void 0:t.setConfiguration)&&this.instance.setConfiguration(e)}getConfiguration(){var e;return this.instance&&"function"==typeof(null===(e=this.instance)||void 0===e?void 0:e.getConfiguration)?this.instance.getConfiguration():this.rtcConfigPolyfill||this.config}}"function"==typeof SuppressedError&&SuppressedError;const oa=e=>hr(e.type),na=function*(e){dr().debug("vertoEventWorker started");const{channels:t,instance:r,initialState:i}=e,{swEventChannel:o}=t,{rtcPeerId:n}=i;if(!n)throw new Error("Missing rtcPeerId for roomSubscribedWorker");const s=Ii.createCatchableSaga((function*(e){var t,i;const{id:o,method:s,params:a={}}=e.payload,{callID:c,nodeId:d}=a,l=r.getRTCPeerById(c);if(!l)return void dr().warn(`RTCPeer '${c}' not found for method: '${s}'`,a);const u=r.peer;switch(s){case"verto.media":case"verto.answer":if(l.uuid===(null==u?void 0:u.uuid)){const e="verto.media"===s?"early":"active";r.setState(e)}null!=a&&a.sdp&&l.onRemoteSdp(a.sdp),yield We(Si.upsert({id:null===(t=e.payload.params)||void 0===t?void 0:t.callID,nodeId:null===(i=e.payload.params)||void 0===i?void 0:i.nodeId})),yield $e([r,r.execute],{method:r._getRPCMethod(),params:{message:Fr(o,s),node_id:d}});break;case"verto.bye":yield $e([r,r.onVertoBye],{rtcPeerId:c,byeCause:null==a?void 0:a.cause,byeCauseCode:null==a?void 0:a.causeCode,redirectDestination:null==a?void 0:a.redirectDestination}),yield $e([r,r.execute],{method:r._getRPCMethod(),params:{message:Fr(o,s),node_id:d}});break;case"verto.ping":{const{nodeId:e}=a,t=function(e,t){var r={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(i=Object.getOwnPropertySymbols(e);o<i.length;o++)t.indexOf(i[o])<0&&Object.prototype.propertyIsEnumerable.call(e,i[o])&&(r[i[o]]=e[i[o]])}return r}(a,["nodeId"]);yield $e([r,r.execute],{method:r._getRPCMethod(),params:{message:Hr(t),node_id:e}});break}case"verto.mediaParams":{if(!c||!a.mediaParams){dr().warn("Invalid mediaParams event",a);break}const{audio:e,video:t}=a.mediaParams;l&&t&&l.applyMediaConstraints("video",t),l&&e&&l.applyMediaConstraints("audio",e);break}case"verto.display":r.setActiveRTCPeer(n),r.emit("verto.display",e.payload.params);break;default:return dr().warn(`Unknown Verto method: ${s}`,a)}}),(e=>{dr().error("Verto Error",e)}));for(;;){const e=yield De(o,(e=>{var t;return!!oa(e)&&(null===(t=e.payload.params)||void 0===t?void 0:t.callID)===n}));yield Ue(s,e)}dr().trace("vertoEventWorker ended")},sa=function*(e){dr().debug("roomSubscribedWorker started");const{channels:t,instance:r,initialState:i}=e,{swEventChannel:o}=t,{rtcPeerId:n}=i;if(!n)throw new Error("Missing rtcPeerId for roomSubscribedWorker");const s=yield De(o,(e=>("video.room.subscribed"===e.type||"call.joined"===e.type)&&e.payload.call_id===n)),a=JSON.parse(JSON.stringify(s.payload));r.setActiveRTCPeer(n);const c=s.payload.room_session.id||s.payload.room_session.room_session_id;yield We(Si.upsert({id:s.payload.call_id,roomId:s.payload.room_session.room_id,roomSessionId:c,memberId:s.payload.member_id,previewUrl:s.payload.room_session.preview_url})),r.emit("room.subscribed",s.payload),r.emit("room.joined",aa.call(r,a)),dr().debug("roomSubscribedWorker ended",n)};function aa(e){return["room_session","room"].forEach((t=>{e[t]&&e[t].recordings&&(e[t].recordings=(e[t].recordings||[]).map((t=>{let r=this.instanceMap.get(t.id);return r?r.setPayload({room_id:e.room.room_id,room_session_id:e.room_session.id,recording:t}):r=co.createRoomSessionRecordingObject({store:this.store,payload:{room_id:e.room.room_id,room_session_id:e.room_session.id,recording:t}}),this.instanceMap.set(t.id,r),r}))),e[t]&&e[t].playbacks&&(e[t].playbacks=(e[t].playbacks||[]).map((t=>{let r=this.instanceMap.get(t.id);return r?r.setPayload({room_id:e.room.room_id,room_session_id:e.room_session.id,playback:t}):r=co.createRoomSessionPlaybackObject({store:this.store,payload:{room_id:e.room.room_id,room_session_id:e.room_session.id,playback:t}}),this.instanceMap.set(t.id,r),r}))),e[t]&&e[t].streams&&(e[t].streams=(e[t].streams||[]).map((t=>{let r=this.instanceMap.get(t.id);return r?r.setPayload({room_id:e.room.room_id,room_session_id:e.room_session.id,stream:t}):r=co.createRoomSessionStreamObject({store:this.store,payload:{room_id:e.room.room_id,room_session_id:e.room_session.id,stream:t}}),this.instanceMap.set(t.id,r),r})))})),e}const ca=function*(e){dr().debug("promoteDemoteWorker started");const{channels:t,instance:r,initialState:i}=e,{swEventChannel:o}=t,{rtcPeerId:n}=i;if(!n)throw new Error("Missing rtcPeerId for promoteDemoteWorker");const s=yield De(o,(e=>("video.member.promoted"===e.type||"video.member.demoted"===e.type)&&e.payload.member_id===r.memberId));dr().debug("promoteDemoteWorker:",s.type,s.payload),yield We(gi.updateAuthState(s.payload.authorization));const a=yield He(Zn.getAuthState);if(!a)throw new Error(`Invalid authState for '${s.type}'`);const{audio_allowed:c,video_allowed:d}=a;switch(s.type){case"video.member.promoted":r.updateMediaOptions({audio:"both"===c,video:"both"===d,negotiateAudio:"none"!==c,negotiateVideo:"none"!==d});break;case"video.member.demoted":r.updateMediaOptions({audio:!1,video:!1,negotiateAudio:"none"!==c,negotiateVideo:"none"!==d})}r._triggerNewRTCPeer(),dr().debug("promoteDemoteWorker ended",n)},da=function*(e){dr().debug("sessionAuthWorker started");const{instance:t}=e;switch((yield De([qr.authSuccessAction.type,qr.authErrorAction.type])).type){case qr.authSuccessAction.type:yield $e([t,t.resume]);break;case qr.authErrorAction.type:yield $e([t,t.setState],"hangup")}dr().debug("sessionAuthWorker ended")},la={echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},ua=Object.assign(Object.assign({},la),{noiseSuppression:!1,autoGainControl:!1,googAutoGainControl:!1}),ha={width:{ideal:1280,min:320},height:{ideal:720,min:180},aspectRatio:{ideal:16/9}},ma={destinationNumber:"room",remoteCallerName:"Outbound Call",remoteCallerNumber:"",callerName:"",callerNumber:"",audio:la,video:ha,useStereo:!1,attach:!1,screenShare:!1,additionalDevice:!1,userVariables:{},requestTimeout:1e4,autoApplyMediaParams:!0,iceGatheringTimeout:2e3,maxIceGatheringTimeout:5e3,maxConnectionStateTimeout:3e3,watchMediaPackets:!0,watchMediaPacketsTimeout:2e3};class pa extends Yi{constructor(e){super(e),this.leaveReason=void 0,this.gotEarly=!1,this.state="new",this.prevState="new",this.rtcPeerMap=new Map,this.resuming=!1,this.onVertoBye=e=>{this.logger.debug("onVertoBye",e);const{rtcPeerId:t,byeCause:r="NORMAL_CLEARING",byeCauseCode:i="16",redirectDestination:o}=e;this.cause=String(r),this.causeCode=String(i);const n=this.getRTCPeerById(t);return n?o&&n.localSdp?(this.logger.debug("Redirect Destination to:",o,"for RTCPeer:",n.uuid),void this.executeInvite(n.localSdp,n.uuid,o)):(n.onRemoteBye({code:this.causeCode,message:this.cause}),void(this.activeRTCPeerId===(null==n?void 0:n.uuid)&&(this.logger.debug("onVertoBye go hangup"),this.setState("hangup")))):this.logger.warn("Invalid RTCPeer to hangup",e)},this.options=Object.assign(Object.assign({},ma),e),this._checkDefaultMediaConstraints(),this.setState("new"),this.logger.trace("New Call with Options:",this.options),this._initPeer()}get id(){return this.__uuid}get active(){return"active"===this.state}get trying(){return"trying"===this.state}get memberId(){return this.component.memberId}get previewUrl(){return this.component.previewUrl}get roomId(){return this.component.roomId}get roomSessionId(){return this.component.roomSessionId}get nodeId(){return this.component.nodeId||this.options.nodeId}get callId(){var e;return(null===(e=this.peer)||void 0===e?void 0:e.uuid)||""}get localStream(){var e;return null===(e=this.peer)||void 0===e?void 0:e.localStream}set localStream(e){this.peer&&(this.peer.localStream=e)}get remoteStream(){var e;return null===(e=this.peer)||void 0===e?void 0:e.remoteStream}get iceServers(){var e,t;return null!==(t=null===(e=this.options)||void 0===e?void 0:e.iceServers)&&void 0!==t?t:this.select(Zn.getIceServers)}get component(){return this.select((e=>oo.getComponent(e,this.callId)))||{}}get cameraId(){return this.peer?this.peer.getDeviceId("video"):null}get cameraLabel(){return this.peer?this.peer.getDeviceLabel("video"):null}get microphoneId(){return this.peer?this.peer.getDeviceId("audio"):null}get microphoneLabel(){return this.peer?this.peer.getDeviceLabel("audio"):null}get withAudio(){var e;return!(null===(e=this.peer)||void 0===e||!e.hasAudioReceiver)}get withVideo(){var e;return!(null===(e=this.peer)||void 0===e||!e.hasVideoReceiver)}get localAudioTrack(){return this.peer?this.peer.localAudioTrack:null}get localVideoTrack(){return this.peer?this.peer.localVideoTrack:null}get peer(){return this.getRTCPeerById(this.activeRTCPeerId)}set peer(e){if(e){if(this.logger.debug("Set RTCPeer",e.uuid,e),this.rtcPeerMap.set(e.uuid,e),this.peer&&this.peer.instance&&this.callId!==e.uuid){const e=this.peer.uuid;this.logger.debug(">>> Stop old RTCPeer",e),this.hangup(e).catch(console.error),this.peer.detachAndStop()}this.logger.debug(">>> Replace RTCPeer with",e.uuid),this.activeRTCPeerId=e.uuid}else this.logger.warn("Invalid RTCPeer",e)}emit(e,...t){return super.emit(e,...t)}dialogParams(e){const{destinationNumber:t,attach:r,callerName:i,callerNumber:o,remoteCallerName:n,remoteCallerNumber:s,userVariables:a,screenShare:c,additionalDevice:d,pingSupported:l=!0}=this.options;return{dialogParams:{id:e,destinationNumber:t,attach:r,reattaching:r,callerName:i,callerNumber:o,remoteCallerName:n,remoteCallerNumber:s,userVariables:a,screenShare:c,additionalDevice:d,pingSupported:l,version:1e3}}}getRTCPeerById(e){return this.rtcPeerMap.get(e)}appendRTCPeer(e){return this.rtcPeerMap.set(e.uuid,e)}setActiveRTCPeer(e){this.peer=this.getRTCPeerById(e)}setLocalStream(e){return new Promise((async(t,r)=>{try{if(!this.peer||!this.localStream)return r(new Error("Invalid RTCPeerConnection."));if(!rs(e))return r(new Error("Invalid stream provided."));const i=this.localStream.getAudioTracks(),o=e.getAudioTracks();o.length<=0?this.logger.info("No audio track found in the stream provided. Audio will be unaffected."):(i.forEach((e=>{var t;ss(e),null===(t=this.localStream)||void 0===t||t.removeTrack(e)})),o.forEach((e=>{var t;null===(t=this.localStream)||void 0===t||t.addTrack(e)})));const n=this.localStream.getVideoTracks(),s=e.getVideoTracks();s.length<=0?this.logger.info("No video track found in the stream provided. Video will be unaffected."):(n.forEach((e=>{var t;ss(e),null===(t=this.localStream)||void 0===t||t.removeTrack(e)})),s.forEach((e=>{var t;null===(t=this.localStream)||void 0===t||t.addTrack(e)}))),await this.updateStream(this.localStream),this.logger.debug("setLocalStream done"),t(this.localStream)}catch(i){this.logger.error("setLocalStream",i),r(i)}}))}vertoExecute(e){return this.execute({method:this._getRPCMethod(),params:e})}_getRPCMethod(){const e=this.select(Zn.getAuthState);return e&&Pr(e)?"webrtc.verto":"video.message"}async _triggerNewRTCPeer(){this.logger.debug("_triggerNewRTCPeer Start");try{this.logger.debug("Build a new RTCPeer");const e=this._buildPeer("offer");this.logger.debug("Trigger start for the new RTCPeer!"),await e.start()}catch(d){this.logger.error("Error building new RTCPeer to promote/demote",d)}}updateCamera(e){return this.applyConstraintsAndRefreshStream({video:Object.assign({aspectRatio:16/9},e)})}updateMicrophone(e){return this.applyConstraintsAndRefreshStream({audio:e})}_getTransceiverDirection(e){let t="inactive";return"audio"===e&&(t=this.options.audio&&this.options.negotiateAudio?"sendrecv":this.options.audio&&!this.options.negotiateAudio?"sendonly":!this.options.audio&&this.options.negotiateAudio?"recvonly":"inactive"),"video"===e&&(t=this.options.video&&this.options.negotiateVideo?"sendrecv":this.options.video&&!this.options.negotiateVideo?"sendonly":!this.options.video&&this.options.negotiateVideo?"recvonly":"inactive"),t}manageSendersWithConstraints(e){return!1===e.audio&&(this.logger.info("Switching off the microphone"),this.stopOutboundAudio()),!1===e.video&&(this.logger.info("Switching off the camera"),this.stopOutboundVideo()),e.audio||e.video}updateConstraints(e,{attempt:t=0}={}){return t>1?Promise.reject(new Error("Failed to update constraints")):new Promise((async(r,i)=>{var o;try{if(!this.peer)return i(new Error("Invalid RTCPeerConnection."));if(!Object.keys(e).length)return i(new Error("Invalid audio/video constraints."));if(this.logger.debug("updateConstraints trying constraints",this.__uuid,e),!this.manageSendersWithConstraints(e))return this.logger.debug("Either `video` and `audio` (or both) constraints were set to `false` so their corresponding senders (if any) were stopped"),r();let s,a={};null===(o=this.localStream)||void 0===o||o.getTracks().forEach((t=>{var r;a[t.kind]=t.getConstraints(),void 0!==e[t.kind]&&(this.logger.debug("updateConstraints stop old tracks first?"),this.logger.debug("Track readyState:",t.kind,t.readyState),ss(t),t.stop(),null===(r=this.localStream)||void 0===r||r.removeTrack(t))}));try{this.logger.info("updateConstraints with",e),s=await gs(e)}catch(n){return this.logger.error("Error updating device constraints:",n.name,n.message,n),this.logger.info("Restoring previous constraints",a),await this.updateConstraints(a,{attempt:t+1}),i(n)}this.logger.debug("updateConstraints done"),r(s)}catch(s){this.logger.error("updateConstraints",s),i(s)}}))}async updateStream(e){try{if(!this.peer)throw new Error("Invalid RTCPeerConnection.");const t=this.localVideoTrack,r=this.localAudioTrack;this.logger.debug("updateStream got stream",e),this.localStream||(this.localStream=new MediaStream);const i=e.getTracks();this.logger.debug(`updateStream got ${i.length} tracks`);for(const e of i)this.logger.debug("updateStream apply track: ",e),await this.handleTransceiverForTrack(e),this.emitDeviceUpdatedEvents({newTrack:e,prevAudioTrack:r,prevVideoTrack:t});this.logger.debug("updateStream done")}catch(l){throw this.logger.error("updateStream error",l),l}}async handleTransceiverForTrack(e){var t,r;if(!this.peer)return this.logger.error("Invalid RTCPeerConnection");const i=this.peer.instance.getTransceivers().find((({mid:t,sender:r,receiver:i})=>r.track&&r.track.kind===e.kind?(this.logger.debug("Found transceiver by sender"),!0):i.track&&i.track.kind===e.kind?(this.logger.debug("Found transceiver by receiver"),!0):null===t&&(this.logger.debug("Found disassociated transceiver"),!0)));if(i){this.logger.debug("handleTransceiverForTrack got transceiver",i.currentDirection,i.mid),(null===(t=i.sender.track)||void 0===t?void 0:t.id)!==e.id&&(await i.sender.replaceTrack(e),this.logger.debug(`handleTransceiverForTrack replaceTrack for ${e.kind}`));const r=this._getTransceiverDirection(e.kind);i.direction!==r&&(i.direction=r,this.logger.debug(`handleTransceiverForTrack set direction to ${r}`)),this.replaceOldTrack(e)}else{this.logger.debug("handleTransceiverForTrack no transceiver found; addTransceiver and start dancing!");const t=this._getTransceiverDirection(e.kind);this.peer.type="offer",null===(r=this.localStream)||void 0===r||r.addTrack(e),this.peer.instance.addTransceiver(e,{direction:t,streams:[this.localStream]})}}replaceOldTrack(e){if(!this.peer||!this.localStream)return this.logger.error("Invalid RTCPeerConnection");this.peer._detachAudioTrackListener(),this.peer._detachVideoTrackListener(),this.localStream.getTracks().forEach((t=>{var r;t.kind===e.kind&&t.id!==e.id&&(this.logger.debug("replaceOldTrack stop old track and apply new one"),ss(t),null===(r=this.localStream)||void 0===r||r.removeTrack(t))})),this.localStream.addTrack(e),"audio"===e.kind&&(this.options.micId=e.getSettings().deviceId),"video"===e.kind&&(this.options.camId=e.getSettings().deviceId),this.peer._attachAudioTrackListener(),this.peer._attachVideoTrackListener()}emitDeviceUpdatedEvents({newTrack:e,prevAudioTrack:t,prevVideoTrack:r}){"audio"===e.kind?this.emit("microphone.updated",{previous:{deviceId:null==t?void 0:t.id,label:null==t?void 0:t.label},current:{deviceId:e.id,label:e.label}}):"video"===e.kind&&this.emit("camera.updated",{previous:{deviceId:null==r?void 0:r.id,label:null==r?void 0:r.label},current:{deviceId:e.id,label:e.label}})}async applyConstraintsAndRefreshStream(e){const t=await this.updateConstraints(e);t&&await this.updateStream(t)}runRTCPeerWorkers(e){this.runWorker("vertoEventWorker",{worker:na,initialState:{rtcPeerId:e}}),!this.options.additionalDevice&&!this.options.screenShare&&(this.runWorker("roomSubscribedWorker",{worker:sa,initialState:{rtcPeerId:e}}),this.runWorker("promoteDemoteWorker",{worker:ca,initialState:{rtcPeerId:e}}))}invite(){return new Promise((async(e,t)=>{this.direction="outbound",this.peer=this._buildPeer("offer");try{await this.peer.start(),e(this)}catch(r){this.logger.error("Invite error",r),t(r)}}))}answer(){return new Promise((async(e,t)=>{this.direction="inbound",this.peer||(this.peer=this._buildPeer("answer"));try{await this.peer.start(),e(this)}catch(r){this.logger.error("Answer error",r),t(r)}}))}onLocalSDPReady(e){if(!e.instance.localDescription)throw this.logger.error("Missing localDescription",e),new Error("Invalid RTCPeerConnection localDescription");const{type:t,sdp:r}=e.instance.localDescription,i=this._mungeSDP(r);switch(this.logger.debug("LOCAL SDP \n",`Type: ${t}`,"\n\n",i),t){case"offer":return this._watchSessionAuth(),!this.resuming&&e.instance.remoteDescription?this.executeUpdateMedia(i,e.uuid):this.executeInvite(i,e.uuid);case"answer":return this.executeAnswer(i,e.uuid);default:return this.logger.error(`Unknown SDP type: '${t}' on call ${this.id}`)}}_closeWSConnection(){this._watchSessionAuth(),this.store.dispatch(qr.sessionForceCloseAction())}_watchSessionAuth(){this.sessionAuthTask&&this.sessionAuthTask.cancel(),this.sessionAuthTask=this.runWorker("sessionAuthWorker",{worker:da})}async resume(){var e;if(this.logger.warn(`[resume] Call ${this.id}`),null!==(e=this.peer)&&void 0!==e&&e.instance){const{connectionState:e}=this.peer.instance;this.logger.debug(`[resume] connectionState for ${this.id} is '${e}'`),"closed"!==e&&(this.resuming=!0,this.peer.restartIce())}}async executeInvite(e,t,r){const i=this.getRTCPeerById(t);if(!i||i.instance.remoteDescription&&!this.resuming)throw new Error(`RTCPeer '${t}' already has a remoteDescription. Invalid invite.`);"new"===this.state&&this.setState("requesting");try{const i=this.options.screenShare?{layout:this.options.layout,positions:this.options.positions}:{},o=Wr(Object.assign(Object.assign(Object.assign({},this.dialogParams(t)),i),{sdp:e}));let n=[];n=this.options.screenShare?["video.room.screenshare"]:this.options.additionalDevice?["video.room.additionaldevice"]:this.getSubscriptions(),this.logger.debug("Subscribing to",n);const s=await this.vertoExecute({message:o,callID:t,node_id:r??this.options.nodeId,subscribe:n});this.logger.debug("Invite response",s),this.resuming=!1}catch(o){throw this.setState("hangup"),o}}async executeAnswer(e,t,r){"new"===this.state&&this.setState("answering");try{const i=Br(Object.assign(Object.assign({},this.dialogParams(t)),{sdp:e})),o=await this.vertoExecute({message:i,callID:t,node_id:r??this.options.nodeId,subscribe:this.getSubscriptions()});this.logger.debug("Answer response",o),this.resuming=!1,this.setActiveRTCPeer(t)}catch(i){throw this.setState("hangup"),i}}async executeUpdateMedia(e,t){var r,i;try{const r=$r(Object.assign(Object.assign({},this.dialogParams(t)),{sdp:e,action:"updateMedia"})),i=await this.vertoExecute({message:r,callID:t,node_id:this.nodeId});if(i.sdp||this.logger.error("UpdateMedia invalid SDP answer",i),this.logger.debug("UpdateMedia response",i),!this.peer)return this.logger.error("Invalid RTCPeer to updateMedia");await this.peer.onRemoteSdp(i.sdp)}catch(o){throw this.logger.error("UpdateMedia error",o),null===(i=null===(r=this.peer)||void 0===r?void 0:r._pendingNegotiationPromise)||void 0===i||i.reject(o),o}}async hangup(e){const t=e??this.callId;if(!t)throw new Error("Invalid RTCPeer ID to hangup");try{const e=Nr(this.dialogParams(t));await this.vertoExecute({message:e,callID:t,node_id:this.nodeId})}catch(r){this.logger.error("Hangup error:",r)}finally{if(t!==this.callId)return this.logger.warn("Prevent setState hangup",t,this.callId);this.setState("hangup")}}async hangupAll(){const e=this.callId;if(!e)throw new Error("Invalid RTCPeer ID to hangup");try{const t=Nr(Object.assign({cause:"REJECT_ALL",causeCode:"825"},this.dialogParams(e)));await this.vertoExecute({message:t,callID:e,node_id:this.nodeId})}catch(l){this.logger.error("HangupAll error:",l)}finally{this.setState("hangup")}}async sendDigits(e){const t=this.callId;if(!t)throw new Error("Invalid RTCPeer ID to send DTMF");const r=Ur(Object.assign(Object.assign({},this.dialogParams(t)),{dtmf:e}));await this.vertoExecute({message:r,callID:t,node_id:this.nodeId})}doReinviteWithRelayOnly(){this.peer&&this.active&&this.peer.restartIceWithRelayOnly()}stopOutboundAudio(){this.peer&&this.active&&this.peer.stopTrackSender("audio")}restoreOutboundAudio(){this.peer&&this.active&&this.peer.restoreTrackSender("audio")}stopOutboundVideo(){this.peer&&this.active&&this.peer.stopTrackSender("video")}restoreOutboundVideo(){this.peer&&this.active&&this.peer.restoreTrackSender("video")}setState(e){switch(this.prevState=this.state,this.state=e,this.logger.trace(`Call ${this.id} state change from ${this.prevState} to ${this.state}`),this.emit(this.state,this),e){case"purge":case"destroy":this._finalize();break;case"hangup":this.setState("destroy")}}updateMediaOptions(e){this.logger.debug("updateMediaOptions",Object.assign({},e)),this.options=Object.assign(Object.assign({},this.options),e),this._checkDefaultMediaConstraints()}_mungeSDP(e){return(e=>{const t=/^a=candidate.*.local\ .*/;return e.split("\r\n").filter((e=>!t.test(e))).join("\r\n")})(e)}_checkDefaultMediaConstraints(){!0===this.options.video&&(this.options.video=ha),!0===this.options.audio&&(this.options.audio=this.options.screenShare?ua:la)}_initPeer(){this.options.remoteSdp&&(this.peer=this._buildPeer("answer"))}_buildPeer(e){const t=new ia(this,e);return this.appendRTCPeer(t),this.runRTCPeerWorkers(t.uuid),t}_finalize(){this.rtcPeerMap.forEach((e=>{e.stop()})),this.rtcPeerMap.clear()}_upsertTransceiverByKind(e,t){if(!this.peer)return this.logger.error("Invalid RTCPeerConnection");let r=this.peer.instance.getTransceivers().find((e=>{var r,i;return(null===(r=e.sender.track)||void 0===r?void 0:r.kind)===t||(null===(i=e.receiver.track)||void 0===i?void 0:i.kind)===t}));if(r){if(r.direction===e)return void this.logger.info(`Transceiver ${t} has the same direction "${e}".`);r.direction=e,this.logger.info(`Updated ${t} transceiver to "${e}" mode.`)}else"inactive"!==e&&(this.peer.type="offer",r=this.peer.instance.addTransceiver(t,{direction:e}),this.logger.info(`Added ${t} transceiver in "${e}" mode.`));"stopped"===e||"inactive"===e?(this.peer.stopTrackReceiver(t),this.peer.stopTrackSender(t)):"sendonly"===e?this.peer.stopTrackReceiver(t):"recvonly"===e&&this.peer.stopTrackSender(t)}async updateMedia(e){var t,r,i,o,n,s,a;try{const{audio:s,video:a}=e;if(!this.peer)throw new Error("Invalid RTCPeerConnection");if(null!==(t=this.peer)&&void 0!==t&&t.isNegotiating)throw new Error("The peer is already negotiating the media!");const c=this.peer,d=new Promise(((e,t)=>{c._pendingNegotiationPromise={resolve:e,reject:t}})),l=["sendonly","sendrecv"].includes((null==s?void 0:s.direction)||""),u=["sendonly","sendrecv"].includes((null==a?void 0:a.direction)||""),h=["sendrecv","receive"].includes((null==s?void 0:s.direction)||""),m=["sendrecv","receive"].includes((null==a?void 0:a.direction)||"");if(this.updateMediaOptions(Object.assign(Object.assign(Object.assign(Object.assign({},s&&{audio:null!==(r=null==s?void 0:s.constraints)&&void 0!==r?r:l}),a&&{video:null!==(i=null==a?void 0:a.constraints)&&void 0!==i?i:u}),s&&{negotiateAudio:h}),a&&{negotiateVideo:m})),await this.applyConstraintsAndRefreshStream(Object.assign(Object.assign({},s&&{audio:null!==(o=null==s?void 0:s.constraints)&&void 0!==o?o:l}),a&&{video:null!==(n=null==a?void 0:a.constraints)&&void 0!==n?n:u})),s&&!l&&this._upsertTransceiverByKind(s.direction,"audio"),a&&!u&&this._upsertTransceiverByKind(a.direction,"video"),await this.peer.startNegotiation(),await d,!Qs({localSdp:this.peer.localSdp,remoteSdp:this.peer.remoteSdp,media:"audio"}))throw new Error("The server did not set the audio direction correctly");if(!Qs({localSdp:this.peer.localSdp,remoteSdp:this.peer.remoteSdp,media:"video"}))throw new Error("The server did not set the video direction correctly")}catch(c){throw null===(a=null===(s=this.peer)||void 0===s?void 0:s._pendingNegotiationPromise)||void 0===a||a.reject(c),c}}async setAudioDirection(e){if(!["sendonly","sendrecv","recvonly","inactive"].includes(e))throw new Error("Invalid direction specified");return this.updateMedia({audio:{direction:e}})}async setVideoDirection(e){if(!["sendonly","sendrecv","recvonly","inactive"].includes(e))throw new Error("Invalid direction specified");return this.updateMedia({video:{direction:e}})}}function ga(e){this.message=e}ga.prototype=new Error,ga.prototype.name="InvalidCharacterError";var va=typeof window<"u"&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new ga("'atob' failed: The string to be decoded is not correctly encoded.");for(var r,i,o=0,n=0,s="";i=t.charAt(n++);~i&&(r=o%4?64*r+i:i,o++%4)?s+=String.fromCharCode(255&r>>(-2*o&6)):0)i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(i);return s};function fa(e){this.message=e}function ya(e,t){if("string"!=typeof e)throw new fa("Invalid token specified");var r=!0===(t=t||{}).header?0:1;try{return JSON.parse(function(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(va(e).replace(/(.)/g,(function(e,t){var r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r})))}(t)}catch{return va(t)}}(e.split(".")[r]))}catch(i){throw new fa("Invalid token specified: "+i.message)}}fa.prototype=new Error,fa.prototype.name="InvalidTokenError";var ba=Object.defineProperty,_a=Object.defineProperties,wa=Object.getOwnPropertyDescriptors,ka=Object.getOwnPropertySymbols,Sa=Object.prototype.hasOwnProperty,Ca=Object.prototype.propertyIsEnumerable,Ea=(e,t,r)=>t in e?ba(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,Ia=(e,t)=>{for(var r in t||(t={}))Sa.call(t,r)&&Ea(e,r,t[r]);if(ka)for(var r of ka(t))Ca.call(t,r)&&Ea(e,r,t[r]);return e},Ma=(e,t)=>_a(e,wa(t)),Pa=(e,t)=>{var r={};for(var i in e)Sa.call(e,i)&&t.indexOf(i)<0&&(r[i]=e[i]);if(null!=e&&ka)for(var i of ka(e))t.indexOf(i)<0&&Ca.call(e,i)&&(r[i]=e[i]);return r},Ta=(e,t)=>{for(var r in t)ba(e,r,{get:t[r],enumerable:!0})},xa=(e,t,r)=>Ea(e,"symbol"!=typeof t?t+"":t,r);Ta({},{ChatMember:()=>xn,ChatMessage:()=>Tn,Client:()=>Kc});var Aa=qr.createAction("swJs/audioSetSpeakerAction"),Ra=({speakerId:e})=>function*({instance:t,runSaga:r}){if(typeof Audio>"u")dr().warn("`Audio` is not supported on this environment.");else try{const i=t.getAudioEl();let o;const n=function(n){if("audio"===n.track.kind)o=r(La,{track:n.track,element:i,speakerId:e,room:t})};t.on("track",n),t.once("destroy",(()=>{null==o||o.cancel()}))}catch(i){dr().error("audioElementSaga",i)}};function*Oa({element:e,room:t}){const r=qr.getCustomSagaActionType(t.__uuid,Aa);for(;;){const o=yield De([r]);try{if(o.type===r){const r=yield $e(os,e,o.payload);t.emit(`${Yt}.speaker.updated`,o.payload),t.settleCustomSagaTrigger({dispatchId:o.dispatchId,payload:r,kind:"resolve"})}}catch(i){t.settleCustomSagaTrigger({dispatchId:o.dispatchId,payload:i,kind:"reject"}),dr().error(i)}}}function*La({track:e,element:t,speakerId:r,room:i}){(({track:e,element:t})=>{t.autoplay=!0,t.playsinline=!0,t.srcObject=new MediaStream([e]),e.addEventListener("ended",(()=>{t.srcObject=null,t.remove()}))})({track:e,element:t}),r&&os(t,r).catch((()=>{})),yield Ue(Oa,{element:t,room:i})}var ja=function*(e){dr().trace("videoManagerRoomsWorker started");const{instance:t,action:{type:r,payload:i}}=e,o={rooms:i.rooms.map((e=>vr(e)))};t.emit(wr(r),o),dr().trace("videoManagerRoomsWorker ended")},Va=function*(e){dr().trace("videoManagerRoomWorker started");const{instance:t,action:{type:r,payload:i}}=e;t.emit(wr(r),vr(i)),dr().trace("videoManagerRoomWorker ended")},Da=function*(e){dr().trace("videoManagerWorker started");const{channels:{swEventChannel:t}}=e;function*r(t){const{type:r}=t;switch(r){case"video-manager.rooms.subscribed":yield Ue(ja,Ia({action:t},e));break;case"video-manager.room.added":case"video-manager.room.deleted":case"video-manager.room.ended":case"video-manager.room.started":case"video-manager.room.updated":yield Ue(Va,Ia({action:t},e));break;default:dr().warn(`Unknown video-manager event: "${r}"`)}}for(;;){const e=yield De(t,(e=>e.type.startsWith("video-manager.")));yield Ue(r,e)}dr().trace("videoManagerWorker ended")},Wa=class extends to{constructor(e){super(e),this.runWorker("videoManagerWorker",{worker:Da})}getSubscriptions(){const e=this.eventNames().map((e=>`video-manager.${e}`));return Ir(e)}},Na={echoCancellation:!0,noiseSuppression:!1,autoGainControl:!1,googAutoGainControl:!1},$a="sw-sdk-",Ua="sw-overlay-",Ba=e=>`${Ua}${e}`,za=_r(class extends pa{join(){return super.invite()}leave(){return super.hangup()}},{audioMute:co.audioMuteMember,audioUnmute:co.audioUnmuteMember,videoMute:co.videoMuteMember,videoUnmute:co.videoUnmuteMember,setMicrophoneVolume:co.setInputVolumeMember,setInputVolume:co.setInputVolumeMember,setInputSensitivity:co.setInputSensitivityMember}),Ha=()=>{},Fa="memberList.updated",qa=(({event:e,namespace:t})=>("string"==typeof e&&(e=(e=>e.replace(lr,(e=>`_${e.toLowerCase()}`)))(e=yr({event:e,namespace:t}))),e))({event:Fa}),Ka=(e=>{const t=e.split(".")[0];return e.split(".").reduce(((e,r)=>(e.push(r),r===t&&e.push(er),e)),[]).join(".")})(qa),Ja=["video.room.joined","video.member.joined","video.member.left","video.member.updated"],Ga=e=>Ja.includes(e),Za=(e,t)=>{(e=>Ir(Ja).filter((t=>!e.includes(t))))(t).forEach((t=>{e.once(t,Ha)}));const r=({members:t})=>{e.emit(Fa,{members:t})};return e.on(Ka,r),{cleanup:()=>{e.off(Ka,r)}}};function*Qa({swEventChannel:e,instance:t}){const r=new Map;function*i(e){const i="video.room.joined"===e.type?e.payload.room_session.id:e.payload.room_session_id,o=(({action:e,memberList:t})=>{const r=(e=>"video.room.joined"===e.type?e.payload.room_session.members:[e.payload.member])(e);"video.member.left"===e.type?r.forEach((e=>{t.delete(e.id)})):r.forEach((e=>{t.set(e.id,e)}));return Array.from(t.values())})({action:e,memberList:r}),n={room_session_id:i,members:o};t.emit(Ka,n)}for(;;){const t=yield De(e,(({type:e})=>Ga(e)));yield Ue(i,t)}}var Xa=function*({channels:{swEventChannel:e},instance:t}){const r=t.getSubscriptions();if(!(e=>e.some((e=>e.includes(Fa))))(r))return;const{cleanup:i}=Za(t,r);yield Ue(Qa,{swEventChannel:e,instance:t}),t.once("destroy",(()=>{i()}))},Ya=function*(e){dr().trace("childMemberJoinedWorker started");const{channels:t,instance:r,initialState:i,onDone:o,onFail:n}=e,{swEventChannel:s}=t,{parentId:a}=i;if(!a)throw new Error("Missing parentId for childMemberJoinedWorker");const c=yield De(s,(e=>"video.member.joined"===e.type&&e.payload.member.parent_id===a)),{member:d}=c.payload;if(null!=d&&d.parent_id){const e=yield He(oo.getComponentsById);Object.values(e).find((e=>"memberId"in e&&e.memberId===d.parent_id))?(yield We(Si.upsert({id:r.callId,roomId:c.payload.room_id,roomSessionId:c.payload.room_session_id,memberId:d.id})),null==o||o()):null==n||n({error:new Error("Unknown parent_id")})}dr().trace("childMemberJoinedWorker ended")},ec=function*(e){dr().trace("videoStreamWorker started");const{instance:t,action:{type:r,payload:i},instanceMap:{get:o,set:n,remove:s}}=e;let a=o(i.stream.id);switch(a?a.setPayload(i):a=co.createRoomSessionStreamObject({store:t.store,payload:i}),n(i.stream.id,a),r){case"video.stream.started":t.emit("stream.started",a);break;case"video.stream.ended":t.emit("stream.ended",a),s(i.stream.id);break;default:dr().warn(`Unknown video.stream event: "${r}"`)}dr().trace("videoStreamWorker ended")},tc=function*(e){dr().trace("videoRecordWorker started");const{instance:t,action:{type:r,payload:i},instanceMap:{get:o,set:n,remove:s}}=e;let a=o(i.recording.id);a?a.setPayload(i):a=co.createRoomSessionRecordingObject({store:t.store,payload:i}),n(i.recording.id,a);const c=wr(r);switch(r){case"video.recording.started":case"video.recording.updated":t.emit(c,a);break;case"video.recording.ended":t.emit(c,a),s(i.recording.id);break;default:dr().warn(`Unknown video.stream event: "${r}"`)}dr().trace("videoRecordWorker ended")},rc=function*(e){dr().trace("videoPlaybackWorker started");const{instance:t,action:{type:r,payload:i},instanceMap:{get:o,set:n,remove:s}}=e;let a=o(i.playback.id);a?a.setPayload(i):a=co.createRoomSessionPlaybackObject({store:t.store,payload:i}),n(i.playback.id,a);const c=wr(r);switch(r){case"video.playback.started":case"video.playback.updated":t.emit(c,a);break;case"video.playback.ended":t.emit(c,a),s(i.playback.id);break;default:dr().warn(`Unknown video.stream event: "${r}"`)}dr().trace("videoPlaybackWorker ended")},ic=function*(e){dr().trace("videoWorker started");const{channels:t,instance:r}=e,{swEventChannel:i}=t;function*o(t){const{type:i,payload:o}=t;switch(i){case"video.room.subscribed":return void(yield Ue(Ln.memberPositionWorker,Ma(Ia({},e),{instance:r,initialState:o})));case"video.playback.started":case"video.playback.updated":case"video.playback.ended":return void(yield Ue(rc,Ia({action:t},e)));case"video.recording.started":case"video.recording.updated":case"video.recording.ended":return void(yield Ue(tc,Ia({action:t},e)));case"video.stream.ended":case"video.stream.started":return void(yield Ue(ec,Ia({action:t},e)));case"video.room.audience_count":return void r.emit("room.audienceCount",o);case"video.member.talking":{const{member:e}=o;if("talking"in e){const t=e.talking?"started":"ended";r.emit(`member.talking.${t}`,o);const i=e.talking?"start":"stop";r.emit(`member.talking.${i}`,o)}break}case"video.layout.changed":r.currentLayoutEvent=t.payload}const n=wr(i,"video");r.emit(n,o)}const n=e=>e.type.startsWith("video.");for(;;){const e=yield De(i,n);yield Ue(o,e)}dr().trace("videoWorker ended")},oc=class extends pa{constructor(){super(...arguments),xa(this,"_screenShareList",new Set),xa(this,"_audioEl"),xa(this,"_overlayMap"),xa(this,"_localVideoOverlay")}get audioEl(){return this._audioEl}set overlayMap(e){this._overlayMap=e}get overlayMap(){return this._overlayMap}set localVideoOverlay(e){this._localVideoOverlay=e}get localVideoOverlay(){return this._localVideoOverlay}get screenShareList(){return Array.from(this._screenShareList)}_attachSpeakerTrackListener(){is()&&Vs().then((e=>{e.on("removed",(async e=>{var t,r;const i=this._audioEl.sinkId,o=e.changes.find((e=>{const t=e.payload.deviceId;return t===i||""===t&&"default"===i||"default"===t&&""===i}));if(o){this.emit("speaker.disconnected",{deviceId:o.payload.deviceId,label:o.payload.label}),await(null==(r=(t=this._audioEl).setSinkId)?void 0:r.call(t,""));const e=await $s("default");if(null==e||!e.deviceId)return;this.emit("speaker.updated",{previous:{deviceId:o.payload.deviceId,label:o.payload.label},current:{deviceId:e.deviceId,label:e.label}})}}))}))}_finalize(){this._screenShareList.clear(),super._finalize()}async hangup(e){return this._screenShareList.forEach((e=>{e.leave()})),super.hangup(e)}leave(){return this.hangup()}attachPreConnectWorkers(){this.runWorker("memberListUpdated",{worker:Xa})}getAudioEl(){return this._audioEl||(this._audioEl=new Audio,this._attachSpeakerTrackListener()),this._audioEl}getMemberOverlay(e){return this.overlayMap.get(Ba(e))}async startScreenShare(e={}){return new Promise((async(t,r)=>{var i;const{autoJoin:o=!0,audio:n=!1,video:s=!0,layout:a,positions:c}=e;try{const e=await vs({audio:!0===n?Na:n,video:s}),d=Ma(Ia({},this.options),{screenShare:!0,recoverCall:!1,localStream:e,remoteStream:void 0,userVariables:Ma(Ia({},(null==(i=this.options)?void 0:i.userVariables)||{}),{memberCallId:this.callId,memberId:this.memberId}),layout:a,positions:c}),l=Ki({store:this.store,Component:za})(d);return e.getVideoTracks().forEach((e=>{e.addEventListener("ended",(()=>{l&&l.active&&l.leave()}))})),l.once("destroy",(()=>{l.emit("room.left"),this._screenShareList.delete(l)})),l.runWorker("childMemberJoinedWorker",{worker:Ya,onDone:()=>t(l),onFail:r,initialState:{parentId:this.memberId}}),this._screenShareList.add(l),o?await l.join():t(l)}catch(d){this.logger.error("ScreenShare Error",d),r(d)}}))}updateSpeaker({deviceId:e}){const t=this.audioEl.sinkId;return this.once(`${Yt}.speaker.updated`,(async e=>{const r=await $s(t),i=await $s(e),o=(null==i?void 0:i.deviceId)===(null==r?void 0:r.deviceId);null==i||!i.deviceId||o||this.emit("speaker.updated",{previous:{deviceId:null==r?void 0:r.deviceId,label:null==r?void 0:r.label},current:{deviceId:i.deviceId,label:i.label}})})),this.triggerCustomSaga(Aa(e))}},nc=_r(class extends pa{join(){return super.invite()}leave(){return super.hangup()}},{audioMute:co.audioMuteMember,audioUnmute:co.audioUnmuteMember,videoMute:co.videoMuteMember,videoUnmute:co.videoUnmuteMember,setInputVolume:co.setInputVolumeMember,setMicrophoneVolume:co.setInputVolumeMember,setInputSensitivity:co.setInputSensitivityMember}),sc=class extends oc{constructor(e){super(e),xa(this,"_deviceList",new Set),xa(this,"_currentLayoutEvent"),this.initWorker()}set currentLayoutEvent(e){this._currentLayoutEvent=e}get currentLayoutEvent(){return this._currentLayoutEvent}get currentLayout(){var e;return null==(e=this._currentLayoutEvent)?void 0:e.layout}get currentPosition(){var e,t;return null==(t=null==(e=this._currentLayoutEvent)?void 0:e.layout.layers.find((e=>e.member_id===this.memberId)))?void 0:t.position}get deviceList(){return Array.from(this._deviceList)}get interactivityMode(){return this.select((({session:e})=>{var t;const{authState:r}=e;return null!=(t=null==r?void 0:r.join_as)?t:""}))}get permissions(){return this.select((({session:e})=>{var t,r;const{authState:i}=e;return null!=(r=null==(t=null==i?void 0:i.room)?void 0:t.scopes)?r:[]}))}initWorker(){this.runWorker("videoWorker",{worker:ic})}getSubscriptions(){const e=this.eventNames().map((e=>`video.${String(e)}`));return Ir(e)}_finalize(){this._deviceList.clear(),super._finalize()}async hangup(e){return this._deviceList.forEach((e=>{e.leave()})),super.hangup(e)}join(){return super.invite()}getLayoutList(){return this.getLayouts()}getMemberList(){return this.getMembers()}async createScreenShareObject(e={}){return this.startScreenShare(e)}addCamera(e={}){const t=e,{autoJoin:r=!0}=t,i=Pa(t,["autoJoin"]);return this.addDevice({autoJoin:r,video:i})}addMicrophone(e={}){const t=e,{autoJoin:r=!0}=t,i=Pa(t,["autoJoin"]);return this.addDevice({autoJoin:r,audio:i})}async addDevice(e={}){return new Promise((async(t,r)=>{var i;const{autoJoin:o=!0,audio:n=!1,video:s=!1}=e;if(!n&&!s)throw new TypeError("At least one of `audio` or `video` must be requested.");const a=Ma(Ia({},this.options),{localStream:void 0,remoteStream:void 0,audio:n,video:s,additionalDevice:!0,recoverCall:!1,userVariables:Ma(Ia({},(null==(i=this.options)?void 0:i.userVariables)||{}),{memberCallId:this.callId,memberId:this.memberId})}),c=Ki({store:this.store,Component:nc})(a);c.once("destroy",(()=>{c.emit("room.left"),this._deviceList.delete(c)}));try{return c.runWorker("childMemberJoinedWorker",{worker:Ya,onDone:()=>t(c),onFail:r,initialState:{parentId:this.memberId}}),this._deviceList.add(c),o?await c.join():t(c)}catch(d){this.logger.error("RoomDevice Error",d),r(d)}}))}},ac=_r(sc,{audioMute:co.audioMuteMember,audioUnmute:co.audioUnmuteMember,videoMute:co.videoMuteMember,videoUnmute:co.videoUnmuteMember,deaf:co.deafMember,undeaf:co.undeafMember,setInputVolume:co.setInputVolumeMember,setOutputVolume:co.setOutputVolumeMember,setMicrophoneVolume:co.setInputVolumeMember,setSpeakerVolume:co.setOutputVolumeMember,setInputSensitivity:co.setInputSensitivityMember,removeMember:co.removeMember,removeAllMembers:co.removeAllMembers,getMembers:co.getMembers,getLayouts:co.getLayouts,setLayout:co.setLayout,setPositions:co.setPositions,setMemberPosition:co.setMemberPosition,hideVideoMuted:co.hideVideoMuted,showVideoMuted:co.showVideoMuted,getRecordings:co.getRecordings,startRecording:co.startRecording,getPlaybacks:co.getPlaybacks,play:co.play,setHideVideoMuted:co.setHideVideoMuted,getMeta:co.getMeta,setMeta:co.setMeta,updateMeta:co.updateMeta,deleteMeta:co.deleteMeta,getMemberMeta:co.getMemberMeta,setMemberMeta:co.setMemberMeta,updateMemberMeta:co.updateMemberMeta,deleteMemberMeta:co.deleteMemberMeta,promote:co.promote,demote:co.demote,getStreams:co.getStreams,startStream:co.startStream,lock:co.lock,unlock:co.unlock,setRaisedHand:co.setRaisedHand,setPrioritizeHandraise:co.setPrioritizeHandraise}),cc=e=>e instanceof sc,dc=()=>{if(window&&window.sessionStorage)return window.sessionStorage},lc=e=>{var t;let r="";try{const i=ya(e);r=null!=(t=null==i?void 0:i.r)?t:""}catch{try{r=ya(e,{header:!0}).typ||""}catch{r=""}}const i=!!r;return{authStateKey:i&&`as-${r}`,protocolKey:i&&`pt-${r}`,callIdKey:i&&`ci-${r}`}},uc="ci-SAT",hc=function*(e){dr().debug("wsClientWorker started");const{channels:t,initialState:r,instance:i}=e,{swEventChannel:o}=t,{handleIncomingInvite:n}=r;function*s(e){i.emit(e.type,e.payload)}function*a(e){n(e.payload.params)}const c=e=>"webrtc.message"===e.type&&"verto.invite"===e.payload.method;try{for(;;){const e=yield De(o,(()=>!0));yield Ue(s,e),c(e)&&(dr().debug("Receiving a call over WebSocket",e),yield Ue(a,e))}}finally{dr().trace("wsClientWorker ended")}},mc=function*(e){dr().debug("conversationWorker started");const{channels:{swEventChannel:t},initialState:r}=e,{conversation:i}=r,o=e=>e.type.startsWith("conversation.");for(;;){const e=yield De(t,o);i.handleEvent(e.payload)}dr().trace("conversationWorker ended")},pc=class extends Yi{constructor(e){super(e),xa(this,"_payload"),this._payload=e.payload}get id(){return this._payload.member.member_id}get callId(){return this._payload.member.call_id}get nodeId(){return this._payload.member.node_id}get memberId(){return this.id}get roomSessionId(){return this._payload.room_session_id}get roomId(){return this._payload.room_id}get parentId(){return this._payload.member.parent_id}get name(){return this._payload.member.name}get type(){return this._payload.member.type}get requestedPosition(){return this._payload.member.requested_position}get currentPosition(){return this._payload.member.current_position}get meta(){return this._payload.member.meta}get handraised(){return this._payload.member.handraised}get talking(){return this._payload.member.talking}get audioMuted(){return this._payload.member.audio_muted}get videoMuted(){return this._payload.member.video_muted}get deaf(){return this._payload.member.deaf}get visible(){return this._payload.member.visible}get inputVolume(){return this._payload.member.input_volume}get outputVolume(){return this._payload.member.output_volume}get inputSensitivity(){return this._payload.member.input_sensitivity}get subscriberData(){return this._payload.member.subscriber_data}setPayload(e){const t=Ma(Ia(Ia({},this._payload),e),{member:Ia(Ia({},this._payload.member),e.member)});this._payload=t}},gc=e=>Ki({store:e.store,Component:pc})(e),vc=function*(e){dr().trace("callLeftWorker started");const{action:{payload:t},instance:r,instanceMap:i}=e,{room_session_id:o}=t;i.getAll().forEach((([e,t])=>{t instanceof pc&&t.roomSessionId===o&&i.remove(e)})),r.emit("call.left",t),r.emit("room.left",t),dr().trace("callLeftWorker ended")},fc=function*(e){dr().trace("fabricMemberWorker started");const{instance:t,action:{type:r,payload:i},instanceMap:{get:o,set:n,remove:s}}=e,a=i.member.member_id;let c=o(a);if(!c&&"member.talking"!==r&&(c=gc({store:t.store,payload:i})),c&&c.setPayload(i),n(a,c),r.startsWith("member.updated.")){const e=fr(r);t.emit(e,i)}switch(r){case"member.joined":case"member.updated":case"member.talking":t.emit(r,i);break;case"member.left":t.emit(r,i),s(a)}dr().trace("fabricMemberWorker ended")},yc=e=>({id:e.member_id,room_id:e.room_id,room_session_id:e.room_session_id,name:e.name,type:e.type,handraised:e.handraised,visible:e.visible,audio_muted:e.audio_muted,video_muted:e.video_muted,deaf:e.deaf,input_volume:e.input_volume,output_volume:e.output_volume,input_sensitivity:e.input_sensitivity,meta:e.meta,talking:e.talking,current_position:e.current_position,requested_position:e.requested_position,parent_id:e.parent_id}),bc=e=>Ma(Ia({},yc(e)),{updated:e.updated.map((e=>"member_id"===e?"id":e))}),_c=e=>({room_id:e.room_id,room_session_id:e.room_session_id,event_channel:e.event_channel,name:e.name,recording:e.recording,hide_video_muted:e.hide_video_muted,preview_url:e.preview_url,recordings:e.recordings,playbacks:e.playbacks,streams:e.streams,prioritize_handraise:e.prioritize_handraise}),wc=e=>({id:e.id,display_name:e.display_name,room_id:e.room_id,room_session_id:e.room_session_id,event_channel:e.event_channel,name:e.name,recording:e.recording,recordings:e.recordings,playbacks:e.playbacks,hide_video_muted:e.hide_video_muted,preview_url:e.preview_url,layout_name:e.layout_name,locked:e.locked,meta:e.meta,members:e.members.map(yc),streaming:e.streaming,streams:e.streams,prioritize_handraise:e.prioritize_handraise,updated:e.updated}),kc=e=>({call_id:e.call_id,member_id:e.member_id,room:Ma(Ia({},_c(e.room_session)),{members:e.room_session.members.map(yc)}),room_session:Ma(Ia({},wc(e.room_session)),{members:e.room_session.members.map(yc)})}),Sc=e=>({room_session_id:e.room_session_id,room_id:e.room_id,member:yc(e.member)}),Cc=e=>({room_session_id:e.room_session_id,room_id:e.room_id,member:bc(e.member)}),Ec=class{constructor(e){this._flags=e}get on(){return this._flags.some((e=>!e.endsWith(".off")))}get off(){return this._flags.some((e=>!e.endsWith(".on")))}},Ic=class{constructor(e,t){this._flags=e,this._memberType=t,xa(this,"_muteAudio"),xa(this,"_muteVideo"),xa(this,"_deaf")}get muteAudio(){var e;return this._muteAudio=null!=(e=this._muteAudio)?e:new Ec(this._flags.filter((e=>e===this._memberType||e===`${this._memberType}.mute`||e.startsWith(`${this._memberType}.mute.audio`)))),this._muteAudio}get muteVideo(){var e;return this._muteVideo=null!=(e=this._muteVideo)?e:new Ec(this._flags.filter((e=>e===this._memberType||e===`${this._memberType}.mute`||e.startsWith(`${this._memberType}.mute.video`)))),this._muteVideo}get microphoneVolume(){return this._flags.some((e=>e===this._memberType||e===`${this._memberType}.microphone`||e.startsWith(`${this._memberType}.microphone.volume`)))}get microphoneSensitivity(){return this._flags.some((e=>e===this._memberType||e===`${this._memberType}.microphone`||e.startsWith(`${this._memberType}.microphone.sensitivity`)))}get speakerVolume(){return this._flags.some((e=>e===this._memberType||e===`${this._memberType}.speaker`||e.startsWith(`${this._memberType}.speaker.volume`)))}get deaf(){var e;return this._deaf=null!=(e=this._deaf)?e:new Ec(this._flags.filter((e=>e===this._memberType||e.startsWith(`${this._memberType}.deaf`)))),this._deaf}get raisehand(){return{on:!0,off:!0}}get position(){return this._flags.some((e=>e===this._memberType||e.startsWith(`${this._memberType}.position`)))}get meta(){return this._flags.some((e=>e===this._memberType||e.startsWith(`${this._memberType}.meta`)))}get remove(){return this._flags.some((e=>e===this._memberType||e.startsWith(`${this._memberType}.remove`)))}},Mc=class{constructor(e){this._flags=e,xa(this,"_self"),xa(this,"_member"),xa(this,"_vmutedHide"),xa(this,"_lock")}_buildMemberCapability(e){return new Ic(this._flags.filter((t=>t.startsWith(e))),e)}get self(){var e;return this._self=null!=(e=this._self)?e:this._buildMemberCapability("self"),this._self}get member(){var e;return this._member=null!=(e=this._member)?e:this._buildMemberCapability("member"),this._member}get end(){return this._flags.some((e=>"end"===e))}get setLayout(){return this._flags.some((e=>e.startsWith("layout")))}get sendDigit(){return this._flags.some((e=>e.startsWith("digit")))}get vmutedHide(){var e;return this._vmutedHide=null!=(e=this._vmutedHide)?e:new Ec(this._flags.filter((e=>e.startsWith("vmuted")))),this._vmutedHide}get lock(){var e;return this._lock=null!=(e=this._lock)?e:new Ec(this._flags.filter((e=>e.startsWith("lock")))),this._lock}get device(){return this._flags.some((e=>"device"===e))}get screenshare(){return this._flags.some((e=>"screenshare"===e))}},Pc=function*(e){var t;dr().trace("callJoinWorker started");const{action:r,instanceMap:i,instance:o}=e,{payload:n}=r,{get:s,set:a}=i;yield Ue(Ln.memberPositionWorker,Ma(Ia({},e),{initialState:kc(n),dispatcher:function*(t,r){const i=wr(t,"video"),o=Ma(Ia({},r),{member:Ma(Ia({},r.member),{member_id:r.member.id})});yield Ue(fc,Ma(Ia({},e),{action:{type:i,payload:o}}))}})),null==(t=n.room_session.members)||t.forEach((e=>{let t=s(e.member_id);t?t.setPayload({member:e,room_id:n.room_id,room_session_id:n.room_session_id}):t=gc({store:o.store,payload:{member:e,room_id:n.room_id,room_session_id:n.room_session_id}}),a(e.member_id,t)})),o.member=s(n.member_id),o.capabilities=(e=>new Mc(e))(n.capabilities);const c=Ma(Ia({},n),{capabilities:o.capabilities});o.emit("call.joined",c),dr().trace("callJoinWorker ended")},Tc=function*(e){const{action:t,channels:{swEventChannel:r},instance:i}=e,o=t.payload.call_id,n=t.payload.room_session_id;function*s(t){const{type:o,payload:n}=t;switch(o){case"call.joined":break;case"call.left":return yield $e(vc,Ma(Ia({},e),{action:t})),!0;case"call.updated":i.emit(o,n),i.emit("room.updated",n);break;case"call.play":case"call.connect":case"call.room":i.emit(o,n);break;case"member.joined":case"member.left":{yield Ue(fc,Ma(Ia({},e),{action:t}));const i=(e=>({type:`video.${e.type}`,payload:Sc(e.payload)}))(t);yield We(r,i);break}case"member.updated":{const e=(e=>({type:`video.${e.type}`,payload:Cc(e.payload)}))(t);yield We(r,e);break}case"layout.changed":{i.currentLayoutEvent=t.payload,i.emit(o,n);const e=(e=>({type:`video.${e.type}`,payload:e.payload}))(t);yield We(r,e);break}case"member.talking":yield Ue(fc,Ma(Ia({},e),{action:t}));break;default:dr().warn("Got an unknown fabric event",t)}return!1}dr().debug(`callSegmentWorker started for: callId ${o}, roomSessionId ${n}`),yield Ue(Pc,Ma(Ia({},e),{action:t}));const a=e=>{const{type:t,payload:r}=e,i=t.startsWith("call.")||t.startsWith("member.")||t.startsWith("layout."),s="call_id"in r&&o===r.call_id,a=n===r.room_session_id;return!(!i||!s&&!a)};for(;;){const e=yield De(r,a),t=yield Ue(s,e);if(yield ze(t))return}},xc=function*(e){dr().trace("fabricWorker started");const{channels:{swEventChannel:t},instance:r}=e;function*i(t){const{type:i,payload:o}=t;switch(i){case"call.joined":if(!r.selfMember){const e=gc({store:r.store,payload:{member:t.payload.room_session.members.find((e=>e.member_id===t.payload.member_id)),room_id:t.payload.room_id,room_session_id:t.payload.room_session_id}});r.selfMember=e}yield Ue(Tc,Ma(Ia({},e),{instance:r,action:t}));break;case"call.state":r.emit(i,o)}}let o=!1;const n=e=>{if("call.state"===e.type)return!0;if("call.joined"!==e.type)return!1;if(!o){return e.payload.call_id===e.payload.origin_call_id&&(o=!0,!0)}return!0};for(;;){const e=yield De(t,n);yield Ue(i,e)}dr().trace("fabricWorker ended")},Ac=class extends oc{constructor(e){super(e),xa(this,"_self"),xa(this,"_member"),xa(this,"_currentLayoutEvent"),xa(this,"_capabilities"),this.initWorker()}get memberId(){var e;return null==(e=this._member)?void 0:e.memberId}set currentLayoutEvent(e){this._currentLayoutEvent=e}get currentLayoutEvent(){return this._currentLayoutEvent}get currentLayout(){var e;return null==(e=this._currentLayoutEvent)?void 0:e.layout}get currentPosition(){var e,t;return null==(t=null==(e=this._currentLayoutEvent)?void 0:e.layout.layers.find((e=>e.member_id===this.memberId)))?void 0:t.position}get capabilities(){return this._capabilities}set capabilities(e){this._capabilities=e}get selfMember(){return this._self}set selfMember(e){this._self=e}set member(e){this._member=e}get member(){return this._member}initWorker(){this.runWorker("fabricWorker",{worker:xc}),this.runWorker("makeAudioElement",{worker:Ra({speakerId:this.options.speakerId})})}async join(){var e,t;return this.options.attach&&(this.options.prevCallId=null!=(t=null==(e=dc())?void 0:e.getItem(uc))?t:void 0),this.logger.debug(`Tying to reattach to previuos call? ${!!this.options.prevCallId} - prevCallId: ${this.options.prevCallId}`),super.invite()}executeAction(e,t={}){var r,i,o;const{method:n,channel:s,memberId:a,extraParams:c={}}=e,d=a?this.instanceMap.get(a):this.member;if(!d)throw new Error("No target param found to execute");return this.execute({method:n,params:Ia(Ma(Ia({},s&&{channels:[s]}),{self:{member_id:null==(r=this.selfMember)?void 0:r.id,call_id:null==(i=this.selfMember)?void 0:i.callId,node_id:null==(o=this.selfMember)?void 0:o.nodeId},target:{member_id:d.id,call_id:d.callId,node_id:d.nodeId}}),c)},t)}async resume(){var e;if(this.logger.warn(`[resume] Call ${this.id}`),null!=(e=this.peer)&&e.instance){const{connectionState:e}=this.peer.instance;this.logger.debug(`[resume] connectionState for ${this.id} is '${e}'`),["closed","failed","disconnected"].includes(e)&&(this.resuming=!0,this.peer.restartIce())}}async start(){return new Promise((async(e,t)=>{try{this.once("room.subscribed",(t=>{var r;null==(r=dc())||r.setItem(uc,t.call_id),e()})),this.once("destroy",(()=>{var e;null==(e=dc())||e.removeItem(uc)})),await this.join()}catch(l){this.logger.error("WSClient call start",l),t(l)}}))}async audioMute(e){var t,r;if(e&&e.memberId!==this.member.id?null==(r=this.capabilities)||!r.member.muteAudio.off:null==(t=this.capabilities)||!t.self.muteAudio.off)throw Error("Missing audio mute capability");return this.executeAction({method:"call.mute",channel:"audio",memberId:null==e?void 0:e.memberId})}async audioUnmute(e){var t,r;if(e&&e.memberId!==this.member.id?null==(r=this.capabilities)||!r.member.muteAudio.on:null==(t=this.capabilities)||!t.self.muteAudio.on)throw Error("Missing audio unmute capability");return this.executeAction({method:"call.unmute",channel:"audio",memberId:null==e?void 0:e.memberId})}async videoMute(e){var t,r;if(e&&e.memberId!==this.member.id?null==(r=this.capabilities)||!r.member.muteVideo.on:null==(t=this.capabilities)||!t.self.muteVideo.off)throw Error("Missing video mute capability");return this.executeAction({method:"call.mute",channel:"video",memberId:null==e?void 0:e.memberId})}async videoUnmute(e){var t,r;if(e&&e.memberId!==this.member.id?null==(r=this.capabilities)||!r.member.muteVideo.on:null==(t=this.capabilities)||!t.self.muteVideo.on)throw Error("Missing video unmute capability");return this.executeAction({method:"call.unmute",channel:"video",memberId:null==e?void 0:e.memberId})}async deaf(e){var t,r;if(e&&e.memberId!==this.member.id?null==(r=this.capabilities)||!r.member.deaf.on:null==(t=this.capabilities)||!t.self.deaf.on)throw Error("Missing deaf capability");return this.executeAction({method:"call.deaf",memberId:null==e?void 0:e.memberId})}async undeaf(e){var t,r;if(e&&e.memberId!==this.member.id?null==(r=this.capabilities)||!r.member.deaf.off:null==(t=this.capabilities)||!t.self.deaf.off)throw Error("Missing undeaf capability");return this.executeAction({method:"call.undeaf",memberId:null==e?void 0:e.memberId})}async getLayouts(){return this.executeAction({method:"call.layout.list"},{transformResolve:e=>({layouts:e.layouts})})}async getMembers(){return this.executeAction({method:"call.member.list"},{transformResolve:e=>({members:e.members})})}async removeMember(e){var t;if(null==(t=this.capabilities)||!t.member.remove)throw Error("Missing setLayout capability");if(null==e||!e.memberId)throw new TypeError('Invalid or missing "memberId" argument');return this.executeAction({method:"call.member.remove",memberId:e.memberId})}async setRaisedHand(e){var t,r,i,o;const{raised:n=!0,memberId:s}=e||{};if(s==this.member.id&&n?null==(t=this.capabilities)||!t.self.raisehand.on:null==(r=this.capabilities)||!r.member.raisehand.on)throw Error("Missing raisehand capability");if(s!=this.member.id||n?null==(o=this.capabilities)||!o.member.raisehand.off:null==(i=this.capabilities)||!i.self.raisehand.off)throw Error("Missing lowerhand capability");return this.executeAction({method:n?"call.raisehand":"call.lowerhand",memberId:s})}async setLayout(e){var t;if(null==(t=this.capabilities)||!t.setLayout)throw Error("Missing setLayout capability");const r={layout:e.name,positions:e.positions};return this.executeAction({method:"call.layout.set",extraParams:r})}async setInputVolume(e){var t,r;if(e&&e.memberId!==this.member.id?null==(r=this.capabilities)||!r.member.microphoneVolume:null==(t=this.capabilities)||!t.self.microphoneVolume)throw Error("Missing setInputVolume capability");return this.executeAction({method:"call.microphone.volume.set",memberId:null==e?void 0:e.memberId,extraParams:{volume:null==e?void 0:e.volume}})}async setOutputVolume(e){var t,r;if(e&&e.memberId!==this.member.id?null==(r=this.capabilities)||!r.member.speakerVolume:null==(t=this.capabilities)||!t.self.speakerVolume)throw Error("Missing setOutputVolume capability");return this.executeAction({method:"video.member.set_output_volume",memberId:null==e?void 0:e.memberId,extraParams:{volume:null==e?void 0:e.volume}})}async setInputSensitivity(e){var t,r;if(e&&e.memberId!==this.member.id?null==(r=this.capabilities)||!r.member.microphoneSensitivity:null==(t=this.capabilities)||!t.self.microphoneSensitivity)throw Error("Missing setOutputVolume capability");return this.executeAction({method:"call.microphone.sensitivity.set",memberId:null==e?void 0:e.memberId,extraParams:{value:null==e?void 0:e.value}})}async setPositions(e){var t,r,i,o,n;const s=e.positions;if(s&&!Object.keys(s).length)throw new Error("Invalid positions");if(Object.keys(s).some((e=>["self",`${this.memberId}`].includes(e)))?null==(t=this.capabilities)||!t.self.position:null==(r=this.capabilities)||!r.member.position)throw Error("Missing setPositions capability");const a=[];if(Object.entries(s).forEach((([e,t])=>{const r="self"===e?this.member:this.instanceMap.get(e);r&&a.push({target:{member_id:r.id,call_id:r.callId,node_id:r.nodeId},position:t})})),!a.length)throw new Error("Invalid targets");return this.execute({method:"call.member.position.set",params:{self:{member_id:null==(i=this.selfMember)?void 0:i.id,call_id:null==(o=this.selfMember)?void 0:o.callId,node_id:null==(n=this.selfMember)?void 0:n.nodeId},targets:a}})}async lock(){var e;if(null==(e=this.capabilities)||!e.lock.on)throw Error("Missing lock capability");return this.executeAction({method:"call.lock"})}async unlock(){var e;if(null==(e=this.capabilities)||!e.lock.off)throw Error("Missing unlock capability");return this.executeAction({method:"call.unlock"})}},Rc=e=>e instanceof Ac,Oc=class{constructor(e){xa(this,"id"),xa(this,"_domElement"),xa(this,"_status"),this.id=e.id,this._status="hidden"}get userId(){return this.id.split(Ua)[1]}get domElement(){return this._domElement}set domElement(e){dr().debug("Setting domElement for ",this.id),this._domElement=e}get status(){return this._status}set status(e){this._status=e}hide(){if(!this.domElement)return dr().warn("Missing overlay to hide");this.domElement.style.opacity="0",this.status="hidden"}show(){if(!this.domElement)return dr().warn("Missing overlay to show");this.domElement.style.opacity="1",this.status="visible"}},Lc=class extends Oc{constructor(e){super(e),xa(this,"_mirrored"),xa(this,"_room"),this._mirrored=e.mirrorLocalVideoOverlay,this._room=e.room,this.fabricMemberVideoMutedHandler=this.fabricMemberVideoMutedHandler.bind(this),this.videoMemberVideoMutedHandler=this.videoMemberVideoMutedHandler.bind(this),this.attachListeners()}get userId(){return this.id.split($a)[1]}get mirrored(){return this._mirrored}attachListeners(){Rc(this._room)?this._room.on("member.updated.videoMuted",this.fabricMemberVideoMutedHandler):cc(this._room)&&this._room.on("member.updated.videoMuted",this.videoMemberVideoMutedHandler)}detachListeners(){Rc(this._room)?this._room.off("member.updated.videoMuted",this.fabricMemberVideoMutedHandler):cc(this._room)&&this._room.off("member.updated.videoMuted",this.videoMemberVideoMutedHandler)}memberVideoMutedHandler(e,t){try{e===this._room.memberId&&(t?this.hide():this.show())}catch(l){dr().error("Error handling videoMuted in LocalVideoOverlay",l)}}fabricMemberVideoMutedHandler(e){this.memberVideoMutedHandler(e.member.member_id,e.member.video_muted)}videoMemberVideoMutedHandler(e){this.memberVideoMutedHandler(e.member.id,e.member.video_muted)}setMediaStream(e){if(!this.domElement)return dr().warn("Missing local overlay to set the stream");const t=this.domElement.querySelector("video");t&&(t.srcObject=e)}setMirror(e=this._mirrored){if(!this.domElement||!this.domElement.firstChild)return dr().warn("Missing local overlay to set the mirror");const t=this.domElement.firstChild;t.style.transform=e?"scale(-1, 1)":"scale(1, 1)",t.style.webkitTransform=e?"scale(-1, 1)":"scale(1, 1)",this._mirrored=e}},jc=()=>{const e=document.createElement("video");return e.muted=!0,e.autoplay=!0,e.playsInline=!0,e.addEventListener("pause",(()=>{e.play().catch((t=>{dr().error("Video Element Paused",e,t)}))})),e},Vc=({x:e,y:t,width:r,height:i})=>({top:`${t}%`,left:`${e}%`,width:`${r}%`,height:`${i}%`}),Dc=({location:e})=>{const{top:t,left:r,width:i,height:o}=Vc(e),n=document.createElement("div");return n.style.position="absolute",n.style.overflow="hidden",n.style.top=t,n.style.left=r,n.style.width=i,n.style.height=o,n},Wc=({location:e,element:t})=>{const{top:r,left:i,width:o,height:n}=Vc(e);return t.style.top=r,t.style.left=i,t.style.width=o,t.style.height=n,t},Nc=({video:e,rootElement:t,paddingWrapper:r})=>{const i=function(e,t=0){let r=null,i=null;const o=function(){r&&(clearTimeout(r),i=null,r=null)},n=function(){if(!t)return e.apply(this,arguments);const n=this,s=arguments;o(),i=function(){e.apply(n,s)},r=setTimeout((function(){r=null;{const e=i;return i=null,null==e?void 0:e()}}),t)};return n.cancel=o,n.flush=function(){const e=i;o(),e&&e()},n}((({width:t,height:i})=>{const o=e.videoHeight/e.videoWidth*100;if(r){const n=i/t*100;r.style.paddingBottom=`${n>o?o:n}%`,r.style.width=((t,r)=>{const i=e.videoWidth/e.videoHeight;return i>t/r?"100%":r*i+"px"})(t,i)}}),100),o=new ResizeObserver((e=>{e.forEach((e=>{if(e.contentBoxSize){const{inlineSize:t,blockSize:r}=Array.isArray(e.contentBoxSize)?e.contentBoxSize[0]:e.contentBoxSize;i({width:t,height:r})}else e.contentRect&&i({width:e.contentRect.width,height:e.contentRect.height})}))})),n=()=>{const e=t.clientWidth,r=t.clientHeight;i({width:e,height:r})};return{start:()=>{o.observe(t),e.addEventListener("resize",n)},stop:()=>{o.disconnect(),e.removeEventListener("resize",n)}}},$c=async e=>{var t;try{const{room:r,rootElement:i,applyLocalVideoOverlay:o=!0,applyMemberOverlay:n=!0,mirrorLocalVideoOverlay:s=!0}=e;let a=!1;const c=new Map,d=y();let l;i?l=i:(l=document.createElement("div"),l.id=`rootElement-${d}`);const u=(e=>`${$a}${e}`)(d),h=new Lc({id:u,mirrorLocalVideoOverlay:s,room:r});o&&c.set(u,h);const m=(e=>{const{applyLocalVideoOverlay:t,applyMemberOverlay:r,overlayMap:i,localVideoOverlay:o,mirrorLocalVideoOverlay:n,rootElement:s}=e;return async e=>{dr().debug("Process layout.changed");try{const{layout:a,memberId:c,localStream:d}=e,{layers:l=[]}=a,u=s.querySelector(".mcuLayers"),h=document.createDocumentFragment(),m=new Set;if(t){const e=l.find((({member_id:e})=>e===c)),t=o.id;let r=o.domElement;if(m.add(t),e){if(r)dr().debug("Update local video overlay"),Wc({location:e,element:r});else{dr().debug("Build local video overlay"),r=Dc({location:e}),r.id=t;const i=jc();i.srcObject=d,i.disablePictureInPicture=!0,i.style.width="100%",i.style.height="100%",i.style.pointerEvents="none",i.style.objectFit="cover",r.appendChild(i),o.domElement=r,n&&o.setMirror()}d.getVideoTracks().filter((e=>e.enabled&&"live"===e.readyState)).length>0&&e.visible?(o.setMediaStream(d),o.show()):o.hide(),h.appendChild(r)}else dr().warn("Local video overlay location not found"),o.status="hidden",r&&o.hide()}r&&l.forEach((e=>{const t=e.member_id;if(!t)return;const r=Ba(t);m.add(r);let o=i.get(r);if(o&&o.domElement)dr().debug("Update an overlay for ",t),Wc({location:e,element:o.domElement});else{dr().debug("Build an overlay for ",t),o=new Oc({id:r}),i.set(r,o);const n=Dc({location:e});n.id=`${r}-${y()}`,o.domElement=n}e.visible?o.show():o.hide(),h.appendChild(o.domElement)})),i.forEach(((e,t)=>{m.has(t)||(e.domElement&&e.domElement.parentNode&&e.domElement.parentNode.removeChild(e.domElement),i.delete(t))})),u&&(u.innerHTML="",u.appendChild(h))}catch(c){dr().error("Layout Changed Error",c)}}})({applyLocalVideoOverlay:o,applyMemberOverlay:n,overlayMap:c,localVideoOverlay:h,mirrorLocalVideoOverlay:s,rootElement:l}),p=e=>{var t;null!=(t=r.peer)&&t.hasVideoSender&&r.localStream?m({layout:e.layout,localStream:r.localStream,memberId:r.memberId}):h.hide()},g=e=>{dr().debug("Received layout.changed - videoTrack",a),a&&p(e)},v=async e=>{a=!0,await Uc({applyLocalVideoOverlay:o,applyMemberOverlay:n,rootElement:l,track:e});const t=r.currentLayoutEvent;t&&p(t)},f=null==(t=r.peer)?void 0:t.remoteVideoTrack;f&&await v(f);const b=async function(e){"video"===e.track.kind&&await v(e.track)},_=()=>{(e=>{for(;e.firstChild;)e.removeChild(e.firstChild)})(l),c.clear(),r.overlayMap=c,(Rc(r)||cc(r))&&(r.off("track",b),r.off("layout.changed",g),r.off("destroy",_)),h.detachListeners()};return(Rc(r)||cc(r))&&(r.on("track",b),r.on("layout.changed",g),r.once("destroy",_)),r.overlayMap=c,r.localVideoOverlay=h,{element:l,overlayMap:c,localVideoOverlay:h,unsubscribe:_}}catch(l){throw dr().error("Unable to build the video element"),l}},Uc=async e=>{try{const{applyLocalVideoOverlay:t,applyMemberOverlay:r,track:i,rootElement:o}=e,n=jc();if((({track:e,element:t})=>{t.srcObject=new MediaStream([e]),e.addEventListener("ended",(()=>{t.srcObject=null,t.remove()}))})({element:n,track:i}),n.style.width="100%",n.style.maxHeight="100%",o.querySelector(".mcuContent"))return void dr().debug("MCU Content already there");const s=document.createElement("div");s.style.position="absolute",s.style.top="0",s.style.left="0",s.style.right="0",s.style.bottom="0",s.appendChild(n);const a=document.createElement("div");a.classList.add("paddingWrapper"),a.style.paddingBottom="56.25%",a.style.position="relative",a.style.width="100%",a.appendChild(s);let c=null;(t||r)&&(c=document.createElement("div"),c.classList.add("mcuLayers"),c.style.display="none",a.appendChild(c));const d=document.createElement("div");d.classList.add("mcuContent"),d.style.position="relative",d.style.width="100%",d.style.height="100%",d.style.margin="0 auto",d.style.display="flex",d.style.alignItems="center",d.style.justifyContent="center",d.appendChild(a),o.style.width="100%",o.style.height="100%",o.appendChild(d),dr().debug("MCU readyState 1 >>",n.readyState),n.readyState===HTMLMediaElement.HAVE_NOTHING&&(dr().debug("Wait for the MCU to be ready"),await(({element:e})=>new Promise((t=>{e.addEventListener("canplay",(function r(){e.removeEventListener("canplay",r),t()})),e.addEventListener("resize",(function r(){e.removeEventListener("resize",r),t()}))})))({element:n})),dr().debug("MCU is ready..");const l=Nc({rootElement:o,video:n,paddingWrapper:a});l.start(),i.addEventListener("ended",(()=>{l&&l.stop()})),c&&(c.style.display="block")}catch(d){dr().error("Handle video track error",d)}},Bc=class extends eo{constructor(){super(...arguments),xa(this,"_videoManager"),xa(this,"_chat"),xa(this,"_pubSub")}get rooms(){return{makeRoomObject:e=>{const t=e,{rootElement:r,applyLocalVideoOverlay:i=!0,applyMemberOverlay:o=!0,mirrorLocalVideoOverlay:n=!0,stopCameraWhileMuted:s=!0,stopMicrophoneWhileMuted:a=!0}=t,c=Pa(t,["rootElement","applyLocalVideoOverlay","applyMemberOverlay","mirrorLocalVideoOverlay","stopCameraWhileMuted","stopMicrophoneWhileMuted"]),d=[];d.push(Ra({speakerId:c.speakerId}));const l=(e=>Ki({store:e.store,customSagas:e.customSagas,Component:ac})(e))(Ma(Ia({},c),{store:this.store,customSagas:d}));if(r)try{$c({applyLocalVideoOverlay:i,applyMemberOverlay:o,mirrorLocalVideoOverlay:n,room:l,rootElement:r})}catch{this.logger.error("Unable to build the video element automatically")}return l.on("room.subscribed",(e=>{var t;const r=null==(t=e.room_session.members)?void 0:t.find((e=>e.id===l.memberId));if(null!=r&&r.audio_muted)try{l.stopOutboundAudio()}catch(i){this.logger.error("Error handling audio_muted",i)}if(null!=r&&r.video_muted)try{l.stopOutboundVideo()}catch(i){this.logger.error("Error handling video_muted",i)}})),a&&l.on("member.updated.audio_muted",(({member:e})=>{try{e.id===l.memberId&&"audio_muted"in e&&(e.audio_muted?l.stopOutboundAudio():l.restoreOutboundAudio())}catch(t){this.logger.error("Error handling audio_muted",t)}})),s&&l.on("member.updated.video_muted",(({member:e})=>{try{e.id===l.memberId&&"video_muted"in e&&(e.video_muted?l.stopOutboundVideo():l.restoreOutboundVideo())}catch(t){this.logger.error("Error handling video_muted",t)}})),l}}}get chat(){return this._chat||(this._chat=an.createBaseChatObject({store:this.store})),this._chat}get pubSub(){return this._pubSub||(this._pubSub=bn.createBasePubSubObject({store:this.store})),this._pubSub}get videoManager(){return this._videoManager||(this._videoManager=(e=>{const t=Ki({store:e.store,Component:Wa})(e);return new Proxy(t,{get:(e,t,r)=>"_eventsNamespace"===t?"":"eventChannel"===t?"video-manager.rooms":Reflect.get(e,t,r)})})(this.options)),this._videoManager}reauthenticate(e){this.store.dispatch(qr.reauthAction({token:e}))}},zc="function"==typeof CloseEvent?CloseEvent:class{constructor(e,t={}){this.type=e,Xt(this,"code"),Xt(this,"reason"),Xt(this,"wasClean"),this.code=void 0===t.code?0:t.code,this.reason=void 0===t.reason?"":t.reason,this.wasClean=void 0!==t.wasClean&&t.wasClean}},Hc=class extends _i{constructor(e){var t;let r={};try{r=ya(e.token,{header:!0})}catch{}super(Ma(Ia({},e),{host:(null==r?void 0:r.ch)||e.host})),this.options=e,xa(this,"WebSocketConstructor",WebSocket),xa(this,"CloseEventConstructor",zc),xa(this,"agent","@signalwire/js/browser/3.28.0-dev.202502271238.03698cd.0"),xa(this,"tokenTyp"),this.tokenTyp=null!=(t=r.typ)?t:"VRT"}get allowReattach(){var e;return!1!==(null==(e=this.options)?void 0:e.reattach)&&(this.isVRT()||this.isSAT())}async retrieveRelayProtocol(){var e,t;if(!this.allowReattach)return"";const{protocolKey:r}=lc(this.options.token);return r?(this.logger.trace("Search protocol for",r),null!=(t=null==(e=dc())?void 0:e.getItem(r))?t:""):""}async persistRelayProtocol(){var e;if(!this.allowReattach)return;const{protocolKey:t}=lc(this.options.token);t&&(this.logger.trace("Persist protocol",t,this.relayProtocol),null==(e=dc())||e.setItem(t,this.relayProtocol))}async retrieveSwAuthorizationState(){var e,t;const{authStateKey:r}=lc(this.options.token);return r&&null!=(t=null==(e=dc())?void 0:e.getItem(r))?t:""}async persistSwAuthorizationState(e){var t;if(!this.allowReattach)return;const{authStateKey:r}=lc(this.options.token);r&&(this.logger.trace("Persist auth state",r,e),null==(t=dc())||t.setItem(r,e))}_onSocketClose(e){var t,r,i;if("unknown"===this.status||"disconnected"===this.status){const{protocolKey:e,authStateKey:o,callIdKey:n}=lc(this.options.token);this.logger.debug("Cleaning up storage"),e&&(this.logger.debug("Remove protocolKey",e),null==(t=dc())||t.removeItem(e)),o&&(this.logger.debug("Remove authStateKey",o),null==(r=dc())||r.removeItem(o)),n&&(this.logger.debug("Remove callIdKey",n),null==(i=dc())||i.removeItem(n))}super._onSocketClose(e)}isVRT(){return"VRT"===this.tokenTyp}isSAT(){return"SAT"===this.tokenTyp}},Fc=e=>{const t=Ma(Ia({},e),{emitter:Ji()}),r=Gi({userOptions:t,SessionConstructor:Hc});return Ki({store:r,Component:Bc})(t)},qc=["subscribe","publish","getMessages","getMembers","getMemberState","getAllowedChannels","setMemberState"],Kc=function(e){const t=Fc(e),r={_session:t,disconnect:()=>t.disconnect()};return new Proxy(t.chat,{get:(e,i,o)=>i in r?r[i]:qc.includes(i)?(e=>async(...r)=>(await t.connect(),t.chat[e](...r)))(i):Reflect.get(e,i,o)})};Ta({},{Client:()=>Gc,PubSubMessage:()=>Zc}),Object.keys(ro).map((e=>`member.updated.${e}`));var Jc=["getAllowedChannels","subscribe","publish"],Gc=function(e){const t=Fc(e),r={_session:t,disconnect:()=>t.disconnect()};return new Proxy(t.pubSub,{get:(e,i,o)=>i in r?r[i]:Jc.includes(i)?(e=>async(...r)=>(await t.connect(),t.pubSub[e](...r)))(i):Reflect.get(e,i,o)})},Zc=bn.PubSubMessage;async function Qc(e,t){const r=await fetch(e,t);if(!r.ok){if(401===r.status)throw new Li(r.status,"Unauthorized");let e;try{e=await r.json()}catch{}const t=null!=e&&e.errors?JSON.stringify(e.errors):"Not Found";throw new ji(r.status,t,e)}try{r.parsedBody=await r.json()}catch{}return r}Ta({},{SignalWire:()=>ud,isFabricRoomSession:()=>Rc});var Xc=(e,t=Qc)=>{var r=e,{baseUrl:i,timeout:o=3e4}=r,n=Pa(r,["baseUrl","timeout"]);return async(e,r)=>{const s=Ia(Ia(Ia({},null!=r&&r.body?{"Content-Type":"application/json"}:{}),n.headers),null==r?void 0:r.headers),a=ed(Ma(Ia(Ia({},n),r),{headers:s}));let c;if(o){const e=new AbortController,t=e.signal;a.signal=t,c=setTimeout((()=>{e.abort()}),o)}try{return{body:(await t(td({path:e,baseUrl:i,searchParams:null==r?void 0:r.searchParams}),a)).parsedBody}}catch(d){throw d}finally{c&&clearTimeout(c)}}},Yc=e=>"string"==typeof e?e:JSON.stringify(e),ed=e=>Object.entries(e).reduce(((e,[t,r])=>"body"===t?Ma(Ia({},e),{body:Yc(r)}):null!=r?Ma(Ia({},e),{[t]:r}):e),{}),td=({path:e,baseUrl:t,searchParams:r})=>{const i=new URL(e,t);return r&&Object.entries(r).forEach((([e,t])=>{null!=t&&i.searchParams.append(e,t)})),i.toString()};function rd(e,t){const r=async e=>{if(!e)return Promise.resolve(void 0);const{body:r}=await t(e);return rd(r,t)};return{data:e.data,self:async()=>{const{self:t}=e.links;return r(t)},nextPage:async()=>{const{next:t}=e.links;return r(t)},prevPage:async()=>{const{prev:t}=e.links;return r(t)},firstPage:async()=>{const{first:t}=e.links;return r(t)},hasNext:!!e.links.next,hasPrev:!!e.links.prev}}function id(e,t){const r=t.toString();return r?`${e}?${r}`:e}var od=class{constructor(e){this.options=e,xa(this,"httpClient"),this.httpClient=Xc({baseUrl:`https://${this.httpHost}`,headers:{Authorization:`Bearer ${this.options.token}`}})}get fetch(){return this.httpClient}get httpHost(){let e={};try{e=ya(this.options.token,{header:!0})}catch{}const t=this.options.host||(null==e?void 0:e.ch);return t?`fabric.${t.split(".").splice(1).join(".")}`:"fabric.signalwire.com"}async getAddress(e){let t="/api/fabric/addresses";(e=>e&&"name"in e)(e)?t=`${t}?name=${e.name}`:(e=>e&&"id"in e)(e)&&(t=`${t}/${e.id}`);const{body:r}=await this.httpClient(t);if((e=>e&&"data"in e)(r)){if(!r.data[0])throw new ji(404,"Not Found");return r.data[0]}return r}async getAddresses(e){const{type:t,displayName:r,pageSize:i,sortBy:o,sortOrder:n}=e||{};const s=new URLSearchParams;t&&s.append("type",t),r&&s.append("display_name",r),i&&s.append("page_size",i.toString()),o&&s.append("sort_by",o),n&&s.append("sort_order",n);const a=id("/api/fabric/addresses",s);dr().debug(`[getAddresses] query URL ${a}`);const{body:c}=await this.httpClient(a);return rd(c,this.httpClient)}async registerDevice(e){const{deviceType:t,deviceToken:r}=e,{body:i}=await this.httpClient("/subscriber/devices",{method:"POST",body:{device_type:t,device_token:r}});return i}async unregisterDevice(e){const{id:t}=e,r=`/subscriber/devices/${t}`;await this.httpClient(r,{method:"DELETE"})}async getSubscriberInfo(){const{body:e}=await this.httpClient("/api/fabric/subscriber/info");return e}},nd=class{constructor(e,t){this.conversation=e,this.payload=t}get id(){return this.payload.id}get addressId(){return this.payload.address_id}get createdAt(){return this.payload.created_at}get lastMessageAt(){return this.payload.last_message_at}get metadata(){return this.payload.metadata}get name(){return this.payload.name}sendMessage(e){return this.conversation.sendMessage({addressId:this.id,text:e.text})}getMessages(e){return this.conversation.getConversationMessages(Ia({addressId:this.id},e))}},sd=10,ad=class{constructor(e){xa(this,"httpClient"),xa(this,"wsClient"),xa(this,"callbacks",new Set),xa(this,"chatSubscriptions",{}),this.httpClient=e.httpClient,this.wsClient=e.wsClient,this.wsClient.runWorker("conversationWorker",{worker:mc,initialState:{conversation:this}})}handleEvent(e){if("chat"===e.subtype){const t=this.chatSubscriptions[e.conversation_id];null!=t&&t.size&&t.forEach((t=>t(e)))}this.callbacks.size&&this.callbacks.forEach((t=>{t(e)}))}async sendMessage(e){try{const{addressId:t,text:r}=e,i="/api/fabric/messages",{body:o}=await this.httpClient.fetch(i,{method:"POST",body:{conversation_id:t,text:r}});return o}catch(d){throw new Error("Error sending message to conversation!",d)}}async getConversations(e){try{const{pageSize:t}=e||{},r="/api/fabric/conversations",i=new URLSearchParams;t&&i.append("page_size",t.toString());const{body:o}=await this.httpClient.fetch(id(r,i)),n=this,s=o.data.map((e=>new nd(n,e)));return rd(Ma(Ia({},o),{data:s}),this.httpClient.fetch)}catch(d){throw new Error("Error fetching the conversation history!",d)}}async getMessages(e){try{const{pageSize:t}=e||{},r="/api/fabric/messages",i=new URLSearchParams;t&&i.append("page_size",t.toString());const{body:o}=await this.httpClient.fetch(id(r,i));return rd(o,this.httpClient.fetch)}catch(d){throw new Error("Error fetching the conversation messages!",d)}}async getConversationMessages(e){try{const{addressId:t,pageSize:r}=e||{},i=`/api/fabric/conversations/${t}/messages`,o=new URLSearchParams;r&&o.append("page_size",r.toString());const{body:n}=await this.httpClient.fetch(id(i,o));return rd(n,this.httpClient.fetch)}catch(d){throw new Error("Error fetching the conversation messages!",d)}}async getChatMessages(e){const{addressId:t,pageSize:r=sd}=e,i=async(e,o=[],n=!0)=>{var s;const a=[...o],c=e=>e.conversation_id===t&&"chat"===e.subtype;let d;d=await(null==e?void 0:e());let l=null!=(s=null==d?void 0:d.data.filter(c))?s:[],u=r-a.length;for(let t=0;t<l.length&&t<u;t++)a.push(l[t]);for(;a.length<r&&null!=d&&d.hasNext&&(d=await(n?null==d?void 0:d.nextPage():null==d?void 0:d.prevPage()),d&&d.data.length);){u=r-a.length,l=d.data.filter(c);for(let e=0;e<l.length&&e<u;e++)a.push(l[e])}let h=[];return u<l.length&&(h=l.slice(u)),{data:a,hasNext:!(null==d||!d.hasNext)||!!o.length,hasPrev:!(null==d||!d.hasPrev),nextPage:()=>i(null==d?void 0:d.nextPage,h),prevPage:()=>i(null==d?void 0:d.prevPage,h,!1),self:()=>i(null==d?void 0:d.self,h),firstPage:()=>i(null==d?void 0:d.firstPage,h)}};return i((()=>this.getConversationMessages({addressId:t,pageSize:r})))}async subscribe(e){return this.callbacks.add(e),{unsubscribe:()=>this.callbacks.delete(e)}}async subscribeChatMessages(e){const{addressId:t,onMessage:r}=e;return t in this.chatSubscriptions||(this.chatSubscriptions[t]=new Set),this.chatSubscriptions[t].add(r),{unsubscribe:()=>this.chatSubscriptions[t].delete(r)}}async joinConversation(e){try{const{addressId:t}=e,r="/api/fabric/conversations/join",{body:i}=await this.httpClient.fetch(r,{method:"POST",body:{conversation_id:t}});return i}catch(d){throw new Error("Error joining a conversation!",d)}}},cd=class{constructor(e){this.options=e,xa(this,"_client"),xa(this,"_pendingInvites",{}),xa(this,"_handlers",{}),this._client=e.client}_buildNotification(e){const t=async t=>new Promise(((r,i)=>{delete this._pendingInvites[e.callID];try{const i=this.options.buildInboundCall(e,t);i.answer(),r(i)}catch(o){i(o)}})),r=()=>(delete this._pendingInvites[e.callID],this.options.executeVertoBye(e.callID,e.nodeId));return{invite:{details:e,accept:e=>t(e),reject:()=>r()}}}setNotificationHandlers(e){this._handlers.all=e.all,(e.pushNotification&&this._handlers.all!=e.pushNotification||!e.pushNotification)&&(this._handlers.pushNotification=e.pushNotification),(e.websocket&&this._handlers.all!=e.websocket||!e.websocket)&&(this._handlers.websocket=e.websocket)}handleIncomingInvite(e){var t,r;if(e.callID in this._pendingInvites)return void this._client.logger.debug(`skiping nottification for pending invite to callID: ${e.callID}`);if(this._pendingInvites[e.callID]=e,!this._handlers.all&&!this._handlers[e.source])return void this._client.logger.warn("Skiping nottification due to no listeners");const i=this._buildNotification(e);null==(r=(t=this._handlers).all)||r.call(t,i);const o=this._handlers[e.source];null==o||o(i)}},dd=class extends Hc{constructor(e){super(e),this.options=e,xa(this,"connectVersion",Rr)}get signature(){if(this._rpcConnectResult){const{authorization:e}=this._rpcConnectResult;return e.jti}}async _checkTokenExpiration(){}async reauthenticate(){if(this.logger.debug("Session Reauthenticate",{ready:this.ready,expired:this.expired}),!this.ready||this.expired)return this.connect();const e={project:this._rpcConnectResult.authorization.project_id,jwt_token:this.options.token};try{const t=await this.execute(Lr(e));this._rpcConnectResult=Ia(Ia({},this._rpcConnectResult),t)}catch(d){throw d}}},ld=class extends eo{constructor(e){const t=(e=>{const t=Gi({userOptions:e,SessionConstructor:dd});return Ma(Ia({},e),{store:t})})(e);super(t),this.wsClientOptions=e,xa(this,"_incomingCallManager"),xa(this,"_disconnected",!1),this._incomingCallManager=new cd({client:this,buildInboundCall:this.buildInboundCall.bind(this),executeVertoBye:this.executeVertoBye.bind(this)}),this.runWorker("wsClientWorker",{worker:hc,initialState:{handleIncomingInvite:e=>{this._incomingCallManager.handleIncomingInvite(Ia({source:"websocket"},e))}}})}makeFabricObject(e){const t=e,{rootElement:r,applyLocalVideoOverlay:i=!0,applyMemberOverlay:o=!0,stopCameraWhileMuted:n=!0,stopMicrophoneWhileMuted:s=!0,mirrorLocalVideoOverlay:a=!0}=t,c=Pa(t,["rootElement","applyLocalVideoOverlay","applyMemberOverlay","stopCameraWhileMuted","stopMicrophoneWhileMuted","mirrorLocalVideoOverlay"]),d=(e=>Ki({store:e.store,Component:Ac})(e))(Ma(Ia({},c),{store:this.store}));if(r)try{$c({applyLocalVideoOverlay:i,applyMemberOverlay:o,mirrorLocalVideoOverlay:a,room:d,rootElement:r})}catch{this.logger.error("Unable to build the video element automatically")}return d.on("room.subscribed",(e=>{var t;const r=null==(t=e.room_session.members)?void 0:t.find((e=>e.id===d.memberId||e.member_id===d.memberId));if(null!=r&&r.audio_muted)try{d.stopOutboundAudio()}catch(i){this.logger.error("Error handling audio_muted",i)}if(null!=r&&r.video_muted)try{d.stopOutboundVideo()}catch(i){this.logger.error("Error handling video_muted",i)}})),s&&d.on("member.updated.audioMuted",(({member:e})=>{try{e.member_id===d.memberId&&"audio_muted"in e&&(e.audio_muted?d.stopOutboundAudio():d.restoreOutboundAudio())}catch(t){this.logger.error("Error handling audio_muted",t)}})),n&&d.on("member.updated.videoMuted",(({member:e})=>{try{e.member_id===d.memberId&&"video_muted"in e&&(e.video_muted?d.stopOutboundVideo():d.restoreOutboundVideo())}catch(t){this.logger.error("Error handling video_muted",t)}})),d}buildOutboundCall(e){var t,r,i,o,n;const[s,a]=e.to.split("?");if(!s)throw new Error("Invalid destination address");let c=!1,d=!1;"video"===new URLSearchParams(a).get("channel")&&(c=!0,d=!0);const l=this.makeFabricObject({audio:null==(t=e.audio)||t,video:null!=(r=e.video)?r:c,negotiateAudio:null==(i=e.negotiateAudio)||i,negotiateVideo:null!=(o=e.negotiateVideo)?o:d,rootElement:e.rootElement||this.wsClientOptions.rootElement,applyLocalVideoOverlay:!0,applyMemberOverlay:!0,stopCameraWhileMuted:!0,stopMicrophoneWhileMuted:!0,watchMediaPackets:!1,destinationNumber:e.to,nodeId:e.nodeId,attach:null!=(n=e.attach)&&n,disableUdpIceServers:e.disableUdpIceServers||!1,userVariables:e.userVariables||this.wsClientOptions.userVariables});return l.once("destroy",(()=>{this.logger.debug("RTC Connection Destroyed"),l.destroy()})),this.session.once("session.disconnected",(()=>{this.logger.debug("Session Disconnected"),l.destroy(),this.destroy()})),l.attachPreConnectWorkers(),l}buildInboundCall(e,t){var r,i,o,n;const s=this.makeFabricObject({audio:null==(r=t.audio)||r,video:null==(i=t.video)||i,negotiateAudio:null==(o=t.negotiateAudio)||o,negotiateVideo:null==(n=t.negotiateVideo)||n,rootElement:t.rootElement||this.wsClientOptions.rootElement,applyLocalVideoOverlay:!0,applyMemberOverlay:!0,stopCameraWhileMuted:!0,stopMicrophoneWhileMuted:!0,watchMediaPackets:!1,nodeId:e.nodeId,remoteSdp:e.sdp,prevCallId:e.callID,disableUdpIceServers:t.disableUdpIceServers||!1,userVariables:t.userVariables||this.wsClientOptions.userVariables});return s.once("destroy",(()=>{this.logger.debug("RTC Connection Destroyed"),s.destroy()})),this.session.once("session.disconnected",(()=>{this.logger.debug("Session Disconnected"),s.destroy(),this.destroy()})),s.attachPreConnectWorkers(),s}async executeVertoBye(e,t){try{return await this.execute({method:"webrtc.verto",params:{callID:e,node_id:t,message:Nr({cause:"USER_BUSY",causeCode:"17",dialogParams:{callID:e}})}})}catch(l){throw this.logger.warn("The call is not available anymore",e),l}}async executeVertoSubscribe(e,t){try{return await this.execute({method:"webrtc.verto",params:{callID:e,node_id:t,subscribe:[],message:zr({sessid:e,eventChannel:[]})}})}catch(l){throw this.logger.warn("The call is not available anymore",e),l}}disconnect(){return new Promise(((e,t)=>{this._disconnected&&e(),this.session.once("session.disconnected",(()=>{this.destroy(),e(),this._disconnected=!0})),super.disconnect()}))}async dial(e){return new Promise((async(t,r)=>{try{t(this.buildOutboundCall(e))}catch(i){this.logger.error("Unable to connect and dial a call",i),r(i)}}))}async reattach(e){return new Promise((async(t,r)=>{try{t(this.buildOutboundCall(Ma(Ia({},e),{attach:!0})))}catch(i){this.logger.error("Unable to connect and reattach a call",i),r(i)}}))}handlePushNotification(e){return new Promise((async(t,r)=>{const{decrypted:i,type:o}=e;"call_invite"!==o&&(this.logger.warn("Unknown notification type",e),r("Unknown notification type")),this.logger.debug("handlePushNotification",e);const{params:{params:n},node_id:s}=i;try{try{await this.executeVertoSubscribe(n.callID,s)}catch(a){this.logger.warn("Verto Subscribe",a)}this._incomingCallManager.handleIncomingInvite(Ia({source:"pushNotification",nodeId:s},n)),t({resultType:"inboundCall"})}catch(a){r(a)}}))}updateToken(e){return new Promise(((t,r)=>{this.session.once("session.auth_error",(e=>{r(e)})),this.session.once("session.connected",(()=>{t()})),this.store.dispatch(qr.reauthAction({token:e}))}))}async online({incomingCallHandlers:e}){return this._incomingCallManager.setNotificationHandlers(e),this.execute({method:"subscriber.online",params:{}})}offline(){return this._incomingCallManager.setNotificationHandlers({}),this.execute({method:"subscriber.offline",params:{}})}},ud=(()=>{let e=null;return t=>(e||(e=new Promise((async(r,i)=>{try{const i=new ld(t),o=new od(t),n=new ad({httpClient:o,wsClient:i});await i.connect(),r({registerDevice:o.registerDevice.bind(o),unregisterDevice:o.unregisterDevice.bind(o),getSubscriberInfo:o.getSubscriberInfo.bind(o),disconnect:async()=>{await i.disconnect(),e=null},online:i.online.bind(i),offline:i.offline.bind(i),dial:i.dial.bind(i),reattach:i.reattach.bind(i),handlePushNotification:i.handlePushNotification.bind(i),updateToken:i.updateToken.bind(i),address:{getAddresses:o.getAddresses.bind(o),getAddress:o.getAddress.bind(o)},conversation:{getConversations:n.getConversations.bind(n),getMessages:n.getMessages.bind(n),getConversationMessages:n.getConversationMessages.bind(n),subscribe:n.subscribe.bind(n),sendMessage:n.sendMessage.bind(n),join:n.joinConversation.bind(n)},chat:{getMessages:n.getChatMessages.bind(n),subscribe:n.subscribeChatMessages.bind(n),sendMessage:n.sendMessage.bind(n),join:n.joinConversation.bind(n)},on:i.on.bind(i),off:i.off.bind(i),__httpClient:o,__wsClient:i})}catch(o){i(o)}})).catch((t=>{throw e=null,t}))),e)})();Ta({},{RoomSession:()=>yd,createClient:()=>Fc,createRoomObject:()=>md,isVideoRoomSession:()=>cc,joinRoom:()=>pd});var hd={aspectRatio:{ideal:16/9}},md=e=>new Promise((async(t,r)=>{const i=e,{audio:o=!0,video:n=!0,iceServers:s,rootElementId:a,applyLocalVideoOverlay:c=!0,autoJoin:d=!1,stopCameraWhileMuted:l=!0,stopMicrophoneWhileMuted:u=!0,speakerId:h}=i,m=Pa(i,["audio","video","iceServers","rootElementId","applyLocalVideoOverlay","autoJoin","stopCameraWhileMuted","stopMicrophoneWhileMuted","speakerId"]),p=Fc(Ia({},m));if(await p.connect(),!p)return;let g;if(a){const e=document.getElementById(a);e?g=e:(g=document.body,dr().warn(`We couldn't find an element with id: ${a}: using 'document.body' instead.`))}const v=p.rooms.makeRoomObject({audio:o,video:!0===n?hd:n,negotiateAudio:!0,negotiateVideo:!0,iceServers:s,rootElement:g,applyLocalVideoOverlay:c,stopCameraWhileMuted:l,stopMicrophoneWhileMuted:u,speakerId:h});v.once("destroy",(()=>{v.emit("room.left"),p.disconnect()}));const f=()=>new Promise((async(e,t)=>{try{v.once("room.subscribed",(t=>{e(v)})),await v.join()}catch(r){dr().error("Join",r),p.disconnect(),t(r)}})),y=new Proxy(v,{get:(e,t,r)=>"join"===t?f:Reflect.get(e,t,r)});if(d)try{await y.join(),t(y)}catch(b){r(b)}else t(y)})),pd=e=>md(Ma(Ia({},e),{autoJoin:!0})),gd=["audioMute","audioUnmute","deaf","getLayouts","getMembers","getRecordings","hideVideoMuted","leave","removerMember","restoreOutboundAudio","restoreOutboundVideo","setInputSensitivity","setInputVolume","setLayout","setPositions","setMemberPosition","setOutputVolume","showVideoMuted","startRecording","stopOutboundAudio","stopOutboundVideo","undeaf","videoMute","videoUnmute","setMicrophoneVolume","setSpeakerVolume","getMeta","setMeta","updateMeta","deleteMeta","getMemberMeta","setMemberMeta","updateMemberMeta","deleteMemberMeta","promote","demote","lock","unlock"],vd=["member.joined","layout.changed"],fd=()=>{},yd=function(e){const t=e,{audio:r=!0,video:i=!0,iceServers:o,rootElement:n,applyLocalVideoOverlay:s=!0,mirrorLocalVideoOverlay:a=!1,stopCameraWhileMuted:c=!0,stopMicrophoneWhileMuted:d=!0,speakerId:l,destinationNumber:u,localStream:h,watchMediaPackets:m,watchMediaPacketsTimeout:p,disableUdpIceServers:g=!1}=t,v=Pa(t,["audio","video","iceServers","rootElement","applyLocalVideoOverlay","mirrorLocalVideoOverlay","stopCameraWhileMuted","stopMicrophoneWhileMuted","speakerId","destinationNumber","localStream","watchMediaPackets","watchMediaPacketsTimeout","disableUdpIceServers"]);["audio","video"].forEach((t=>{t in e&&dr().warn(`The '${t}' parameter on the RoomSession constructor is deprecated. Set it on the '.join()' function instead.`)}));const f=!1!==(null==e?void 0:e.reattach),{callIdKey:y}=lc(v.token),b={joined:({call_id:e})=>{var t;f&&y&&(null==(t=dc())||t.setItem(y,e))},init:()=>{f&&w.on("room.subscribed",b.joined),w.options.prevCallId=b.getPrevCallId()},destroy:()=>{var e;f&&(w.off("room.subscribed",b.joined),y&&(null==(e=dc())||e.removeItem(y)))},getPrevCallId:()=>{var e,t;if(f&&y)return null!=(t=null==(e=dc())?void 0:e.getItem(y))?t:void 0}},_=Fc(v),w=_.rooms.makeRoomObject({negotiateAudio:!0,negotiateVideo:!0,iceServers:o,rootElement:n,applyLocalVideoOverlay:s,mirrorLocalVideoOverlay:a,stopCameraWhileMuted:c,stopMicrophoneWhileMuted:d,speakerId:l,destinationNumber:u,localStream:h,watchMediaPackets:m,watchMediaPacketsTimeout:p,prevCallId:b.getPrevCallId(),disableUdpIceServers:g});w.once("destroy",(()=>{w.emit("room.left",{reason:w.leaveReason}),b.destroy(),_.disconnect()})),_.session.once("session.disconnected",(()=>{w.destroy()}));const k={join:e=>new Promise((async(t,o)=>{var n,s;try{w.attachPreConnectWorkers(),await _.connect();const a=null!=(n=null==e?void 0:e.audio)?n:r,c=null!=(s=null==e?void 0:e.video)?s:i,d=_._sessionAuthState;if(dr().debug("getJoinMediaParams authState?",d),d&&"video"===d.type){const t=(e=>{const{authState:t,audio:r=!0,video:i=!0,sendAudio:o,sendVideo:n,receiveAudio:s,receiveVideo:a}=e;dr().debug("getJoinMediaParams options",Ia({},e));const{audio_allowed:c,video_allowed:d,join_as:l}=t,u="member"===(l??"member"),h=u&&"both"===c,m=u&&"both"===d,p="none"!==c,g="none"!==d,v=!!(o??r),f=!!(n??i),y=!!(s??r),b=!!(a??i);return!h&&v&&dr().info("Not allowed to send audio on this room. Default values will be used."),!m&&f&&dr().info("Not allowed to send video on this room. Default values will be used."),!p&&y&&dr().info("Not allowed to receive video from the room. Default values will be used."),!g&&b&&dr().info("Not allowed to receive video from the room. Default values will be used."),{mustSendAudio:h&&v,mustSendVideo:m&&f,mustRecvAudio:p&&y,mustRecvVideo:g&&b}})(Ia({authState:d,sendAudio:!!a,sendVideo:!!c},e));if(!(e=>Object.values(e).some(Boolean))(t))return _.disconnect(),o(new Error(`Invalid arguments to join the room. The token used has join_as: '${d.join_as}'. \n${JSON.stringify(e,null,2)}\n`));dr().debug("Set mediaOptions",t),w.updateMediaOptions({audio:!!t.mustSendAudio&&(a||!0),video:!!t.mustSendVideo&&(c||!0),negotiateAudio:t.mustRecvAudio,negotiateVideo:t.mustRecvVideo})}w.once("room.subscribed",(()=>{t(w)})),b.init(),vd.forEach((e=>w.once(e,fd))),await w.join()}catch(a){dr().error("RoomSession Join",a),_.disconnect(),o(a)}}))};return new Proxy(w,{get(e,t,r){if(t in k)return k[t];if(!e.active&&gd.includes(t))throw new Error(`Tried to access the property/method "${t}" before the room was connected. Please call roomSession.join() first.`);return Reflect.get(e,t,r)}})},bd={};Ta(bd,{checkCameraPermissions:()=>hs,checkMicrophonePermissions:()=>ms,checkPermissions:()=>us,checkSpeakerPermissions:()=>ps,createCameraDeviceWatcher:()=>Ds,createDeviceWatcher:()=>Ls,createMicrophoneAnalyzer:()=>Ns,createMicrophoneDeviceWatcher:()=>js,createSpeakerDeviceWatcher:()=>Vs,enumerateDevices:()=>ds,enumerateDevicesByKind:()=>ls,getCameraDevices:()=>Cs,getCameraDevicesWithPermissions:()=>bs,getDevices:()=>Ss,getDevicesWithPermissions:()=>ys,getDisplayMedia:()=>vs,getMicrophoneDevices:()=>Es,getMicrophoneDevicesWithPermissions:()=>_s,getSpeakerDevices:()=>Is,getSpeakerDevicesWithPermissions:()=>ws,getSupportedConstraints:()=>ts,getUserMedia:()=>gs,requestPermissions:()=>fs,setMediaElementSinkId:()=>os,stopStream:()=>ns,stopTrack:()=>ss,supportsGetDisplayMedia:()=>es,supportsGetUserMedia:()=>Yn,supportsMediaDevices:()=>Qn,supportsMediaOutput:()=>is});class _d{constructor(){P(this,"entries",[]),P(this,"lastSpoken",null)}}class wd{constructor(){P(this,"state"),P(this,"aiPartialResult",null),P(this,"userPartialResult",null),this.state=new _d}getHistory(){const e=[...this.state.entries];return this.aiPartialResult&&this.userPartialResult?"user"===this.state.lastSpoken?(e.push(this.aiPartialResult),e.push(this.userPartialResult)):(e.push(this.userPartialResult),e.push(this.aiPartialResult)):this.aiPartialResult?e.push(this.aiPartialResult):this.userPartialResult&&e.push(this.userPartialResult),e}handleEvent(e,t,r){switch(e){case"ai.response_utterance":this.aiPartialResult?this.aiPartialResult.text+=" "+t:this.aiPartialResult={type:"ai",text:t,state:"partial"},this.state.lastSpoken="ai";break;case"ai.completion":this.aiPartialResult&&(this.state.entries.push({...this.aiPartialResult,state:"complete"}),this.aiPartialResult=null),this.state.lastSpoken=r?"user":"ai";break;case"ai.partial_result":this.userPartialResult={type:"user",text:t,state:"partial"},this.state.lastSpoken="user";break;case"ai.speech_detect":this.userPartialResult&&(this.state.entries.push({...this.userPartialResult,state:"complete",text:t}),this.userPartialResult=null),this.state.lastSpoken="user"}this.onUpdate()}onUpdate(){}}class kd{constructor(){P(this,"devices",[]),P(this,"loading",!1),P(this,"selectedMicrophone",null),P(this,"selectedCamera",null),P(this,"selectedSpeaker",null),P(this,"isAudioMuted",!1),P(this,"isVideoMuted",!1),P(this,"isSpeakerMuted",!1),P(this,"currentVideoAspectRatio",null)}get audioinput(){return this.devices.filter((e=>"audioinput"===e.kind))}get audiooutput(){return this.devices.filter((e=>"audiooutput"===e.kind))}get videoinput(){return this.devices.filter((e=>"videoinput"===e.kind))}}const Sd=class e{constructor(){P(this,"state",new kd),P(this,"call",null),P(this,"deviceWatcher",null),P(this,"permissionStream",null)}static getInstance(){return e.instance||(e.instance=new e),e.instance}async getPermissions(e=!0){try{const t=await bd.getUserMedia({audio:!0,video:e});return this.permissionStream&&this.permissionStream.getTracks().forEach((e=>e.stop())),this.permissionStream=t,{success:!0}}catch(l){return console.error("Error getting permissions:",l),{success:!1,message:l instanceof Error?l.message:"Failed to get device permissions"}}}async setup(e){this.permissionStream&&(this.permissionStream.getTracks().forEach((e=>e.stop())),this.permissionStream=null),this.state.loading=!0,this.call=e;try{await this._updateDevicesList(),await this._updateSelectedDevices(),this.updateVideoAspectRatio(),this.deviceWatcher=await bd.createDeviceWatcher(),this.deviceWatcher.on("changed",(async()=>{await this._updateDevicesList(),await this._updateSelectedDevices(),this.updateVideoAspectRatio(),this.onChange()})),this.state.loading=!1,this.onLoad()}catch(l){console.error("Error in setup:",l),this.state.loading=!1}}async _updateDevicesList(){var e,t,r,i;const o=await bd.enumerateDevices();if(this.state.devices=o,this.call){if(this.state.isVideoMuted){const r=this.call.localVideoTrack||(null==(t=null==(e=this.call.localStream)?void 0:e.getVideoTracks())?void 0:t[0]);r&&(r.enabled=!1)}if(this.state.isAudioMuted){const e=this.call.localAudioTrack||(null==(i=null==(r=this.call.localStream)?void 0:r.getAudioTracks())?void 0:i[0]);e&&(e.enabled=!1)}}}async _updateSelectedDevices(){const{audioinput:e,audiooutput:t,videoinput:r}=this.state;!this.state.selectedMicrophone&&e.length>0&&(this.state.selectedMicrophone=e[0]),!this.state.selectedCamera&&r.length>0&&(this.state.selectedCamera=r[0]),!this.state.selectedSpeaker&&t.length>0&&(this.state.selectedSpeaker=t[0]),this.state.selectedMicrophone=e.find((e=>{var t;return e.deviceId===(null==(t=this.state.selectedMicrophone)?void 0:t.deviceId)}))||e[0]||null,this.state.selectedCamera=r.find((e=>{var t;return e.deviceId===(null==(t=this.state.selectedCamera)?void 0:t.deviceId)}))||r[0]||null,this.state.selectedSpeaker=t.find((e=>{var t;return e.deviceId===(null==(t=this.state.selectedSpeaker)?void 0:t.deviceId)}))||t[0]||null}updateVideoAspectRatio(){var e;if(null==(e=this.call)||!e.localStream)return;const t=this.call.localStream.getVideoTracks()[0];if(!t)return;const r=t.getSettings(),i=r.aspectRatio||(r.width&&r.height?r.width/r.height:null);i!==this.state.currentVideoAspectRatio&&(this.state.currentVideoAspectRatio=i,this.onAspectRatioChange(i||null))}onLoad(){}onChange(){}onAspectRatioChange(e){console.log("onAspectRatioChange",e)}async updateCamera(e){const t=this.state.devices.find((t=>t.deviceId===e&&"videoinput"===t.kind));if(!t||!this.call)return!1;try{return await this.call.updateCamera({deviceId:e}),this.state.selectedCamera=t,this.updateVideoAspectRatio(),this.onChange(),!0}catch(r){return console.error("Error updating camera:",r),!1}}async updateMicrophone(e){const t=this.state.devices.find((t=>t.deviceId===e&&"audioinput"===t.kind));if(!t||!this.call)return!1;try{return await this.call.updateMicrophone({deviceId:e}),this.state.selectedMicrophone=t,this.onChange(),!0}catch(r){return console.error("Error updating microphone:",r),!1}}async updateSpeaker(e){const t=this.state.devices.find((t=>t.deviceId===e&&"audiooutput"===t.kind));if(!t||!this.call)return!1;try{return await this.call.updateSpeaker({deviceId:e}),this.state.selectedSpeaker=t,this.onChange(),!0}catch(r){return console.error("Error updating speaker:",r),!1}}async toggleVideo(){var e;if(this.call)try{const e=await this.getSelf();null!=e&&e.videoMuted?await this.call.videoUnmute():await this.call.videoMute(),this.state.isVideoMuted=!this.state.isVideoMuted,this.onChange()}catch(l){console.error("Failed to toggle video via call method, trying fallback:",l);try{const t=this.call.localVideoTrack;if(t)return t.enabled=this.state.isVideoMuted,this.state.isVideoMuted=!this.state.isVideoMuted,void this.onChange();const r=this.call.localStream,i=null==(e=null==r?void 0:r.getVideoTracks())?void 0:e[0];if(i)return i.enabled=this.state.isVideoMuted,this.state.isVideoMuted=!this.state.isVideoMuted,void this.onChange();console.error("No video track available for fallback muting")}catch(t){console.error("Failed to toggle video via fallback method:",t)}}}async toggleAudio(){var e;if(this.call)try{const e=await this.getSelf();null!=e&&e.audioMuted?await this.call.audioUnmute():await this.call.audioMute(),this.state.isAudioMuted=!this.state.isAudioMuted,this.onChange()}catch(l){console.error("Failed to toggle audio via call method, trying fallback:",l);try{const t=this.call.localAudioTrack;if(t)return t.enabled=this.state.isAudioMuted,this.state.isAudioMuted=!this.state.isAudioMuted,void this.onChange();const r=this.call.localStream,i=null==(e=null==r?void 0:r.getAudioTracks())?void 0:e[0];if(i)return i.enabled=this.state.isAudioMuted,this.state.isAudioMuted=!this.state.isAudioMuted,void this.onChange();console.error("No audio track available for fallback muting")}catch(t){console.error("Failed to toggle audio via fallback method:",t)}}}async toggleSpeaker(){if(this.call)try{const e=await this.getSelf();null!=e&&e.deaf?await this.call.undeaf():await this.call.deaf(),this.state.isSpeakerMuted=!this.state.isSpeakerMuted,this.onChange()}catch(d){console.error("Failed to toggle speaker via deaf/undeaf, trying fallback:",d);try{this.call.audioEl&&(this.call.audioEl.muted=!this.state.isSpeakerMuted,this.state.isSpeakerMuted=!this.state.isSpeakerMuted,this.onChange())}catch(l){console.error("Failed to toggle speaker via fallback method:",l)}}}async getSelf(){if(!this.call)return null;const e=await this.call.getMembers();return null==e?void 0:e.members.find((e=>{var t;return e.id===(null==(t=this.call)?void 0:t.memberId)}))}reset(){var e,t,r;this.deviceWatcher&&(this.deviceWatcher.off("changed"),this.deviceWatcher=null),this.permissionStream&&(this.permissionStream.getTracks().forEach((e=>e.stop())),this.permissionStream=null),null!=(e=this.call)&&e.localStream&&this.call.localStream.getTracks().forEach((e=>{e.stop()})),null!=(t=this.call)&&t.localVideoTrack&&this.call.localVideoTrack.stop(),null!=(r=this.call)&&r.localAudioTrack&&this.call.localAudioTrack.stop(),this.call=null,this.state=new kd,this.onLoad=()=>{},this.onChange=()=>{},this.onAspectRatioChange=()=>{}}};P(Sd,"instance");const Cd=Sd.getInstance();class Ed{constructor(e,t){P(this,"client",null),P(this,"callDetails",null),P(this,"chat",null),P(this,"currentCall",null),P(this,"token",null),this.callDetails=e,this.token=t}getLocalVideoTrack(){var e;return null==(e=this.currentCall)?void 0:e.localVideoTrack}getLocalAudioTrack(){var e;return null==(e=this.currentCall)?void 0:e.localAudioTrack}async setupClient(){if(!this.token)throw new Error("Token is not set");const e=await ud({token:this.token});return e.on("ai.partial_result",(e=>{var t;null==(t=this.chat)||t.handleEvent("ai.partial_result",e.text??"",e.barged??!1)})),e.on("ai.speech_detect",(e=>{var t;const r=e.text.replace(/\{confidence=[\d.]+\}/,"");null==(t=this.chat)||t.handleEvent("ai.speech_detect",r,"normal"!==e.type)})),e.on("ai.completion",(e=>{var t;null==(t=this.chat)||t.handleEvent("ai.completion",e.text??"","barged"===e.type)})),e.on("ai.response_utterance",(e=>{var t;null==(t=this.chat)||t.handleEvent("ai.response_utterance",e.utterance??"",!1)})),this.client=e,e}async dial(t,r,i){const o=await this.setupClient();if(this.chat=new wd,!this.callDetails)throw new Error("Call details are not set");const n=await o.dial({to:this.callDetails.destination,rootElement:t,audio:this.callDetails.supportsAudio,video:this.callDetails.supportsVideo,negotiateVideo:this.callDetails.supportsVideo});return this.currentCall=n,n.on("call.joined",(()=>{if(console.log("call.joined",n),window.call=n,null!=n&&n.localStream){Cd.updateVideoAspectRatio(),console.log(n.localStream);const{localVideo:t}=e`<video
          autoplay
          playsinline
          muted
          name="localVideo"
        ></video>`();t.onloadedmetadata=()=>{console.log("localVideo.onloadedmetadata",t.videoWidth/t.videoHeight),Cd.onAspectRatioChange(t.videoWidth/t.videoHeight)},t.srcObject=n.localStream,i(t)}})),n.on("call.updated",(()=>{console.log("call.updated",n)})),this.chat&&(this.chat.onUpdate=()=>{var e;r((null==(e=this.chat)?void 0:e.getHistory())??[])}),n}async start(){var e;if(!this.client)throw new Error("Client is not set");await(null==(e=this.currentCall)?void 0:e.start())}async hangup(){var e;if(!this.currentCall)throw new Error("Call is not set");await(null==(e=this.currentCall)?void 0:e.hangup())}reset(){this.client&&(this.client.off("ai.partial_result"),this.client.off("ai.speech_detect"),this.client.off("ai.completion"),this.client.off("ai.response_utterance"),this.client.disconnect()),this.currentCall=null,this.client=null,this.chat=null}}const Id='<svg xmlns="http://www.w3.org/000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n  <path d="M18 15l-6-6-6 6"/>\n</svg> ',Md=e`
  <div name="controlsContainer">
    <div class="controls">
      <div class="control-group">
        <button class="control-button video-button" name="videoButton">
          <span class="muted-icon" style="display: none;">${'<svg  viewBox="0 0 24 24"><path fill="currentColor" d="M3.27,2L2,3.27L4.73,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16C16.2,18 16.39,17.92 16.54,17.82L19.73,21L21,19.73M21,6.5L17,10.5V7A1,1 0 0,0 16,6H9.82L21,17.18V6.5Z"></path></svg>'}</span>
          <span class="unmuted-icon">${'<svg viewBox="0 0 24 24"><path fill="currentColor" d="M17,10.5V7A1,1 0 0,0 16,6H4A1,1 0 0,0 3,7V17A1,1 0 0,0 4,18H16A1,1 0 0,0 17,17V13.5L21,17.5V6.5L17,10.5Z"></path></svg>'}</span>
        </button>
        <div class="device-select-wrapper">
          <button
            class="device-select-button video-devices-button"
            name="videoDevicesButton"
          >
            ${Id}
          </button>
          <div
            class="device-menu"
            name="videoDevicesMenu"
            style="display: none;"
          >
            <!-- Populated via JS -->
          </div>
        </div>
      </div>

      <div class="control-group">
        <button class="control-button mic-button" name="micButton">
          <span class="muted-icon" style="display: none;"
            >${'<svg  viewBox="0 0 24 24"><title>microphone-off</title><path d="M19,11C19,12.19 18.66,13.3 18.1,14.28L16.87,13.05C17.14,12.43 17.3,11.74 17.3,11H19M15,11.16L9,5.18V5A3,3 0 0,1 12,2A3,3 0 0,1 15,5V11L15,11.16M4.27,3L21,19.73L19.73,21L15.54,16.81C14.77,17.27 13.91,17.58 13,17.72V21H11V17.72C7.72,17.23 5,14.41 5,11H6.7C6.7,14 9.24,16.1 12,16.1C12.81,16.1 13.6,15.91 14.31,15.58L12.65,13.92L12,14A3,3 0 0,1 9,11V10.28L3,4.27L4.27,3Z" style="fill: currentcolor;"></path></svg>'}</span
          >
          <span class="unmuted-icon">${'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n  <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z" fill="currentColor"/>\n</svg> '}</span>
        </button>
        <div class="device-select-wrapper">
          <button
            class="device-select-button mic-devices-button"
            name="micDevicesButton"
          >
            ${Id}
          </button>
          <div class="device-menu" name="micDevicesMenu" style="display: none;">
            <!-- Populated via JS -->
          </div>
        </div>
      </div>

      <div class="control-group">
        <button class="control-button speaker-button" name="speakerButton">
          <span class="muted-icon" style="display: none;"
            >${'<svg viewBox="0 0 24 24"><path d="M12,4L9.91,6.09L12,8.18M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.53C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.5,12.43 16.5,12.21 16.5,12Z" style="fill: currentcolor;"></path></svg>'}</span
          >
          <span class="unmuted-icon">${'<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n  <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" fill="currentColor"/>\n</svg> '}</span>
        </button>
        <div class="device-select-wrapper">
          <button
            class="device-select-button speaker-devices-button"
            name="speakerDevicesButton"
          >
            ${Id}
          </button>
          <div
            class="device-menu"
            name="speakerDevicesMenu"
            style="display: none;"
          >
            <!-- Populated via JS -->
          </div>
        </div>
      </div>

      <button class="control-button hangup" name="hangupButton">
        ${'<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="200px" width="200px" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08a.956.956 0 0 1-.29-.7c0-.28.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71 0 .28-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28a11.27 11.27 0 0 0-2.67-1.85.996.996 0 0 1-.56-.9v-3.1C15.15 9.25 13.6 9 12 9z"></path></svg>'}
      </button>
    </div>
  </div>
`;function Pd(t,r){const i=r.scrollHeight-r.clientHeight<=r.scrollTop+300,o=r.scrollTop,n=t.map((e=>`<div class="message ${"user"===e.type?"message-sent":"message-received"} ${"partial"===e.state?"in-progress":""}">${e.text}<div class="tail"><svg width="25" height="27" viewBox="0 0 25 27" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M25 26C14.5 14.5 12.5 4.5 12.5 0H0V13C0 13 10 26.5 25 26Z"/>\n</svg>\n</div></div> `)).join(""),{chatContainer:s,chat:a}=e`
    <div name="chatContainer" class="chat-container">
      <div class="chat" name="chat">${n}</div>
    </div>
  `();null!==r.querySelector(".chat")?function(e,t){const r=e.children,i=t.children;for(let o=0;o<i.length;o++){const e=i[o],n=r[o];n?(e.innerHTML=n.innerHTML,e.className=n.className):(console.warn("chat.ui.ts: simple_diff: chat state changed in unexpected way."),t.removeChild(e))}for(let o=i.length;o<r.length;o++)t.appendChild(r[o].cloneNode(!0))}(a,r.querySelector(".chat")):r.appendChild(s),i?r.scrollTo({top:r.scrollHeight,behavior:"smooth"}):r.scrollTop=o}const Td=e`<div class="error-message" name="errorModal">
  <div class="error-header">
    <h3 class="error-title" name="titleEl"></h3>
  </div>
  <div class="error-content">
    <div class="error-text" name="messageEl"></div>
    <button class="action-button" name="closeButton">Close</button>
  </div>
</div> `;function xd(e,t,r){const{errorModal:i,closeButton:o,titleEl:n,messageEl:s}=Td();return n.textContent=e,s.textContent=t,null==o||o.addEventListener("click",(()=>{r()})),i}class Ad extends HTMLElement{constructor(){super(),P(this,"callOngoing",!1),P(this,"callLoading",!1),P(this,"shadow",this.attachShadow({mode:"open"})),P(this,"callDetails",null),P(this,"call",null),P(this,"containerElement",null),P(this,"modalContainer",null),P(this,"previousOverflowStyle",""),P(this,"token",null),this.setupDOM(),r.apply(this.shadow)}connectedCallback(){const e=this.getAttribute("token");this.token=e;const t=this.getAttribute("buttonId");if(t){const e=e=>{e.classList.contains("demo-button-disabled")&&e.classList.remove("demo-button-disabled"),e.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),console.log("Starting Call"),this.setupCall()}))},r=document.getElementById(t);r?e(r):new MutationObserver(((r,i)=>{const o=document.getElementById(t);o&&(e(o),i.disconnect())})).observe(document.body,{childList:!0,subtree:!0})}try{const e=this.getAttribute("callDetails");if(null===e)throw new Error("callDetails attribute is required");this.callDetails=JSON.parse(e)}catch{console.error("Invalid JSON in callDetails attribute"),this.callDetails=null}this.callDetails&&this.token&&(this.call=new Ed(this.callDetails,this.token))}closeModal(){if(this.modalContainer){const e=this.modalContainer.querySelector(".modal");this.modalContainer.classList.add("closing"),null==e||e.classList.add("closing"),setTimeout((()=>{var e,t;Cd.reset(),null==(e=this.modalContainer)||e.remove(),this.modalContainer=null,document.body.style.overflow=this.previousOverflowStyle,this.callOngoing=!1,null==(t=this.call)||t.reset()}),800)}}async setupCall(){var t,r,o,n,s,a;if(this.callOngoing)return void console.warn("Call is already ongoing; nop");if(null===this.callDetails||null===this.call)return void console.warn("No call or Call details provided");this.callOngoing=!0,this.callLoading=!0,this.previousOverflowStyle=document.body.style.overflow,document.body.style.overflow="hidden";const{modalContainer:c,videoPanel:d,videoArea:l,localVideoArea:u,controlsPanel:h,chatPanel:m}=function(){const{modalContainer:t,videoPanel:r,videoArea:o,localVideoArea:n,controlsPanel:s,chatPanel:a,videoPanelBackground:c}=i();n.addEventListener("click",(()=>{n.classList.toggle("flipped")}));const d=e`<img
    name="image"
    src="https://developer.signalwire.com/img/call-widget/sw_background.webp"
  />`,{image:l}=d(),u=()=>{c.classList.add("loaded"),c.style.backgroundImage=`url(${l.src})`};return"decode"in l?l.decode().then(u).catch((()=>{u()})):l.onload=u,{modalContainer:t,videoPanel:r,videoArea:o,localVideoArea:n,controlsPanel:s,chatPanel:a}}();this.modalContainer=c,this.renderLoading(this.callLoading,d),null==(t=this.containerElement)||t.appendChild(c);const p=await Cd.getPermissions((null==(r=this.callDetails)?void 0:r.supportsVideo)??!1);if(!p.success){console.error("Error getting permissions");const e=xd("Error Accessing Devices",p.message||"Error getting device permissions. Please grant this page access and try again.",(()=>this.closeModal()));return void(null==(o=this.modalContainer)||o.appendChild(e))}let g=null;try{g=await this.call.dial(l,(function(e){Pd(e,m)}),(function(e){u.appendChild(e)}))}catch(f){console.error("Error setting up call",f);const e=xd("Error","Error creating the call. Please refresh the page and try again.",(()=>this.closeModal()));return void(null==(n=this.modalContainer)||n.appendChild(e))}await Cd.setup(g),Cd.onAspectRatioChange=e=>{e&&u&&(u.style.aspectRatio=`${e}`)};const v=await async function(e){Cd.onChange=h;const{controlsContainer:t,videoButton:r,micButton:i,speakerButton:o,hangupButton:n,videoDevicesButton:s,micDevicesButton:a,speakerDevicesButton:c,videoDevicesMenu:d,micDevicesMenu:l,speakerDevicesMenu:u}=Md();function h(){const{isVideoMuted:e,isAudioMuted:t,isSpeakerMuted:n,videoinput:h,audioinput:p,audiooutput:g,selectedCamera:v,selectedMicrophone:f,selectedSpeaker:y}=Cd.state;function b(e,t){const r=e.querySelector(".muted-icon"),i=e.querySelector(".unmuted-icon");r&&i&&(r.style.display=t?"block":"none",i.style.display=t?"none":"block")}b(r,e),b(i,t),b(o,n),s.style.display=h.length>0?"block":"none",s.disabled=e,r.classList.toggle("standalone",0===h.length),a.style.display=p.length>0?"block":"none",a.disabled=t,i.classList.toggle("standalone",0===p.length),c.style.display=g.length>0?"block":"none",c.disabled=n,o.classList.toggle("standalone",0===g.length),m(d,h,v,"camera"),m(l,p,f,"microphone"),m(u,g,y,"speaker")}function m(e,t,r,i){e.innerHTML=t.map((e=>`\n      <div class="device-option ${e.deviceId===(null==r?void 0:r.deviceId)?"selected":""}" data-device-id="${e.deviceId}">\n        ${e.deviceId===(null==r?void 0:r.deviceId)?'<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">\n  <path d="M13.3333 4L6 11.3333L2.66667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n</svg> ':""}\n        ${e.label||`${i} ${t.indexOf(e)+1}`}\n      </div>\n    `)).join("")}function p(e,t,r){e.addEventListener("click",(e=>{e.stopPropagation(),[d,l,u].forEach((e=>{e!==t&&(e.style.display="none")})),t.style.display="none"===t.style.display?"block":"none"})),t.addEventListener("click",(async e=>{const i=e.target.closest(".device-option");if(i){const e=i.getAttribute("data-device-id");e&&(await r(e),t.style.display="none")}}))}return r.addEventListener("click",(()=>Cd.toggleVideo())),i.addEventListener("click",(()=>Cd.toggleAudio())),o.addEventListener("click",(()=>Cd.toggleSpeaker())),n.addEventListener("click",(()=>null==e?void 0:e())),p(s,d,(e=>Cd.updateCamera(e))),p(a,l,(e=>Cd.updateMicrophone(e))),p(c,u,(e=>Cd.updateSpeaker(e))),document.addEventListener("click",(()=>{d.style.display="none",l.style.display="none",u.style.display="none"})),h(),t}((async()=>{var e;try{await(null==(e=this.call)?void 0:e.hangup())}catch(t){console.error("Error hanging up call. Force terminating call.",t)}this.closeModal()}));null==g||g.on("room.left",(()=>{this.closeModal()})),h.appendChild(v);try{await(null==(s=this.call)?void 0:s.start())}catch(f){console.error("Error starting call",f);const e=xd("Error","Error starting the call. This is possibly due to network issues. Please refresh the page and try again.",(()=>this.closeModal()));return void(null==(a=this.modalContainer)||a.appendChild(e))}this.callLoading=!1,this.renderLoading(this.callLoading,d)}renderLoading(e,t){var r;if(e){const{loading:e}=o();t.appendChild(e)}else null==(r=t.querySelector(".loading"))||r.remove()}setupDOM(){const e=document.createElement("div");this.shadow.appendChild(e),this.containerElement=e}disconnectedCallback(){this.closeModal()}}customElements.define("c2c-widget",Ad)}();